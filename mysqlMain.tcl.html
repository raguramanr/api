<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                       "http://www.w3.org/TR/html4/transitional.dtd">
<!-- Generated by TclDoc @@VERSION@@ -->
<html>
<head>
  <title>mysqlMain.tcl</title>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <link rel="stylesheet" type="text/css" href="default.css">
</head>
<body class="src-html">
<div class="index-selector">
<!-- index for tcl source files -->
	Index by: 
	<a href="index_main.html#mysqlMain.tcl">file name</a> | 
	<a href="index_main.html#byprocname">procedure name</a> | 
	<a href="index_main.html#bycall">procedure call</a> | 
	<a href="index_annot_full.html">annotation</a>

</div>
<hr>

<p><strong>mysqlMain.tcl</strong>&nbsp;&nbsp;<span class="filetype-link">(<a href="mysqlMain.tcl-annot.html">annotations</a> | <a href="mysqlMain.tcl.txt">original source</a>)</span>
</p>
<pre class="src-code">
<span class="comment-line">#!/usr/bin/tclsh</span>



source ../Lib/parse_args.tcl
source ../Lib/mainLib.tcl
source ./cfg/common.cfg
package require Tclx

<strong><a name="::::regPrintUsage_10">proc <a href="mysqlMain.tcl-annot.html#::::regPrintUsage">::::regPrintUsage</a></a></strong> {} {
    puts &#34;\r&#34;
    puts &#34;usage:\n&#34;
    puts &#34;   mysqlMain.tcl -module &lt;module name&gt; -regId &lt;regression_id&gt;&#34;
    puts &#34;\nOR, if new regression:\n&#34;
    puts &#34;   mysqlMain.tcl -module &lt;module name&gt; -platform &lt;platform_name&gt; -build &lt;build_num&gt;&#34;
    puts &#34;\nOptional arguments for both of above:\n&#34;
    puts &#34;         \[-mode &lt;mode&gt;\] \[-cfg &lt;cfg file&gt;] \[-lst &lt;lst&gt; | -tcList &lt;moduleList&gt;\]&#34;
    puts &#34;         \[-rerun y|n\] \[-debugLevel &lt;error debug level&gt;\] \[-verCheck y|n\] \[-help\]&#34;
    puts &#34;         \[-moduleArg &lt;module specific arg&gt;\] \[-subversion &lt;subversion variable&gt;\] \[-efence &lt;process list&gt;\] \[-saveConfigPerTest &lt;enable save config per test&gt;\] \[-cliFlag NO_REBOOT|NO_REBOOT_NO_DOWNLOAD\]&#34;
    puts &#34;\n&#34;
    puts &#34;    -module:     Feature to run - e.g: VRRP \(case insensitive\)&#34;
    puts &#34;    -regId:      Regression ID from the mysql Website - e.g: 385&#34;
    puts &#34;    -platform:   Platform name to upload on \(from runReg.cfg\) - e.g: JAG_FUNC_IPR,1&#34;
    puts &#34;    -build:      Build number to use when uploading - e.g: 11.5.0.13&#34;
    puts &#34;    -mode:       auto | dev | autodev&#34;
    puts &#34;    -cfg:        cfg filename, path optional - e.g: cfg/p1_asp_g48t.cfg&#34;
    puts &#34;    -lst:        quick | pass | all&#34;
    puts &#34;    -tcList:     List of test cases names to run. Do not specify this if rerun option is \&#34;y\&#34;&#34;
    puts &#34;    -rerun:      Default \&#34;n\&#34;; if \&#34;y\&#34;, will run all the failed testcases from the first run of module.&#34;
    puts &#34;    -efence:     list of efence activated processes.&#34;
    puts &#34;    -saveConfigPerTest:     enable save config per test.&#34;
    puts &#34;    -debugLevel: Debug level 0|1|2|3. The level at which the debug information is dumped when script encounters an error. Default 0 \(no debug\)&#34;
    puts &#34;    -verCheck:   Version check; if \&#34;n\&#34;, will not check that the build name specified matches with the actual version loaded on the DUT's. Default y.&#34;
    puts &#34;    -cliFlag:    Optional only for \&#34;cli\&#34; regression \(NO_REBOOT|NO_REBOOT_NO_DOWNLOAD\)&#34;
    puts &#34;    -qId:        Regression system queue ID SC_######_###### or RTP_######_######&#34;
    puts &#34;    -TrafficGen: ixia or ixvm or stc&#34;
    puts &#34;    -harness:    tcl,itest,all - Which harness to execute&#34;
    puts &#34;    -comment:    note passed to main.tcl for comment or control of global args&#34;
    puts &#34;    -help:       Print this usage help&#34;
}

<span class="comment-line">#Validate args</span>
<strong><a name="::::ValidateMysqlMainArgs_43">proc <a href="mysqlMain.tcl-annot.html#::::ValidateMysqlMainArgs">::::ValidateMysqlMainArgs</a></a></strong> { args } {

    global regId queueId 
    global logFileId
    global mysql_handler

    <a name="::parse_args(1)"><a href="./parse_args.tcl.html#::parse_args_29">::parse_args</a></a> ValidateMysqlMainArgs $args {
	rerun &#34;n&#34;
	tcList &#34;all&#34;
	regId &#34;null&#34;
	module &#34;null&#34;
	platform &#34;null&#34;
	build &#34;null&#34;
        subversion &#34;null&#34;
	efence &#34;no&#34;
	saveConfigPerTest &#34;no&#34;
	debugLevel &#34;0&#34;
    }

    if { $regId != &#34;null&#34; } {
        <span class="comment-line"># is that regId actually a queueId ? - ex: SC_060614_124245</span>
        if [regexp -nocase {[a-z]} $regId] {
          puts $logFileId &#34;regId was queueId $regId&#34;
          set queueId $regId
          <span class="comment-line"># do we have platform?</span>
          if {$platform != &#34;null&#34;} {
            set platformInfoList [DetermineCfgRegTypeSubTypeFromPlatform $platform]

            set defaultCfg [lindex $platformInfoList 0]
            set regType    [lindex $platformInfoList 1]
            set regSubType [lindex $platformInfoList 2]
            set regPath    &#34;[GetRegPath $regType $regSubType]&#34;

            puts $logFileId &#34;defaultCfg  = $defaultCfg&#34;
            set platform_id [mysqlsel $mysql_handler \
                            &#34;SELECT platform_id FROM platform_table \
                             WHERE platform_cfg_file_name='$defaultCfg'&#34; -flatlist]
            <span class="comment-line">#result_debug &#34;platform_id = $platform_id&#34;</span>
            puts $logFileId &#34; validateArgs platform_id = $platform_id&#34;
          } else {
            set platform_id &#34;null&#34;
          }

          <span class="comment-line"># do we have existing regId queueId build?</span>
          puts $logFileId &#34;do we have existing regId queueId $queueId build $build platform_id $platform_id ?&#34;
          set regId [<a name="::GetRegressionIdFromQueueId(1)"><a href="./mysqlLib.tcl.html#::GetRegressionIdFromQueueId_1546">::GetRegressionIdFromQueueId</a></a> $queueId $build $platform_id $module ]
          if { $regId == &#34;&#34; } {
            set regId &#34;null&#34;
          }
        } else {
          set queueId &#34;null&#34;
        }
    }

    <span class="comment-line"># Either regId or platform+build MUST exist</span>
    if { ($regId == &#34;null&#34;) &amp;&amp; ($queueId == &#34;null&#34;) } {
	<span class="comment-line"># Regression ID is not given</span>
	if { ($platform == &#34;null&#34;) || ($build == &#34;null&#34;) } {
	    puts $logFileId &#34;Error: Either Regression ID or Platform+Build must be supplied.&#34;
	    <a name="::regPrintUsage(1)"><a href="./mysqlMain.tcl.html#::regPrintUsage_10">::regPrintUsage</a></a>
	    exit
	}
    } else {
	<span class="comment-line"># Regression ID is given</span>
	if { ((($platform != &#34;null&#34;) || (($build != &#34;null&#34;) &amp;&amp; ($build != &#34;0.0.0.0&#34;))) \
               &amp;&amp; ($queueId == &#34;null&#34;)) } {
             puts $logFileId &#34;platform = $platform build = $build&#34;
            puts $logFileId &#34;queueId = $queueId&#34;
	    puts $logFileId &#34;Error: Either Regression ID or Platform+Build must be supplied, but not any combination of the above.&#34;
	    <a name="::regPrintUsage(2)"><a href="./mysqlMain.tcl.html#::regPrintUsage_10">::regPrintUsage</a></a>
	    exit
	}
    }

    <span class="comment-line"># tcList cannot coexist with rerun option.</span>
    if { [regexp -nocase &#34;y&#34; $rerun] &amp;&amp; ($tcList != &#34;all&#34;) } {
	puts $logFileId &#34;Error: rerun option cannot be Y with tcList given. Do not include tcList.&#34;
	<a name="::regPrintUsage(3)"><a href="./mysqlMain.tcl.html#::regPrintUsage_10">::regPrintUsage</a></a>
	exit
    }

    <span class="comment-line"># Module name must be supplied</span>
    if { $module == &#34;null&#34; } {
	puts $logFileId &#34;Error: Module name must be specified.&#34;
	<a name="::regPrintUsage(4)"><a href="./mysqlMain.tcl.html#::regPrintUsage_10">::regPrintUsage</a></a>
	exit
    }
    
    <span class="comment-line"># Grant removed 7/28 to enable passing in a filename from the queuing system</span>
    <span class="comment-line">#if { ($debugLevel &lt; 0 ) || ($debugLevel &gt;= 4) } {</span>
	 <span class="comment-line">#puts $logFileId &#34;Error: Debug Level must be between 0 and 4.&#34;</span>
	 <span class="comment-line">#regPrintUsage</span>
	 <span class="comment-line">#exit</span>
    <span class="comment-line">#}</span>
}

<strong><a name="::::ValidateDUTVersions_139">proc <a href="mysqlMain.tcl-annot.html#::::ValidateDUTVersions">::::ValidateDUTVersions</a></a></strong> { build cfg mode } {

    global logFileId
    <span class="comment-line"># All of the below variables are required as global at this stage because Login assumes them to exist in global scope.</span>
    global numDUT verCheck
    global DUT1_CONNECT DUT2_CONNECT DUT3_CONNECT DUT4_CONNECT DUT5_CONNECT
    global DUT1_IP DUT2_IP DUT3_IP DUT4_IP DUT5_IP connectionTimeout 
    global supportedPlatform i386Platform

    global powerCyclerRetry
    puts $logFileId &#34;Location [pwd] ValidateDUTVersions  build cfg mode = $build $cfg $mode&#34;
    <span class="comment-line">#source ../main/cfg/common.cfg</span>

    if { [regexp -nocase &#34;^n&#34; $verCheck] } {
        puts $logFileId &#34;verCheck was specified as no. Will not check DUT versions.&#34;
        <a name="::result_ok(1)"><a href="./lconsoles.tcl.html#::result_ok_9">::result_ok</a></a> &#34;verCheck was specified as no. Will not check DUT versions.&#34;
        return
    }

    puts &#34;\nVerify that all DUT's in $cfg are loaded with version $build\n&#34;
    puts  $logFileId  &#34;\nVerify that all DUT's in $cfg are loaded with version $build\n&#34;

    <span class="comment-line"># Source cfg file, with or without a cfg/.... specified</span>
    if { (![regexp -nocase &#34;^cfg&#34; $cfg]) &amp;&amp; (![regexp -nocase {/} $cfg]) } {
        if { ![file exists $cfg] } {
            set cfg &#34;cfg/$cfg&#34;
        }
    }
    set cfg [string trim $cfg]
    puts $logFileId &#34;Using config file: ($cfg)&#34;    
    puts &#34;Using config file: ($cfg)&#34;    
    source $cfg
    
    if { [info exists DUT5_CONNECT] } {
        set numDUT 5
    } elseif { [info exists DUT4_CONNECT] } {
        set numDUT 4
    } elseif { [info exists DUT3_CONNECT] } {
        set numDUT 3
    } elseif { [info exists DUT2_CONNECT] } {
        set numDUT 2
    } elseif { [info exists DUT1_CONNECT] } {
        set numDUT 1
    }

    <span class="comment-line"># Check each DUT, if $build is not current build, quit!</span>
    set dutList &#34;&#34;
    for {set dut 1} {$dut &lt;= $numDUT} {incr dut} {
        set DUTName [format %s%d DUT $dut]
        <a name="::Login(1)"><a href="./login.tcl.html#::Login_24">::Login</a></a> [set ${DUTName}_CONNECT] -CheckOperational 0 -masterCheck 0
        if { $mode == &#34;dev&#34; } {
            lappend parameterList {{<a name="::version(1)"><a href="./ePTClient.tcl.html#::version_470">::version</a></a>} 1}
            set verstr [<a name="::GetKeyValue(1)"><a href="./OptionCheck.tcl.html#::GetKeyValue_438">::GetKeyValue</a></a> &#34;show version&#34; $parameterList]
        } else {
            <a name="::SendACmd(1)"><a href="./SendSwCmd.tcl.html#::SendACmd_157">::SendACmd</a></a> &#34;disable clipaging&#34;
            lappend parameterList {{Image Selected:} 1}
            lappend parameterList {{Primary ver:} 1}
            lappend parameterList {{Secondary ver:} 1}
            set imageList [<a name="::GetKeyValue(2)"><a href="./OptionCheck.tcl.html#::GetKeyValue_438">::GetKeyValue</a></a> &#34;show switch&#34; $parameterList]
            set imageSelected [lindex $imageList 0]
            if { [regexp -nocase &#34;primary&#34; $imageSelected] } {
            set verstr [lindex $imageList 1]
            } else {
            set verstr [lindex $imageList 2]
            }
        }
        unset parameterList
        puts &#34;\nDUT $dut image = $verstr&#34;
        puts $logFileId &#34;\nDUT $dut image = $verstr&#34;

        if { $verstr != $build } {
            set dutList &#34;$dutList $dut&#34;
        }

        global spawn_id
        exp_send &#34;\035&#34;
        expect &#34;telnet&#34;
        exp_send &#34;quit\r&#34;
        expect &#34;.*&#34;
        close -i $spawn_id
    }
    sleep 3
    if { $dutList == &#34;&#34; } {
        puts $logFileId  &#34;All DUT's have the correct image $build loaded.&#34;
        <a name="::result_ok(2)"><a href="./lconsoles.tcl.html#::result_ok_9">::result_ok</a></a> &#34;All DUT's have the correct image $build loaded.&#34;
    } else {
        set dutList [string range $dutList 1 end]
        puts $logFileId &#34;DUT's \{ $dutList \} do not have the correct image. Please download correct image on these DUT's and rerun mysqlMain.tcl&#34;
        <a name="::result_error(1)"><a href="./lconsoles.tcl.html#::result_error_6">::result_error</a></a> &#34;DUT's \{ $dutList \} do not have the correct image. Please download correct image on these DUT's and rerun mysqlMain.tcl&#34;
        exit
    }
}

<span class="comment-line">################################################################################</span>
<span class="comment-line">#                                M A I N</span>
<span class="comment-line">################################################################################</span>

<a name="::parse_args(2)"><a href="./parse_args.tcl.html#::parse_args_29">::parse_args</a></a> mysqlMain $argv {
    module &#34;null&#34;
    regId &#34;null&#34;
    queueId &#34;null&#34;
    platform &#34;null&#34;
    build &#34;null&#34;
    subversion &#34;null&#34;
    obuild &#34;&#34;
    mode &#34;auto&#34;
    cfg &#34;null&#34;
    lst &#34;all&#34;
    tcList &#34;all&#34;
    rerun &#34;n&#34;
    debugLevel &#34;0&#34;
    verCheck &#34;y&#34;
    cliFlag &#34;&#34;
    moduleArg &#34;&#34;
    efence &#34;no&#34;
    saveConfigPerTest &#34;no&#34;
    mainPath &#34;&#34;
    qId &#34;null&#34;
    help &#34;&#34;
    sustaining &#34;0&#34;
    TrafficGen &#34;ixia&#34;
    harness &#34;tcl&#34;
    comment &#34;null&#34;
}

<span class="comment-line"># Display usage if no arguments given or -help is given</span>
if { ([llength $argv]  == 0) || ([lsearch $argv &#34;-help&#34;]  &gt; -1) } {
    <a name="::regPrintUsage(5)"><a href="./mysqlMain.tcl.html#::regPrintUsage_10">::regPrintUsage</a></a> 
    exit
}

load [lindex [glob &#34;/usr/lib/libexpect*so*&#34;] 0]
set LIB_PATH &#34;../Lib&#34;
lappend auto_path $LIB_PATH
<a name="::::gen_index(1)"><a href="./summarize.tcl.html#::::gen_index_76">::::gen_index</a></a> ../Lib
<a name="::::gen_index(2)"><a href="./summarize.tcl.html#::::gen_index_76">::::gen_index</a></a> .

<span class="comment-line">##################################################################</span>
<span class="comment-line"># MAIN arguments used in lib procs</span>
<span class="comment-line">##################################################################</span>
set MAIN(IxiaReady) 1
set MAIN(RESULTPATH) &#34;Result&#34;
set MAIN(RESULTDIR) &#34;null&#34;;<span class="comment-line"># all script results file will be posted here while running</span>
set MAIN(REPORTDIR) &#34;null&#34;;<span class="comment-line"># ResultDir is renamed to this at the very end.</span>
set MAIN(SHOWSTDOUT) 1

<span class="comment-line"># ------------------------------------------------------------------------------</span>
<span class="comment-line"># These 4 calls are REQUIRED for all sublevel libraries that use</span>
<span class="comment-line"># result_xxxx functions to work.</span>
set resultDir &#34;Tmp&#34;
if { ! [file isdirectory $resultDir] } {
    ;<span class="comment-line"># Create it!</span>
    file mkdir $resultDir
}

set tStartTime [clock seconds]
set tStartDate [clock format [clock seconds] -format &#34;%Y-%m-%d %I.%M.%S%p&#34;]
set tStartDateString [clock format [clock seconds] -format &#34;%Y-%m-%d_%I.%M.%S%p&#34;]

set fd_res [<a name="::open_result_file(1)"><a href="./result.tcl.html#::open_result_file_276">::open_result_file</a></a> &#34;runall-[clock format [clock seconds] -format &#34;%I.%M%p&#34;]-[pid]&#34;]

source ../Lib/mainLib.tcl
source ../Lib/platform.tcl

<span class="comment-line"># Default config file</span>
set cfgFile ../main/runReg.cfg

set cnfgFileFound 1
<span class="comment-line"># Source config file that has Regression PC information</span>
if [file exists $cfgFile] {
    puts &#34;Sourcing $cfgFile now&#34;
    catch {source $cfgFile} reason
} else {
    puts &#34;!!! Configuration file $cfgFile not found !!!&#34;
    set cnfgFileFound 0
}

global mysqlIP my_db
set host $mysqlIP
set db $my_db
global host
global mysql_handler

<span class="comment-line"># connect to database</span>
puts &#34;connecting to database $db at $host&#34;
set connStatus [<a name="::conn_to_db(1)"><a href="./mysqlLib.tcl.html#::conn_to_db_8">::conn_to_db</a></a> $host $db]
puts &#34;database $db at $host - status $connStatus&#34;

<span class="comment-line"># Open log file</span>
set tmStr [clock format [clock seconds] -format &#34;%Y-%m-%d %I.%M.%S%p&#34;]

set logRegId $regId
set logQueueId $queueId

if { $regId != &#34;null&#34; } {
   <span class="comment-line"># is that regId actually a queueId ? - ex: SC_060614_124245</span>
   if [regexp -nocase {[a-z]} $regId] {
     set logRegId &#34;null&#34;
     set logQueueId $regId
   }
}

set logFileName &#34;../main/Log/M $logRegId $logQueueId $platform $build $module $tmStr.txt&#34;
if { [catch {open $logFileName w} logFileId] } {
   puts &#34;ERROR:: Can't Open $logFileName&#34;
   return
}

if {!$cnfgFileFound} {
    <a name="::result_error(2)"><a href="./lconsoles.tcl.html#::result_error_6">::result_error</a></a> &#34;!!! Configuration file $cfgFile not found !!!&#34;
    return 0
}


puts &#34;###################################################################&#34;
puts $logFileId  &#34;###################################################################&#34;
puts &#34;                    MYSQLMAIN.TCL STARTED!&#34;
puts $logFileId  &#34;                    MYSQLMAIN.TCL STARTED!&#34;
puts &#34;###################################################################&#34;
puts $logFileId  &#34;###################################################################&#34;
puts &#34;[exec date]&#34;
puts $logFileId  &#34;[exec date]&#34;

puts $logFileId &#34;database $db at $host - status $connStatus&#34;

puts &#34;mysqlMain starts with: \n \
queueId: $queueId \n \
regId: $regId \n \
module: $module \n \
platform: $platform \n \
build: $build \n \
subversion: $subversion \n \
obuild: $obuild \n \
mode: $mode \n \
cfg: $cfg \n \
lst: $lst \n \
tcList: $tcList \n \
efence: $efence \n \
saveConfigPerTest: $saveConfigPerTest \n \
rerun: $rerun \n&#34;

puts $logFileId &#34;mysqlMain starts with: \n \
queueId: $queueId \n \
regId: $regId \n \
module: $module \n \
platform: $platform \n \
build: $build \n \
subversion: $subversion \n \
obuild: $obuild \n \
mode: $mode \n \
cfg: $cfg \n \
lst: $lst \n \
tcList: $tcList \n \
efence: $efence \n \
saveConfigPerTest: $saveConfigPerTest \n \
rerun: $rerun \n&#34;

<a name="::ValidateMysqlMainArgs(1)"><a href="./mysqlMain.tcl.html#::ValidateMysqlMainArgs_43">::ValidateMysqlMainArgs</a></a> -rerun &#34;$rerun&#34; -tcList &#34;$tcList&#34; -regId &#34;$regId&#34; -module &#34;$module&#34; \
           -platform &#34;$platform&#34; -build &#34;$build&#34; -subversion $subversion -efence &#34;$efence&#34; \
           -saveConfigPerTest &#34;$saveConfigPerTest&#34; -debugLevel &#34;$debugLevel&#34;

if { $regId != &#34;null&#34; } {
    puts &#34;regression_id is supplied, regId = $regId&#34;
    puts $logFileId  &#34;regression_id is supplied, regId = $regId&#34;

    set cfgRegtypeRegsubtypeList [<a name="::DetermineCfgRegTypeSubTypeFromRegId(1)"><a href="./mysqlLib.tcl.html#::DetermineCfgRegTypeSubTypeFromRegId_1484">::DetermineCfgRegTypeSubTypeFromRegId</a></a> $regId]
    if { $cfgRegtypeRegsubtypeList == -1 } {
	puts $logFileId &#34;Nice try ... Is the website down or are you?&#34;
	puts $logFileId &#34;Regression ID $regId does not exist... please double check webpage and try again.&#34;
	exit
    }
puts $logFileId &#34;1: cfgRegtypeRegsubtypeList=$cfgRegtypeRegsubtypeList&#34;
    set defaultCfg [lindex $cfgRegtypeRegsubtypeList 0]
    set regType    [lindex $cfgRegtypeRegsubtypeList 1]
    set regSubType [lindex $cfgRegtypeRegsubtypeList 2]
    set regPath    &#34;[GetRegPath $regType $regSubType]&#34;

    set build [<a name="::DetermineBuildNumFromRegId(1)"><a href="./mysqlLib.tcl.html#::DetermineBuildNumFromRegId_1517">::DetermineBuildNumFromRegId</a></a> $regId]
} else {
    puts &#34;regression_id is not supplied, try to find it or create it&#34;
    puts $logFileId  &#34;regression_id is not supplied, try to find it or create it&#34;

    set platformInfoList [DetermineCfgRegTypeSubTypeFromPlatform $platform]
puts $logFileId &#34;2: platformInfoList=$platformInfoList&#34;
    set defaultCfg [lindex $platformInfoList 0]
    set regType    [lindex $platformInfoList 1]
    set regSubType [lindex $platformInfoList 2]
    set regPath    &#34;[GetRegPath $regType $regSubType]&#34;

    set platform_id [mysqlsel $mysql_handler &#34;SELECT platform_id FROM platform_table WHERE platform_cfg_file_name='$defaultCfg'&#34; -flatlist]
    puts &#34;platform_id = $platform_id&#34;
    puts $logFileId  &#34;platform_id = $platform_id&#34;

    <span class="comment-line"># Get build ID</span>
<span class="comment-line">#    regexp {([0-9]+)\.([0-9]+)\.([0-9]+)[\.b]([0-9]+.*)} $build match major minor patch buildnumber</span>
<span class="comment-line">#    set minorver $major.$minor.$patch</span>
<span class="comment-line">#    set build_list [mysqlsel $mysql_handler &#34;SELECT build_id FROM build_table WHERE build_minor_release='$minorver' AND build_number='$buildnumber'&#34; -flatlist]</span>
<span class="comment-line">#    set build_id [lindex $build_list 0]</span>
    set build_id [<a name="::GetBuildIdFromBuild(1)"><a href="./mysqlLib.tcl.html#::GetBuildIdFromBuild_1684">::GetBuildIdFromBuild</a></a> $build]

    puts &#34;build_id = $build_id&#34;
    puts $logFileId  &#34;build_id = $build_id&#34;

    set regId [<a name="::GetRegressionId(1)"><a href="./mysqlLib.tcl.html#::GetRegressionId_1604">::GetRegressionId</a></a> -queue_id $queueId -build_id $build_id -platform_id $platform_id -feature_type $regType -feature_sub_type $regSubType]
}

if { $cfg == &#34;null&#34; } {
    <span class="comment-line"># user did not specify their own cfgfile to run on; use default</span>
    set configToRunMain $defaultCfg
} else {
    <span class="comment-line"># user specified their own cfgfile to run on; use that one instead of the default</span>
    set configToRunMain $cfg
}

puts &#34;defaultCfg = $defaultCfg&#34;
puts $logFileId  &#34;defaultCfg = $defaultCfg&#34;
puts &#34;configToRunMain = $configToRunMain&#34;
puts $logFileId  &#34;configToRunMain = $configToRunMain&#34;
puts &#34;regType,regSubType = $regType,$regSubType&#34;
puts $logFileId  &#34;regType,regSubType = $regType,$regSubType&#34;
puts &#34;build = $build&#34;
puts $logFileId  &#34;build = $build&#34;
puts &#34;regression_id = $regId&#34;
puts $logFileId  &#34;regression_id = $regId&#34;

<span class="comment-line"># Validate correct image on all DUT's</span>
<a name="::ValidateDUTVersions(1)"><a href="./mysqlMain.tcl.html#::ValidateDUTVersions_139">::ValidateDUTVersions</a></a> $build $configToRunMain $mode

<span class="comment-line"># get regression data</span>

set feature_directory &#34;NULL&#34;
set regressionModules [mysqlsel $mysql_handler &#34;SELECT feature_directory FROM feature_table WHERE \
	feature_type='$regType' AND feature_sub_type='$regSubType' AND status = 'Active'&#34; -flatlist]
foreach regressionModule [lsort $regressionModules] {
    set match &#34;&#34;
    set str &#34;&#34;
    <span class="comment-line">#[regexp -nocase &#34;(^$module)&#34; $regressionModule match str]</span>
    if {[string tolower [string trim $module]] == [string tolower [string trim $regressionModule]]} {
        puts $logFileId &#34;\nOK: Module name '$module' found in regression modules.&#34;
        <a name="::result_ok(3)"><a href="./lconsoles.tcl.html#::result_ok_9">::result_ok</a></a> &#34;Module name $regressionModule found in regression modules.&#34;
	set feature_directory $regressionModule
	break
    }
}
if { $feature_directory == &#34;NULL&#34; } {
    puts $logFileId &#34;\nERROR: Module name '$module' does not correspond to any feature name in the mysql database. Check spelling and try again.&#34;
    exit
}

puts &#34;module = $feature_directory&#34;
puts $logFileId  &#34;module = $feature_directory&#34;

<span class="comment-line">#######################################################################</span>
<span class="comment-line">#regexp {([0-9]+)\.([0-9]+)\.([0-9]+)[\.b]([0-9]+.*)} $build  match major minor patch buildnumber</span>
<span class="comment-line">#set minorver $major.$minor.$patch</span>
<span class="comment-line">#</span>
<span class="comment-line">#set build_list [mysqlsel $mysql_handler &#34;SELECT build_id FROM build_table WHERE build_minor_release='$minorver' AND build_number='$buildnumber'&#34; -flatlist]</span>
<span class="comment-line">#set build_id [lindex $build_list 0]</span>
<span class="comment-line">#result_debug &#34;build_id = $build_id&#34;</span>
<span class="comment-line">#set regression_id [lindex [mysqlsel $mysql_handler &#34;SELECT regression_id FROM regression_table WHERE build_id='$build_id' AND \</span>
<span class="comment-line">#	feature_type='$regType' AND feature_sub_type='$regSubType' AND platform_id='$platform_id'&#34; -flatlist] 0]</span>
<span class="comment-line">#</span>
<span class="comment-line"># get platform data</span>
<span class="comment-line">#set platform_id [mysqlsel $mysql_handler &#34;SELECT platform_id FROM regression_table WHERE regression_id='$regId'&#34; -flatlist]</span>
<span class="comment-line">#set platform_list [mysqlsel $mysql_handler &#34;SELECT platform_name, platform_blade FROM platform_table WHERE platform_id = '$platform_id'&#34; -flatlist]</span>
<span class="comment-line">#set platform_name [lindex $platform_list 0]</span>
<span class="comment-line">#set blade [lindex $platform_list 1]</span>
<span class="comment-line">#</span>
<span class="comment-line">#result_debug &#34;platform_list = $platform_list&#34;</span>
<span class="comment-line">#result_debug &#34;platform_id = $platform_id&#34;</span>
<span class="comment-line">#result_debug &#34;platform_name = $platform_name&#34;</span>
<span class="comment-line">#result_debug &#34;blade = $blade&#34;</span>
<span class="comment-line">#result_debug &#34;build_name $build&#34;</span>
<span class="comment-line">#</span>
<span class="comment-line"># get build data</span>
<span class="comment-line">#set build_list [mysqlsel $mysql_handler &#34;SELECT build_minor_release, build_number FROM build_table WHERE build_id = '$build_id'&#34; -flatlist]</span>
<span class="comment-line">#result_debug &#34;build_list = $build_list&#34;</span>
<span class="comment-line">#set build_minor_release [lindex $build_list 0]</span>
<span class="comment-line">#set build_number [lindex $build_list 1]</span>
<span class="comment-line">#set build_name &#34;$build_minor_release.$build_number&#34;</span>
<span class="comment-line">#######################################################################</span>

<span class="comment-line"># get feature_id</span>
set feature_id [mysqlsel $mysql_handler &#34;SELECT feature_id FROM feature_table WHERE feature_directory = '$feature_directory' AND feature_type = '$regType' AND feature_sub_type = '$regSubType'&#34; -flatlist]
puts &#34;feature_id $feature_id for feature_directory='$feature_directory'&#34;
puts $logFileId  &#34;feature_id $feature_id for feature_directory='$feature_directory'&#34;

<span class="comment-line"># get the previous run number</span>
set run_number_test_result_list [mysqlsel $mysql_handler &#34;SELECT run_number, test_result FROM report_table WHERE regression_id = '$regId' AND feature_id = '$feature_id' ORDER BY report_id DESC LIMIT 1&#34; -flatlist]
set run_number [lindex $run_number_test_result_list 0]
set test_result [lindex $run_number_test_result_list 1]
puts &#34;Previous run_number = $run_number&#34;
puts $logFileId  &#34;Previous run_number = $run_number&#34;
puts &#34;test_result = $test_result&#34;
puts $logFileId  &#34;test_result = $test_result&#34;

<span class="comment-line"># the new run number</span>
if {($test_result == &#34;aborted&#34;) || ($test_result == &#34;NA&#34;) || ($test_result == &#34;other&#34;) } {
  set runNumber $run_number
} else {
  set runNumber [expr $run_number +1]
}

puts &#34;new runNumber = $runNumber&#34;
puts $logFileId  &#34;new runNumber = $runNumber&#34;
puts &#34;regPath = $regPath&#34;
puts $logFileId  &#34;regPath = $regPath&#34;
puts &#34;regId = $regId&#34;
puts $logFileId  &#34;regId = $regId&#34;

if { [regexp &#34;y&#34; $rerun] } {
    set tcList [<a name="::GetFailingTestsForModule(1)"><a href="./mysqlLib.tcl.html#::GetFailingTestsForModule_1316">::GetFailingTestsForModule</a></a> -regression_id $regId -feature_type $regType -feature_directory $feature_directory -host $host]
    puts $logFileId &#34;rerunning testcases: $tcList\n&#34;
    if { $tcList == &#34;all&#34; } {
	<span class="comment-line"># If rerun &#34;y&#34; is given and there are no failed testcases, there is no reason to continue. Give error msg and exit.</span>
	puts $logFileId  &#34;Rerun 'y' was given but there are no failed testcases. Exiting now.&#34;	
	<a name="::result_error(3)"><a href="./lconsoles.tcl.html#::result_error_6">::result_error</a></a> &#34;Rerun 'y' was given but there are no failed testcases. Exiting now.&#34;	
	exit
    }
}

<span class="comment-line">#set expected_duration [getExpectedDuration &#34;ASP_FUNC_STD,1&#34; &#34;11.5&#34; &#34;UDP_Forwarding&#34; \</span>
<span class="comment-line">#                                           &#34;3.2.3&#34; &#34;10.210.1.58&#34; autoweb_db \</span>
<span class="comment-line">#                                           regression_user extreme ]</span>
<span class="comment-line">#puts $logFileId &#34;expected_duration $expected_duration&#34;</span>
<span class="comment-line">#exit</span>
<span class="comment-line"># set regression status to running</span>
mysqlexec $mysql_handler &#34;UPDATE regression_table SET status='running' WHERE regression_id = '$regId'&#34;

puts &#34;\tCalling main.tcl -mode $mode -module $feature_directory -cfg $configToRunMain -comment \&#34;$comment\&#34; \
       -qId $qId -tcList \&#34;$tcList\&#34; -debugLevel $debugLevel -regPath \&#34;$regPath\&#34; -cliFlag \&#34;$cliFlag\&#34; \
       -obuild \&#34;$obuild\&#34; -moduleArg \&#34;$moduleArg\&#34; -subversion \&#34;$subversion\&#34; -efence \&#34;$efence\&#34; \
       -saveConfigPerTest \&#34;$saveConfigPerTest\&#34; -TrafficGen \&#34;$TrafficGen\&#34; -harness \&#34;$harness\&#34;&#34;
puts $logFileId  &#34;\tCalling main.tcl -mode $mode -module $feature_directory -cfg $configToRunMain -comment \&#34;$comment\&#34; \
       -qId $qId -tcList \&#34;$tcList\&#34; -debugLevel $debugLevel -regPath \&#34;$regPath\&#34; -cliFlag \&#34;$cliFlag\&#34; \
       -obuild \&#34;$obuild\&#34; -moduleArg \&#34;$moduleArg\&#34; -subversion \&#34;$subversion\&#34; -efence \&#34;$efence\&#34; \
       -saveConfigPerTest \&#34;$saveConfigPerTest\&#34; -TrafficGen \&#34;$TrafficGen\&#34; -harness \&#34;$harness\&#34;&#34;

;<span class="comment-line"># Write logs to file before starting</span>
flush $fd_res
if {[info exists mainPath]&amp;&amp;$mainPath!=&#34;&#34;} {
   set prevDir [pwd]
   cd $mainPath
   set regPath $mainPath/../Functionaltest
}
catch { exec {tclsh} ../main/main.tcl \
	-mode $mode \
	-module $feature_directory \
	-cfg $configToRunMain \
    -qId $qId \
    -comment &#34;$comment&#34; \
	-tcList &#34;$tcList&#34; \
	-debugLevel $debugLevel \
	-regPath &#34;$regPath&#34; \
	-cliFlag &#34;$cliFlag&#34; \
        -moduleArg $moduleArg \
        -obuild &#34;$obuild&#34; \
        -moduleArg &#34;$moduleArg&#34; \
        -TrafficGen &#34;$TrafficGen&#34; \
        -harness &#34;$harness&#34; \
	&gt;@stdout } result
<span class="comment-line">#result_debug &#34;main.tcl returned result: $result&#34;</span>
puts stderr $result
puts $logFileId $result
flush stderr
if {[info exists mainPath]&amp;&amp;$mainPath!=&#34;&#34;} {
   cd $prevDir
}

set isFullRun [expr ([string length $tcList]==0)]

puts &#34;\tCalling mysqlAutomate.tcl -regId $regId -module $feature_directory -isFullRun $isFullRun&#34;
puts $logFileId  &#34;\tCalling mysqlAutomate.tcl -regId $regId -module $feature_directory -isFullRun $isFullRun&#34;

set scmFlag &#34;&#34;
if {[regexp -nocase &#34;RTP|CIT&#34; $qId]} {
    set scmFlag &#34;regServer:&#34;
}

if {!$sustaining} {
    catch { exec {tclsh} ../main/mysqlAutomate.tcl \
        -regId $regId \
        -module $feature_directory \
        -obuild &#34;$obuild&#34; \
        -callLocation &#34;mysqlMain: $scmFlag&#34; \
        -isFullRun $isFullRun } \
        result
} else {
    catch { exec {tclsh} ../main/mysqlAutomate.tcl \
        -regId $regId \
        -module $feature_directory \
        -obuild &#34;$obuild&#34; \
        -callLocation &#34;mysqlMain: $scmFlag&#34; \
        -isFullRun $isFullRun \
        -sustaining $sustaining } \
        result
}
puts &#34;RESULTS OF mysqlAutomate: $result&#34;
puts $logFileId &#34;RESULTS OF mysqlAutomate: $result&#34;

<span class="comment-line"># set regression status to finished</span>
mysqlexec $mysql_handler &#34;UPDATE regression_table SET status='finished' WHERE regression_id = '$regId'&#34;
puts &#34;######################################################################&#34;
puts $logFileId  &#34;######################################################################&#34;
puts &#34;                      MYSQLMAIN.TCL FINISHED!&#34;
puts $logFileId  &#34;                      MYSQLMAIN.TCL FINISHED!&#34;
puts &#34;######################################################################&#34;
puts $logFileId  &#34;######################################################################&#34;
</pre>
<hr>
<div class="index-selector">
	<a href="index_main.html#byfilename">file name</a> 
 | 
	<a href="index_main.html#byprocname">procedure name</a> 
 | 
	<a href="index_main.html#bycall">procedure call</a> 
 | 
	<a href="index_annot_full.html">annotation</a> 

<br>
<cite>File generated 2018-06-14 at 17:09.</cite>
</div>

</body>
</html>
