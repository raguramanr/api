<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                       "http://www.w3.org/TR/html4/transitional.dtd">
<!-- Generated by TclDoc @@VERSION@@ -->
<html>
<head>
  <title>Checksum.tcl</title>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <link rel="stylesheet" type="text/css" href="default.css">
</head>
<body class="src-html">
<div class="index-selector">
<!-- index for tcl source files -->
	Index by: 
	<a href="index_main.html#Checksum.tcl">file name</a> | 
	<a href="index_main.html#byprocname">procedure name</a> | 
	<a href="index_main.html#bycall">procedure call</a> | 
	<a href="index_annot_full.html">annotation</a>

</div>
<hr>

<p><strong>Checksum.tcl</strong>&nbsp;&nbsp;<span class="filetype-link">(<a href="Checksum.tcl-annot.html">annotations</a> | <a href="Checksum.tcl.txt">original source</a>)</span>
</p>
<pre class="src-code">

 
<span class="comment-line">################################################################## </span>
<span class="comment-line"># Procedure Name: Checksum</span>
<span class="comment-line">#   </span>
<span class="comment-line"># Description: calculate the 2 bytes checksum number</span>
<span class="comment-line">#               </span>
<span class="comment-line">#     </span>
<span class="comment-line">#</span>
<span class="comment-line"># Input args:</span>
<span class="comment-line">#                rawFame - the string of the frame</span>
<span class="comment-line">#                index   - the start index to repace by the checksum number</span>
<span class="comment-line"># Output args: none</span>
<span class="comment-line"># Typical usage: </span>
<span class="comment-line">#      </span>
<span class="comment-line">#</span>
<span class="comment-line"># Category Types (SetupSwitch,GetSwitchInfo,SendTraffic,CaptureTraffic,</span>
<span class="comment-line">#                 SetupTestTool,VerifySwitchOutput,Utility,VerifyTraffic)</span>
<span class="comment-line"># Category: Utility</span>
<span class="comment-line">################################################################## </span>
<strong><a name="::::Checksum_21">proc <a href="Checksum.tcl-annot.html#::::Checksum">::::Checksum</a></a></strong> {rawFrame index} {

set lngth [llength $rawFrame];
<span class="comment-line">#puts &#34;length = $lngth&#34;;</span>
set remainder [expr $lngth % 2];
set dx 0x00;
set dy 0x00;

<span class="comment-line"># --- not even number</span>
if {$remainder != 0} {
    <span class="comment-line">#puts &#34;before data = $rawFrame&#34;;</span>
    set lg [expr $lngth - 1];
    set lvar [lindex $rawFrame $lg];
    set rawFrame [lreplace $rawFrame $lg $lg 00 $lvar]; 
}

<span class="comment-line">#puts &#34;Raw Frame before checksum = $rawFrame&#34;;</span>

<span class="comment-line"># --- all together</span>
foreach {x y} $rawFrame {
    set x1 0x$x;
    <span class="comment-line">#puts &#34;xbefore ==&gt; $dx $x1&#34;;</span>
    set d [expr $x1 + $dx];
    set dx [format 0x%x $d]; 
    <span class="comment-line">#puts &#34;xafter ==&gt; $dx $x1&#34;;</span>
    
    set y1 0x$y;
    <span class="comment-line">#puts &#34;\nybefore ==&gt; $dy $y1&#34;;</span>
    set d [expr $y1 + $dy];
    set dy [format 0x%x $d];
    <span class="comment-line">#puts &#34;\nyafter ==&gt; $dy $y1&#34;;      </span>
}

<span class="comment-line">#puts &#34;\n======&gt; $dx $dy&#34;;</span>

set tmp [expr $dx &lt;&lt; 24];
set tmp2 [format %x $tmp];
set lx [string range $tmp2 0 1];
set rx [expr $dx &gt;&gt; 8];
<span class="comment-line">#puts &#34;\n@@@ $rx $lx &#34;;</span>

set tmp [expr $dy &lt;&lt; 24];
set tmp2 [format %x $tmp];
set ly [string range $tmp2 0 1];
set ry [expr $dy &gt;&gt; 8];
<span class="comment-line">#puts &#34;\n@@@ $ry $ly &#34;;</span>

set tmpx [format %x [expr ~0x[format %x [expr 0x$lx + 0x$ry]]]];
set tmpy [format %x [expr ~0x[format %x [expr 0x$ly + 0x$rx]]]];
set x [string toupper [string range $tmpx 6 7]];
set y [string toupper [string range $tmpy 6 7]];
<span class="comment-line">#puts &#34;\n!!! =&gt; $x $y&#34;;</span>

<span class="comment-line">#puts &#34;\nRaw Frame after checksum = [lreplace $rawFrame [expr $index-1] $index $x $y]&#34;;</span>
return  [lreplace $rawFrame [expr $index-1] $index $x $y]; 
}

<span class="comment-line">################################################################## </span>
<span class="comment-line"># Procedure Name: GetICMPv6Checksum</span>
<span class="comment-line">#   </span>
<span class="comment-line"># Description: return the 2 bytes checksum number: 1's complement of the</span>
<span class="comment-line">#                 sum of the 1's complement </span>
<span class="comment-line">#               </span>
<span class="comment-line"># Input args: args</span>
<span class="comment-line"># Output args: none</span>
<span class="comment-line"># Typical usage: </span>
<span class="comment-line">#          GetICMPv6Checksum $args</span>
<span class="comment-line">#</span>
<span class="comment-line"># Category Types (SetupSwitch,GetSwitchInfo,SendTraffic,CaptureTraffic,</span>
<span class="comment-line">#                 SetupTestTool,VerifySwitchOutput,Utility,VerifyTraffic)</span>
<span class="comment-line"># Category: Utility</span>
<span class="comment-line">################################################################## </span>
<strong><a name="::::GetICMPv6Checksum_93">proc <a href="Checksum.tcl-annot.html#::::GetICMPv6Checksum">::::GetICMPv6Checksum</a></a></strong> {args} {
   <a name="::parse_args(1)"><a href="./parse_args.tcl.html#::parse_args_29">::parse_args</a></a> GetICMPv6Checksum $args {
      sourceIp      &#34;fe 80 00 00 00 00 00 00 02 a1 f1 ff fe 00 00 01&#34;
      destIp        &#34;ff 05 00 00 00 00 00 00 00 00 00 00 11 11 00 33&#34;
      group         &#34;ff 05 00 00 00 00 00 00 00 00 00 00 11 11 00 33&#34;
      type          &#34;130&#34;
      code          &#34;00&#34;
      mldReponseDelay      &#34;00 00&#34;
      parameterProbPointer &#34;00 00 00 00&#34;
      packetTooBigMTU      &#34;00 00 00 00&#34;
      echoRequestIdentifer &#34;00 00&#34;
      echoRequestSeqNum    &#34;00 00&#34;
      echoReplyIdentifer   &#34;00 00&#34;
      echoReplySeqNum      &#34;00 00&#34;
      advTypeValue         &#34;20&#34;
      ndTargetAddr         &#34;00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00&#34;
      ndType               &#34;00&#34;
      ndLength             &#34;00&#34;
      ndLinkLayerAddr      &#34;00 00 00 00 00 00&#34;
      blank                &#34;00 00 00 00&#34;
      nHeaderLength        &#34;00 00 00 18&#34;
      options              &#34;&#34;
   }

set nullCSum &#34;&#34;
switch -- $type \
      &#34;1&#34; {
      set nHeaderLength &#34;00 00 00 08&#34;
      set options $blank 
   }  &#34;2&#34; {
      set nHeaderLength &#34;00 00 00 08&#34;
      set options $packetTooBigMTU
   }  &#34;3&#34; {
      set nHeaderLength &#34;00 00 00 08&#34;
      set options $blank
   }  &#34;4&#34; {
      set nHeaderLength &#34;00 00 00 08&#34;
      set options $parameterProbPointer
   }  &#34;128&#34; {
      set nHeaderLength &#34;00 00 00 08&#34;
      set options &#34;$echoRequestIdentifer $echoRequestSeqNum&#34;
   }  &#34;129&#34; {
      set nHeaderLength &#34;00 00 00 08&#34;
      set options &#34;$echoReplyIdentifer $echoReplySeqNum&#34;
   }  &#34;130&#34; {
      set nHeaderLength &#34;00 00 00 18&#34;
      set options &#34;$mldReponseDelay $group&#34;
      set nullCSum &#34;00 00&#34;
   }  &#34;131&#34; {
      set nHeaderLength &#34;00 00 00 18&#34;
      set options &#34;$mldReponseDelay $group&#34;
      set nullCSum &#34;00 00&#34;
   }  &#34;132&#34; {
      set nHeaderLength &#34;00 00 00 18&#34;
      set options &#34;$mldReponseDelay $group&#34;
      set nullCSum &#34;00 00&#34;
   }  &#34;135&#34; {
      set nHeaderLength &#34;00 00 00 20&#34; ;<span class="comment-line"># </span>
      set options &#34;$advTypeValue $ndTargetAddr $ndType $ndLength $ndLinkLayerAddr&#34;
      set nullCSum &#34;&#34;
   }  &#34;136&#34; {
      set nHeaderLength &#34;00 00 00 20&#34; ;<span class="comment-line">#</span>
      set options &#34;$advTypeValue $ndTargetAddr $ndType $ndLength $ndLinkLayerAddr&#34;
      set nullCSum &#34;&#34;
   }  &#34;143&#34; {
      set nHeaderLength &#34;$nHeaderLength&#34; ;<span class="comment-line">#</span>
      set options &#34;$options&#34;
      set nullCSum &#34;00 00&#34;
   }  &#34;mldv2query&#34; {
      set nHeaderLength &#34;$nHeaderLength&#34;
      set options &#34;$options&#34;
      set nullCSum &#34;00 00&#34;
      set type 130
   }

set icmpNHeader &#34;00 00 00 3A&#34;
set hexType [<a name="::dectohex(1)"><a href="./ePTUtils.tcl.html#::dectohex_470">::dectohex</a></a> $type]
if {[string length $hexType] == 1} {
   set hexType &#34;0$hexType&#34;
}
set hexCode [<a name="::dectohex(2)"><a href="./ePTUtils.tcl.html#::dectohex_470">::dectohex</a></a> $code]
if {[string length $hexCode] == 1} {
   set hexCode &#34;0$hexCode&#34;
}
<span class="comment-line">#$nullCSum </span>
set tframe &#34;$sourceIp $destIp $nHeaderLength $icmpNHeader $hexType $hexCode $options&#34;

<span class="comment-line">#result_debug &#34;CheckSum Frame: $tframe&#34; </span>

set lngth [llength $tframe];
<span class="comment-line">#puts &#34;length = $lngth&#34;;</span>
set remainder [expr $lngth % 2];

<span class="comment-line"># --- not even number</span>
if {$remainder != 0} {
    <span class="comment-line">#puts &#34;before data = $rawFrame&#34;;</span>
    set lg [expr $lngth - 1];
    set lvar [lindex $tframe $lg];
    set rawFrame [lreplace $tframe $lg $lg 00 $lvar]; 
}

<span class="comment-line">#puts &#34;Raw Frame before checksum = $rawFrame&#34;;</span>

<span class="comment-line"># --- Sum all together</span>
set sumHex 0x0;
foreach {x y} $tframe {
    set d1 ${x}$y;
    set sumHex 0x[format %x [expr 0x$d1 + $sumHex]]
}

<span class="comment-line">##set sumHex [string trimleft $sumHex 0x]</span>
<span class="comment-line">##set sLength [string length $sumHex]</span>
<span class="comment-line">##set r [expr $sLength - 4]</span>
<span class="comment-line">##set s [expr $r - 1]</span>

<span class="comment-line">#2feef</span>
<span class="comment-line">##set lx [string range $sumHex 0 $s];</span>
<span class="comment-line">##set rx [string range $sumHex $r $sLength];</span>

<span class="comment-line">##set sumOnesComp [format %x [expr 0x$lx + 0x$rx]];</span>

while {$sumHex &gt; 0xFFFF} {
set sumHex [string trimleft $sumHex 0x]
set sLength [string length $sumHex]
set r [expr $sLength - 4]
set s [expr $r - 1]

<span class="comment-line">#2feef</span>
set lx [string range $sumHex 0 $s];
set rx [string range $sumHex $r $sLength];
<span class="comment-line">#result_debug &#34;0x${rx}  ==&gt;  ${lx}&#34;</span>
set sumHex 0x[format %04x [expr 0x$lx + 0x$rx]];
<span class="comment-line">#result_debug &#34;sumHex  ==&gt;  ${sumHex}&#34;</span>
set sumOnesComp [format %04x [expr 0x$lx + 0x$rx]]
<span class="comment-line">#result_debug &#34;sumOnesComp  ==&gt;  ${sumOnesComp} [format %04x [expr 0x$lx + 0x$rx]]&#34;</span>
}

<a name="::result_debug(1)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;FINAL  --&gt;  $sumOnesComp&#34;


<span class="comment-line"># Get a list of the 4 sum ones complement digits</span>
set digitList &#34;&#34;;
for {set i 0} {$i&lt;4} {incr i} {
   lappend digitList [string range $sumOnesComp $i $i ]
}
<span class="comment-line"># Get the ones complement of the ones compliment sum</span>
set checkSumList &#34;&#34;;
foreach digit $digitList {
   set digit [string toupper $digit];
   switch -- $digit \
      &#34;&#34; {
      lappend checkSumList &#34;F&#34;        
   }  &#34;0&#34; {
      lappend checkSumList &#34;F&#34;        
   }  &#34;1&#34; {
      lappend checkSumList &#34;E&#34;   
   }  &#34;2&#34; {
      lappend checkSumList &#34;D&#34;        
   }  &#34;3&#34; {
      lappend checkSumList &#34;C&#34;   
   }  &#34;4&#34; {
      lappend checkSumList &#34;B&#34;        
   }  &#34;5&#34; {
      lappend checkSumList &#34;A&#34;   
   }  &#34;6&#34; {
      lappend checkSumList &#34;9&#34;        
   }  &#34;7&#34; {     
      lappend checkSumList &#34;8&#34;   
   }  &#34;8&#34; {
      lappend checkSumList &#34;7&#34;        
   }  &#34;9&#34; {
      lappend checkSumList &#34;6&#34;   
   }  &#34;A&#34; {
      lappend checkSumList &#34;5&#34;        
   }  &#34;B&#34; {
      lappend checkSumList &#34;4&#34;   
   }  &#34;C&#34; {
      lappend checkSumList &#34;3&#34;        
   }  &#34;D&#34; {
      lappend checkSumList &#34;2&#34;   
   }  &#34;E&#34; {
      lappend checkSumList &#34;1&#34;        
   }  &#34;F&#34; {
      lappend checkSumList &#34;0&#34;   
   }  
}

set checkSum &#34;[lindex $checkSumList 0][lindex $checkSumList 1] [lindex $checkSumList 2][lindex $checkSumList 3]&#34;;
<a name="::result_debug(2)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;####### Calculated ICMPv6 Checksum: $checkSum #######&#34; 
return $checkSum;
}
</pre>
<hr>
<div class="index-selector">
	<a href="index_main.html#byfilename">file name</a> 
 | 
	<a href="index_main.html#byprocname">procedure name</a> 
 | 
	<a href="index_main.html#bycall">procedure call</a> 
 | 
	<a href="index_annot_full.html">annotation</a> 

<br>
<cite>File generated 2018-06-14 at 17:09.</cite>
</div>

</body>
</html>
