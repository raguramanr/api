<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                       "http://www.w3.org/TR/html4/transitional.dtd">
<!-- Generated by TclDoc @@VERSION@@ -->
<html>
<head>
  <title>finalRun.tcl</title>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <link rel="stylesheet" type="text/css" href="default.css">
</head>
<body class="src-html">
<div class="index-selector">
<!-- index for tcl source files -->
	Index by: 
	<a href="index_main.html#finalRun.tcl">file name</a> | 
	<a href="index_main.html#byprocname">procedure name</a> | 
	<a href="index_main.html#bycall">procedure call</a> | 
	<a href="index_annot_full.html">annotation</a>

</div>
<hr>

<p><strong>finalRun.tcl</strong>&nbsp;&nbsp;<span class="filetype-link">(<a href="finalRun.tcl-annot.html">annotations</a> | <a href="finalRun.tcl.txt">original source</a>)</span>
</p>
<pre class="src-code">
<span class="comment-line">#!/usr/bin/expect --</span>

load [lindex [glob &#34;/usr/lib/libexpect*so*&#34;] 0]

set cliPcIpaddr &#34;10.210.1.218&#34;
set routingPcIpaddr &#34;10.210.1.217&#34;
set rootDir &#34;/auto/automation&#34;
set utilDir &#34;$rootDir/Util&#34;
set reportDir &#34;$rootDir/TestReport&#34;
set totalCount 0
<span class="comment-line">#List of file names generated from initial run.</span>
set fnameList [ list &#34;Functionaltest.txt&#34; &#34;CLItest.txt&#34; &#34;Routing.txt&#34; \
               &#34;PerformanceTest.txt&#34; &#34;Benchmarktest.txt&#34; &#34;Scalabilitytest.txt&#34; \
               &#34;Stresstest.txt&#34; ]

<span class="comment-line">#***************************************************************</span>
<span class="comment-line"># This procedure will login to the specified machine, run the</span>
<span class="comment-line"># initialRun.tcl script on that machine and  then copy the report</span>
<span class="comment-line"># file (CLI or Routing) from the remote machine to local machine.</span>
<span class="comment-line"># Input : ipaddr IP address of the remote machine</span>
<span class="comment-line">#         module (CLItest for CLI and Functionaltest for Routing)</span>
<span class="comment-line"># Output : None </span>
<span class="comment-line">#****************************************************************</span>

<strong><a name="::::runRemoteReport_25">proc <a href="finalRun.tcl-annot.html#::::runRemoteReport">::::runRemoteReport</a></a></strong> { ipaddr module } {
     global  buildName
     global  utilDir
     global  reportDir

     set login  &#34;autotest-sc&#34;
     set passwd &#34;glitterpen1&#34;

     set localIp [ <a name="::getLocalIpaddr(1)"><a href="./finalRun.tcl.html#::getLocalIpaddr_182">::getLocalIpaddr</a></a> ]
     if { $localIp == 0 } {
        puts &#34;ERROR : Can't find local IP address&#34;
        exit
     }
     spawn telnet $ipaddr
     expect -nocase &#34;login:&#34;
     send   &#34;$login\r&#34;
     expect -nocase &#34;password:&#34;
     send   &#34;$passwd\r&#34;
     expect {
        -re &#34;Login incorrect&#34; {
            puts &#34;!!! Failed to login to $ipaddr&#34;
        }
        -re &#34;$login@&#34; {
            puts &#34;Login successful&#34;
        }
     }
     send &#34;cd $utilDir\r&#34; 
     expect &#34;$login@&#34;
     send &#34;tclsh initialRun.tcl $buildName\r&#34;
     expect &#34;$login@&#34;
     send &#34;chmod 777 $reportDir/$module.txt\r&#34;
     expect &#34;$login@&#34;
     if { $module == &#34;CLItest&#34; } {
        send &#34;scp $reportDir/$module.txt $localIp:$reportDir/$module.txt \r&#34;
     } else {
        send &#34;scp $reportDir/$module.txt $localIp:$reportDir/Routing.txt \r&#34;
     }
     expect {
        -re &#34;.* password&#34; { send &#34;$passwd\r&#34; }
        -re &#34;yes&#34; {
                   send &#34;yes\r&#34;
                   expect -re &#34;.* password&#34; { send &#34;$passwd\r&#34; }
         }
     }
    expect &#34;$login@&#34;
    send &#34;logout\r&#34;
}
<span class="comment-line">#********************************************************</span>
<span class="comment-line"># Procedure used to print the title of the report </span>
<span class="comment-line">#********************************************************</span>
<strong><a name="::::printTitle_75">proc <a href="finalRun.tcl-annot.html#::::printTitle">::::printTitle</a></a></strong> { fd } {
  global buildName
  puts $fd &#34;&lt;html&gt;&#34;
  puts $fd &#34;&lt;head&gt;&#34;
  puts $fd &#34;&lt;meta http-equiv=\&#34;content-type\&#34;&#34;
  puts $fd &#34;content=\&#34;text/html; charset=ISO-8859-1\&#34;&gt;&#34;
  puts $fd &#34;&lt;title&gt;&lt;/title&gt;&#34;
  puts $fd &#34;&lt;/head&gt;&#34;
  puts $fd &#34;&lt;div style=\&#34;margin-left:\&#34;&gt;&lt;span style=\&#34;font-weight: bold;\
           font-size:15.0pt;mso-bidi-font-size:16.0pt; font-family:Courier;\
           text-decoration: underline;\&#34;&gt;&#34;

  puts $fd &#34;TEST CASE COUNTING REPORT &lt;/span&gt; &lt;br&gt;&#34;
  puts $fd &#34;&lt;/div&gt;&#34;
  puts $fd &#34;&lt;br&gt;&#34;
  puts $fd &#34;&lt;span style=\&#34;font-size:10.0pt;mso-bidi-font-size:11.0pt;\
            font-family:Courier;\&#34;&gt;Build : $buildName &lt;/span&gt;&lt;br&gt;&#34;
  puts $fd &#34;&lt;span style=\&#34;font-size:9.0pt;mso-bidi-font-size:10.0pt;\
            font-family:Courier;\&#34;&gt;Date: [exec date] &lt;/span&gt;&lt;br&gt;&#34;
  puts $fd &#34;&lt;br&gt;&#34;
  puts $fd &#34;&lt;br&gt;&#34;
}

<span class="comment-line">#****************************************************************</span>
<span class="comment-line"># Procedure used to print the trailer html information of the report </span>
<span class="comment-line">#****************************************************************</span>
<strong><a name="::::printTrailor_101">proc <a href="finalRun.tcl-annot.html#::::printTrailor">::::printTrailor</a></a></strong> { fd } {
  puts $fd &#34;&lt;/div&gt;&#34;
  puts $fd &#34;&lt;/body&gt;&#34;
  puts $fd &#34;&lt;/html&gt;&#34;
}

<span class="comment-line">#*******************************************************************</span>
<span class="comment-line"># This procedure will fetch the number of test cases from the report</span>
<span class="comment-line"># file of the specific regression type. The count will be used to </span>
<span class="comment-line"># calculate grand tolal.</span>
<span class="comment-line">#</span>
<span class="comment-line"># Input : fname - report file name (Ex. Functionaltest.txt)</span>
<span class="comment-line"># Output : number of test cases run</span>
<span class="comment-line">#*******************************************************************</span>

<strong><a name="::::getTestcaseCount_116">proc <a href="finalRun.tcl-annot.html#::::getTestcaseCount">::::getTestcaseCount</a></a></strong> { fname } {
    if { [catch { set line [exec grep &#34;TOTAL NUMBER&#34; $fname] }] } {
        puts &#34;ERROR: Can't fetch total# of test cases from: $fname&#34;
        return 0
    }
    set ch &#34; = &#34;
    set length [string length $line]
    set index [string first $ch $line]
    incr index 2
    set number [string range $line $index $length]
    set number [string trim $number]
    if { ![string is integer $number] } {
        puts &#34;$fname: Can't fetch total number of test cases.&#34;
        return 0
    }
    return $number
}
<span class="comment-line">#*************************************************************</span>
<span class="comment-line"># This function will correct the header infromation for the</span>
<span class="comment-line"># routing test cases. Since the routing test cases are also</span>
<span class="comment-line"># stored in 'Functionaltest' directory, the header name which</span>
<span class="comment-line"># is generated based on direcroty name is not correct for</span>
<span class="comment-line"># routing. This function will process that file and correct</span>
<span class="comment-line"># the header information.</span>
<span class="comment-line"># Input : Routing.txt</span>
<span class="comment-line"># Output : Routing.txt</span>
<span class="comment-line">#*************************************************************</span>
<strong><a name="::::processRoutingFile_143">proc <a href="finalRun.tcl-annot.html#::::processRoutingFile">::::processRoutingFile</a></a></strong> {} {
    global reportDir

    if { [ catch { set tfd [ open &#34;$reportDir/temp.txt&#34; w+ ] } ] } {
        puts &#34;ERROR: Can't open the file temp.txt&#34;
        return;
    }
    if { [catch {set fd [ open &#34;$reportDir/Routing.txt&#34; r+ ]} ] } {
        puts &#34;ERROR: Can't open the file Routing.txt&#34;
        return;
    }

    while { [ gets $fd line ] != -1 } {  
       if { [ regsub &#34;FUNCTIONAL&#34; $line &#34;ROUTING&#34; tline ] == 1 } {
           puts $tfd $tline
       } else {
           puts $tfd $line
       }
    }
    close $tfd
    close $fd
    if { [catch { exec cp &#34;$reportDir/temp.txt&#34; &#34;$reportDir/Routing.txt&#34;} ] } {
        puts &#34;ERROR: Unable to copy temp.txt to Routing.txt&#34;
        return;
    }
    if { [catch { exec rm &#34;$reportDir/temp.txt&#34; } ] } {
        puts &#34;ERROR: Unable to delete the file temp.txt&#34;
        return;
    }
}

<span class="comment-line">#********************************************************</span>
<span class="comment-line"># This procedure is used to find the IP address of  the</span>
<span class="comment-line"># local machine.</span>
<span class="comment-line">#</span>
<span class="comment-line"># Input : None</span>
<span class="comment-line"># Output: ipaddr</span>
<span class="comment-line">#*********************************************************</span>

<strong><a name="::::getLocalIpaddr_182">proc <a href="finalRun.tcl-annot.html#::::getLocalIpaddr">::::getLocalIpaddr</a></a></strong> { } {
    set buff [ exec ifconfig eth0 ]
    set ret [ regexp {[0-9]+(.)[0-9]+(.)[0-9]+(.)[0-9]+} $buff ip]
    if { $ret == 1 } {
        puts &#34;IP of local machine = $ip&#34;
        return $ip
    } else {
        puts &#34;ERROR: Can't find ip address of local machine&#34;
        return 0
   }
}

<strong><a name="::::updateAutoweb_194">proc <a href="finalRun.tcl-annot.html#::::updateAutoweb">::::updateAutoweb</a></a></strong> { } {
   global reportDir
   set targetDir &#34;/autoweb/Http/html/wwwroot/stats/data/&#34;
   set curTime [clock seconds]
   set year  [clock format $curTime -format %Y]
   set month [clock format $curTime -format %B]
   cd $targetDir
   if { ![file isdirectory $year] }  {
      exec mkdir $year
      cd $year
      exec mkdir $month
   } else {
     cd $year
     if { ![file isdirectory $month] } {
        exec mkdir $month
     } else {
        if { ![file isdirectory &#34;$month/backup&#34;] } {
             exec mkdir &#34;$month/backup&#34;
         }
        exec cp -f &#34;$month/TestReport.html&#34; &#34;$month/backup/.&#34;
     }
  }
  append targetDir &#34;$year&#34;
  append targetDir &#34;/&#34;
  append targetDir &#34;$month&#34;
  cd $targetDir
  exec rm -rf *
  exec cp &#34;$reportDir/TestReport.html&#34; &#34;$targetDir/.&#34;
}

<strong><a name="::::printUsage_224">proc <a href="finalRun.tcl-annot.html#::::printUsage">::::printUsage</a></a></strong> {} {
     puts &#34;\r&#34;
     puts &#34;Usage: finalRun.tcl  &lt;buildNumber&gt;&#34;
     puts &#34;buildNumber: format xxxbzz Ex. 711b36&#34;
}
<span class="comment-line">#************************************************************</span>
<span class="comment-line"># Main code segment</span>
<span class="comment-line">#***********************************************************</span>
source ../main/mainLib.tcl

<a name="::::gen_index(1)"><a href="./summarize.tcl.html#::::gen_index_76">::::gen_index</a></a> &#34;./../Lib&#34;

set LIB_PATH ../Lib
lappend auto_path $LIB_PATH

if { $argc&lt;1 } {
      <a name="::printUsage(1)"><a href="./finalRun.tcl.html#::printUsage_224">::printUsage</a></a>
      exit
}
if { [lsearch $argv &#34;-help&#34;] &gt; -1} {
      <a name="::printUsage(2)"><a href="./finalRun.tcl.html#::printUsage_224">::printUsage</a></a>
      exit
}
if { [lsearch $argv &#34;?&#34;] &gt; -1} {
      <a name="::printUsage(3)"><a href="./finalRun.tcl.html#::printUsage_224">::printUsage</a></a>
      exit
}
set build [lindex $argv 0]
set buildName [getBuildNumber $build]
if { $buildName == 0 } {
    puts &#34;ERROR: Wrong build name. Build name Ex.711b16 is required!!&#34;
    exit
}

set module &#34;CLItest&#34;
<a name="::runRemoteReport(1)"><a href="./finalRun.tcl.html#::runRemoteReport_25">::runRemoteReport</a></a> $cliPcIpaddr $module

set module &#34;Functionaltest&#34;
<a name="::runRemoteReport(2)"><a href="./finalRun.tcl.html#::runRemoteReport_25">::runRemoteReport</a></a> $routingPcIpaddr $module

<a name="::processRoutingFile(1)"><a href="./finalRun.tcl.html#::processRoutingFile_143">::processRoutingFile</a></a>

cd $reportDir
if { [catch { set rfd [ open &#34;TestReport.html&#34; w ] } ] } {
    puts &#34;ERROR: Can't open the file: TestReport.html&#34;
    exit
}
<a name="::printTitle(1)"><a href="./finalRun.tcl.html#::printTitle_75">::printTitle</a></a> $rfd;
foreach fname $fnameList {
       if { [catch { set fd [ open $fname r ] } ] } {
            puts &#34;ERROR: Can't open the file: $fname&#34;
            exit
       }
       set count [ <a name="::getTestcaseCount(1)"><a href="./finalRun.tcl.html#::getTestcaseCount_116">::getTestcaseCount</a></a> $fname ]
       puts &#34;Test Cases for $fname = $count&#34;
       incr totalCount $count
       while { [ gets $fd line ] != -1 } {  
             puts $rfd $line
       }
       close $fd
}
<a name="::printTrailor(1)"><a href="./finalRun.tcl.html#::printTrailor_101">::printTrailor</a></a> $rfd

puts $rfd &#34;&lt;br&gt;&lt;br&gt;&#34;
puts $rfd &#34;&lt;div style=\&#34;margin-left:\&#34;&gt;&lt;span style=\&#34;font-weight: bold;font-size:12.0pt;mso-bidi-font-size:13.0pt; font-family:Courier;\&#34;&gt;&#34;
puts $rfd &#34;GRAND TOTAL =  $totalCount &lt;/span&gt; &lt;br&gt;&#34;
puts $rfd &#34;&lt;/div&gt;&#34;
close $rfd

<a name="::updateAutoweb(1)"><a href="./finalRun.tcl.html#::updateAutoweb_194">::updateAutoweb</a></a>

exec clear
puts &#34;\n**********************************\n&#34;
puts &#34;GRAND TOTAL = $totalCount&#34;
puts &#34;\n**********************************&#34;

</pre>
<hr>
<div class="index-selector">
	<a href="index_main.html#byfilename">file name</a> 
 | 
	<a href="index_main.html#byprocname">procedure name</a> 
 | 
	<a href="index_main.html#bycall">procedure call</a> 
 | 
	<a href="index_annot_full.html">annotation</a> 

<br>
<cite>File generated 2018-06-14 at 17:09.</cite>
</div>

</body>
</html>
