<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                       "http://www.w3.org/TR/html4/transitional.dtd">
<!-- Generated by TclDoc @@VERSION@@ -->
<html>
<head>
  <title>resource_track.tcl</title>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <link rel="stylesheet" type="text/css" href="default.css">
</head>
<body class="src-html">
<div class="index-selector">
<!-- index for tcl source files -->
	Index by: 
	<a href="index_main.html#resource_track.tcl">file name</a> | 
	<a href="index_main.html#byprocname">procedure name</a> | 
	<a href="index_main.html#bycall">procedure call</a> | 
	<a href="index_annot_full.html">annotation</a>

</div>
<hr>

<p><strong>resource_track.tcl</strong>&nbsp;&nbsp;<span class="filetype-link">(<a href="resource_track.tcl-annot.html">annotations</a> | <a href="resource_track.tcl.txt">original source</a>)</span>
</p>
<pre class="src-code">
package require mysqltcl;
<span class="comment-line">##################################################################</span>
<span class="comment-line">#</span>
<span class="comment-line">#</span>
<span class="comment-line">#</span>
<span class="comment-line">##################################################################</span>
<strong><a name="::::OpenTrackingPort_7">proc <a href="resource_track.tcl-annot.html#::::OpenTrackingPort">::::OpenTrackingPort</a></a></strong> {args} {

    package require json::write
    package require json
    package forget http 1.0
    package require http
    package require uuid
    global MAIN env

    <a name="::parse_args(1)"><a href="./parse_args.tcl.html#::parse_args_29">::parse_args</a></a> OpenTrackingPort $args {
        user &#34;null&#34;
        cfg &#34;null&#34;
        script_name &#34;null&#34;
        type &#34;script&#34;
    }

    if {![info exists MAIN(TRACKRESOURCES)] || !$MAIN(TRACKRESOURCES)} {
        return 0;
    }

    set myServerIp [<a name="::_MyServerIp(1)"><a href="./queueLib.tcl.html#::_MyServerIp_5043">::_MyServerIp</a></a>]
    set main(MYSERVERIP) $myServerIp
    set myUuid [uuid::uuid generate]
    set MAIN(uuid) $myUuid
    if {$user == &#34;null&#34;} {
        if [info exists env(USER)] {
            set myName $env(USER);
        } else {
            set myName &#34;null&#34;
        }
    } else {
        set myName $user;
    }
    set myCfg $cfg;

    set dbStatus [<a name="::RecordTracking(1)"><a href="./resource_track.tcl.html#::RecordTracking_489">::RecordTracking</a></a> -user &#34;$myName&#34; -cfg &#34;$cfg&#34; \
          -script_name &#34;$script_name&#34; -uuid &#34;$myUuid&#34; -type &#34;$type&#34; \
          -server_ip &#34;$myServerIp&#34;]

    switch -exact -- $dbStatus {
        &#34;inuse&#34; {
                puts &#34;\n\n\n$cfg In Use\n\n\n&#34;;
                if {[info exists MAIN(ENFORCETRACKING)] &amp;&amp; $MAIN(ENFORCETRACKING)} {
                    exit;
                } else {
                    puts &#34;\n\nSleeping 60 seconds so you can kill this run so it doesn't interupt resources\n&#34;
                    sleep 60
                    return 0;
                }
        }
        &#34;faildb&#34; { puts &#34;\n\nDB Reservation Connection failed. Continue\n\n&#34;; return 0;}
        &#34;reservefail&#34; { puts &#34;\n\nDB Reservation Connection failed. Continue\n\n&#34;; return 0;}
        &#34;reserved&#34; { puts &#34;\n\nDB Reserveration Entr Made. Continue\n\n&#34;;}
        default { puts &#34;\n\nNot sure what happened with the Reservation. Continue\n\n&#34;; return 0;}
    }
    package forget http
    package require http 1.0
    return 1
}
<span class="comment-line">######################################################################################</span>
<span class="comment-line">#</span>
<span class="comment-line">#</span>
<span class="comment-line">######################################################################################</span>
<strong><a name="::::TrackingCleanup_70">proc <a href="resource_track.tcl-annot.html#::::TrackingCleanup">::::TrackingCleanup</a></a></strong> {} {
    global MAIN

    if {[info exists MAIN(uuid)] &amp;&amp; [string trim $MAIN(uuid)] != &#34;&#34;} {
        set ts [clock format [clock seconds] -format &#34;%Y-%m-%d %H.%M.%S&#34;]
        <a name="::_updateTrackingDBEntry(1)"><a href="./resource_track.tcl.html#::_updateTrackingDBEntry_272">::_updateTrackingDBEntry</a></a> -where &#34;uuid = '$MAIN(uuid)'&#34; -script_name &#34;&#34; -server_ip &#34;&#34; -update_time &#34;$ts&#34; \
          -username &#34;&#34; -port &#34;&#34; -text &#34;&#34; -start_time &#34;&#34; -pause &#34;&#34; -pause_by &#34;&#34; -pause_time &#34;&#34; -uuid &#34;&#34;
    }
}
<strong><a name="::::UpdateTrackDB_79">proc <a href="resource_track.tcl-annot.html#::::UpdateTrackDB">::::UpdateTrackDB</a></a></strong> {args} {
    global MAIN
    <a name="::parse_args(2)"><a href="./parse_args.tcl.html#::parse_args_29">::parse_args</a></a> UpdateTrackDB $args {
        text &#34;none&#34;
        text2 &#34;none&#34;
        status &#34;none&#34;
        pause &#34;none&#34;
        pause_by &#34;none&#34;
        pause_time &#34;none&#34;
        qid &#34;none&#34;
        teefile &#34;none&#34;
        testcase &#34;none&#34;
    }
    <span class="comment-line"># possible args to build call with.</span>
    set uList &#34;text text2 status pause pause_by teefile qid testcase pause_time&#34;

    if {[info exists MAIN(uuid)] &amp;&amp; [string trim $MAIN(uuid)] != &#34;&#34;} {
        set ts [clock format [clock seconds] -format &#34;%Y-%m-%d %H.%M.%S&#34;]
        set myargs &#34;&#34;
        foreach lv $uList {
            if {[set $lv] != &#34;none&#34;} {
                lappend myargs -$lv
                lappend myargs &#34;[set $lv]&#34;
            }
        }
        switch -- [llength $myargs] \
            &#34;2&#34;  {
              <a name="::_updateTrackingDBEntry(2)"><a href="./resource_track.tcl.html#::_updateTrackingDBEntry_272">::_updateTrackingDBEntry</a></a> -where &#34;uuid = '$MAIN(uuid)'&#34; -update_time $ts \
                    [lindex $myargs 0] [lindex $myargs 1]
            } &#34;4&#34;  {
              <a name="::_updateTrackingDBEntry(3)"><a href="./resource_track.tcl.html#::_updateTrackingDBEntry_272">::_updateTrackingDBEntry</a></a> -where &#34;uuid = '$MAIN(uuid)'&#34; -update_time $ts \
                    [lindex $myargs 0] [lindex $myargs 1] [lindex $myargs 2] [lindex $myargs 3]
            } &#34;6&#34;  {
              <a name="::_updateTrackingDBEntry(4)"><a href="./resource_track.tcl.html#::_updateTrackingDBEntry_272">::_updateTrackingDBEntry</a></a> -where &#34;uuid = '$MAIN(uuid)'&#34; -update_time $ts \
                    [lindex $myargs 0] [lindex $myargs 1] [lindex $myargs 2] [lindex $myargs 3] \
                    [lindex $myargs 4] [lindex $myargs 5] 
            } &#34;8&#34;  {
              <a name="::_updateTrackingDBEntry(5)"><a href="./resource_track.tcl.html#::_updateTrackingDBEntry_272">::_updateTrackingDBEntry</a></a> -where &#34;uuid = '$MAIN(uuid)'&#34; -update_time $ts \
                    [lindex $myargs 0] [lindex $myargs 1] [lindex $myargs 2] [lindex $myargs 3] \
                    [lindex $myargs 4] [lindex $myargs 5] [lindex $myargs 6] [lindex $myargs 7]
            } &#34;10&#34;  {
              <a name="::_updateTrackingDBEntry(6)"><a href="./resource_track.tcl.html#::_updateTrackingDBEntry_272">::_updateTrackingDBEntry</a></a> -where &#34;uuid = '$MAIN(uuid)'&#34; -update_time $ts \
                    [lindex $myargs 0] [lindex $myargs 1] [lindex $myargs 2] [lindex $myargs 3] \
                    [lindex $myargs 4] [lindex $myargs 5] [lindex $myargs 6] [lindex $myargs 7] \
                    [lindex $myargs 8] [lindex $myargs 9]
            } &#34;12&#34;  {
              <a name="::_updateTrackingDBEntry(7)"><a href="./resource_track.tcl.html#::_updateTrackingDBEntry_272">::_updateTrackingDBEntry</a></a> -where &#34;uuid = '$MAIN(uuid)'&#34; -update_time $ts \
                    [lindex $myargs 0] [lindex $myargs 1] [lindex $myargs 2] [lindex $myargs 3] \
                    [lindex $myargs 4] [lindex $myargs 5] [lindex $myargs 6] [lindex $myargs 7] \
                    [lindex $myargs 8] [lindex $myargs 9] [lindex $myargs 10] [lindex $myargs 11]
            }
    }

}
<strong><a name="::::UpdateTrackDBTxt_133">proc <a href="resource_track.tcl-annot.html#::::UpdateTrackDBTxt">::::UpdateTrackDBTxt</a></a></strong> {txt} {
    global MAIN

    if {[info exists MAIN(uuid)] &amp;&amp; [string trim $MAIN(uuid)] != &#34;&#34;} {
        set ts [clock format [clock seconds] -format &#34;%Y-%m-%d %H.%M.%S&#34;]
        <a name="::_updateTrackingDBEntry(8)"><a href="./resource_track.tcl.html#::_updateTrackingDBEntry_272">::_updateTrackingDBEntry</a></a> -where &#34;uuid = '$MAIN(uuid)'&#34; -text &#34;$txt&#34; -update_time &#34;$ts&#34;
    }
}
<strong><a name="::::UpdateTrackDBStatus_141">proc <a href="resource_track.tcl-annot.html#::::UpdateTrackDBStatus">::::UpdateTrackDBStatus</a></a></strong> {txt} {
    global MAIN

    if {[info exists MAIN(uuid)] &amp;&amp; [string trim $MAIN(uuid)] != &#34;&#34;} {
        set ts [clock format [clock seconds] -format &#34;%Y-%m-%d %H.%M.%S&#34;]
        <a name="::_updateTrackingDBEntry(9)"><a href="./resource_track.tcl.html#::_updateTrackingDBEntry_272">::_updateTrackingDBEntry</a></a> -where &#34;uuid = '$MAIN(uuid)'&#34; -status &#34;$txt&#34; -update_time &#34;$ts&#34;
    }
}
<strong><a name="::::UpdateTrackDBLock_149">proc <a href="resource_track.tcl-annot.html#::::UpdateTrackDBLock">::::UpdateTrackDBLock</a></a></strong> {txt stat} {
    global MAIN

    if {[info exists MAIN(uuid)] &amp;&amp; [string trim $MAIN(uuid)] != &#34;&#34;} {
        set ts [clock format [clock seconds] -format &#34;%Y-%m-%d %H.%M.%S&#34;]
        <a name="::_updateTrackingDBEntry(10)"><a href="./resource_track.tcl.html#::_updateTrackingDBEntry_272">::_updateTrackingDBEntry</a></a> -where &#34;uuid = '$MAIN(uuid)'&#34; -text &#34;$txt&#34; -status &#34;$stat&#34; -update_time &#34;$ts&#34;
    }
}
<strong><a name="::::UpdateTrackDBTxt2_157">proc <a href="resource_track.tcl-annot.html#::::UpdateTrackDBTxt2">::::UpdateTrackDBTxt2</a></a></strong> {txt} {
    global MAIN

    if {[info exists MAIN(uuid)] &amp;&amp; [string trim $MAIN(uuid)] != &#34;&#34;} {
        set ts [clock format [clock seconds] -format &#34;%Y-%m-%d %H.%M.%S&#34;]
        <a name="::_updateTrackingDBEntry(11)"><a href="./resource_track.tcl.html#::_updateTrackingDBEntry_272">::_updateTrackingDBEntry</a></a> -where &#34;uuid = '$MAIN(uuid)'&#34; -text2 &#34;$txt&#34; -update_time &#34;$ts&#34;
    }
}
<strong><a name="::::_setTrackDBIssue_165">proc <a href="resource_track.tcl-annot.html#::::_setTrackDBIssue">::::_setTrackDBIssue</a></a></strong> {c} {
    global MAIN

    if {[info exists MAIN(uuid)] &amp;&amp; [string trim $MAIN(uuid)] != &#34;&#34;} {
        set ts [clock format [clock seconds] -format &#34;%Y-%m-%d %H:%M:%S&#34;]
        <a name="::_updateTrackingDBEntry(12)"><a href="./resource_track.tcl.html#::_updateTrackingDBEntry_272">::_updateTrackingDBEntry</a></a> -where &#34;cfg = '$MAIN(cfg)'&#34; -issue &#34;$c&#34; -update_time &#34;$ts&#34;
    }
}
<strong><a name="::::UpdateTrackDBPause_173">proc <a href="resource_track.tcl-annot.html#::::UpdateTrackDBPause">::::UpdateTrackDBPause</a></a></strong> {{schedule_id &#34;null&#34;}} {
    global MAIN

    if {[info exists MAIN(SCHEDULE_ID)] &amp;&amp; $MAIN(SCHEDULE_ID)&gt;0 &amp;&amp; $schedule_id == &#34;null&#34;} {
        set schedule_id $MAIN(SCHEDULE_ID)
    }

    if {[info exists MAIN(uuid)] &amp;&amp; [string trim $MAIN(uuid)] != &#34;&#34;} {
        set ts [clock format [clock seconds] -format &#34;%Y-%m-%d %H.%M.%S&#34;]
        <a name="::_updateTrackingDBEntry(13)"><a href="./resource_track.tcl.html#::_updateTrackingDBEntry_272">::_updateTrackingDBEntry</a></a> -where &#34;uuid = '$MAIN(uuid)'&#34; -pause &#34;$schedule_id&#34; -update_time &#34;$ts&#34;
    }
}
<strong><a name="::::DeleteReservation_185">proc <a href="resource_track.tcl-annot.html#::::DeleteReservation">::::DeleteReservation</a></a></strong> {} {
    global MAIN

    if {[info exists MAIN(uuid)] &amp;&amp; [string trim $MAIN(uuid)] != &#34;&#34;} {
        set ts [clock format [clock seconds] -format &#34;%Y-%m-%d %H.%M.%S&#34;]
        <a name="::_updateTrackingDBEntry(14)"><a href="./resource_track.tcl.html#::_updateTrackingDBEntry_272">::_updateTrackingDBEntry</a></a> -where &#34;uuid = '$MAIN(uuid)'&#34; -pause &#34;0&#34; -update_time &#34;$ts&#34;
    }
    if {[info exists MAIN(RESOURCE_ID)] &amp;&amp; [string trim $MAIN(RESOURCE_ID)] &gt; 0} {
        <a name="::_deleteReservation(1)"><a href="./resource_track.tcl.html#::_deleteReservation_397">::_deleteReservation</a></a>;
    }
}
<span class="comment-line">##################################################################</span>
<span class="comment-line">#</span>
<span class="comment-line">#</span>
<span class="comment-line">##################################################################</span>
<strong><a name="::::_getTrackingDBEntry_200">proc <a href="resource_track.tcl-annot.html#::::_getTrackingDBEntry">::::_getTrackingDBEntry</a></a></strong> {args} {
    global TRACKING_DB_IP MAIN
    <a name="::parse_args(3)"><a href="./parse_args.tcl.html#::parse_args_29">::parse_args</a></a> _getTrackingDBEntry $args {
        where &#34;null&#34;
        start_time &#34;none&#34;
        uuid &#34;none&#34;
        cfg  &#34;none&#34;
        script_name &#34;none&#34;
        server_ip &#34;none&#34;
        <a name="::port(1)"><a href="./ePTClient.tcl.html#::port_510">::port</a></a> &#34;none&#34;
        username &#34;none&#34;
        text &#34;none&#34;
        text2 &#34;none&#34;
        condition &#34;none&#34;
        type &#34;none&#34;
        status &#34;none&#34;
        pause &#34;none&#34;
        pause_by &#34;none&#34;
        teefile &#34;none&#34;
        testcase &#34;none&#34;
        qid &#34;none&#34;
        pause_time &#34;none&#34;
        update_time &#34;none&#34;
    }
    <span class="comment-line"># Fields in running table to gather info on</span>
    set uList &#34;start_time cfg script_name server_ip port username text text2 condition type status \
               pause pause_by teefile testcase qid pause_time update_time&#34;

    foreach lv $uList {
        if {[set $lv] != &#34;none&#34;} {
            set sel_clause [append sel_clause &#34;${lv}, &#34;]
        }
    }
    set sel_clause [string trimright $sel_clause]
    set sel_clause [string trimright $sel_clause &#34;,&#34;]

    set sel_clause2 [append sel_clause2 &#34;SELECT &#34;]
    set sel_clause2 [append sel_clause2 $sel_clause]
    set sel_clause2 [append sel_clause2 &#34; FROM running &#34;]

    if {$uuid != &#34;null&#34;} {
        set sel_clause2 [append sel_clause2 &#34; WHERE uuid = '[set uuid]'&#34;]
    } elseif {$where != &#34;null&#34;} {
        set sel_clause2 [append sel_clause2 &#34; WHERE $where &#34;]
    } else {
        return -1
    }

    if [catch {mysqlconnect -host $TRACKING_DB_IP -user regression_user -password extreme \
           -db reservation} mysql_sock] {
        puts &#34;Not using the reservation database.  Connection failed!&#34;;
        return 0;
    }

    puts &#34;\nSelect Tracking - $sel_clause2\n&#34;
    if [catch {mysqlsel $mysql_sock $sel_clause2 -flatlist} getMe] {
        puts &#34;There was a db issue selecting the record!&#34;;
        mysqlclose $mysql_sock
        return 0
    } else {
        mysqlclose $mysql_sock
        set oVal &#34;&#34;;
        foreach res $getMe {
            set oVal [string trim [lindex $res 0]]
        }
        return $oVal;
    }
}
<span class="comment-line">##################################################################</span>
<span class="comment-line">#</span>
<span class="comment-line">#</span>
<span class="comment-line">##################################################################</span>
<strong><a name="::::_updateTrackingDBEntry_272">proc <a href="resource_track.tcl-annot.html#::::_updateTrackingDBEntry">::::_updateTrackingDBEntry</a></a></strong> {args} {
    global TRACKING_DB_IP
    <a name="::parse_args(4)"><a href="./parse_args.tcl.html#::parse_args_29">::parse_args</a></a> _updateTrackingDBEntry $args {
        where &#34;null&#34;
        start_time &#34;none&#34;
        uuid &#34;none&#34;
        cfg  &#34;none&#34;
        script_name &#34;none&#34;
        server_ip &#34;none&#34;
        <a name="::port(2)"><a href="./ePTClient.tcl.html#::port_510">::port</a></a> &#34;none&#34;
        username &#34;none&#34;
        text &#34;none&#34;
        text2 &#34;none&#34;
        issue &#34;none&#34;
        type &#34;none&#34;
        status &#34;none&#34;
        pause &#34;none&#34;
        pause_by &#34;none&#34;
        teefile &#34;none&#34;
        testcase &#34;none&#34;
        qid &#34;none&#34;
        pause_time &#34;none&#34;
        update_time &#34;none&#34;
    }

    <span class="comment-line">#some cases to auto set status</span>
    if {[regexp -nocase &#34;adminlock&#34; $text]} {
        set status &#34;royalblue&#34;
    } elseif {[regexp -nocase &#34;userlock&#34; $text]} {
        set status &#34;royalblue&#34;
    } elseif {[regexp -nocase &#34;autolock&#34; $text]} {
        set status &#34;red&#34;
    } 

    <span class="comment-line"># Fields in running table to be updated if not null</span>
    set uList &#34;start_time uuid cfg script_name server_ip port username text text2 issue type status \
               pause pause_by teefile testcase qid pause_time update_time&#34;

    foreach lv $uList {
        if {[set $lv] != &#34;none&#34;} {
            set update_clause2 [append update_clause2 &#34;$lv = \'[set $lv]\', &#34;]
        }
    }
    set update_clause2 [string trimright $update_clause2]
    set update_clause2 [string trimright $update_clause2 &#34;,&#34;]

    set update_clause [append update_clause &#34;UPDATE running SET &#34;]
    set update_clause [append update_clause $update_clause2]

    if {$where != &#34;null&#34;} {
        set update_clause [append update_clause &#34; WHERE $where&#34;]
    } else {
        return -1
    }

    if [catch {mysqlconnect -host $TRACKING_DB_IP -user regression_user -password extreme \
           -db reservation} mysql_sock] {
        puts &#34;Not using the reservation database.  Connection failed!&#34;;
        return 0;
    }

    puts &#34;\nUpdate Tracking - $update_clause \n&#34;
    if [catch {mysqlexec $mysql_sock $update_clause} checkMe] {
        puts &#34;There was a db issue updating the record! $checkMe&#34;;
        mysqlclose $mysql_sock
        return 0
    } else {
        mysqlclose $mysql_sock
        return 1
    }
}
<span class="comment-line">##################################################################</span>
<span class="comment-line"># Procedure: _updateReservation</span>
<span class="comment-line">#</span>
<span class="comment-line">##################################################################</span>
<strong><a name="::::_updateReservation_347">proc <a href="resource_track.tcl-annot.html#::::_updateReservation">::::_updateReservation</a></a></strong> {args} {
    global TRACKING_DB_IP
    <a name="::parse_args(5)"><a href="./parse_args.tcl.html#::parse_args_29">::parse_args</a></a> _updateReservation $args {
        where &#34;null&#34;
        res_id  &#34;none&#34;
        username &#34;none&#34;
        request_date &#34;none&#34;
        request_duration  &#34;none&#34;
        holds_pause &#34;none&#34;
    }
    <span class="comment-line"># Fields in running table to be updated if not null</span>
    set uList &#34;res_id username request_date request_duration  holds_pause&#34;

    foreach lv $uList {
        if {[set $lv] != &#34;none&#34;} {
            set update_clause2 [append update_clause2 &#34;$lv = \&#34;[set $lv]\&#34;, &#34;]
        }
    }
    set update_clause2 [string trimright $update_clause2]
    set update_clause2 [string trimright $update_clause2 &#34;,&#34;]

    set update_clause [append update_clause &#34;update reserve set &#34;]
    set update_clause [append update_clause $update_clause2]

    if {$where != &#34;null&#34;} {
        set update_clause [append update_clause &#34;  WHERE $where &#34;]
    } else {
        return -1
    }

    if [catch {mysqlconnect -host $TRACKING_DB_IP -user regression_user -password extreme \
           -db reservation} mysql_sock] {
        puts &#34;Not using the reservation database.  Connection failed!&#34;;
        return 0;
    }

    puts &#34;\nUpdate Reservation - $update_clause \n&#34;
    if [catch {mysqlexec $mysql_sock $update_clause} checkMe] {
        puts &#34;There was a db issue updating the record!&#34;;
        mysqlclose $mysql_sock
        return 0
    } else {
        mysqlclose $mysql_sock
        return 1
    }
}
<span class="comment-line">##################################################################</span>
<span class="comment-line">#</span>
<span class="comment-line">#</span>
<span class="comment-line">##################################################################</span>
<strong><a name="::::_deleteReservation_397">proc <a href="resource_track.tcl-annot.html#::::_deleteReservation">::::_deleteReservation</a></a></strong> {args} {
    global TRACKING_DB_IP MAIN
    <a name="::parse_args(6)"><a href="./parse_args.tcl.html#::parse_args_29">::parse_args</a></a> _deleteReservation $args {
        res_id  &#34;none&#34;
    }

    if {$res_id == &#34;none&#34; &amp;&amp; [info exists MAIN(RESOURCE_ID)] &amp;&amp; $MAIN(RESOURCE_ID)&gt;0} {
        set res_id $MAIN(RESOURCE_ID)
    }

    set delete_clause [append delete_clause &#34;delete FROM reserve &#34;]
    set delete_clause [append delete_clause &#34;WHERE res_id = '$res_id' &#34;]

    if [catch {mysqlconnect -host $TRACKING_DB_IP -user regression_user -password extreme \
           -db reservation} mysql_sock] {
        puts &#34;Not using the reservation database.  Connection failed!&#34;;
        return 0;
    }

    puts &#34;\nDelete Reservation - $delete_clause \n&#34;
    if [catch {mysqlexec $mysql_sock $delete_clause} checkMe] {
        puts &#34;There was a db issue deleting the record!&#34;;
        mysqlclose $mysql_sock
        return 0
    } else {
        mysqlclose $mysql_sock
        return 1
    }

}
<span class="comment-line">##################################################################</span>
<span class="comment-line">#</span>
<span class="comment-line">#</span>
<span class="comment-line">##################################################################</span>
<strong><a name="::::CreateReservation_431">proc <a href="resource_track.tcl-annot.html#::::CreateReservation">::::CreateReservation</a></a></strong> {args} {
    <a name="::parse_args(7)"><a href="./parse_args.tcl.html#::parse_args_29">::parse_args</a></a> CreateReservation $args {
        resource_id      &#34;null&#34;
        username         &#34;nobody&#34;
        request_date     &#34;null&#34;
        request_duration &#34;1&#34;
        holds_pause      &#34;yes&#34;
    }
    global TRACKING_DB_IP MAIN mysqlIP my_db
    puts &#34;TRACKING_DB_IP $TRACKING_DB_IP&#34;

    set MAIN(SCHEDULE_ID) &#34;&#34;

    if {$resource_id == &#34;null&#34; &amp;&amp; [info exists MAIN(RESOURCE_ID)] &amp;&amp; $MAIN(RESOURCE_ID)&gt;0} {
        set resource_id $MAIN(RESOURCE_ID);
    }
    if {$request_date == &#34;null&#34;} {
        set request_date [clock format [clock seconds] -format &#34;%Y-%m-%d %H.%M.%S&#34;]
    }

    if [catch {mysqlconnect -host $TRACKING_DB_IP -user regression_user -password extreme \
                        -db reservation} mysql_sock] {
        puts &#34;Not using the reservation database.  Connection failed!&#34;;
        return -1;
    }
    set insert_clause [append insert_clause &#34;insert into reserve (res_id, &#34;]
    set insert_clause [append insert_clause &#34;username, &#34;]
    set insert_clause [append insert_clause &#34;request_date, &#34;]
    set insert_clause [append insert_clause &#34;request_duration, &#34;]
    set insert_clause [append insert_clause &#34;holds_pause)&#34;]

    set insert_clause [append insert_clause &#34;values (\&#34;$resource_id\&#34;, &#34;]
    set insert_clause [append insert_clause &#34;\&#34;$username\&#34;, &#34;]
    set insert_clause [append insert_clause &#34;\&#34;$request_date\&#34;, &#34;]
    set insert_clause [append insert_clause &#34;\&#34;$request_duration\&#34;, &#34;]
    set insert_clause [append insert_clause &#34;\&#34;$holds_pause\&#34;)&#34;]

    if [catch {mysqlexec  $mysql_sock $insert_clause} out] {
        mysqlclose $mysql_sock
        puts &#34;Failed query $insert_clause&#34;
        return 0;
    } else {
        set q &#34;SELECT schedule_id FROM reserve WHERE res_id = '$resource_id' AND request_date = '$request_date'&#34;
        if [catch {mysqlsel $mysql_sock $q -list} checkId] {
            puts &#34;There was a db issue looking for my resource id!&#34;;
        }
        foreach res $checkId {
            set MAIN(SCHEDULE_ID) [string trim [lindex $res 0]]
        }
        mysqlclose $mysql_sock
        return reserved;
    }
}
<span class="comment-line">##################################################################</span>
<span class="comment-line">#</span>
<span class="comment-line">#</span>
<span class="comment-line">#</span>
<span class="comment-line">##################################################################</span>
<strong><a name="::::RecordTracking_489">proc <a href="resource_track.tcl-annot.html#::::RecordTracking">::::RecordTracking</a></a></strong> {args} {
    <a name="::parse_args(8)"><a href="./parse_args.tcl.html#::parse_args_29">::parse_args</a></a> RecordTracking $args {
        user        &#34;null&#34;
        cfg         &#34;null&#34;
        script_name &#34;null&#34;
        server_ip   &#34;&#34;
        uuid        &#34;&#34;
        type        &#34;script&#34;
    }
    global TRACKING_DB_IP MAIN mysqlIP my_db
    puts &#34;TRACKING_DB_IP $TRACKING_DB_IP&#34;

    set legalTypes &#34;script daemon wrapper&#34;

    if {[lsearch $legalTypes $type] &lt; 0} {
        puts &#34;\n@\n@\n@\n  Illegal type passed to tracking daemon \n@\n@\n@&#34;
    }

    if [catch {mysqlconnect -host $TRACKING_DB_IP -user regression_user -password extreme \
                        -db reservation} mysql_sock] {
        puts &#34;Not using the reservation database.  Connection failed!&#34;;
        return faildb;
    }

    if {$type == &#34;script&#34;} {
        set goPlat 1
        if [catch {mysqlconnect -host $mysqlIP -user regression_user -password extreme \
                            -db $my_db} mysql_sock0] {
            puts &#34;Reg platforms db.  Connection failed!&#34;;
            set goPlat 0
        }
        if {$goPlat} {
            set q0 &#34;SELECT platform_share_list \
              FROM platform_table WHERE platform_cfg_file_name = '$cfg' &#34;
            if [catch {mysqlsel $mysql_sock0 $q0 -list} platRs] {
                puts &#34;There was a db issue looking for my platform record!&#34;;
            }
            foreach res $platRs {
                set sList [list [string trim [lindex $res 0]]]
                foreach scfg $sList {
                    set q &#34;SELECT username, script_name, server_ip, port, start_time, pause, text \
                      FROM running WHERE cfg_file_name = '$scfg' AND type = 'script'&#34;
                    if [catch {mysqlsel $mysql_sock $q -list} checkMe] {
                        puts &#34;There was a db issue looking for my record!&#34;;
                    }
                    set active 0
                    set chkShare 0
                    foreach res $checkMe {
                        set chkShare 1
                        set susername [string trim [lindex $res 0]]
                        set sscript_name [string trim [lindex $res 1]]
                        set sserver_ip [string trim [lindex $res 2]]
                        set sport [string trim [lindex $res 3]]
                        set sstart_time [string trim [lindex $res 4]]
                        set spause [string trim [lindex $res 5]]
                        set stext [string trim [lindex $res 6]]
                    }
                    if {$chkShare} {
                        <span class="comment-line"># same type is exists as we want to start. check to see if its running</span>
                        if {[string trim $sserver_ip] != &#34;&#34; &amp;&amp; [string trim $sport] != &#34;&#34;} {
                            set active [<a name="::Login_Monitor(1)"><a href="./resource_track.tcl.html#::Login_Monitor_788">::Login_Monitor</a></a> -ip $sserver_ip -port $sport -action &#34;verify&#34;]
                        }
                        if {$active} {
                            puts &#34;\n\n--------------------------------------------------------&#34;
                            puts &#34;-------          S  H  A  R  E  D          -------------&#34;
                            puts &#34;-------   T E S T   B E D   I N   U S E    -------------&#34;
                            puts &#34;--------------------------------------------------------&#34;
                            puts &#34;This test bed $scfg is in use:&#34;
                            puts &#34;User: $susername&#34;;
                            puts &#34;Running: $sscript_name&#34;;
                            puts &#34;         $stext&#34;;
                            puts &#34;Server IP Port: $sserver_ip $sport&#34;;
                            puts &#34;Locked Since: $sstart_time&#34;;
                                if {$spause &gt; 0} {
                                    puts &#34;\nThis ACTIVE Shared test bed is&#34;
                                    puts &#34;       L O C K E D  &#34;
                                    puts &#34;\nYour run will continue&#34;
                                    puts &#34;--------------------------------------------------------&#34;
                                    puts &#34;--------------------------------------------------------\n\n&#34;
                                    return reserved
                                }
                            puts &#34;--------------------------------------------------------&#34;
                            puts &#34;--------------------------------------------------------\n\n&#34;
                            return inuse
                        }
                    }
                }
            }
        }
    }

    set q &#34;SELECT uuid, username, script_name, server_ip, port, start_time, type, pause, text, res_id \
      FROM running WHERE cfg_file_name = '$cfg' &#34;
    if [catch {mysqlsel $mysql_sock $q -list} checkMe] {
        puts &#34;There was a db issue looking for my record!&#34;;
    }
    set step1 0
    set new 1
    set active 0
    set parentpause 0
    set parentexists 0
    foreach res $checkMe {
        set fuuid [string trim [lindex $res 0]]
        set fusername [string trim [lindex $res 1]]
        set fscript_name [string trim [lindex $res 2]]
        set fserver_ip [string trim [lindex $res 3]]
        set fport [string trim [lindex $res 4]]
        set fstart_time [string trim [lindex $res 5]]
        set ftype [string trim [lindex $res 6]]
        set fpause [string trim [lindex $res 7]]
        set ftext [string trim [lindex $res 8]]
        set fres_id [string trim [lindex $res 9]]
        if {($ftype == &#34;daemon&#34; || $ftype == &#34;wrapper&#34;)} {
            set parentexists 1
        }
        if {($ftype == &#34;daemon&#34; || $ftype == &#34;wrapper&#34;) &amp;&amp; $fpause &gt; 0} {
            set parentpause 1
        }
        if {$type == $ftype} {
            set step1 1
            set new   0
            set duuid $fuuid
            set dusername $fusername
            set dscript_name $fscript_name
            set dserver_ip $fserver_ip
            set dport $fport
            set dstart_time $fstart_time
            set dtype $ftype
            set dpause $fpause
            set dtext $ftext
            set dres_id $fres_id
        }
    }

    if {$step1} {
        <span class="comment-line"># same type is exists as we want to start. check to see if its running</span>
        if {[string trim $dserver_ip] != &#34;&#34; &amp;&amp; [string trim $dport] != &#34;&#34;} {
            set active [<a name="::Login_Monitor(2)"><a href="./resource_track.tcl.html#::Login_Monitor_788">::Login_Monitor</a></a> -ip $dserver_ip -port $dport -action &#34;verify&#34;]
        }
        if {[string trim $duuid] == &#34;&#34;} {
            set active 0
        }
        if {$active} {
            puts &#34;\n\n--------------------------------------------------------&#34;
            puts &#34;-------   T E S T   B E D   I N   U S E    -------------&#34;
            puts &#34;--------------------------------------------------------&#34;
            puts &#34;This test bed $cfg is in use:&#34;
            puts &#34;User: $dusername&#34;;
            puts &#34;Running: $dscript_name&#34;;
            puts &#34;         $dtext&#34;;
            puts &#34;Server IP Port: $dserver_ip $dport&#34;;
            puts &#34;Locked Since: $dstart_time&#34;;

            if {$dpause &gt; 0} {
                puts &#34;\nThis ACTIVE test bed&#34;
                puts &#34;       L O C K E D  &#34;
                puts &#34;\nYour run will continue&#34;
                puts &#34;--------------------------------------------------------&#34;
                puts &#34;--------------------------------------------------------\n\n&#34;
                return reserved
            }

            puts &#34;--------------------------------------------------------&#34;
            puts &#34;--------------------------------------------------------\n\n&#34;
            return inuse
        }
        set MAIN(TRACKINGSTARTTIME) [clock format [clock seconds] -format &#34;%Y-%m-%d %H.%M.%S&#34;]
        set try 1
        set sockSuccess 0
        while {$try &lt; 4} {
            set MAIN(tport) [expr 10000 + [expr {int(rand()*50000)}]]
            if {[catch {socket -server on_connect_track $MAIN(tport)} why]} {
                puts &#34;Failed to open Socket server on socket $MAIN(tport)&#34;
            } else {
                set sockSuccess 1
                break;
            }
            incr try
        }
        if {$sockSuccess} {
            set res [<a name="::_updateTrackingDBEntry(15)"><a href="./resource_track.tcl.html#::_updateTrackingDBEntry_272">::_updateTrackingDBEntry</a></a> -where &#34;cfg_file_name = '$cfg' AND type = '$type'&#34; \
                  -script_name &#34;$script_name&#34; -server_ip &#34;$server_ip&#34; -uuid &#34;$uuid&#34; \
                  -start_time &#34;$MAIN(TRACKINGSTARTTIME)&#34; \
                  -port &#34;$MAIN(tport)&#34; -username &#34;$user&#34; -text &#34;Initial start&#34; -type &#34;$type&#34;]
            if {$res} {
                set MAIN(RESOURCE_ID) $dres_id
                return &#34;reserved&#34;
            } else {
                return &#34;reservefail&#34;
            }
        }
    }


    if {$new} {
        set MAIN(TRACKINGSTARTTIME) [clock format [clock seconds] -format &#34;%Y-%m-%d %H.%M.%S&#34;]
        set try 1
        set sockSuccess 0
        while {$try &lt; 4} {
            set MAIN(tport) [expr 10000 + [expr {int(rand()*50000)}]]
            if {[catch {socket -server on_connect_track $MAIN(tport)} why]} {
                puts &#34;Failed to open Socket server on socket $MAIN(tport) $why&#34;
            } else {
                set sockSuccess 1
                break;
            }
            incr try
        }

        if {$sockSuccess} {
            set insert_clause [append insert_clause &#34;insert into running (start_time, &#34;]
            set insert_clause [append insert_clause &#34;cfg_file_name, &#34;]
            set insert_clause [append insert_clause &#34;uuid, &#34;]
            set insert_clause [append insert_clause &#34;server_ip, &#34;]
            set insert_clause [append insert_clause &#34;port, &#34;]
            set insert_clause [append insert_clause &#34;username, &#34;]
            set insert_clause [append insert_clause &#34;script_name, &#34;]
            set insert_clause [append insert_clause &#34;text, &#34;]
            set insert_clause [append insert_clause &#34;type)&#34;]

            set insert_clause [append insert_clause &#34;values (\&#34;$MAIN(TRACKINGSTARTTIME)\&#34;, &#34;]
            set insert_clause [append insert_clause &#34;\&#34;$cfg\&#34;, &#34;]
            set insert_clause [append insert_clause &#34;\&#34;$uuid\&#34;, &#34;]
            set insert_clause [append insert_clause &#34;\&#34;$server_ip\&#34;, &#34;]
            set insert_clause [append insert_clause &#34;\&#34;$MAIN(tport)\&#34;, &#34;]
            set insert_clause [append insert_clause &#34;\&#34;$user\&#34;, &#34;]
            set insert_clause [append insert_clause &#34;\&#34;$script_name\&#34;, &#34;]
            set insert_clause [append insert_clause &#34;\&#34;Initial Start\&#34;, &#34;]
            set insert_clause [append insert_clause &#34;\&#34;$type\&#34;)&#34;]

            if [catch {mysqlexec  $mysql_sock $insert_clause} out] {
                mysqlclose $mysql_sock
                return reservefail;
            } else {
                set q &#34;SELECT res_id FROM running WHERE uuid = '$uuid' &#34;
                if [catch {mysqlsel $mysql_sock $q -list} checkId] {
                    puts &#34;There was a db issue looking for my resource id!&#34;;
                }
                foreach res $checkId {
                    set MAIN(RESOURCE_ID) [string trim [lindex $res 0]]
                }
                mysqlclose $mysql_sock
                return reserved;
            }
        } else {
            return reservefail;
        }
    }
}
<span class="comment-line">###########################################################################</span>
<span class="comment-line">#</span>
<span class="comment-line">#</span>
<span class="comment-line">###########################################################################</span>
<strong><a name="::::on_connect_track_742">proc <a href="resource_track.tcl-annot.html#::::on_connect_track">::::on_connect_track</a></a></strong> {newsock clientAddress clientPort} {
    global MAIN

    if {![info exists MAIN(TRACKINGSTARTTIME)]} {
        set MAIN(TRACKINGSTARTTIME) &#34;&#34;
    }

    set initsend &#34;ACTIVE: $MAIN(TRACKINGSTARTTIME) You are $clientAddress on port $clientPort. Socket is $newsock&#34;
    set mySock $newsock
    fconfigure $newsock -blocking 0 -buffering line
    puts $newsock &#34;$initsend&#34;
    fileevent  $newsock readable {}
}
<strong><a name="::::_checkPidAlive_755">proc <a href="resource_track.tcl-annot.html#::::_checkPidAlive">::::_checkPidAlive</a></a></strong> {p {action &#34;quit&#34;}} {
    global MAIN
    set psLine [catch {exec ps -p $p | egrep -e &#34;$p&#34; | grep -v grep} psout]
    <span class="comment-line">#puts &#34;the psLine $psLine and configFile $configFile&#34;</span>
    if {[lindex $psout 0] == $p} {
        puts &#34;\n!!\n!!\n!!\n!!\n!!\nHit pid $p\n!!\n!!\n!!\n!!\n!!&#34;;
        return 1;
    } else {
        puts &#34;\n!!\n!!\n!!\n!!\n!!\nMISSED MISSED MISSED  pid $p\n!!\n!!\n!!\n!!\n!!&#34;;
        if {$action == &#34;quit&#34;} {
            catch {<a name="::handleOutput(1)"><a href="./semaphore.tcl.html#::handleOutput_211">::handleOutput</a></a> $MAIN(sPipe) &#34;Kill&#34;} why
            exit;
        } else {
            return 0
        }
    }
}

<strong><a name="::::_kill_my_monitor_773">proc <a href="resource_track.tcl-annot.html#::::_kill_my_monitor">::::_kill_my_monitor</a></a></strong> {uuid} {
    set psLine [catch {exec ps -eafwww | egrep -e &#34;$uuid&#34; | grep -v grep} psout]
    if {[regexp -nocase {[0-9]+} [lindex $psout 1]]} {
        set retValue [catch {exec kill -9 [lindex $psout 1]}]
        set cmd1 &#34;wait [lindex $psout 1]&#34;
        set outpid1 [catch &#34;$cmd1&#34; reason1]
        if {$outpid1} {
            puts &#34;Failed to wait for child return: $reason1\n&#34;
        }
        if {$retValue==0} {
            puts &#34;Failed to kill monitor daemon&#34;
        }        
    }
}

<strong><a name="::::Login_Monitor_788">proc <a href="resource_track.tcl-annot.html#::::Login_Monitor">::::Login_Monitor</a></a></strong> {args} {
    global MAIN connectionTimeout
    <a name="::parse_args(9)"><a href="./parse_args.tcl.html#::parse_args_29">::parse_args</a></a> spawn_tracker $args {
        <a name="::ip(1)"><a href="./ePTClient.tcl.html#::ip_974">::ip</a></a>      &#34;null&#34;
        <a name="::port(3)"><a href="./ePTClient.tcl.html#::port_510">::port</a></a>    &#34;null&#34;
        action  &#34;verify&#34;
    }

    if {![info exists connectionTimeout]} {
        set connectionTimeout 90;
    }
    set addr &#34;$ip $port&#34;
    set cmd &#34;spawn telnet $addr&#34;
    if [catch &#34;$cmd&#34; rea] {
        puts &#34;Could not connect to monitor daemon via $cmd - $rea\n&#34;
        if {[regexp &#34;ACTIVE:&#34; $rea]} {
            puts &#34;ACTIVE:&#34;
            return 1;
        }
        return 0
    }
    set timeout 2
    puts &#34;Login_Monitor  $ip $port $action,  pid=$spawn_id&#34;
    expect {
        -re &#34;ACTIVE:&#34;  {
             catch {close -i $spawn_id} r
             set timeout $connectionTimeout
             return 1
        }
        -re &#34;Connection refused&#34; {
             catch {close -i $spawn_id} r
             set timeout $connectionTimeout
             return 0
        }
        timeout {
             catch {close -i $spawn_id} r
             set timeout $connectionTimeout
             return 1
        }
    }
}
</pre>
<hr>
<div class="index-selector">
	<a href="index_main.html#byfilename">file name</a> 
 | 
	<a href="index_main.html#byprocname">procedure name</a> 
 | 
	<a href="index_main.html#bycall">procedure call</a> 
 | 
	<a href="index_annot_full.html">annotation</a> 

<br>
<cite>File generated 2018-06-14 at 17:09.</cite>
</div>

</body>
</html>
