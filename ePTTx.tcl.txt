##################################################################
# $RCSfile: ixiaTx.tcl,v $ - SQA Library
#
# Copyright (c) 1999 by Extreme Networks Inc.
# 
# Revision control history
# ------------------------
# $Header: /export/cvsroot/automation/Lib/ixiaTx.tcl,v 2.25.6.33 2010/08/24 01:39:53 ghundertmark Exp $
#
# Extreme Networks modification history
# -------------------------------------
# $Log: ixiaTx.tcl,v $
# Revision 2.25.6.33  2010/08/24 01:39:53  ghundertmark
# Merge branch 12_4 to trunk
#
# Revision 2.25.6.33  2010/08/24 01:39:53  ghundertmark
# Merge branch 12_4 to trunk
#
# Revision 2.25.6.32  2009/07/07 22:39:03  lagrawal
# removed extra empty line causing issue in some procs
#
# Revision 2.25.6.31.2.4  2010/08/19 02:22:09  ghundertmark
# Local changes on NAS branch
#
# Revision 2.25.6.31.2.3  2010/06/16 05:37:28  nellinivasu
# udfRepeat default value is set to 1.
#
# Revision 2.25.6.31.2.2  2010/05/26 06:00:59  anarayanan
# udfOffset parameter added for CFM frame support
#
# Revision 2.25.6.31.2.1  2009/07/07 22:37:06  lagrawal
# removed extra empty line causing issue in some procs
#
# Revision 2.25.6.31  2009/07/01 10:55:42  nellinivasu
# Merged From Branch 'branch-dev_v12-1-rel4'
#
# Revision 2.25.6.30  2009/06/10 19:18:36  jramarao
# ixCheckLinkState commented as few ixia version show issues with kLinkState
#
# Revision 2.25.6.29  2009/06/05 00:25:09  jramarao
# Merged from DEV after May 26 2009
#
# Revision 2.25.6.28  2009/05/01 18:06:54  lagrawal
# merge from dev
#
# Revision 2.25.6.27  2009/04/14 00:46:07  lagrawal
# merge from dev branch
# Revision 2.25.6.26.14.4  2009/04/27 04:07:39  jramarao
# writeConfigToHardware corrected with one more argument to avoid bgp related issues where protocol server is stopping
# Revision 2.25.6.26.14.3  2009/04/10 19:16:30  jramarao
# added delay after writeConfigToHardware to avoid timing issue
#
# Revision 2.25.6.26.18.1  2009/02/17 21:42:41  ghundertmark
# add protocolTag to enable 88a8 in the ethertype offset.
#
# Revision 2.25.6.26  2008/01/04 00:38:45  achilukuri
# zero port stats based on the condition as this will get the correct tx-rx pkts
#
# Revision 2.25.6.25  2007/04/30 11:26:19  ghundertmark
# Add percentage to the formatting of frame info displayed
#
# Revision 2.25.6.24  2006/12/05 04:27:51  smohanty
# Added debug statements and code to reconfigure ixia port Mac address if it
# fails at the 1st attempt.
#
# Revision 2.25.6.23  2006/11/14 04:53:15  dsuk
# Q2FY07 11.5 Phase 2 Merge
#
# Revision 2.25.6.22.2.1  2006/11/01 22:33:07  dsuk
# added frameSizeMIN and frameSizeMAX arguments
#
# Revision 2.25.6.22  2006/09/29 22:38:16  djain
# Commit for Release Q1FY07-Rel11.4
#
# Revision 2.25.6.21  2006/08/01 04:19:57  nellinivasu
# Removed port ownership code in proc IxiaPortsInit
#
# Revision 2.25.6.20  2006/07/26 12:47:45  nellinivasu
# Modified proc IxiaPortsInit to take port ownership and added proc IxiaPortsClear.
#
# Revision 2.25.6.19  2006/07/19 17:41:20  smohanty
# Merged from exos-br-11_4 for protocol enable field configuration
#
# Revision 2.25.6.18.2.1  2006/07/19 17:39:34  smohanty
# Workaround introduced to disable protocolOffset Field unless it is specifically
# configured to be enabled
#
# Revision 2.25.6.18  2006/06/30 22:35:35  ghundertmark
# Q4FY06 Release commit
#
# Revision 2.25.6.17  2006/05/30 05:41:02  nellinivasu
# Changes made to debug ixia transmission problem.
#
# Revision 2.25.6.16  2006/05/29 13:19:31  nellinivasu
# Changes made to debug ixia transmission problem.
#
# Revision 2.25.6.15  2006/05/11 01:48:10  skumar
# Added support for fiber port on stx4 cards, PD3-62599768
#
# Revision 2.25.6.14  2006/04/15 00:25:27  skumar
# Use lsort in -dict
#
# Revision 2.25.6.13.2.2  2006/05/12 02:14:55  smohanty
# Supported Generation of QinQ (double tag) packets from ixia
#
# Revision 2.25.6.13.2.1  2006/04/17 22:57:27  smohanty
# Added debug information to the Tx Arp packets from IXIA
#
# Revision 2.25.6.13  2006/02/03 09:41:51  nellinivasu
# Modified the proc EnableFlowControl
#
# Revision 2.25.6.12  2006/01/30 21:23:11  igokhale
# merged from branch11_1 with Nanda's changes
#
# Revision 2.25.6.11  2005/12/21 22:24:18  smohanty
# Commit for Release 12
#
# Revision 2.25.6.10  2005/11/30 02:28:01  skumar
# Updates w/ decideLoopCount calls
#
# Revision 2.25.6.9.4.2  2005/10/12 01:51:38  skumar
# Fix wrong spelling in couint
#
# Revision 2.25.6.9.4.1  2005/10/12 00:43:57  skumar
# Added workaround for > 16Mil pkt count
#
# Revision 2.25.6.9.4.2  2005/10/12 01:51:38  skumar
# Fix wrong spelling in couint
#
# Revision 2.25.6.9.4.1  2005/10/12 00:43:57  skumar
# Added workaround for > 16Mil pkt count
#
# Revision 2.25.6.9.4.4  2005/12/23 10:28:48  nellinivasu
# Removed Proc's EnableAsymmetricFlowControl and EnableSymmetricFlowControl and instead added a proc EnableFlowControl
#
# Revision 2.25.6.9.4.3  2005/12/23 10:22:27  nellinivasu
#
#  Added proc's EnableSymmetricFlowControl,EnableAsymmetricFlowControl
#
# Revision 2.25.6.9.4.2  2005/10/12 01:51:38  skumar
# Fix wrong spelling in couint
#
# Revision 2.25.6.9.4.1  2005/10/12 00:43:57  skumar
# Added workaround for > 16Mil pkt count
#
# Revision 2.25.6.9  2005/09/16 02:05:11  skumar
# Added dontTx arg. Default 0. Used for ONLY stream config
#
# Revision 2.25.6.8  2005/07/09 01:12:47  skumar
# Clear ownership if any
#
# Revision 2.25.6.7  2004/11/09 23:02:27  mverma
# Reverting back the file as the local changed got checked in accidently
#
# Revision 2.25.6.5  2004/09/30 00:59:26  mverma
# Exos Rel7 check in.
#
# Revision 2.25.6.4.2.1  2004/09/08 00:31:32  skumar
# Added more support for ACL tests
#
# Revision 2.25.6.4  2004/07/28 19:45:05  skumar
# Use udf defn
#
# Revision 2.25.6.3  2004/06/16 20:09:52  cshaw
# merge from main trunk again for ixOS3.70 stuff
#
# Revision 2.36  2003/12/18 02:54:54  skumar
# Stop transmit during factory default set
#
# Revision 2.35  2003/12/17 19:01:05  skumar
# Merge from br-1-10 because need to set ixia ports to default
#
# Revision 2.25.6.2  2003/11/24 06:02:13  dchan
# trunk-exos release 3
#
# Revision 2.25.6.1.6.3  2003/11/10 20:38:45  skumar
# Set the default portId mac.
#
# Revision 2.25.6.1.6.2  2003/11/10 19:57:57  skumar
# Port setFactory default to avoid left over config mess up the regression
#
# Revision 2.25.6.1.6.1  2003/11/04 21:15:26  cshaw
# unsymmetric tagging
#
# Revision 2.25.6.1  2003/08/20 03:20:05  cshaw
# trunk-exos release
#
# Revision 2.25.4.2  2003/08/14 00:47:49  cshaw
# Merged in trunk for 3.65 related changes
#
# Revision 2.31  2003/07/25 18:02:58  cshaw
# Merged from br-1-6
#
# Revision 2.30.6.1  2003/07/19 21:40:38  skumar
# Changed calls to support ix 3.65, removed deprecated calls.
#
# Revision 2.25.4.1  2003/06/23 21:28:45  cshaw
# Merged in EW trunk
#
# Revision 2.30  2003/04/18 19:37:09  autotest
# Changes as taken from br-1-3.
#
# Revision 2.29.8.1  2003/03/25 01:14:31  cshaw
# Fix ixiaConf-2ports: Sending traffic, whether it's 1-way or 2-way, first port is always the src port and the second port is always the dest port in an entry in the one2one array
#
# Revision 2.29  2002/12/10 22:51:42  skumar
# Merged from br-1-0.
#
# Revision 2.28.4.1  2002/11/07 19:22:01  tquach
# make it work with biSendFrame
#
# Revision 2.28  2002/08/21 22:46:19  tquach
# Should clear the tx port only - not the whole card
#
# Revision 2.27  2002/07/31 17:30:06  skumar
# Proc headers, optimize ixStartCapture.
#
# Revision 2.26  2002/07/19 00:32:20  skumar
# Change ixStartPortCapture to ixStartCapture.
#
# Revision 2.25  2002/05/30 00:41:42  skumar
# Remove cleanUp to avoid probs in tcl8.3.
#
# Revision 2.24  2002/05/06 21:34:54  aleu
# remove all cardSpeed global var
#
# Revision 2.23  2002/04/24 21:31:38  aleu
# check ixiaPortPerCard card by card due to TXS8 addition (different card types for 10/100 speed)
#
# Revision 2.22  2002/03/28 18:25:00  skumar
# Fix dependency on startCardNum.
#
# Revision 2.21  2001/06/18 21:59:30  Autotest
# Add tagpriority
#
# Revision 2.20  2001/06/10 01:42:43  skumar
# Refreshed function ixiaConf_groupPorts. overall cleanup.
#
# Revision 2.19  2001/05/31 18:45:58  aleu
# added "protocol setDefault" in ixiaConf_2Ports
#
# Revision 2.18  2001/01/23 04:01:28  tnguyen
# Fix ixia 3.1 version  for pattern option to work
#
# Revision 2.17  2000/11/03 22:43:36  tnguyen
# Add new init function to replace the old one
#
# Revision 2.16  2000/09/25 18:28:41  tnguyen
# Remove 2portsNum_adjust,
# call capturing only on Tx and Rx ports instead of all cards
#
# Revision 2.14  2000/08/04 18:27:56  jfan
# Fix a bug: Do ixiaCheckTxDone only if the streamType is "stopStream"
#
# Revision 2.13  2000/06/29 23:06:05  tnguyen
# Add ramdom size packet option
#
# Revision 2.12  2000/05/17 00:41:45  tnguyen
# Add option to return data frames instead writing to a file
#
# Revision 2.11  2000/04/28 17:26:11  jlequang
# Fist stage of incorporating old BD-extension to Thanh's
# new enhancement.
#
# Revision 2.10  2000/04/07 00:23:48  tnguyen
# Various modifications to the whole project in Lib, L2 and L3.  Commit changes for all these folders at the same time.
#
# Revision 2.9  2000/01/07 00:01:14  jfan
# Mofify for different speed Ixia port number conversion
#
# Revision 2.8  1999/10/27 21:58:59  jfan
# Modify IxiaTx functions as interface changed.  Replace "Input" dir to "Exp" dir.  Replace "Tmp\in_xxx" to "Tmp_tmp_xxx"
#
# Revision 2.7  1999/10/13 00:11:11  jfan
# Bug fix
#
# Revision 2.6  1999/10/11 16:14:32  jfan
# Modify program fir IxiaCardSpeed & IxiaStartingCardNumber options
#
# Revision 2.5  1999/09/16 23:50:06  jfan
# Modify initialization.  Delete L3 part
#
# Revision 2.4  1999/08/12 20:36:32  aedem
# Changed the parse args function from ixiaConf_txFromAPort_arp to ixiaConf_txFromAPort_ip in the ixiaConf_txFromAPort_ip function
#
# Revision 2.3  1999/08/10 18:14:17  jfan
# Updated for L3
#
# Revision 2.2  1999/07/23 23:24:49  aedem
# Removed load line
#
# Revision 2.1  1999/07/23 14:50:24  aedem
# Merge for 2.0
#
# Revision 1.1.1.1.2.5  1999/07/23 21:12:54  aedem
# Clean-up for Merge
#
# Revision 1.1.1.1.2.4  1999/07/23 18:40:14  aedem
# Updated to use the new result formatting functions
#
# Revision 1.1.1.1.2.3  1999/07/14 15:46:11  aedem
# *** empty log message ***
#
# Revision 1.1.1.1.2.2  1999/06/30 09:33:20  aedem
# Removed timestamp information when generating packets.
#
# Revision 1.1.1.1.2.1  1999/06/28 10:02:52  aedem
# Call "stream write ..." aftwer "stream set ..."
#
# Revision 1.1.1.1  1999/06/25 17:53:46  jfan
# Initial import.
#
#
##################################################################

################################################################## 
# Procedure Name: IxiaPortsInit
#   
# Description: proc that initializez all ixia ports for auto neg, protocol servers, mac address etc.
#
#
# Input args: none
# Output args: none
# Typical usage:
#             IxiaPortsInit
#
# Category Types (Setup,GetSwitchInfo,SendTraffic,CaptureTraffic,VerifySwitchOutput
#                          VerifyTraffic)
# Category: Setup
##################################################################
proc IxiaPortsInit {} {
if { 0 } { 
global portMappingList
puts "enter into IxiaPortsInit ----"    
#   globalSetDefault
puts "exit into IxiaPortsInit ----"    
global phyMode

   set TxRxPortList {}
   set ind 0
   foreach port $portMappingList {
     set portId [lindex $port 0]
puts "enter into IxiaPortsInit ----"    
 MapIxiaPortId $portId chid c p	 
     result_debug "Setting portId $portId to factory defaults..."
   ### port setFactoryDefaults $chid $c $p
    #------work around solution from ixia added to automation--- prasanna
    #if [port isValidFeature $chid $c $p portFeatureLocalCPU]  {
    #   if [portCpu reset $chid $c $p] {
    #      ixPuts $::ixErrorInfo
#	} 

 #   ixPuts "$chid:$c:$p has been reset"
  #  }
    #####--- end of work around solution############
     if {[info exists phyMode]} {
        if {[llength $phyMode]==1} {
           if {[regexp -nocase "fiber" $phyMode]} {
              port setPhyMode $::portPhyModeFiber $chid $c $p
           }
        } else {
           set portIdPhyMode [lindex [lindex $phyMode $ind] 1]
           if {[regexp -nocase "fiber" $portIdPhyMode]} {
              port setPhyMode $::portPhyModeFiber $chid $c $p
           } else {
              port setPhyMode $::portPhyModeCopper $chid $c $p
           }
        }
     }
     StopPortsTransmit $portId  ;# setFactoryDefaults dont stop the xmit.
     if {[ixPortClearOwnership $chid $c $p force]!=0} {
        result_error "Can not clear ixia port ownership:$chid $c $p"
     }
     set retVal1 [port config -MacAddress [GetPortIdMac $portId]]
     result_debug "Port Mac address config retVal is $retVal1."
     set retVal2 [port set $chid $c $p]
     result_debug "Port Mac address set retVal is $retVal2."
     set retVal3 [port write $chid $c $p]
     result_debug "Port Mac address write retVal is $retVal3."
     if {($retVal2 != 0) || ($retVal3 != 0)} {
        set retVal1 [port config -MacAddress [GetPortIdMac $portId]]
        result_debug "Port Mac address config retVal is $retVal1."
        set retVal2 [port set $chid $c $p]
        result_debug "Port Mac address set retVal is $retVal2."
        set retVal3 [port write $chid $c $p]
        result_debug "Port Mac address write retVal is $retVal3."
     }
     if {($retVal2 != 0) || ($retVal3 != 0)} {
        port setFactoryDefaults $chid $c $p
        set retVal1 [port config -MacAddress [GetPortIdMac $portId]]
        result_debug "Port Mac address config retVal is $retVal1."
        set retVal2 [port set $chid $c $p]
        result_debug "Port Mac address set retVal is $retVal2."
        set retVal3 [port write $chid $c $p]
        result_debug "Port Mac address write retVal is $retVal3."
     }
     incr ind
   }

#   ixiaGenMap $numIxiaCd $startCardNum "standard" "2Way" $chid

   # Make sure link is up
   if [ixInitLinks one2oneArray $TxRxPortList] {
#      cleanUp
   }
}
      return 1
}

################################################################## 
# Procedure Name: ixiaConf_groupPorts
#   
# Description:
# Ixia control - for a group of ports, normally used to send mac frames in a group of ports
#        Called from SendFrameFromMultiplePorts.
#
#
# Input args:
#      numIxiaCd :		Number of Ixia cards involved (1-16)
#	   startCardNum :	Starting Ixia card slot number (1-16)
#      ixMapOption :	Standard or customized Ixia mapping
#                       For customized mapping, new program may need to
#                       be added in ixiaGenMap in ixiaMisc.tcl
#      direction :		uni-direction (1Way) or bi-direction (2Way)
#      numFrames :		Number of frames to send per Ixia port
#      frameSize :		Frame size
#      dataPattern :	Packet data pattern 
#      streamType :		advance, contBurst, contPacket, firstLoopCount,
#						gotofirst, stopStream (Note: see Ixia manual)
#      patternOffset :	For "filterPallette" (Note: see Ixia manual)
#      fcsError :		good, alignErr, bad, dribbleErr, none
#						(Note: see Ixia manual)
#      wTag :			With Tag (true, false)
#	   tagNo :			Tag number
#      priority :		Priority for the packet
#      protocol :		mac, ip, ipx
#      saMode :			contDecrement, contIncrement, ctrRandom,
#						decrement, idle, increment (Note: see Ixia manual)
#      daMode :			contDecrement, contIncrement, ctrRandom,
#						decrement, idle, increment (Note: see Ixia manual)
#      percentage :		For TX speed - Percentage of the line rate
#      sendLearn :		To send learning frames? (true, false)
#      numLearnFrames :	Number of the learning frames
#      chid :			Ixia chassis id
#      applyFilter: Flag to indicate if the filter/filterPallette to be applied in ixia reciving ports

# Output args: none
# Typical usage:
#  ixiaConf_groupPorts -numIxiaCd $numIxiaCd  -startCardNum $startCardNum \
#                       -sendLearn $sendLearn -applyFilter $applyFilter -protocol $protocol \
#                       -numFrames $numFrames -frameSize $frameSize -frameSizeType $frameSizeType \
#                       -dataPattern $dataPattern -streamType $streamType -fcsError $fcsError \
#                       -saMode $saMode -daMode $daMode \
#                       -percentage $percentage -wTag $wTag -tagNo $tag
#
#
# Category Types (Setup,GetSwitchInfo,SendTraffic,CaptureTraffic,VerifySwitchOutput
#                          VerifyTraffic)
# Category: SendTraffic
##################################################################
proc ixiaConf_groupPorts {args} {
   parse_args ixiaConf_groupPorts $args {
      numIxiaCd 1
      startCardNum 1
      txPortId 1
      rxPortId 2
      ixMapOption "standard"
      direction "2Way"
      protocol "mac"
      numFrames "1"
      frameSize "64"
      frameSizeType "sizeFixed"
      dataPattern "0000"
      streamType "stopStream"
      patternOffset "32"
      fcsError "good"
      priority "0"
      protocol "mac"
      saMode "idle"
      daMode "idle"
      percentage "100"
      sendLearn "false"
      numLearnFrames "1"
      wTag "false"
	  tagNo "002"
	  tagCfi "resetCFI"
      tagMode "vIdle"
	  tagRepeat "1"
      chid "1"
      applyFilter "0"
      dontTx "0"
   }

   global spawn_id
   global one2oneArray
   global macBroadcast
   global preambleSize
   globalSetDefault

   set macBroadcast	{FF FF FF FF FF FF}
   set preambleSize	8

   set date [clock format [clock seconds] -format "%m-%d-%Y %I.%M.%S%p"]
   result_debug "*** date=$date"
   set time1 [clock seconds]

   set lastCardNum [expr $startCardNum + $numIxiaCd - 1]  

   ixiaGenMap $txPortId $rxPortId $ixMapOption $direction $chid

   if { $sendLearn == "true" } {
      learn config -numframes $numLearnFrames
      send_learn_frames one2oneArray
   }
   #-----------------------------------------------------------------
   # Config streams for validation traffic
   foreach txMap [lsort -dictionary [array names one2oneArray]] {

      # Here we gather information about the first port 
      scan $txMap					"%d,%d,%d" chid c p
      port get						$chid $c $p
      set txSpeed					[port cget -speed]
      set srcAddr 					[port cget -MacAddress]

      # Here we gather information about the second port
      set rxMap						$one2oneArray($txMap)
      scan [join $rxMap]			"%d %d %d" rxch rxc rxp
      port get						$rxch $rxc $rxp
      set destAddr					[port cget -MacAddress]

      # Now we configure the stream
      stream config -numFrames		$numFrames
      stream config -name 			S_${c}_${p}
      stream config -framesize		$frameSize
      #random size
      if {$frameSizeType == "sizeRandom"} {
         stream config -frameSizeType		$frameSizeType
         stream config -frameSizeMAX      1500
         stream config -frameSizeMIN      64
      }

      decideLoopCount $numFrames $streamType
    stream config -rateMode usePercentRate
      stream config -percentPacketRate $percentage

#      set frameRate [decideFrameRate $txSpeed $frameSize $percentage]
     # set ifg [calculateGap $frameRate $frameSize $preambleSize $txSpeed]
      stream config -fcs                       $fcsError
     # stream config -ifg                       $ifg
     # stream config -isg                       $ifg
     # stream config -ibg                       $ifg
#      stream config -fir                      true            ;# for timestamp
      stream config -patternType nonRepeat  ;#needed for version 3.1
      stream config -dataPattern	userpattern -pattern $dataPattern
      stream config -sa				$srcAddr
      stream config -da				$destAddr

      stream config -saRepeatCounter	$saMode
      stream config -daRepeatCounter $daMode
      if { $saMode != "idle" } { 
	     stream config -numSA			$numFrames
      }
      if { $daMode != "idle" } { 
	     stream config -numDA			$numFrames
      }

      protocol setDefault
      protocol config -name			$protocol
      protocol config -enable802dot1qTag	$wTag

      vlan config -cfi						$tagCfi
      vlan config -mode						$tagMode
      vlan config -repeat					$tagRepeat
	  vlan config -vlanID					$tagNo
      vlan set								$chid $c $p

      stream set 					$chid $c $p 1

      filterPallette config -pattern1			$dataPattern
      filterPallette config -patternOffset1 	$patternOffset
      filterPallette set						$rxch $rxc $rxp

      filter config -captureFilterEnable		true
      filter config -captureTriggerEnable		true
      if {$applyFilter} {
         filter config -userDefinedStat1Enable true
         filterPallette config -DA1 				$destAddr
         filter config -userDefinedStat1DA		addr1
         filterPallette config -SA1             $srcAddr
         filter config -userDefinedStat1SA		addr1
         filterPallette set				$rxch $rxc $rxp
      } else {
         filter config -userDefinedStat1Enable false
      }
      
      filter config -userDefinedStat1DA			addr1
      filter config -captureFilterPattern		anyPattern
      filter config -captureTriggerPattern		anyPattern
      filter config -captureTriggerDA			anyAddr
      filter config -captureFilterDA			anyAddr
      filter set								$rxch $rxc $rxp
   }
   writeConfigToHardware one2oneArray
   exSleep 1
   zeroStats one2oneArray
   startCapture one2oneArray
   if {!$dontTx} {
      startTx one2oneArray
      set time2 [clock seconds]
      result_debug "*** Time for Ixia TX setup = [expr $time2-$time1] secs"

      # Make sure TX done
      if { $streamType == "stopStream" } {
         if { ($saMode != "contIncrement") && ($saMode != "contDecrement") &&   \
              ($daMode != "contIncrement") && ($daMode != "contDecrement") } {
            for {set c $startCardNum} {$c<=$lastCardNum} {incr c 1} {
               set ixiaPortPerCard [findNumPortPerIxiaCard $c]
               for {set p 1} {$p<=$ixiaPortPerCard} {incr p 1} {
                  ixiaCheckTxDone $chid $c $p $numFrames $txPortId
               }
            }
         }
      }
      set time3 [clock seconds]
      result_debug "*** Time for Ixia TX done = [expr $time3-$time2] secs\n"
   }
}

################################################################## 
# Procedure Name: ixiaConf_2Ports
#   
# Description:
# Ixia control - TX from a port & RX from another port. 
# Uni-direction or bi-direction.
#
#
# Input args:
#      numIxiaCd :		Number of Ixia cards involved (1-16)
#                       for statistics & capture purpose
#	   startCardNum :	Starting Ixia card slot number (1-16)
#      direction :		uni-direction (1Way) or bi-direction (2Way)
#      txChas :			TX Ixia chassis id
#      txCard :			TX Ixia card number
#      txPort :			TX Ixia port number
#      rxChas :			RX Ixia chassis id
#      rxCard :			RX Ixia card number
#      rxPort :			RX Ixia port number
#      inSaMac :		Input source MAC address
#      inDaMac :		Input destination MAC address
#      numFrames :		Number of frames to send per Ixia port
#      frameSize :		Frame size
#      dataPattern :	Packet data pattern 
#      streamType :		advance, contBurst, contPacket, firstLoopCount,
#						gotofirst, stopStream (Note: see Ixia manual)
#      patternOffset :	For "filterPallette" (Note: see Ixia manual)
#      fcsError :		good, alignErr, bad, dribbleErr, none
#						(Note: see Ixia manual)
#      wTag :			With Tag (true, false)
#	   tagNo :			Tag number
#      priority :		Priority for the packet
#      protocol :		mac, ip, ipx
#      saMode :			contDecrement, contIncrement, ctrRandom,
#						decrement, idle, increment (Note: see Ixia manual)
#      daMode :			contDecrement, contIncrement, ctrRandom,
#						decrement, idle, increment (Note: see Ixia manual)
#      percentage :		For TX speed - Percentage of the line rate
#      sendLearn :		To send learning frames? (true, false)
#      numLearnFrames :	Number of the learning frames
#      chid :			Ixia chassis id
#      userStatFltrSA1		MAC address filter for user stat 1
#      userStatFltrDA1		MAC address filter for user stat 1
#
# Output args: none
# Typical usage:
#   set frameSent [ixiaConf_2Ports -numIxiaCd $numIxiaCd \
#                  -txChas $txChasisId -txCard $txCard -txPort $txPort -direction "2Way" \
#                  -rxChas $rxChasisId -rxCard $rxCard -rxPort $rxPort -sendLearn $sendLearn \
#                  -protocol $protocol -numFrames $numFrames -frameSize $frameSize \
#                  -frameSizeType $frameSizeType -frameSizeMIN $frameSizeMIN  -frameSizeMAX $frameSizeMAX \
#                  -dataPattern $dataPattern -streamType $streamType -fcsError $fcsError]
#
#
#
# Category Types (Setup,GetSwitchInfo,SendTraffic,CaptureTraffic,VerifySwitchOutput
#                          VerifyTraffic)
# Category: SendTraffic
##################################################################

proc ixiaConf_2Ports {args} {
#puts "-----Enter into ixiaConf_2Ports--------------------"
   parse_args ixiaConf_2Ports $args {
      numIxiaCd "1"
      startCardNum "1"
      direction "1Way"
      txChas "1"
      txCard "1"
      txPort "1"
      rxChas "1"
      rxCard "1"
      rxPort "2"
      inSaMac "default"
      inDaMac "default"
      numFrames "1"
      frameSizeType "sizeFixed"
      frameSizeMAX "1518"
      frameSizeMIN "64"
      frameSize "64"
      dataPattern "0000"
      ethernetType "noType"
      frameType "08 00"
      streamType "stopStream"
      patternOffset "32"
      fcsError "good"
      priority "0"
      protocol "mac"
      saMode "idle"
      daMode "idle"
      saCount ""
      daCount ""
      percentage "100"
      sendLearn "false"
      numLearnFrames "1"
      wTag "false"
      tagNo "002"
      tagCfi "resetCFI"
      tagMode "vIdle"
      tagRepeat "1"
      tagPriority "0"	  
      protocolTagId "null"
      chid "1"
      userDefinedStat1SA "00:00:00:00:00:00"
      userDefinedStat1DA "00:00:00:00:00:00"
      rate               "null"      
      udfEnable "false"
      udfInitval "00"
      udfOffset "0"
      udfCountertype "c8"
      udfContinuousCount "false"
      udfRepeat "1"
      protoOffsetEnable "false"
      protoOffset "14"
      userDefTag ""
      dontTx "0"
      ZeroStats "yes"
   }

   global spawn_id
   global one2oneArray
   global macBroadcast
   global preambleSize
   #globalSetDefault

   set date [clock format [clock seconds] -format "%m-%d-%Y %I.%M.%S%p"]
#   result_debug "*** date=$date for <ixiaConf_2Ports> on ($txChas $txCard $txPort)"
   set time1 [clock seconds]
 
   set macBroadcast	{FF FF FF FF FF FF}
   set preambleSize	8

   # Create mapping
  # map new -type	one2one
  # map config -type one2one
#   puts "@@@@@@@2Way value :$direction"
#   puts "@@@@@@@Protocol Offset Value : $protoOffsetEnable"
#   puts "@@@@@@@UserDefined Tag : $userDefTag"
#puts "--------------------- ll1 -----------------"
#puts "--------------------- ll2 -----------------"
   if { $direction == "2Way" } {
#puts "--------------------- ll3 -----------------"
      map add $txChas $txCard $txPort $rxChas $rxCard $rxPort $rxChas $rxCard $rxPort $txChas $txCard $txPort
#puts "--------------------- ll4 -----------------"
   } else  {
      map add $txChas $txCard $txPort $rxChas $rxCard $rxPort
   }
   if { $sendLearn == "true" } {
   #   learn config -numframes $numLearnFrames
   #   send_learn_frames one2oneArray
   }
   #-----------------------------------------------------------------
   # Config streams for validation traffic
   set wkTag $wTag
   set wkTagNo $tagNo
   set portNo 0
    
    ### TK add
    set portList {}
  # foreach txMap [lsort -dictionary [array names one2oneArray]] 
      if { $wkTag == "true" } {
	 set wTag "true"
	 set tagNo [lindex $wkTagNo $portNo]
	 incr portNo
         if { $tagNo == "" } {set tagNo [lindex $wkTagNo 0]}
	 if { $tagNo == 0 || $tagNo == "none" } {set wTag "false"}
	 result_debug "wTag = $wTag, tagNo = $tagNo"
      }
#      scan $txMap					"%d,%d,%d" chid c p
#      port get						$chid $c $p
       set chid $txChas
       set c $txCard
       set p $txPort
      #set txSpeed					[port cget -speed]
      set txSpeed					100
#puts "--------------------- ll5 -----------------"
      stream config -numFrames		$numFrames
#      stream config -name 			S_${c}_${p}
      stream config -frameSizeType		$frameSizeType
      stream config -framesize		$frameSize
#          puts "INSIDE ixia_config_ports function FRAME SIZE : $frameSize"
#puts "--------------------- ll6 -----------------"
      #random size
      if {$frameSizeType == "sizeRandom"} {
#puts "--------------------- ll7 -----------------"
         stream config -frameSizeType		$frameSizeType
         stream config -frameSizeMAX      $frameSizeMAX
         stream config -frameSizeMIN      $frameSizeMIN
      }
      decideLoopCount $numFrames $streamType
      set frameRate [decideFrameRate $txSpeed $frameSize $percentage]
      if { $rate != "null" } {
         set percentage [decidePercentage $txSpeed $frameSize $rate]
      }
      stream config -rateMode fixed
      stream config -percentPacketRate $percentage

#      set ifg [calculateGap $frameRate $frameSize $preambleSize $txSpeed]
      # Now we configure the stream
      stream config -fcs                       $fcsError
#      stream config -ifg                       $ifg
#      stream config -isg                       $ifg
#      stream config -ibg                       $ifg
#      stream config -fir                       true            ;# for timestamp
      stream config -patternType nonRepeat  ;#needed for version 3.1
#     stream config -dataPattern	userpattern -pattern $dataPattern
     stream config -dataPattern	$dataPattern
      stream config -frameType $frameType
#      set rxMap						$one2oneArray($txMap)
#      scan [join $rxMap]			"%d %d %d" rxch rxc rxp
#      port get						$rxch $rxc $rxp
       port get $txChas $txCard $txPort  
       set srcAddr					[port cget -MacAddress]
       after 200   
#       puts " INSIDE IXIA FILE SRC ADDR : $srcAddr"
       port get $rxChas $rxCard $rxPort  
      set destAddr					[port cget -MacAddress]
       after 200   
#       puts " INSIDE IXIA FILE DESTR ADDR : $destAddr"

      stream config -saRepeatCounter $saMode 
      stream config -daRepeatCounter $daMode 
      if {$saMode != "idle"} {
          if {$saCount == ""} {
              stream config -numSA $numFrames
          } else {
              stream config -numSA $saCount
          }
      }
      if {$daMode != "idle"} {
          if {$daCount == ""} {
              stream config -numDA $numFrames
          } else {
              stream config -numDA $daCount
          }
      }

# Sending traffic, whether it's 1-way or 2-way, first port is always the src port
# and the second port is always the dest port in an entry in the one2one array
if { 1 } {
      if {$direction == "2Way"} {
          if {($chid == $rxChas) && ($c == $rxCard) && ($p == $rxPort)} {
              if { $inSaMac == "default" } {
                  stream config -sa $srcAddr
              } else { 
                  stream config -sa $inDaMac 
              }				    
              if { $inDaMac == "default" } { 
                  stream config -da $destAddr
              } else {                 
                  stream config -da $inSaMac 
              }

		    ### TK add
		    lappend portList [list $txChas $txCard $txPort]
          } else {
              if { $inSaMac == "default" } {
                  stream config -sa $srcAddr
              } else { 
                  stream config -sa $inSaMac 
              }				    
              if { $inDaMac == "default" } { 
                  stream config -da $destAddr
              } else {                 
                  stream config -da $inDaMac 
              }
		    ### TK add
		    lappend portList [list $txChas $txCard $txPort]
#		    lappend portList [list $rxChas $rxCard $rxPort]
          }
      } else {
          if { $inSaMac == "default" } {
              stream config -sa $srcAddr
          } else { 
              stream config -sa $inSaMac 
          }				    
          if { $inDaMac == "default" } { 
              stream config -da $destAddr
          } else {                 
              stream config -da $inDaMac 
          }
		### TK add
		lappend portList [list $txChas $txCard $txPort]
      }
} else {

	    ### TK
	    ixPuts "It should not come to this branch"
      if { $inSaMac == "default" } {
              stream config -sa $srcAddr
          } else { 
              stream config -sa $inSaMac 
          }				    
          if { $inDaMac == "default" } { 
              stream config -da $destAddr
          } else {                 
              stream config -da $inDaMac 
      }
}
      
#          protocol setDefault
	  protocol config -name					$protocol
#          puts "INSIDE ixia_config_ports function PROTOCOL NAME : $protocol"
          if {[regexp -nocase "ip" $protocol]} {
#           ip setDefault
	    ip config -ipProtocol 255
#    ip set $chid $c $p
          }
	  protocol config -ethernetType $ethernetType
	  protocol config -enable802dot1qTag	$wTag
	  #ipx
#	  if { $protocol == "ipx" } {
#	   puts "NetbiosOOOOOOOOOO"
#	   ipx config -packetType "typeNetBios"
#	   ipx config -destSocket "socketNetBios"
#	   puts [ipx cget -packetType] }

      vlan config -cfi						$tagCfi
      vlan config -mode						$tagMode
      vlan config -repeat					$tagRepeat
#      puts "INSIDE ixia_config_ports function Before Protocol ID : $tagNo"
      vlan config -userPriority					$tagPriority
#      puts "INSIDE ixia_config_ports function After Protocol ID : $tagNo"
      if {$protocolTagId != "null"} {
          set decProtoTagId [expr $protocolTagId]
          vlan config -protocolTagId                            $decProtoTagId
      }
      vlan config -vlanID					$tagNo
#      vlan set	 						$chid $c $p
      # Define UDF package 
      if {$udfEnable == "true"} {
          set inter 0
          foreach udfOffs $udfOffset {
          udf config -enable "true"
          udf config -continuousCount [lindex $udfContinuousCount $inter]
          udf config -initval [lindex $udfInitval $inter]
          udf config -offset [lindex $udfOffset $inter]
          udf config -countertype [lindex $udfCountertype $inter]
          udf config -repeat [lindex $udfRepeat $inter]
          incr inter
#         udf set $inter
          }
      }
     
          udf config -enable $udfEnable
      # define protocolOffset
      if {$protoOffsetEnable == "true"} {
#         protocolOffset setDefault
         protocolOffset config -enable true
         protocolOffset config -offset $protoOffset
         protocolOffset config -userDefinedTag $userDefTag
#         if [protocolOffset set $txChas $txCard $txPort] {
#            result_debug "Error in protocolOffset set for \
#                          $txChas $txCard $txPort"
#         }
      } else {
#         protocolOffset setDefault
         protocolOffset config -enable false
#        protocolOffset set $txChas $txCard $txPort
      }

#     stream set $chid $c $p 1

	# Define filter & capture

	### TK add
	if  {$direction == "2Way"} {
      filterPallette config -DA1 			$destAddr
      filterPallette config -pattern1			$dataPattern
      filterPallette config -patternOffset1 		$patternOffset
#     filterPallette set				$rxch $rxc $rxp

      filter config -captureFilterEnable		true
      filter config -captureTriggerEnable		true
  
      #user defined stats settings
      if { ( $userDefinedStat1DA != "00:00:00:00:00:00" ) || \
           ( $userDefinedStat1SA != "00:00:00:00:00:00" ) }  {
        filter config -userDefinedStat1Enable		true
        if { $userDefinedStat1DA != "00:00:00:00:00:00" } {
          filterPallette config -DA1 			$userDefinedStat1DA
          filter config -userDefinedStat1DA		addr1
        }
        if { $userDefinedStat1SA != "00:00:00:00:00:00" } {
          filterPallette config -SA1 			$userDefinedStat1SA
          filter config -userDefinedStat1SA		addr1
        }
#        filterPallette set				$rxch $rxc $rxp
      } else {
        filter config -userDefinedStat1Enable		false
        filter config -userDefinedStat1DA		addr1
      }      
      filter config -captureFilterPattern		anyPattern
      filter config -captureTriggerPattern		anyPattern
      filter config -captureTriggerDA			anyAddr
      filter config -captureFilterDA			anyAddr
#      filter set 					$rxch $rxc $rxp 
	}; ### TK add

#puts "--------------------- ll8 -----------------"
    #### TK modify
    if {[ixWriteConfigToHardware $portList -noProtocolServer]} {
	ixPuts "failed to do ixWritePortsToHardware.\n$::ixErrorInfo"
    }
    #### Wait for the link to come up
#    if {[ixCheckLinkState portList]} {
#	ixPuts "failed to do ixCheckLinkState.\n$::ixErrorInfo"
#    }
    
   if {$ZeroStats != "no" } {
	      zeroPortStats $txChas $txCard $txPort
	      zeroPortStats $rxChas $rxCard $rxPort
      }
   #for {set c $startCardNum} {$c<=[expr $startCardNum + $numIxiaCd - 1]} {incr c 1} { 
   #    ixiaConf_clearStat $c
   #    }

   #just in case some previous function stop capture on these ports
    ### TK 
       set pList ""
       lappend pList "$txChas $txCard $txPort"
       lappend pList "$rxChas $rxCard $rxPort"
#       set pList "$txChas:$txCard:$txPort#$rxchas:$rxCard:$rxport"
#puts "--------------------- ll9 -----------------"
    ixStartCapture $pList
#puts "--------------------- ll10-----------------"

      stream get $txChas $txCard $txPort 1
      set streamSent [stream cget -packetView]
#      puts "=========================$streamSent#################"
   if {!$dontTx} {
#puts "--------------------- ll11 $portList-----------------"
       startTx $portList
#      startTx one2oneArray
      set time2 [clock seconds]
#      result_debug "*** Time for Ixia TX setup = [expr $time2-$time1] secs"
      #get the stream so we can return it later
      # Make sure TX done
      if { $streamType == "stopStream" } {
#puts "--------------------- ll12-----------------"
         if { ($saMode != "contIncrement") && ($saMode != "contDecrement") &&   \
              ($daMode != "contIncrement") && ($daMode != "contDecrement") } {
#puts "--------------------- ll13-----------------"
            ixiaCheckTxDone $txChas $txCard $txPort $numFrames $txPort
            if { $direction == "2Way" } {
               ixiaCheckTxDone $rxChas $rxCard $rxPort $numFrames $txPort
            }
         }
#puts "--------------------- ll14-----------------"
      }
#  after 200
   set time3 [clock seconds]
#   result_debug "*** Time for Ixia TX done = [expr $time3-$time2] secs\n"
   result_debug "*** Ixia port config time [expr $time2-$time1] secs and TX time [expr $time3-$time2] secs\n"
#set destAddr "00 a1 f1 00 00 02"
   if {$inDaMac == "default"} {
#puts "--------------------- ll15-----------------"
      set inDaMac $destAddr
   }
#set srcAddr "00 a1 f1 00 00 01"
   if {$inSaMac == "default"} {
#puts "--------------------- ll16-----------------"
      set inSaMac $srcAddr
   }

   set txPortId [MapIxiaCardnPort $txChas $txCard $txPort]
#puts "--------------------- ll17-----------------"
   set rxPortId [MapIxiaCardnPort $rxChas $rxCard $rxPort]
   displayMacPacketFormat -txPortId $txPortId -rxPortId $rxPortId \
                    -frameSent $streamSent -streamType $streamType \
                    -destMac $inDaMac -srcMac $inSaMac -numFrames $numFrames \
                    -protocol $protocol -wTag $wTag -tag $tagNo \
                    -userPriority $priority -direction $direction -daMode \
                     $daMode -daCount $daCount -saMode $saMode -saCount $saCount \
                     -percentage $percentage

#puts "--------------------- ll18-----------------"

   return $streamSent
   } else {
      return ""
   }
}

##################################################################
# Procedure Name: EnableFlowControl
#
# Description: Set Flow control ability to the following modes -
#                   none,symmetric,asymmetric and both (both symmetric or asymmetric)
#
# Input args:
#              portIdList - Port list
#              mode 
#
# Output args: none
#
#
# Typical usage:
#             [EnableAsymmetricFlowControl $portIdList "symmetric"]
#             [EnableAsymmetricFlowControl $portIdList "asymmetric" 0]  ;# 0 - Do not wait for link up
#           
# Category: setup
##################################################################

proc EnableFlowControl {portIdList mode {maxWait 15}} {

    puts " Setting ports - $portIdList to flow control mode : $mode"
    foreach portId $portIdList {   
        MapIxiaPortId $portId chasis card port

        # ----- Get the port before re-writing to avoid messing up the old port info.
        port get $chasis $card $port

	if {$mode == "asymmetric"} {        
        port config -flowControl false
        port config -negotiateMasterSlave 0
        port config -advertiseAbilities portAdvertiseSend
        }
        if {$mode == "symmetric"} {
        port config -flowControl false
	port config -negotiateMasterSlave 1
        port config -advertiseAbilities portAdvertiseSendAndReceive
        }         

	if {$mode == "none"} {
        port config -flowControl false
        port config -negotiateMasterSlave 0
        port config -advertiseAbilities portAdvertiseNone
        }
        if {$mode == "both"} {
        port config -flowControl true
        port config -negotiateMasterSlave 1
        port config -advertiseAbilities portAdvertiseSendAndOrReceive
        }
        
        port config -advertise1000FullDuplex true
        port set $chasis $card $port
        port write $chasis $card $port
            
        if {$maxWait == 0} {
            continue
        }
         set maxWaitCounter $maxWait
       
         while { $maxWaitCounter } {
            port get $chasis $card $port
            if {[port cget -linkState] == 1} {
                result_debug "FOUND LINK UP for portId:$portId!"
                break
            } else {
                result_debug "Waiting for portId:$portId linkUp.."
                sleep 1
                incr maxWaitCounter -1 
            }
        }

        if {$maxWaitCounter == 0} {   
            result_warning "WARNING: No linkUp for Ixia portId:$portId"
        }
   }
}
   

##################################################################
# Procedure Name: IxiaPortsClear
#
# Description: proc that clears ixia port ownership.
#
#
# Input args: none
# Output args: none
# Typical usage:
#             IxiaPortsClear
#       
# Category Types (Setup,GetSwitchInfo,SendTraffic,CaptureTraffic,VerifySwitchOutput
#                          VerifyTraffic)
# Category: Setup
##################################################################
proc IxiaPortsClear {} {
      
   global portMappingList
#   globalSetDefault
   set TxRxPortList {}
 
   foreach port $portMappingList {
      set portId [lindex $port 0]
      MapIxiaPortId $portId chid c p

      if {[ixPortClearOwnership $chid $c $p force]!=0} {
        result_error "Can not clear ixia port ownership:$chid $c $p"
      }
   }

}

######################################################################

