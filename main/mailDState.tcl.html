<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                       "http://www.w3.org/TR/html4/transitional.dtd">
<!-- Generated by TclDoc @@VERSION@@ -->
<html>
<head>
  <title>mailDState.tcl</title>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <link rel="stylesheet" type="text/css" href="default.css">
</head>
<body class="src-html">
<div class="index-selector">
<!-- index for tcl source files -->
	Index by: 
	<a href="index_main.html#mailDState.tcl">file name</a> | 
	<a href="index_main.html#byprocname">procedure name</a> | 
	<a href="index_main.html#bycall">procedure call</a> | 
	<a href="index_annot_full.html">annotation</a>

</div>
<hr>

<p><strong>mailDState.tcl</strong>&nbsp;&nbsp;<span class="filetype-link">(<a href="mailDState.tcl-annot.html">annotations</a> | <a href="mailDState.tcl.txt">original source</a>)</span>
</p>
<pre class="src-code">
<span class="comment-line">#!/usr/bin/tclsh</span>

    global webServerDirName
    global newPlatforms
    global regplatform
    array set modOwnList [ list {bootprelay} {mathurv} \
                          {dhcp} {dmunuswamy} \
                          {fdbvalidation} {pamin} \
                          {flowredirect} {pamin} \
                          {igmpsnooping} {rramachandran} \
                          {staticigmp} {rramachandran} \
                          {ipx} {pamin} \
                          {jumboframe} {kgopanna} \
                          {l2} {kgopanna} \
                          {l3} {mathurv} \
                          {loadsharing} {sharanb} \
                          {macsecurity} {mathurv} \
                          {macbased} {mathurv} \
                          {mirroring} {spalanivel} \
                          {multinetting} {mathurv} \
                          {ip-multinetting} {sganesan} \
                          {nat} {mathurv} \
                          {qos} {spalanivel} \
                          {radius} {rpalaniappan} \
                          {sntp&dns} {dmunuswamy} \
                          {swredun} {sharanb} \
                          {tacacs} {dmunuswamy} \
                          {vlanaggregation} {mathurv} \
                          {ipfrag&pmtu} {kgopanna} \
                          {management} {sganesan} \
                          {dos} {dmunuswamy} \
                          {dot1x} {dmunuswamy} \
                          {rip} {rramachandran} \
                          {bgp} {skuppuswamy} \
                          {dvmrp} {sganesan} \
                          {eaps} {hkrishna} \
                          {fdbimprovement} {pamin} \
                          {isis} {sganesan} \
                          {pim-sm} {sganesan} \
                          {pim-dm} {sganesan} \
                          {spanningtree} {rramachandran} \
                          {ospf} {hkrishna} \
                          {emistp} {hkrishna} \
                          {esrp} {skuppuswamy} \
                          {vrrp} {skuppuswamy} \
                          {elrp} {rramachandran} \
                          {diffserve} {spalanivel} \
                          {stpdot1w} {hkrishna} \
                          {staticrouting} {rramachandran}] 

   global summitList
   global ownerList


                   
set summitList &#34;summit7i|summit48i|summit5i|summit24e3|summit48si|summit2|summit4&#34;

<strong><a name="::print_usage_58">proc <a href="mailDState.tcl-annot.html#::print_usage">::print_usage</a></a></strong><a name="::print_usage"></a> {} {
    puts &#34;\r&#34;
    puts {USAGE: mailDState.tcl -build &lt;imageName&gt; -mailinginterval &lt;hours&gt; \
                -pollinterval &lt;hours&gt; -status &lt;start/stop&gt;}
    puts {      -build:    Name of image e.g. 6.1.7b16/617b16/620b56}
    puts {      -mailinginterval: The duration in hours when the mail will be \
                 sent to the module owners}
    puts {      -pollinterval: The duration in hours when the autoweb should \
                 be scanned to get the information of the modules in D state}
    puts {      -status: Whether to start the application or stop. To stop you \
                 just need to give the build number and the keyword stop }
    puts &#34;\r&#34;
}

<strong><a name="::formMailingInfo_72">proc <a href="mailDState.tcl-annot.html#::formMailingInfo">::formMailingInfo</a></a></strong><a name="::formMailingInfo"></a> {platform blade module mailinginterval} {
    global ownerList
    if {$ownerList == &#34;&#34; } {
       <a name="::informDState(1)"><a href="./mailDState.tcl.html#::informDState_96">::informDState</a></a> $platform $blade $module
    } elseif {[lsearch $ownerList $platform$blade$module] == -1} {
       <a name="::informDState(2)"><a href="./mailDState.tcl.html#::informDState_96">::informDState</a></a> $platform $blade $module
    } else {
       for { set i 0 } { $i &lt; [llength $ownerList] } { incr i 3} {
          set searchval $platform$blade$module
          if { $searchval == [lindex $ownerList $i] } {
             set prevtime [lindex $ownerList [expr $i + 2]]
             set currtime [clock seconds]
             set calctime [expr $currtime - $prevtime]
             if { $calctime &gt;= [expr $mailinginterval * 3600] } {
                <a name="::informDState(3)"><a href="./mailDState.tcl.html#::informDState_96">::informDState</a></a> $platform $blade $module
                break
             } else {
                break
          }
       }
    }
  }
}

<strong><a name="::informDState_96">proc <a href="mailDState.tcl-annot.html#::informDState">::informDState</a></a></strong><a name="::informDState"></a> {platform blade module} {
    global modOwnList
    global testModule
    global ownerList
    global autowebLink
    global buildName
    global fd_log

    set mod [string tolower $module]
    lappend ownerList &#34;$platform$blade$module&#34;
    set owner $modOwnList($mod)
    lappend ownerList &#34;$owner&#34;
    <span class="comment-line"># Send email notification</span>
    set subject &#34;Build v$buildName Module $testModule in D State&#34;
    set mailTo &#34;$owner@extremenetworks.com&#34;
    set ccList &#34;mverma@extremenetworks.com,schawla@extremenetworks.com&#34;
    set body &#34;Please look into the module $testModule in $platform$blade which \
              is in D state. Refer the autoweb for more information. \
                \nBUILD: v$buildName \
                \nMODULES: $testModule
                \nAUTOWEB: $autowebLink&#34;

    set mailtime [clock format [clock seconds] -format &#34;%m-%d-%Y&#34;]
    set timestamp [clock seconds]
    lappend ownerList $timestamp
    puts $fd_log &#34;Mail sent to $owner for build v$buildName module $module \
                  which is in D state on $mailtime&#34;


<span class="comment-line">#   exec /bin/mail -s &#34;$subject&#34; schawla@extremenetworks.com &lt;&lt; &#34;$body&#34; &amp;</span>

   exec /bin/mail -s &#34;$subject&#34; $mailTo &lt;&lt; &#34;$body&#34;  -c &#34;$ccList&#34; &amp;

}

<strong><a name="::UtilGetPID_131">proc <a href="mailDState.tcl-annot.html#::UtilGetPID">::UtilGetPID</a></a></strong><a name="::UtilGetPID"></a> { name } {
   set output [exec /bin/ps -e | grep $name]
   if {[info exists output]} {
      foreach item [split $output &#34;\n&#34;] {
         if { [regexp $name $item] &amp;&amp; ![regexp &#34;grep&#34; $item] } {
            set mailPID [lindex $item 0]
            if { $mailPID != -1} {
               exec /bin/kill -s SIGHUP $mailPID
            }

         }
      }
  }

  <span class="comment-line"># Process id not found</span>
  return -1
}

load [lindex [glob &#34;/usr/lib/libexpect*so*&#34;] 0]

log_user 1
source ../Lib/parse_args.tcl

catch { parse_args mailDState.tcl $argv {
    build           &#34;&#34;
    mailinginterval &#34;8&#34;
    pollinterval    &#34;4&#34;
    status          &#34;start&#34;
   }
} result

   if { $result != &#34;&#34; } {
      puts &#34;ERROR: $result&#34;
      <a name="::print_usage(1)"><a href="./mailDState.tcl.html#::print_usage_58">::print_usage</a></a>
      exit
   }
   if {[catch {open &#34;DStatelog.txt&#34; w  0777} fd_log]} {
      puts &#34;ERROR: Cannot open file for logging&#34;
   }
   
   if { [string compare [string tolower $status] &#34;stop&#34;] == 0 } {
      set ownerList [list]
      if { [<a name="::UtilGetPID(1)"><a href="./mailDState.tcl.html#::UtilGetPID_131">::UtilGetPID</a></a> mailDState.tcl] == -1} {
          puts &#34;No mail utility to kill&#34;
      }
      close $fd_log
      exit
   }

   if {$build==&#34;&#34; &amp;&amp; [string compare [string tolower $status] &#34;start&#34;] == 0 } {
       puts &#34;ERROR: Required Parameters: -build $build invalid or missing&#34;
       exit
   }
  
   source ./mainLib.tcl
   set sourceFile &#34;./../Autoweb/cgi-bin/cgiScripts/modulesToBeSummarized.cfg&#34;
   if {[file exists $sourceFile] == 0} {
      puts &#34;ERROR: Cannot find config file: $sourceFile, please contact admin\n&#34;
      puts &#34;SETUP ERROR: Cannot find the config file $sourceFile, \
                    please contact the admin.&#34;
      exit
   }
   source $sourceFile

   
   set bgpList &#34;BGP_RFCConform|BGP_RtDamp|BGP_Cli|BGP_RtRedistrib|BGP_RtReflect|BGP_Confeder|BGP_Neighbor|BGP_RtMapnFilt&#34;
   set qosList &#34;QOS-ACL|QOS-Basic|QOS-IRS|QOS-ISQ|QOS-PRI&#34;
   set ospfList &#34;ospf-addressrange|ospf-basic|ospf-dynamicChanges|ospf-areas|ospf-convergance|ospf-lsdb&#34;
   set pollinterval [expr $pollinterval*60]
   set cfgFile ./runReg.cfg
   
   set fd_log [open &#34;mailDstate.txt&#34; &#34;w+&#34;]
   set buildName [getBuildNumber $build]
   puts $fd_log &#34;The bulid number is $buildName&#34;
   source $cfgFile

   set ownerList [list]

   while { 1 } {
    
   foreach testBlade [array names regplatform] {

       <span class="comment-line"># Parse out BD1,1 from regplatform(BD1,1) {config}</span>
       regexp (.*),(.*) $testBlade ignore targetPlatformPC index

       set platform    [lindex $regplatform($testBlade) 0]
       set blade       [lindex $regplatform($testBlade) 1]
       set regType     [lindex $regplatform($testBlade) 3]
       set regSubType  [lindex $regplatform($testBlade) 4]
      
      if { $regType == &#34;&#34; } {
          set regType &#34;functional&#34;
      }

      if { $regSubType == &#34;&#34; } {
          set regSubType &#34;standard&#34;
      }
      if {$regType == &#34;snmp&#34;} {
           if {$regSubType == &#34;uploadanddownload&#34;} {
                continue
           }
       }
      puts &#34;Checking $platform $blade $regType $regSubType for D state \
                   in webServerDirName $webServerDirName&#34;

       <span class="comment-line">#Change the webserver directory name if the SNMP testing is carried out</span>
       if {$regType == &#34;snmp&#34;} {
          set webmoduleDirName $webServerDirName/snmpData
       } elseif {$regType == &#34;scal&#34;} {
          set webmoduleDirName $webServerDirName/scalData
       } elseif {[regexp -nocase &#34;functional&#34; $regType]} {
          set webmoduleDirName $webServerDirName/functionalData
       } elseif {[regexp -nocase &#34;performance&#34; $regType]} {
          set webmoduleDirName $webServerDirName/perfData
       } else {
          set webmoduleDirName $webServerDirName/data
       }

       set regressionModules &#34;&#34;
       <span class="comment-line"># The regressionModules are defined in modulesToBeSummarized.cfg.  \</span>
       <span class="comment-line"># The list is accessed as $regType($regSubType)</span>

       set regressionModules [getRegressionModuleList $regType $regSubType]
       if {$regressionModules == &#34;&#34; } {
          return &#34;Module List was empty!&#34;
       }

       set regressionModules [lrange $regressionModules 1 [expr [llength \
                             $regressionModules] - 1] ]

       foreach testModule $regressionModules {
          set curDir [pwd]
          cd &#34;$webmoduleDirName&#34;
          puts $fd_log &#34;Checking $platform $blade $regType $regSubType for D \
                        state in webServerDirName $webmoduleDirName&#34;

    if {[regexp -nocase $newPlatforms $platform]} {
        set relName $platform
    } else {
        set relName [string range $buildName 0 2]
    }

    switch -- $platform \
    &#34;BD&#34; {
        set pl &#34;BD&#34;
    } &#34;Alpine&#34; {
        set pl $platform
    } &#34;BT&#34; {
        set pl &#34;BT&#34;
    } &#34;Godzilla&#34; {
        set pl &#34;GZ&#34;
    } default {
        set pl $platform
    }
    if {[regexp -nocase $summitList $platform]} {
        set pl &#34;&#34;
    }

    if [regexp -nocase &#34;ipr&#34; $regSubType] {
        global Iproute
        set thisDir &#34;$relName/$buildName/[lindex $Iproute 0]&#34;

    } elseif {[regexp -nocase &#34;cli&#34; $regType]} {
        set thisDir &#34;$relName/$buildName/cli$pl$blade&#34;

    } else {
        set thisDir &#34;$relName/$buildName/$pl$blade&#34;
    }

          set webFileName &#34;$thisDir/$testModule.txt&#34;;
          puts &#34;webfilename is $webFileName&#34;
          if {[catch {open $webFileName r} fd_in]} {
              cd $curDir
              puts $fd_log &#34;** ERROR: Unable to open $webFileName.&#34;
              continue
          } else {
              set count 0
              set para($count) 0
              while {[gets $fd_in line] != -1} {
                  set para($count) $line
                  incr count
              }
              close $fd_in
              for {set ind 0} {$ind&lt;[array size para]} {incr ind} {
                  set state &#34;&#34;
                  set test &#34;&#34;
                  regexp {([0-9]+[.][0-9a-z_.-]*)([a-zA-Z]+)} $para($ind) \
                          match test state
                  <span class="comment-line"># check if state is D for a particular module</span>
                  puts &#34;number of paras are $para($ind)&#34;
                  puts &#34;The value of STATUS is $state module $testModule platform $platform&#34;
                  if {$state==&#34;&#34;} {
                     break;
                  }
                  if {$state==&#34;D&#34;} {
                     if {[regexp -nocase $bgpList $testModule]} {
                       set testModule &#34;BGP&#34;
                     }
                     if {[regexp -nocase $ospfList $testModule]} {
                       set testModule &#34;OSPF&#34;
                     }
                     if {[regexp -nocase $qosList $testModule]} {
                       set testModule &#34;QOS&#34;

                     }
                     <a name="::formMailingInfo(1)"><a href="./mailDState.tcl.html#::formMailingInfo_72">::formMailingInfo</a></a> $platform $blade $testModule \
                                   $mailinginterval  
                   <span class="comment-line">#no need to find out all test cases in D.If 1 test is in D \</span>
                   <span class="comment-line">#is enuf for the module to be in D state</span>
                     break;
                  }
              }
              if [info exists para] {
                 unset para
              }  
           }
        }
     }
     set freq [expr $pollinterval*60]
     puts -nonewline $fd_log &#34;Sleeping $freq seconds    \r&#34;
     while {$freq} {
        incr freq -1
        after 1000
    }
    if { $ownerList == &#34;&#34;} {
       close $fd_log
       exit
    }  
 }
</pre>
<hr>
<div class="index-selector">
	<a href="index_main.html#byfilename">file name</a> 
 | 
	<a href="index_main.html#byprocname">procedure name</a> 
 | 
	<a href="index_main.html#bycall">procedure call</a> 
 | 
	<a href="index_annot_full.html">annotation</a> 

<br>
<cite>File generated 2018-06-14 at 16:57.</cite>
</div>

</body>
</html>
