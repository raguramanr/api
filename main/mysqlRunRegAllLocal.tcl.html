<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                       "http://www.w3.org/TR/html4/transitional.dtd">
<!-- Generated by TclDoc @@VERSION@@ -->
<html>
<head>
  <title>mysqlRunRegAllLocal.tcl</title>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <link rel="stylesheet" type="text/css" href="default.css">
</head>
<body class="src-html">
<div class="index-selector">
<!-- index for tcl source files -->
	Index by: 
	<a href="index_main.html#mysqlRunRegAllLocal.tcl">file name</a> | 
	<a href="index_main.html#byprocname">procedure name</a> | 
	<a href="index_main.html#bycall">procedure call</a> | 
	<a href="index_annot_full.html">annotation</a>

</div>
<hr>

<p><strong>mysqlRunRegAllLocal.tcl</strong>&nbsp;&nbsp;<span class="filetype-link">(<a href="mysqlRunRegAllLocal.tcl-annot.html">annotations</a> | <a href="mysqlRunRegAllLocal.tcl.txt">original source</a>)</span>
</p>
<pre class="src-code">
<span class="comment-line">#!/usr/bin/expect --</span>


<strong><a name="::mysqlRunRegAllLocal_4">proc <a href="mysqlRunRegAllLocal.tcl-annot.html#::mysqlRunRegAllLocal">::mysqlRunRegAllLocal</a></a></strong><a name="::mysqlRunRegAllLocal"></a> {args} {
    puts &#34;\nmysqlRunRegAllLocal args:\n$args \n&#34;
    parse_args mysqlRunRegAllLocal $args {
        platform &#34;&#34;
        targetpc &#34;&#34;
        display &#34;&#34;
        i386ImagePath &#34;&#34;
        marinerImagePath &#34;&#34;
        aspenImagePath &#34;&#34;
        cougarImagePath &#34;&#34;
        x480ImagePath &#34;&#34;
        x870ImagePath &#34;&#34;
        NWIImagePath &#34;&#34;
        viperImagePath &#34;&#34; 
        jaguarImagePath &#34;&#34;
        olympicImagePath &#34;&#34;
        voyagerImagePath &#34;&#34;
        everestImagePath &#34;&#34;
        forstats &#34;no&#34;
        download &#34;yes&#34;
        mailTo &#34;&#34;
        obuild &#34;&#34;
        build_name &#34;&#34;
        subversion &#34;&#34;
        pass_number &#34;1&#34;
        heuristic &#34;no&#34;
        efence &#34;no&#34;
        saveConfigPerTest &#34;no&#34;
        debugLevel &#34;0&#34;
        lst &#34;NULL&#34;
        incrBuilds &#34;NULL&#34;
        include &#34;&#34;
        exclude &#34;&#34;
        rerun &#34;no&#34;
        baseLine &#34;NULL&#34;
        stopWithPhase &#34;NULL&#34;
    }

    global regplatform
    global autoScriptPath
    global regLogin
    global autoPath
    global staggerDelay

    <span class="comment-line"># Parameters used to build runall_monitor</span>
    set paramPlatformIndx &#34;-platformIndx&#34;
    set paramRegType      &#34;-regType&#34;
    set paramRegSubType   &#34;-regSubType&#34;
    set paramPlatform     &#34;-platform&#34;
    set paramBlade        &#34;-blade&#34;
    set paramCfg          &#34;-cfg&#34;
    set paramI386Image    &#34;-i386ImagePath&#34;
    set paramMarinerImage &#34;-marinerImagePath&#34;
    set paramAspenImage   &#34;-aspenImagePath&#34;
    set paramCougarImage  &#34;-cougarImagePath&#34;
    set paramx480Image    &#34;-x480ImagePath&#34;
    set paramx870Image    &#34;-x870ImagePath&#34;
    set paramNWIImage    &#34;-NWIImagePath&#34;
    set paramViperImage   &#34;-viperImagePath&#34;
    set paramJaguarImage  &#34;-jaguarImagePath&#34;
    set paramOlympicImage &#34;-olympicImagePath&#34;
    set paramVoyagerImage &#34;-voyagerImagePath&#34;
    set paramInclude      &#34;-include&#34;
    set paramExclude      &#34;-exclude&#34;
    set paramForstats     &#34;-forstats&#34;
    set paramDownload     &#34;-download&#34;
    set paramMailTo       &#34;-mailTo&#34;
    set paramOBuild       &#34;-obuild&#34;
    set paramBuildName    &#34;-build_name&#34;
    set paramSubVersion   &#34;-subversion&#34;
    set paramPassNumber   &#34;-pass_number&#34;
    set paramHeuristic    &#34;-heuristic&#34;
    set paramEfence       &#34;-efence&#34;
    set paramSaveConfigPerTest      &#34;-saveConfigPerTest&#34;
    set paramDebugLevel   &#34;-debugLevel&#34;
    set paramLst          &#34;-lst&#34;
    set paramincrBuilds   &#34;-incrBuilds&#34;
    set paramRerun        &#34;-rerun&#34;
    set parambaseLine     &#34;-baseLine&#34;
    set paramstopWithPhase &#34;-stopWithPhase&#34;
    <span class="comment-line"># Initialize Xterm Geometry</span>
    set xgeom 0
    set ygeom 0
    set harness &#34;tcl&#34;
    
    set imageList &#34;&#34;
puts &#34;Printing the parameters&#34;
    <a name="::result_debug(1)"><a href="./loadConsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;platform: $platform \n\
        targetpc: $build_name \n\
        display: $display \n\
        i386ImagePath: $i386ImagePath \n\
        marinerImagePath: $marinerImagePath \n\
        aspenImagePath: $aspenImagePath \n\
        cougarImagePath: $cougarImagePath \n\
        x480ImagePath: $x480ImagePath \n\
        x870ImagePath: $x870ImagePath \n\
        NWIImagePath: $NWIImagePath \n\
        viperImagePath: $viperImagePath \n\
        jaguarImagePath: $jaguarImagePath \n\
        olympicImagePath: $olympicImagePath \n\
        voyagerImagePath: $voyagerImagePath \n\
        include: $include \n\
        exclude: $exclude \n\
        forstats: $forstats \n\
        download: $download \n\
        mailTo: $mailTo \n\
        obuild: $obuild \n\
        build_name: $build_name \n\
        subversion: $subversion \n\
        pass_number: $pass_number \n\
        heuristic: $heuristic \n\
        efence: $efence \n\
        saveConfigPerTest: $saveConfigPerTest \n\
        debugLevel: $debugLevel\n\
        lst: $lst\n\
        incrBuilds: $incrBuilds\n\
        rerun: $rerun\n\
        baseLine: $baseLine\n\
        stopWithphase: $stopWithPhase&#34;

    if { $marinerImagePath != &#34;&#34; } {
        append imageList &#34;$paramMarinerImage $marinerImagePath &#34;
    }
    if { $i386ImagePath != &#34;&#34; } {
        append imageList &#34;$paramI386Image $i386ImagePath &#34;
    }
    if { $aspenImagePath != &#34;&#34; } {
        append imageList &#34;$paramAspenImage $aspenImagePath &#34;
    }
    if { $cougarImagePath !=&#34;&#34; } {
        append imageList &#34;$paramCougarImage $cougarImagePath &#34;
    }
    if { $x480ImagePath !=&#34;&#34; } {
        append imageList &#34;$paramx480Image $x480ImagePath &#34;
    }
    if { $x870ImagePath !=&#34;&#34; } {
        append imageList &#34;$paramx870Image $x870ImagePath &#34;
    }
    if { $NWIImagePath !=&#34;&#34; } {
        append imageList &#34;$paramNWIImage $NWIImagePath &#34;
    }
    if { $viperImagePath !=&#34;&#34; } {
        append imageList &#34;$paramViperImage $viperImagePath &#34;
    }
    if { $jaguarImagePath !=&#34;&#34; } {
        append imageList &#34;$paramJaguarImage $jaguarImagePath &#34;
    }
    if { $olympicImagePath !=&#34;&#34; } {
        append imageList &#34;$paramOlympicImage $olympicImagePath &#34;
    }
    if { $voyagerImagePath !=&#34;&#34; } {
        append imageList &#34;$paramVoyagerImage $voyagerImagePath &#34;
    }

    if {$include == &#34;&#34; } { 
	set paramInclude &#34;&#34;  
    } else {
	set include \&#34;$include\&#34;  ;<span class="comment-line"># Make sure the list is quoted when passing</span>
    }
    if {$exclude == &#34;&#34; }  { 
	set paramExclude &#34;&#34;
    } else {
	set exclude \&#34;$exclude\&#34;  ;<span class="comment-line"># Make sure the list is quoted when passing</span>
    }
    if {$forstats == &#34;&#34; }  { 
	set paramForstats &#34;&#34;
    } else {
	set forstats \&#34;$forstats\&#34;  ;<span class="comment-line"># Make sure the list is quoted when passing</span>
    }

    if {$mailTo == &#34;&#34; }   { set paramMailTo &#34;&#34;}
    if {$download == &#34;&#34; } { set paramDownload &#34;&#34;}
    if {$obuild == &#34;&#34; } { set paramOBuild &#34;&#34;}

    set currentPlatform    [lindex $regplatform($platform) 0]
    set currentBlade       [lindex $regplatform($platform) 1]
    set currentCfg         [lindex $regplatform($platform) 2]
    set currentRegType     [lindex $regplatform($platform) 3]
    set currentRegSubType  [lindex $regplatform($platform) 4]


<span class="comment-line">#    set tag [exec cat CVS/Tag]</span>
<span class="comment-line">#    if {[regexp -nocase &#34;.*branch.*&#34; $tag] &amp;&amp; [regexp -nocase &#34;^g&#34; $currentCfg]} {</span>
<span class="comment-line">#      puts &#34;Starting from wrong location. Golden regression start from Trunk&#34;</span>
<span class="comment-line">#      exit</span>
<span class="comment-line">#    }</span>


    <span class="comment-line"># Select the virtual desktop based on the platform type</span>
    set vDesktop 1
    if {[regexp -nocase &#34;440&#34; $currentCfg]} {
        set vDesktop &#34;2&#34;
    } elseif {[regexp -nocase &#34;450&#34; $currentCfg]} {
        set vDesktop &#34;3&#34;
    } elseif {[regexp -nocase &#34;460&#34; $currentCfg]} {
        set vDesktop &#34;4&#34;
    } elseif {[regexp -nocase &#34;620&#34; $currentCfg]} {
        set vDesktop &#34;5&#34;
    } elseif {[regexp -nocase &#34;670&#34; $currentCfg]} {
        set vDesktop &#34;6&#34;
    } elseif {[regexp -nocase &#34;770|870&#34; $currentCfg]} {
        set vDesktop &#34;7&#34;
    } elseif {[regexp -nocase &#34;evere&#34; $currentCfg]} {
        set vDesktop &#34;8&#34;
    } elseif {[regexp -nocase &#34;man|asp|tri&#34; $currentCfg]} {
        set vDesktop &#34;9&#34;
    } elseif {[regexp -nocase &#34;690&#34; $currentCfg]} {
        set vDesktop &#34;10&#34;
    } elseif {[regexp -nocase &#34;vm&#34; $currentCfg]} {
        set vDesktop &#34;11&#34;
    } elseif {[regexp -nocase &#34;vpex&#34; $currentCfg]} {
        set vDesktop &#34;12&#34;
    } else {
        set vDesktop &#34;1&#34;
    }

<span class="comment-line">#    switch -regexp   $currentPlatform {</span>
<span class="comment-line">#        &#34;OldStackables&#34; {</span>
<span class="comment-line">#                     switch -regexp $currentCfg {</span>
<span class="comment-line">#                         &#34;150&#34; {set vDesktop &#34;8&#34; }</span>
<span class="comment-line">#                         &#34;350&#34; {set vDesktop &#34;9&#34; }</span>
<span class="comment-line">#                         &#34;650&#34; {set vDesktop &#34;10&#34; }</span>
<span class="comment-line">#                         &#34;250&#34; {set vDesktop &#34;11&#34; }</span>
<span class="comment-line">#                         &#34;450&#34; {set vDesktop &#34;12&#34; }</span>
<span class="comment-line">#                         default {set vDesktop &#34;1&#34; }</span>
<span class="comment-line">#                     }</span>
<span class="comment-line">#                 }</span>
<span class="comment-line">#        &#34;Genesis&#34;        {set vDesktop &#34;2&#34; }</span>
<span class="comment-line">#        &#34;ASPEN&#34;          {set vDesktop &#34;3&#34; }</span>
<span class="comment-line">#        &#34;Aspen&#34;          {set vDesktop &#34;3&#34; }</span>
<span class="comment-line">#        #&#34;OldStackables&#34;  {set vDesktop &#34;1&#34; }</span>
<span class="comment-line">#        &#34;OldStack&#34;       {set vDesktop &#34;5&#34; }</span>
<span class="comment-line">#        &#34;Voyager&#34;        {set vDesktop &#34;6&#34; }</span>
<span class="comment-line">#        &#34;NewStackables&#34;  {set vDesktop &#34;7&#34; }</span>
<span class="comment-line">#        &#34;NewStack&#34;       {set vDesktop &#34;8&#34; }</span>
<span class="comment-line">#        default          {set vDesktop &#34;1&#34; }</span>
<span class="comment-line">#    }</span>

    <span class="comment-line"># Execute FULL regression for each blade for this platform on this PC</span>
    <span class="comment-line"># We call runall_monitor.tcl</span>
    
    
    set cmdLine &#34;tclsh  mysqlRunall_monitor.tcl&#34;
    
    
    if {$currentRegType == &#34;&#34; } {
        set currentRegType &#34;functional&#34;
    }
    if {$currentRegSubType == &#34;&#34; } {
        set currentRegSubType &#34;standard&#34;
    }
    
    
    set xtermTitle &#34;$currentCfg \([string toupper $currentRegType] [string toupper $currentRegSubType]\) $currentPlatform $currentBlade [exec date]&#34;
    
    <span class="comment-line"># Add params to cmdLine</span>
    set cmdLine &#34;$cmdLine \
            $paramPlatformIndx $platform \
            $paramRegType $currentRegType \
            $paramRegSubType $currentRegSubType \
            $paramPlatform $currentPlatform \
            $paramBlade $currentBlade \
            $paramCfg $currentCfg \
            $paramDownload $download \
            $paramInclude $include \
            $paramExclude $exclude \
            $paramForstats $forstats \
            $paramMailTo $mailTo \
            $imageList \
            $paramOBuild $obuild \
            $paramBuildName $build_name \
            $paramSubVersion $subversion \
            $paramPassNumber $pass_number \
            $paramHeuristic $heuristic \
            $paramEfence $efence \
            $paramSaveConfigPerTest $saveConfigPerTest \
            $paramDebugLevel $debugLevel \
            $paramLst $lst \
            $paramincrBuilds $incrBuilds \
            $paramRerun  $rerun \
            $parambaseLine $baseLine\
            $paramstopWithPhase $stopWithPhase&#34;
           
    global XTERMTEST
    
    if {$XTERMTEST == 1} {
        set cmdLine &#34;ls -l&#34;
    }
    <span class="comment-line"># -----------------------------------------------------------------</span>
    <span class="comment-line">#        S T A R T   A N   X T E R M    A N D   E X E C   C M D</span>
    <span class="comment-line">#</span>
    <span class="comment-line"># Start an xterm on specified display and execute $currentCmd in </span>
    <span class="comment-line"># xterm window</span>
    <span class="comment-line"># Typically $currentCmd should be &#34;tclsh runall_monitor.tcl &lt;params&gt;&#34;</span>
    <span class="comment-line">#</span>
    <span class="comment-line"># -----------------------------------------------------------------</span>
    puts &#34;STARTING: $xtermTitle&#34;
     
    puts &#34;     CMD: $cmdLine&#34;
    <span class="comment-line">#  change to the correct main directory</span>
    send &#34;cd $autoPath/main\r&#34;	
    
    expect &#34;$regLogin@&#34;
    <span class="comment-line"># -----------------------------------------------------------------</span>
    <span class="comment-line">#  kstart is KDE windows manager specific command.  Prior to using</span>
    <span class="comment-line">#     the kstart command, the xterm command below was used.</span>
    <span class="comment-line">#</span>
    <span class="comment-line">#  send &#34;xterm -T \&#34;$xtermTitle\&#34; -bg white -fg black -geometry\</span>
    <span class="comment-line">#     +$xgeom+$ygeom -hold +wf -display $display -e $cmdLine &amp;\r&#34;</span>
    <span class="comment-line"># ------------------------------------------------------------------</span>
    puts &#34;the desktop is $vDesktop&#34;
    puts &#34;xtermTitle : $xtermTitle&#34;
    puts &#34;cmdLine : $cmdLine&#34;
    send &#34;kstart --display :1 --desktop $vDesktop gnome-terminal --title \&#34;$xtermTitle\&#34; --command '$cmdLine' &amp;\r&#34;
    expect &#34;$regLogin@&#34;
    

    ;<span class="comment-line"># TODO: Verify that the xterm actually started!</span>
    
    <span class="comment-line"># Set xterm geometry so all xterms don't sit on top of each other</span>
    incr xgeom 150
    incr ygeom 150
    
    <span class="comment-line"># Sleep x seconds between runs to stagger the DUT downloads</span>
    sleep $staggerDelay
} 


<span class="comment-line"># Default all platforms for a target regression PC.</span>
<strong><a name="::runRegAllLocalDoCommand_333">proc <a href="mysqlRunRegAllLocal.tcl-annot.html#::runRegAllLocalDoCommand">::runRegAllLocalDoCommand</a></a></strong><a name="::runRegAllLocalDoCommand"></a> { targetpc command } {

    global regplatform
    global autoScriptPath
    global regLogin
    global autoPath
    global DUT1_CONNECT
    global DUT2_CONNECT
    global DUT3_CONNECT
    global DUT4_CONNECT
    global DUT5_CONNECT
    global DUT1_IP
    global DUT2_IP
    global DUT3_IP
    global DUT4_IP
    global DUT5_IP
    global connectionTimeout
    global spawn_ids
    global numDUT
    set maxNumDUT 5

    set cfgPath &#34;./cfg&#34;
    puts &#34;Running the Do Command &#34; 
    <a name="::result_debug(2)"><a href="./loadConsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;runRegAllLocalDoCommand( targetpc: $targetpc $command )&#34;

    <span class="comment-line"># Execute unconfig for each blade for this platform on this PC</span>
    foreach testBlade [array names regplatform] {

	<span class="comment-line"># Parse out BD1,1 from regplatform(BD1,1) {config}</span>
	regexp (.*),(.*) $testBlade ignore targetPlatformPC index	

	<span class="comment-line"># Look for this PCs config only.</span>
	if {! [string match $targetPlatformPC $targetpc] } {
	    continue;
	}

	<span class="comment-line"># Config parameters from runReg.cfg for this platform</span>
	<span class="comment-line"># i.e. set regplatform(IPR,1) { Summit48si  Summit48Si ipr1s48si.cfg functional ipRoute1}</span>
	set currentCfg         [lindex $regplatform($testBlade) 2]
	
	;<span class="comment-line"># Clear out old DUT settings so we get correct numDut </span>
	for {set i 1} {$i &lt;= $maxNumDUT} {incr i} {
	    if { [info exists DUT${i}_CONNECT] } {
		unset DUT${i}_CONNECT
	    }
	}
	<span class="comment-line"># Source the current cfg</span>
	if [file exists $cfgPath/$currentCfg] {
	    catch {source $cfgPath/$currentCfg} reason
	} else {
	    <a name="::result_error(1)"><a href="./loadConsoles.tcl.html#::result_error_6">::result_error</a></a> &#34;ERROR: Config file:  $cfgPath/$currentCfg  does NOT exist&#34;
	    continue
	}

	set numDUT 0
	<span class="comment-line"># Determine number of DUTs</span>
	for {set i 1} {$i &lt;= $maxNumDUT} {incr i} {
	    if { [info exists DUT${i}_CONNECT] } {
		incr numDUT
	    }
	}
	
	<a name="::result_debug(3)"><a href="./loadConsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;numDuts: $numDUT&#34;
	<span class="comment-line"># Login to each DUT and unconfigure</span>
	for {set i 1} {$i &lt;= $numDUT} {incr i} {
	    set terminalIP [set DUT${i}_CONNECT]
	    puts &#34;IP $terminalIP&#34;
	    set whichDutNow $i

	    ;<span class="comment-line"># Login to a DUT</span>
	    if {[catch {Login $terminalIP} reason]} {
		<a name="::result_error(2)"><a href="./loadConsoles.tcl.html#::result_error_6">::result_error</a></a> &#34;LOGIN ERROR ($terminalIP): $reason&#34;
		set spawn_id $spawn_ids($terminalIP)
		wait
		set spawn_ids($terminalIP) &#34;INVALID&#34;
		continue
	    }
	    after 1000
	    switch $command {
		&#34;unconfig&#34; {
		    if {[catch {UnconfigSwAll 1} reason]} {
			<a name="::result_error(3)"><a href="./loadConsoles.tcl.html#::result_error_6">::result_error</a></a> &#34;UNCONFIG ERROR ($terminalIP): $reason&#34;
		    }
		}
		&#34;defDelete&#34; {
		    if {[catch {SendACmd &#34;config default del po all&#34;} reason]} {
			<a name="::result_error(4)"><a href="./loadConsoles.tcl.html#::result_error_6">::result_error</a></a> &#34;DEFAULT DELETE ERROR ($terminalIP): $reason&#34;
		    }
		}
	    }
	    set spawn_id $spawn_ids($terminalIP)
	    close 
	    wait
	    set spawn_ids($terminalIP) &#34;INVALID&#34;
	    
	}

    }
} 
</pre>
<hr>
<div class="index-selector">
	<a href="index_main.html#byfilename">file name</a> 
 | 
	<a href="index_main.html#byprocname">procedure name</a> 
 | 
	<a href="index_main.html#bycall">procedure call</a> 
 | 
	<a href="index_annot_full.html">annotation</a> 

<br>
<cite>File generated 2018-06-14 at 16:57.</cite>
</div>

</body>
</html>
