<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                       "http://www.w3.org/TR/html4/transitional.dtd">
<!-- Generated by TclDoc @@VERSION@@ -->
<html>
<head>
  <title>healthCheck.tcl</title>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <link rel="stylesheet" type="text/css" href="default.css">
</head>
<body class="src-html">
<div class="index-selector">
<!-- index for tcl source files -->
	Index by: 
	<a href="index_main.html#healthCheck.tcl">file name</a> | 
	<a href="index_main.html#byprocname">procedure name</a> | 
	<a href="index_main.html#bycall">procedure call</a> | 
	<a href="index_annot_full.html">annotation</a>

</div>
<hr>

<p><strong>healthCheck.tcl</strong>&nbsp;&nbsp;<span class="filetype-link">(<a href="healthCheck.tcl-annot.html">annotations</a> | <a href="healthCheck.tcl.txt">original source</a>)</span>
</p>
<pre class="src-code">
<span class="comment-line">#!/usr/bin/expect --</span>
load [lindex [glob &#34;/usr/lib/libexpect*so*&#34;] 0]

array set sysList [ list {10.210.1.211} {Linux-Alpine} \
                   {10.210.1.212} {Linux-BD1} \
                   {10.210.1.213} {Linux-BD2} \
                   {10.210.1.214} {Linux-Summit} \
                   {10.210.1.215} {Linux-Godzila} \
                   {10.210.1.216} {Linux-BT} \
                   {10.210.1.217} {Linux-IpRoute} \
                   {10.210.1.222} {Linux-10G} \
                   {10.255.56.20} {Linux-SnmpAuto} \
                   {10.255.56.21} {Linux-Snmp} \
                   {10.210.1.218} {Linux-CLI} ]

set numOfSystems [ array size sysList ]

set maxFileSize 1000000

set MIN_POLL_TIME 15
set MAX_POLL_TIME 120
set pollingTime 0

<span class="comment-line">#******************************************************************</span>
<span class="comment-line"># This procedure is used to check the health of a Linux PC.</span>
<span class="comment-line"># It will telnet to the specified IP address, login and then logout.</span>
<span class="comment-line"># Input: Ip address</span>
<span class="comment-line"># Output: ok/error</span>
<span class="comment-line">#*******************************************************************</span>
<strong><a name="::CheckHealth_30">proc <a href="healthCheck.tcl-annot.html#::CheckHealth">::CheckHealth</a></a></strong><a name="::CheckHealth"></a> { ip } {
   global fd_dbg
   <span class="comment-line">#set login &#34;root&#34;</span>
   <span class="comment-line">#set passwd &#34;extreme&#34;</span>
   set login &#34;autotest-sc&#34;
   set passwd &#34;glitterpen1&#34;
   set timeout 120
   set pid [spawn telnet $ip]
   expect -nocase &#34;login:&#34; { send &#34;$login\r&#34; } timeout {
              puts $fd_dbg &#34;[<a name="::GetTimeStr(1)"><a href="./healthCheck.tcl.html#::GetTimeStr_105">::GetTimeStr</a></a>] No answer from host: $ip&#34;
              retrun &#34;error&#34;
   }
   expect -nocase &#34;password:&#34; { send &#34;$passwd\r&#34; } timeout {
          puts $fd_dbg &#34;[<a name="::GetTimeStr(2)"><a href="./healthCheck.tcl.html#::GetTimeStr_105">::GetTimeStr</a></a>] No answer from host: $ip&#34;
          retrun &#34;error&#34;
   }
   expect &#34;$login@&#34;
   send &#34;logout\r&#34;
   close; wait
   return &#34;ok&#34;
}

<strong><a name="::SendEmail_52">proc <a href="healthCheck.tcl-annot.html#::SendEmail">::SendEmail</a></a></strong><a name="::SendEmail"></a> { ipList } {
   global sysList;
   global initialList;
   global currentList;
   global numOfSystems;

   set mailTo &#34;sqaauto@extremenetworks.com&#34;

   for { set i 0 } { $i &lt; $numOfSystems } { incr i } {
     set oldValue [ lindex $initialList $i ]
     set newValue [ lindex $currentList $i ]
     set ip [ lindex $ipList $i ]
     if { $oldValue == 0 &amp;&amp; $newValue == 1 } {
          set subject &#34;$sysList($ip) ($ip) NOT RESPONDING&#34;
          set body &#34;Please check the linux PC $sysList($ip) ($ip).\
                    Probably it got crashed!! &#34;
          exec /bin/mail -s &#34;$subject&#34; $mailTo &lt;&lt; &#34;$body &#34; &amp;        
     } 
     if { $oldValue == 1 &amp;&amp; $newValue == 0 } {
          set subject &#34;$sysList($ip) ($ip) is UP and RUNNING now&#34;
          set body &#34;Linux PC $sysList($ip) ($ip) is fixed.\
                    It's up and running.&#34;
          exec /bin/mail -s &#34;$subject&#34; $mailTo &lt;&lt; &#34;$body &#34; &amp;        
     }
     set initialList [ lreplace $initialList $i $i &#34;$newValue&#34; ]
   }
}

<strong><a name="::isSameList_80">proc <a href="healthCheck.tcl-annot.html#::isSameList">::isSameList</a></a></strong><a name="::isSameList"></a> { iList cList } {
   global fd_dbg
   global numOfSystems

   puts $fd_dbg &#34;Initial List : $iList CurrentList : $cList&#34;

   for { set i 0 } { $i &lt; $numOfSystems } { incr i } {
     set oldValue [ lindex $iList $i ]
     set newValue [ lindex $cList $i ]
     if { $oldValue != $newValue } {
        return &#34;false&#34;
     }
   }
  return &#34;true&#34;
}

<strong><a name="::isAnySystemDown_96">proc <a href="healthCheck.tcl-annot.html#::isAnySystemDown">::isAnySystemDown</a></a></strong><a name="::isAnySystemDown"></a> { sysList } {
   foreach entry $sysList {
     if { $entry == 1 } {
       return &#34;yes&#34;
     }
   }
   return &#34;no&#34; 
}

<strong><a name="::GetTimeStr_105">proc <a href="healthCheck.tcl-annot.html#::GetTimeStr">::GetTimeStr</a></a></strong><a name="::GetTimeStr"></a> { } {
   set sysTime [ clock seconds ]
   set date [clock format $sysTime -format %D]
   set time [clock format $sysTime -format %H:%M:%S]
   set tString [format &#34;%s:%s :&#34; $date $time]
   return $tString
}

for { set i 1 } { $i &lt;=$numOfSystems } { incr i } {
    lappend initialList &#34;0&#34;
    lappend currentList &#34;0&#34;
}
puts &#34;initial list = $initialList current list = $currentList&#34;
puts &#34;Number of systems being monitored = $numOfSystems&#34;

while { 1 } {
   set ipList &#34;&#34;
   if { [ catch { open &#34;healthCheck.txt&#34; w } fd ] } {
      puts &#34;Can't opne file : healthCheck.txt&#34;
      exit
   }
   
   if { [ catch { open &#34;healthCheck_debug.txt&#34; a+ } fd_dbg ] } {
      puts &#34;Can't opne file : healthCheck_error.txt&#34;
      exit
   } else {
       set fSize [file size &#34;healthCheck_debug.txt&#34;]
       if { $fSize &gt;= $maxFileSize } {
          seek $fd_dbg 0 start
       }     
   }
   puts $fd [format &#34;%-35s %-20s&#34; &#34;    MACHINE NAME&#34; &#34;HEALTH CHECK&#34;]
   puts $fd [format &#34;%-35s %-25s\n&#34; &#34; -----------------&#34; &#34;-------------&#34;]
   set idx 0
   foreach ip [ array names sysList ] {
      lappend ipList &#34;$ip&#34;
      puts $fd_dbg &#34;[<a name="::GetTimeStr(3)"><a href="./healthCheck.tcl.html#::GetTimeStr_105">::GetTimeStr</a></a>] Checking $sysList($ip) ($ip)&#34; 
      if { [ catch { set health [ <a name="::CheckHealth(1)"><a href="./healthCheck.tcl.html#::CheckHealth_30">::CheckHealth</a></a> $ip ] } ] } {
           puts $fd_dbg &#34;[<a name="::GetTimeStr(4)"><a href="./healthCheck.tcl.html#::GetTimeStr_105">::GetTimeStr</a></a>] Host: $ip unreachable!!&#34;
           set health &#34;error&#34;
       }
      if { $health == &#34;ok&#34; } {
           puts $fd [format &#34;%-35s %-30s\n&#34; &#34;$sysList($ip) ($ip)&#34; &#34;GOOD&#34;]
           set currentList [ lreplace $currentList $idx $idx &#34;0&#34; ]
      } else {
           puts $fd [format &#34;%-35s %-25s\n&#34; &#34;$sysList($ip) ($ip)&#34; &#34;NOT RESPONDING&#34;]
           set currentList [ lreplace $currentList $idx $idx &#34;1&#34; ]
      }
     incr idx
   }
   puts $fd_dbg &#34;IP List = $ipList&#34;
   set ret [ <a name="::isSameList(1)"><a href="./healthCheck.tcl.html#::isSameList_80">::isSameList</a></a> $initialList $currentList ]
   if { $ret == &#34;false&#34; } {
       <a name="::SendEmail(1)"><a href="./healthCheck.tcl.html#::SendEmail_52">::SendEmail</a></a> $ipList
   } 

   set status [ <a name="::isAnySystemDown(1)"><a href="./healthCheck.tcl.html#::isAnySystemDown_96">::isAnySystemDown</a></a> $currentList ] 
   if { $status == &#34;yes&#34; } {
        set pollingTime $MIN_POLL_TIME
   } else {
        set pollingTime $MAX_POLL_TIME
   }

  set freq [expr $pollingTime*60]
  set currTime [ clock second ]
  set nextTime [ expr $currTime + $freq ]
  puts $fd_dbg &#34;\n\n[<a name="::GetTimeStr(5)"><a href="./healthCheck.tcl.html#::GetTimeStr_105">::GetTimeStr</a></a>] Waiting for next health check cycle to start ...&#34;
  puts $fd_dbg &#34;[<a name="::GetTimeStr(6)"><a href="./healthCheck.tcl.html#::GetTimeStr_105">::GetTimeStr</a></a>] Next health check time : [clock format $nextTime]&#34;
  puts &#34;\n\nWaiting for next health check cycle to start ...&#34;
  puts &#34;Next health check time : [clock format $nextTime]&#34;
  close $fd
  close $fd_dbg
  unset ipList
  set sleepTime $freq
  while {$freq} {
        puts -nonewline &#34;Sleeping $freq of $sleepTime seconds    \r&#34;
        flush stdout
        incr freq -1
        after 1000
    }
}


</pre>
<hr>
<div class="index-selector">
	<a href="index_main.html#byfilename">file name</a> 
 | 
	<a href="index_main.html#byprocname">procedure name</a> 
 | 
	<a href="index_main.html#bycall">procedure call</a> 
 | 
	<a href="index_annot_full.html">annotation</a> 

<br>
<cite>File generated 2018-06-14 at 17:00.</cite>
</div>

</body>
</html>
