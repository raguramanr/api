<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                       "http://www.w3.org/TR/html4/transitional.dtd">
<!-- Generated by TclDoc @@VERSION@@ -->
<html>
<head>
  <title>clicheck.tcl</title>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <link rel="stylesheet" type="text/css" href="default.css">
</head>
<body class="src-html">
<div class="index-selector">
<!-- index for tcl source files -->
	Index by: 
	<a href="index_main.html#clicheck.tcl">file name</a> | 
	<a href="index_main.html#byprocname">procedure name</a> | 
	<a href="index_main.html#bycall">procedure call</a> | 
	<a href="index_annot_full.html">annotation</a>

</div>
<hr>

<p><strong>clicheck.tcl</strong>&nbsp;&nbsp;<span class="filetype-link">(<a href="clicheck.tcl-annot.html">annotations</a> | <a href="clicheck.tcl.txt">original source</a>)</span>
</p>
<pre class="src-code">

<strong><a name="::::CLICheck_2">proc <a href="clicheck.tcl-annot.html#::::CLICheck">::::CLICheck</a></a></strong> {fileList index dummy1 dummy2} {

   <span class="comment-line">################################################################</span>
   set testNo &#34;CLICheck&#34;;
   set title &#34;CLI Save/Reboot and Upload/Download Config Check&#34;;
   <span class="comment-line">################################################################</span>

   <span class="comment-line"># ----- Test variables setup</span>
   set fd_res [<a name="::open_result_file(1)"><a href="./result.tcl.html#::open_result_file_276">::open_result_file</a></a> &#34;$testNo&#34;];
   set time1 [clock seconds];

   result_h1 &#34;$title&#34;;
   <a name="::report_start_test(1)"><a href="./report.tcl.html#::report_start_test_79">::report_start_test</a></a> &#34;$title&#34;;

   global DUT1_CONNECT;
   global DUT1_SETUP;
   global DUTs_info;
   global moduleRegression;
   global optionalFlag;
   global tftpServerList;
   global switchPort2DefaultRouter

   <a name="::Login(1)"><a href="./login.tcl.html#::Login_24">::Login</a></a> $DUT1_CONNECT;

   set time2 [clock seconds];
   result_p &#34;*** Time for $testNo = [expr $time2-$time1] secs\n\n&#34;;
   <a name="::close_result_file(1)"><a href="./result.tcl.html#::close_result_file_363">::close_result_file</a></a>;
   <a name="::report_end_test(1)"><a href="./report.tcl.html#::report_end_test_122">::report_end_test</a></a>;

   set path &#34;../../cli-ew/$moduleRegression&#34;;
   puts &#34;DEBUG: fileList: $fileList&#34;
   set fileList [split $fileList &#34;\n&#34;];
   puts &#34;DEBUG: fileList: $fileList&#34;;
   set firstFile	true
   foreach line $fileList {
<span class="comment-line">#      set filename1 [string trimleft $filename &#34; &#34;];</span>
<span class="comment-line">#      set filename [string trimleft $filename1 &#34;\t&#34;];</span>
      regsub -all &#34;\t&#34; $line &#34; &#34; line
      regsub -all &#34;;&#34; $line &#34; &#34; line
      regsub -all &#34; +&#34; $line &#34; &#34; line
      set line [string trimleft $line &#34; &#34;];
      set filename [lindex [split $line &#34; &#34;] 0];
      puts &#34;DEBUG: filename: $filename&#34;;
      if {$filename == &#34;&#34; || [string index $filename 0] == &#34;#&#34;} {
          continue;
      }
      set fn &#34;$path/$filename.cli&#34;;
   
      puts &#34;filename: &lt;$fn&gt;&#34;;
      <span class="comment-line">#puts &#34;index $index&#34;;</span>
      puts &#34;***************** PWD: [pwd]  fn: $fn *****************&#34;
if { 1 } {
      set CLIList [<a name="::LoadCLIFile(1)"><a href="./CLIFileParser.tcl.html#::LoadCLIFile_11">::LoadCLIFile</a></a> $fn];
      set listLength [llength $CLIList];  
      if {$listLength == 0} { continue; }
      set xos_version [<a name="::::cliGetVersion(1)"><a href="./upgradecheck.tcl.html#::::cliGetVersion_865">::::cliGetVersion</a></a> DUT1 4]
      set firstLine [lindex $CLIList 0];
      if {[<a name="::CheckSkipVersion(1)"><a href="./CLIFileParser.tcl.html#::CheckSkipVersion_312">::CheckSkipVersion</a></a> $firstLine $xos_version]} { 
          puts &#34;DEBUG: $filename.cli skipped - $xos_version in $firstLine&#34;;
          continue; 
      }

      set fd_res1 [<a name="::open_result_file(2)"><a href="./result.tcl.html#::open_result_file_276">::open_result_file</a></a> &#34;$filename&#34;];      
      set time1 [clock seconds];

      set testcaseNo &#34;$filename&#34;;
      <span class="comment-line">################################################</span>
      set subTest &#34;$moduleRegression $filename&#34;;
      <span class="comment-line">################################################</span>
      result_h2 &#34;$subTest&#34;;
      <a name="::report_start_test(2)"><a href="./report.tcl.html#::report_start_test_79">::report_start_test</a></a> &#34;$subTest&#34;;
      
<span class="comment-line">#      RunSetupScript $DUT1_CONNECT $DUT1_SETUP;</span>
<span class="comment-line">#      if { $firstFile == &#34;false&#34; } { UnconfigSwAll }</span>
<span class="comment-line"># --- no unconfig sw all in cli cfg files, always unconfig sw all automatically</span>
      <a name="::UnconfigSwAll(1)"><a href="./SendSwCmd.tcl.html#::UnconfigSwAll_1628">::UnconfigSwAll</a></a>;
      for {set i 1} {$i &lt;= 3} {incr i} {
         <a name="::SendACmd(1)"><a href="./SendSwCmd.tcl.html#::SendACmd_157">::SendACmd</a></a> &#34;config default delete port all&#34;
         <a name="::SendACmd(2)"><a href="./SendSwCmd.tcl.html#::SendACmd_157">::SendACmd</a></a> &#34;disable clipaging&#34;
        <span class="comment-line"># EnableDebugMode</span>
        <span class="comment-line"># SendACmd &#34;!echo dump_stack &gt; /sys/module/watchdog/parameters/watchdog_warn_behavior&#34;</span>
         <span class="comment-line"># --- if the network port is mgmt, make sure it is up</span>
         if {![regexp -nocase $switchPort2DefaultRouter &#34;mgmt&#34;]} {
            break;
         }
         if { [<a name="::::isMgmtPortUp(1)"><a href="./upgradecheck.tcl.html#::::isMgmtPortUp_743">::::isMgmtPortUp</a></a>] == &#34;ok&#34; } { break }
         <a name="::UnconfigSwAll(2)"><a href="./SendSwCmd.tcl.html#::UnconfigSwAll_1628">::UnconfigSwAll</a></a>
      }

      <span class="comment-line"># --- for mariner platforms, set up User VR first</span>
      if { 1 } {
         global gnssPlatform
         set gnssPlatform &#34;BD-10808|mariner|olympic&#34;;
<span class="comment-line">#         set gnssPlatform &#34;olympic&#34;;</span>
      }
      global gnssPlatform
      if {[regexp -nocase &#34;$gnssPlatform&#34; [<a name="::GetPlatform(1)"><a href="./misc.tcl.html#::GetPlatform_478">::GetPlatform</a></a> DUT1]] &amp;&amp;
          $moduleRegression != &#34;vr&#34;} {
         set rebootuploadNo &#34;$testcaseNo.0&#34;;
         <span class="comment-line">################################################</span>
         set subTest &#34;$rebootuploadNo Setup User VR First&#34;;
         <span class="comment-line">################################################</span>
         result_h2 &#34;$subTest&#34;;
         <a name="::report_start_test(3)"><a href="./report.tcl.html#::report_start_test_79">::report_start_test</a></a> &#34;$subTest&#34;;
         global DUT1_DefaultBlade
         global DUTs_info
        
         set userVR &#34;vr-user&#34;;
         lappend parameterList &#34;{Ports available: } 1&#34;;
         set ports [<a name="::GetKeyValue(1)"><a href="./OptionCheck.tcl.html#::GetKeyValue_438">::GetKeyValue</a></a> &#34;show slot $DUT1_DefaultBlade&#34; $parameterList];
         unset parameterList;
         <a name="::SendACmd(3)"><a href="./SendSwCmd.tcl.html#::SendACmd_157">::SendACmd</a></a> &#34;config vr vr-default delete ports ${DUT1_DefaultBlade}:1-$ports&#34;;
         <a name="::SendACmd(4)"><a href="./SendSwCmd.tcl.html#::SendACmd_157">::SendACmd</a></a> &#34;create virtual-router $userVR&#34;;
         <a name="::SendACmd(5)"><a href="./SendSwCmd.tcl.html#::SendACmd_157">::SendACmd</a></a> &#34;config vr vr-user add ports ${DUT1_DefaultBlade}:1-$ports&#34;;
         <a name="::SendACmd(6)"><a href="./SendSwCmd.tcl.html#::SendACmd_157">::SendACmd</a></a> &#34;config vr vr-user add protocol bgp&#34;;
         <a name="::SendACmd(7)"><a href="./SendSwCmd.tcl.html#::SendACmd_157">::SendACmd</a></a> &#34;config vr vr-user add protocol ospf&#34;;
         <a name="::SendACmd(8)"><a href="./SendSwCmd.tcl.html#::SendACmd_157">::SendACmd</a></a> &#34;config vr vr-user add protocol pim&#34;;
         <a name="::SendACmd(9)"><a href="./SendSwCmd.tcl.html#::SendACmd_157">::SendACmd</a></a> &#34;config vr vr-user add protocol rip&#34;;
         <a name="::SendACmd(10)"><a href="./SendSwCmd.tcl.html#::SendACmd_157">::SendACmd</a></a> &#34;virtual-router $userVR&#34;;
         set DUTs_info(UserVR) &#34;$userVR&#34;;
         lappend parameterList &#34;{vr-user *.* +$ports +bopr} exist&#34;;
         <a name="::CheckKeyValue(1)"><a href="./OptionCheck.tcl.html#::CheckKeyValue_47">::CheckKeyValue</a></a> &#34;show virtual-router&#34; $parameterList \
                -comment &#34;User VR vr-user created with bgp, ospf, pim and rip protocols&#34;;
         unset parameterList;
         <span class="comment-line"># --- need to reload cli file</span>
         set CLIList [<a name="::LoadCLIFile(2)"><a href="./CLIFileParser.tcl.html#::LoadCLIFile_11">::LoadCLIFile</a></a> $fn];
         <a name="::report_end_test(2)"><a href="./report.tcl.html#::report_end_test_122">::report_end_test</a></a>
      }
      set firstFile	false
      <span class="comment-line"># get the start_session here   </span>
      <span class="comment-line"># parse CLIList</span>
      set s 0;
      set lngth 0;
      while {1} {
          set retparameters [<a name="::::Start_Session_Parser(1)"><a href="./upgradecheck.tcl.html#::::Start_Session_Parser_594">::::Start_Session_Parser</a></a> $CLIList $lngth];          
          <span class="comment-line">#result_debug &#34;---&gt; [lindex $retparameters 0]&#34;;</span>
          <span class="comment-line">#result_debug &#34;---&gt; [lindex $retparameters 1]&#34;;      </span>
          set lngth [lindex $retparameters 1];
          set CLISession [lindex $retparameters 0];         
          if {$lngth == &#34;NO_DATA&#34;} {
              break;
          }
          
          incr s;
          set rebootuploadNo &#34;$testcaseNo.$s&#34;;
          <span class="comment-line">################################################</span>
          set subTest &#34;$rebootuploadNo Executing commands and check CLI outputs before save and reboot&#34;;
          <span class="comment-line">################################################</span>
          result_h2 &#34;$subTest&#34;;
          <a name="::report_start_test(4)"><a href="./report.tcl.html#::report_start_test_79">::report_start_test</a></a> &#34;$subTest&#34;;
                  
          if {[regexp -nocase &#34;NO_REBOOT&#34; $optionalFlag] &amp;&amp; 
	      [regexp -nocase &#34;NO_DOWNLOAD&#34; $optionalFlag] } {
             <a name="::RunCommandAndCheck(1)"><a href="./CLIParser.tcl.html#::RunCommandAndCheck_406">::RunCommandAndCheck</a></a> $CLISession $rebootuploadNo &#34;firstlast&#34;;
	  } else {
             <a name="::RunCommandAndCheck(2)"><a href="./CLIParser.tcl.html#::RunCommandAndCheck_406">::RunCommandAndCheck</a></a> $CLISession $rebootuploadNo &#34;first&#34;;
	  }
      
          <a name="::report_end_test(3)"><a href="./report.tcl.html#::report_end_test_122">::report_end_test</a></a>;

          if {![regexp -nocase &#34;NO_REBOOT&#34; $optionalFlag] } {
             <a name="::CheckReboot(1)"><a href="./SendSwCmd.tcl.html#::CheckReboot_1202">::CheckReboot</a></a>;   
             if {[regexp -nocase &#34;$gnssPlatform&#34; [<a name="::GetPlatform(2)"><a href="./misc.tcl.html#::GetPlatform_478">::GetPlatform</a></a> DUT1]] &amp;&amp;
                $moduleRegression != &#34;vr&#34;} {
                <a name="::SendACmd(11)"><a href="./SendSwCmd.tcl.html#::SendACmd_157">::SendACmd</a></a> &#34;virtual-router $userVR&#34;;
             }
	     sleep 20
             incr s;
             set rebootuploadNo &#34;$testcaseNo.$s&#34;;
                
             <span class="comment-line">################################################</span>
             set subTest &#34;$rebootuploadNo Checking CLI outputs after save and reboot&#34;;
             <span class="comment-line">################################################</span>
             result_h2 &#34;$subTest&#34;;
             <a name="::report_start_test(5)"><a href="./report.tcl.html#::report_start_test_79">::report_start_test</a></a> &#34;$subTest&#34;;

	     if { $optionalFlag == &#34;NO_DOWNLOAD&#34; } {
                <a name="::RunCommandAndCheck(3)"><a href="./CLIParser.tcl.html#::RunCommandAndCheck_406">::RunCommandAndCheck</a></a> $CLISession $rebootuploadNo &#34;secondlast&#34;;
             } else {
if { 1 } {
                <a name="::RunCommandAndCheck(4)"><a href="./CLIParser.tcl.html#::RunCommandAndCheck_406">::RunCommandAndCheck</a></a> $CLISession $rebootuploadNo &#34;second&#34;;
} else {
                <a name="::RunCommandAndCheck(5)"><a href="./CLIParser.tcl.html#::RunCommandAndCheck_406">::RunCommandAndCheck</a></a> $CLISession $rebootuploadNo &#34;secondlast&#34;;
}
	     }
             <a name="::report_end_test(4)"><a href="./report.tcl.html#::report_end_test_122">::report_end_test</a></a>;
          }      

if { 1 } {
          if {![regexp -nocase &#34;NO_DOWNLOAD&#34; $optionalFlag] } {
             set tmpTime [clock seconds];
             incr s;
             set rebootuploadNo &#34;$testcaseNo.$s&#34;;  
             <span class="comment-line">################################################</span>
             set subTest &#34;$rebootuploadNo Checking CLI outputs after upload and download config&#34;;
             <span class="comment-line">################################################</span>
             result_h2 &#34;$subTest&#34;;
             <a name="::report_start_test(6)"><a href="./report.tcl.html#::report_start_test_79">::report_start_test</a></a> &#34;$subTest&#34;; 
             
             <a name="::Login(2)"><a href="./login.tcl.html#::Login_24">::Login</a></a> $DUT1_CONNECT;
	     set filename &#34;temp__${DUT1_CONNECT}_${tmpTime}.cfg&#34;;
             regsub -all { } $filename {_} filename;
             set tftpServer [<a name="::CheckUploadConfig(1)"><a href="./SendSwCmd.tcl.html#::CheckUploadConfig_1925">::CheckUploadConfig</a></a> $tftpServerList $filename];
             if {$tftpServer == &#34;error&#34;} {
                 <a name="::report_start_test(7)"><a href="./report.tcl.html#::report_start_test_79">::report_start_test</a></a> &#34;$rebootuploadNo.0.1 could not Upload&#34;;
                 <a name="::result_error(1)"><a href="./lconsoles.tcl.html#::result_error_6">::result_error</a></a> &#34;$rebootuploadNo.0.1 could not Upload&#34;;
                 <a name="::report_end_test(5)"><a href="./report.tcl.html#::report_end_test_122">::report_end_test</a></a>;
             } else {
                 <a name="::report_start_test(8)"><a href="./report.tcl.html#::report_start_test_79">::report_start_test</a></a> &#34;$rebootuploadNo.0.1 able to Upload&#34;;
                 <a name="::result_ok(1)"><a href="./lconsoles.tcl.html#::result_ok_9">::result_ok</a></a> &#34;$rebootuploadNo.0.1 able to Upload&#34;;
                 <a name="::report_end_test(6)"><a href="./report.tcl.html#::report_end_test_122">::report_end_test</a></a>;
             }
             set status [<a name="::CheckDownloadConfig(1)"><a href="./SendSwCmd.tcl.html#::CheckDownloadConfig_1046">::CheckDownloadConfig</a></a> $tftpServer $filename];
             if {$status == &#34;error&#34;} {
                 <a name="::report_start_test(9)"><a href="./report.tcl.html#::report_start_test_79">::report_start_test</a></a> &#34;$rebootuploadNo.0.2 could not Download&#34;;
                 <a name="::result_error(2)"><a href="./lconsoles.tcl.html#::result_error_6">::result_error</a></a> &#34;$rebootuploadNo.0.2 could not Download&#34;;
                 <a name="::report_end_test(7)"><a href="./report.tcl.html#::report_end_test_122">::report_end_test</a></a>;
             } else {
                 <a name="::report_start_test(10)"><a href="./report.tcl.html#::report_start_test_79">::report_start_test</a></a> &#34;$rebootuploadNo.0.2 able to Download&#34;;
		 <a name="::SendACmd(12)"><a href="./SendSwCmd.tcl.html#::SendACmd_157">::SendACmd</a></a> &#34;show switch&#34;
                 <a name="::result_ok(2)"><a href="./lconsoles.tcl.html#::result_ok_9">::result_ok</a></a> &#34;$rebootuploadNo.0.2 able to Download&#34;;
                 <a name="::report_end_test(8)"><a href="./report.tcl.html#::report_end_test_122">::report_end_test</a></a>;             
             }             
             sleep 30
             if {[regexp -nocase &#34;$gnssPlatform&#34; [<a name="::GetPlatform(3)"><a href="./misc.tcl.html#::GetPlatform_478">::GetPlatform</a></a> DUT1]] &amp;&amp;
                $moduleRegression != &#34;vr&#34;} {
                <a name="::SendACmd(13)"><a href="./SendSwCmd.tcl.html#::SendACmd_157">::SendACmd</a></a> &#34;virtual-router $userVR&#34;;
             }
<span class="comment-line">#             RunCommandAndCheck $CLISession $rebootuploadNo &#34;false&#34;;</span>
             <a name="::RunCommandAndCheck(6)"><a href="./CLIParser.tcl.html#::RunCommandAndCheck_406">::RunCommandAndCheck</a></a> $CLISession $rebootuploadNo &#34;thirdlast&#34;;
             <a name="::report_end_test(9)"><a href="./report.tcl.html#::report_end_test_122">::report_end_test</a></a>;
          }
}
          if {$lngth == 0} {   
              break;
          } else {
              incr lngth;
          }   
      } 
      <a name="::report_end_test(10)"><a href="./report.tcl.html#::report_end_test_122">::report_end_test</a></a>;
      set time2 [clock seconds]
      result_p &#34;*** Time for $testcaseNo = [expr $time2-$time1] secs\n\n&#34;
      <a name="::close_result_file(2)"><a href="./result.tcl.html#::close_result_file_363">::close_result_file</a></a>;         
   }
   }
}

<strong><a name="::::Start_Session_Parser_249">proc <a href="clicheck.tcl-annot.html#::::Start_Session_Parser">::::Start_Session_Parser</a></a></strong> {CLISessionList lngth} {

    set flag 0;
    if {[info exist buffer]} {unset buffer }
    set listLength [llength $CLISessionList];  
    <span class="comment-line">#puts &#34;listLength = $listLength&#34;;  </span>
    <span class="comment-line">#puts &#34;lngth = $lngth&#34;; </span>
    for {set i $lngth}  {$i &lt;= $listLength} {incr i} {
        set line [string tolower [lindex $CLISessionList $i]];
        set line [string trim $line];          
        if {[regexp -nocase &#34;end_session&#34; $line] } {
            set flag $i;
            break;  
        } elseif {[regexp -nocase &#34;start_session&#34; $line] } {
            if {[info exist buffer]} {unset buffer }        
        } else {
            if {[string length $line]} {
                lappend buffer $line;
            }    
        }
    }    
    if {$lngth != 0} {
        if {[info exist buffer]} {
           lappend retval $buffer;
           lappend retval $flag;        
           return $retval;
        } else {
           lappend retval &#34;NO_DATA&#34;;
           lappend retval &#34;NO_DATA&#34;;        
           return $retval;       
        }
    } else {
        lappend retval $buffer;
        lappend retval $flag;        
        return $retval;
    }    
}
</pre>
<hr>
<div class="index-selector">
	<a href="index_main.html#byfilename">file name</a> 
 | 
	<a href="index_main.html#byprocname">procedure name</a> 
 | 
	<a href="index_main.html#bycall">procedure call</a> 
 | 
	<a href="index_annot_full.html">annotation</a> 

<br>
<cite>File generated 2018-06-14 at 17:09.</cite>
</div>

</body>
</html>
