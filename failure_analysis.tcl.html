<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                       "http://www.w3.org/TR/html4/transitional.dtd">
<!-- Generated by TclDoc @@VERSION@@ -->
<html>
<head>
  <title>failure_analysis.tcl</title>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <link rel="stylesheet" type="text/css" href="default.css">
</head>
<body class="src-html">
<div class="index-selector">
<!-- index for tcl source files -->
	Index by: 
	<a href="index_main.html#failure_analysis.tcl">file name</a> | 
	<a href="index_main.html#byprocname">procedure name</a> | 
	<a href="index_main.html#bycall">procedure call</a> | 
	<a href="index_annot_full.html">annotation</a>

</div>
<hr>

<p><strong>failure_analysis.tcl</strong>&nbsp;&nbsp;<span class="filetype-link">(<a href="failure_analysis.tcl-annot.html">annotations</a> | <a href="failure_analysis.tcl.txt">original source</a>)</span>
</p>
<pre class="src-code">
<span class="comment-line"># ----------------------------------------------------------------------------</span>
<span class="comment-line"># proc _analyzeFailure</span>
<span class="comment-line">#</span>
<span class="comment-line"># First level call upon any failure.  This is defined dynamically in result.tcl</span>
<span class="comment-line">#    fmt_add as part of the result_error proc.</span>
<span class="comment-line">#    Anytime result_error is called this proc will be executed.</span>
<span class="comment-line">#</span>
<span class="comment-line"># In args: none</span>
<span class="comment-line">#</span>
<span class="comment-line">#</span>
<span class="comment-line"># ----------------------------------------------------------------------------</span>
<strong><a name="::::_analyzeFailure_12">proc <a href="failure_analysis.tcl-annot.html#::::_analyzeFailure">::::_analyzeFailure</a></a></strong> {txt} {
    global MAIN DUTs_info ANALYZE

    set caller [<a name="::::PreProcName(1)"><a href="./tpbMainLib.tcl.html#::::PreProcName_287">::::PreProcName</a></a>]
    set me [<a name="::::GetCurrentProcName(1)"><a href="./tpbMainLib.tcl.html#::::GetCurrentProcName_278">::::GetCurrentProcName</a></a>]
    set callStack [<a name="::::ProcEvalTree(1)"><a href="./tpbMainLib.tcl.html#::::ProcEvalTree_295">::::ProcEvalTree</a></a>]
    set hitError [<a name="::_getAnalyzeCaller(1)"><a href="./failure_analysis.tcl.html#::_getAnalyzeCaller_191">::_getAnalyzeCaller</a></a>]
    <span class="comment-line">#puts &#34;_analyzeFailure I am $me called by $caller. $hitError failed. Tree is $callStack\n&#34;;</span>

    set ANALYZE(run) &#34;$hitError&#34;
    set MAIN(ANALYZESTATE) 1

}
<span class="comment-line"># ----------------------------------------------------------------------------</span>
<span class="comment-line"># proc _analyzer</span>
<span class="comment-line">#</span>
<span class="comment-line">#   In Args: -run = the procedure to run at any point in a script when</span>
<span class="comment-line">#                   a preceding error has occurred.</span>
<span class="comment-line">#</span>
<span class="comment-line">#</span>
<span class="comment-line">#</span>
<span class="comment-line">#</span>
<span class="comment-line"># ----------------------------------------------------------------------------</span>
<strong><a name="::::_analyzer_35">proc <a href="failure_analysis.tcl-annot.html#::::_analyzer">::::_analyzer</a></a></strong> {args} {
    global MAIN DUTS_info ANALYZE whichDutNow

    <a name="::parse_args(1)"><a href="./parse_args.tcl.html#::parse_args_29">::parse_args</a></a> _analyzer $args {
        run             &#34;null&#34;
        allshow         &#34;null&#34;
        more            &#34;false&#34;
        dut             &#34;null&#34;
        title           &#34;null&#34;
        imain           &#34;null&#34;
        report_color    &#34;red&#34;
        head_colors     &#34;default&#34;
        special_headers &#34;default&#34;
    }

    set caller [<a name="::::PreProcName(2)"><a href="./tpbMainLib.tcl.html#::::PreProcName_287">::::PreProcName</a></a>]
    set me [<a name="::::GetCurrentProcName(2)"><a href="./tpbMainLib.tcl.html#::::GetCurrentProcName_278">::::GetCurrentProcName</a></a>]
    set callStack [<a name="::::ProcEvalTree(2)"><a href="./tpbMainLib.tcl.html#::::ProcEvalTree_295">::::ProcEvalTree</a></a>]
    set orig $whichDutNow
    <span class="comment-line">#puts &#34;_analyzer I am $me called by $caller. Tree is $callStack\n&#34;;</span>
    <span class="comment-line">#puts &#34;I want to run $run&#34;</span>

    if {[info exists ANALYZE(run)] &amp;&amp; [string trim $ANALYZE(run)] != &#34;&#34;} {
        if {[info exists ANALYZE(bypass)] &amp;&amp; $ANALYZE(bypass)} {
            <a name="::result_debug(1)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;Skipping analyzer call to save time in production regression&#34;
            set ANALYZE(run) &#34;&#34;;
            set MAIN(ANALYZESTATE) 0
            return;
        }


        <span class="comment-line"># head_colors is a list of list, so use lappend when calling.</span>
        <span class="comment-line"># Setting the defaults here.</span>


        if {$head_colors == &#34;default&#34;} {
            lappend hcs &#34;h3 darkcyan&#34;
            lappend hcs &#34;debug darkred&#34;
            lappend hcs &#34;ok yellow&#34;
        } else {
            set hcs $head_colors
        }
        if {$special_headers == &#34;default&#34;} {
            lappend sphs &#34;h2 analyze darkmagenta&#34;;<span class="comment-line"># NOTE special headers are at the bottom of result_format.tcl</span>
        } else {
            set sphs $special_headers
        }
        <a name="::_swapAnalyzerColors(1)"><a href="./failure_analysis.tcl.html#::_swapAnalyzerColors_203">::_swapAnalyzerColors</a></a> -report_color $report_color -head_colors $hcs \
             -special_headers $sphs

        if {$title != &#34;null&#34;} {
            <a name="::result_debug(2)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;ANALYZER - $title&#34;
        }
        puts &#34;FOUND ANALYZE(run) = $ANALYZE(run)&#34;
        if {$run != &#34;null&#34;} {
            if {$dut != &#34;null&#34;} {
                global DUT${dut}_CONNECT
                <a name="::Login(1)"><a href="./login.tcl.html#::Login_24">::Login</a></a> [set DUT${dut}_CONNECT] -CheckOperational 0 -masterCheck 0;
            }
            if {[catch {eval $run} rea]} {
                if {$more == &#34;false&#34;} {
                    set ANALYZE(run) &#34;&#34;;
                }
                <a name="::result_debug(3)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;Could not execute the analysis proc: $rea&#34;
            }
            if {$dut != $orig} {
                global DUT${orig}_CONNECT
                <a name="::Login(2)"><a href="./login.tcl.html#::Login_24">::Login</a></a> [set DUT${orig}_CONNECT] -CheckOperational 0 -masterCheck 0;
            }
        }
        if {$allshow != &#34;null&#34;} {
            <a name="::_setShowOutput(1)"><a href="./SendSwCmd.tcl.html#::_setShowOutput_3101">::_setShowOutput</a></a> -screen off -log off -res_fmt off
            <span class="comment-line">#Create a proc for each DUT that will send the CLI                </span>
            for {set nDUT 1; global DUT${nDUT}_CONNECT} { [info exists DUT${nDUT}_CONNECT] } \
                                                     {incr nDUT ; global DUT${nDUT}_CONNECT} {
                set DUTs_info(DUT$nDUT,show_output) &#34;empty&#34;
                lappend mlist &#34;SendCmdList $nDUT \&#34;$allshow\&#34;&#34;
            }
            <a name="::MultiTask(1)"><a href="./multiTask.tcl.html#::MultiTask_39">::MultiTask</a></a> $mlist
            <a name="::_setShowOutput(2)"><a href="./SendSwCmd.tcl.html#::_setShowOutput_3101">::_setShowOutput</a></a> -screen on -log on -res_fmt on
            <a name="::::_printMultiTaskOutput(1)"><a href="./swConf.tcl.html#::::_printMultiTaskOutput_3651">::::_printMultiTaskOutput</a></a>;
            global DUT${orig}_CONNECT
            <a name="::Login(3)"><a href="./login.tcl.html#::Login_24">::Login</a></a> [set DUT${orig}_CONNECT] -CheckOperational 0 -masterCheck 0;
        }
        if {$more == &#34;false&#34;} {
            set ANALYZE(run) &#34;&#34;;
            set MAIN(ANALYZESTATE) 0
            <a name="::_swapAnalyzerColors(2)"><a href="./failure_analysis.tcl.html#::_swapAnalyzerColors_203">::_swapAnalyzerColors</a></a> -reset true
        }
        if {$imain != &#34;null&#34;} {
            <a name="::imain_prompt(1)"><a href="./iMainLib.tcl.html#::imain_prompt_98">::imain_prompt</a></a> -id $title
        }
    }
}
<span class="comment-line"># ----------------------------------------------------------------------------</span>
<span class="comment-line">#</span>
<span class="comment-line">#</span>
<span class="comment-line">#</span>
<span class="comment-line">#</span>
<span class="comment-line">#</span>
<span class="comment-line"># ----------------------------------------------------------------------------</span>
<strong><a name="::::SendCmdList_136">proc <a href="failure_analysis.tcl-annot.html#::::SendCmdList">::::SendCmdList</a></a></strong> {dut {clist}} {
    global DUT${dut}_CONNECT;
    global spawn_id fd_res


    set pid [pid]
    set fd_in [open &#34;/tmp/tmp_sendcmdlist_DUT${dut}$pid&#34; &#34;w&#34;]

    <a name="::Login(4)"><a href="./login.tcl.html#::Login_24">::Login</a></a> [set DUT${dut}_CONNECT] -CheckOperational 0 -masterCheck 0;
    foreach c $clist {
        <a name="::put_ansi_out(1)"><a href="./result.tcl.html#::put_ansi_out_533">::put_ansi_out</a></a> $fd_in debug $c
        <a name="::SendACmd(1)"><a href="./SendSwCmd.tcl.html#::SendACmd_157">::SendACmd</a></a> &#34;$c&#34; $fd_res $fd_in
    }
    close $fd_in;<span class="comment-line">#</span>

    <span class="comment-line"># -- Read in data for parsing</span>
    set fp [open &#34;/tmp/tmp_sendcmdlist_DUT${dut}$pid&#34; r]
    set show_data [read $fp]
    close $fp
    <span class="comment-line"># -- Delete the supporting files</span>
    catch {file delete -force /tmp/tmp_sendcmdlist_DUT${dut}$pid} oops;<span class="comment-line"># fd_in</span>
    <span class="comment-line">#</span>
    <span class="comment-line"># End Gathering data section</span>
    <span class="comment-line">#</span>

    <span class="comment-line"># --------- Save switch output for printing later -----------</span>
    set fd_so [open &#34;/tmp/${pid}_showout&#34; &#34;w&#34;]
    puts $fd_so &#34;set DUTs_info(DUT$dut,show_output) \{$show_data\}&#34;
    close $fd_so

}
<span class="comment-line"># ----------------------------------------------------------------------------</span>
<span class="comment-line"># proc _getCallingProc</span>
<span class="comment-line">#</span>
<span class="comment-line"># in arg - lvl = number of levels back</span>
<span class="comment-line">#               1 = who called me</span>
<span class="comment-line">#               2 = who called the proc that called me</span>
<span class="comment-line">#               etc.</span>
<span class="comment-line">#</span>
<span class="comment-line">#          Returns: the proc name.</span>
<span class="comment-line">#</span>
<span class="comment-line"># ----------------------------------------------------------------------------</span>
<strong><a name="::::_getCallingProcLevel_178">proc <a href="failure_analysis.tcl-annot.html#::::_getCallingProcLevel">::::_getCallingProcLevel</a></a></strong> {lvl} {
    set val [expr $lvl + 1]
    return [lindex [split [info level [expr [info level] - $val]]] 0]
}
<span class="comment-line"># ----------------------------------------------------------------------------</span>
<span class="comment-line"># proc _getAnalyzeCaller</span>
<span class="comment-line">#</span>
<span class="comment-line"># Args -    In = none</span>
<span class="comment-line">#           Out = returns proc one level above report_error that actually</span>
<span class="comment-line">#           caused the error</span>
<span class="comment-line">#</span>
<span class="comment-line">#</span>
<span class="comment-line"># ----------------------------------------------------------------------------</span>
<strong><a name="::::_getAnalyzeCaller_191">proc <a href="failure_analysis.tcl-annot.html#::::_getAnalyzeCaller">::::_getAnalyzeCaller</a></a></strong> {} {
    return [lindex [split [info level [expr [info level] - 3]]] 0]
}
<span class="comment-line"># ----------------------------------------------------------------------------</span>
<span class="comment-line"># proc _swapAnalyzerColors</span>
<span class="comment-line">#</span>
<span class="comment-line">#</span>
<span class="comment-line">#</span>
<span class="comment-line">#</span>
<span class="comment-line">#</span>
<span class="comment-line">#</span>
<span class="comment-line"># ----------------------------------------------------------------------------</span>
<strong><a name="::::_swapAnalyzerColors_203">proc <a href="failure_analysis.tcl-annot.html#::::_swapAnalyzerColors">::::_swapAnalyzerColors</a></a></strong> {args} {
    global MAIN ANALYZE HEADERFORMAT
    <a name="::parse_args(2)"><a href="./parse_args.tcl.html#::parse_args_29">::parse_args</a></a> _swapAnalyzerColors $args {
        report_color    &#34;null&#34;
        head_colors     &#34;null&#34;
        special_headers &#34;null&#34;
        reset           &#34;false&#34;
    }

    if {$reset != &#34;false&#34; &amp;&amp; [info exists ANALYZE(ALTEREDHEADERS)] &amp;&amp; \
                                        [llength ANALYZE(ALTEREDHEADERS)] &gt; 0} {
        foreach h $ANALYZE(ALTEREDHEADERS) {
            <a name="::fmt_add(1)"><a href="./result.tcl.html#::fmt_add_70">::fmt_add</a></a> $h $HEADERFORMAT($h,default)
        }
        if {[info exists MAIN(FA_REPORT_COLOR_ASCII)]} {
            unset MAIN(FA_REPORT_COLOR_ASCII)
        }
        return
    }

    if {$head_colors != &#34;null&#34;} {
        foreach elems $head_colors {
            set h [lindex $elems 0]
            set val [lindex $elems 1]
            <a name="::fmt_add(2)"><a href="./result.tcl.html#::fmt_add_70">::fmt_add</a></a> $h $HEADERFORMAT($h,default) $val
            lappend ANALYZE(ALTEREDHEADERS) $h
        }
    }
    if {$special_headers != &#34;null&#34;} {
        foreach elems $special_headers {
            set h [lindex $elems 0]
            set sname [lindex $elems 1]
            set val [lindex $elems 2]
            <a name="::fmt_add(3)"><a href="./result.tcl.html#::fmt_add_70">::fmt_add</a></a> $h $HEADERFORMAT($h,$sname) $val
            lappend ANALYZE(ALTEREDHEADERS) $h
        }
    }
    if {$report_color != &#34;null&#34;} {
        set MAIN(FA_REPORT_COLOR_ASCII) &#34;[<a name="::get_color_from_name(1)"><a href="./result.tcl.html#::get_color_from_name_628">::get_color_from_name</a></a> $report_color]&#34;
    }

}
</pre>
<hr>
<div class="index-selector">
	<a href="index_main.html#byfilename">file name</a> 
 | 
	<a href="index_main.html#byprocname">procedure name</a> 
 | 
	<a href="index_main.html#bycall">procedure call</a> 
 | 
	<a href="index_annot_full.html">annotation</a> 

<br>
<cite>File generated 2018-06-14 at 17:09.</cite>
</div>

</body>
</html>
