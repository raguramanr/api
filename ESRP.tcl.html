<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                       "http://www.w3.org/TR/html4/transitional.dtd">
<!-- Generated by TclDoc @@VERSION@@ -->
<html>
<head>
  <title>ESRP.tcl</title>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <link rel="stylesheet" type="text/css" href="default.css">
</head>
<body class="src-html">
<div class="index-selector">
<!-- index for tcl source files -->
	Index by: 
	<a href="index_main.html#ESRP.tcl">file name</a> | 
	<a href="index_main.html#byprocname">procedure name</a> | 
	<a href="index_main.html#bycall">procedure call</a> | 
	<a href="index_annot_full.html">annotation</a>

</div>
<hr>

<p><strong>ESRP.tcl</strong>&nbsp;&nbsp;<span class="filetype-link">(<a href="ESRP.tcl-annot.html">annotations</a> | <a href="ESRP.tcl.txt">original source</a>)</span>
</p>
<pre class="src-code">

<span class="comment-line">##################################################################</span>
<span class="comment-line"># Description:</span>
<span class="comment-line">#     Check if it is ESRP Hello packet</span>
<span class="comment-line">#</span>
<span class="comment-line"># Input args: rawFrame</span>
<span class="comment-line"># Output args: </span>
<span class="comment-line"># Typical usage:</span>
<span class="comment-line">#</span>
<span class="comment-line">##################################################################</span>
<strong><a name="::::IsESRPHelloMessage_11">proc <a href="ESRP.tcl-annot.html#::::IsESRPHelloMessage">::::IsESRPHelloMessage</a></a></strong> {rawFrame} {

    set destmac [string range $rawFrame 0 16];
    if {$destmac == &#34;00 E0 2B 00 00 02&#34;} {
        return &#34;ESRP_HELLO_MESSAGE&#34;;    
    } else {
        return &#34;NOT_ESRP_HELLO_MESSAGE&#34;;
    }    
}

<span class="comment-line">##################################################################</span>
<span class="comment-line"># Description:</span>
<span class="comment-line">#     Request for the option type field</span>
<span class="comment-line">#</span>
<span class="comment-line"># Input args: rawFrame and type</span>
<span class="comment-line"># Output args: offset field</span>
<span class="comment-line"># Typical usage:</span>
<span class="comment-line">#</span>
<span class="comment-line">##################################################################</span>
<strong><a name="::::GetESRPHelloMessageOption_30">proc <a href="ESRP.tcl-annot.html#::::GetESRPHelloMessageOption">::::GetESRPHelloMessageOption</a></a></strong> {rawFrame type} {

    set destmac [string range $rawFrame 0 16];
    if {$destmac == &#34;00 E0 2B 00 00 02&#34;} {    
        switch -- $type \
        &#34;dmac&#34; {
            set val [string range $rawFrame 0 16];
        } &#34;smac&#34; {
            set val [string range $rawFrame 18 34];                        
        } &#34;group&#34; {
            set val [string range $rawFrame 126 130];
        } &#34;priority&#34; {
            set val [string range $rawFrame 132 136];            
        } &#34;state&#34; {
            set val [string range $rawFrame 138 142];    
        } &#34;activeport&#34; {
            set val [string range $rawFrame 144 148];  
        } &#34;ipaddress&#34; {
            set val [string range $rawFrame 150 160]; 
        } &#34;systemmac&#34; {
            set val [string range $rawFrame 162 178];                            
        } &#34;timer&#34; {
            set val [string range $rawFrame 180 184];  
        } &#34;trackport&#34; {
            set val [string range $rawFrame 186 190];                                            
        } default {
            set val &#34;NO_OPTION&#34;;
        }                  
        return $val;
          
    } else {
        return &#34;NOT_ESRP_HELLO_MESSAGE&#34;;
    }   
    
}

<strong><a name="::::GetMasterSlaveIP1_66">proc <a href="ESRP.tcl-annot.html#::::GetMasterSlaveIP1">::::GetMasterSlaveIP1</a></a></strong> {vname sw1 sw2 fd_res} {

    <span class="comment-line"># ----- Environment variables setup</span>
    global DUT1_CONNECT;
    global DUT2_CONNECT;
    global DUT3_CONNECT;
    global DUT4_CONNECT;
    
    set x $sw1;
    set y $sw2;
    append x &#34;_CONNECT&#34;;
    append y &#34;_CONNECT&#34;;
    set connect1 [set $x];
    set connect2 [set $y];    
    set retval &#34;NONE&#34;;
    lappend parameterList &#34;{$vname } 4&#34;;
    <a name="::Login(1)"><a href="./login.tcl.html#::Login_24">::Login</a></a> $connect1
    set val1 [<a name="::GetKeyValue(1)"><a href="./OptionCheck.tcl.html#::GetKeyValue_438">::GetKeyValue</a></a> &#34;show esrp&#34; $parameterList];
    <a name="::Login(2)"><a href="./login.tcl.html#::Login_24">::Login</a></a> $connect2
    set val2 [<a name="::GetKeyValue(2)"><a href="./OptionCheck.tcl.html#::GetKeyValue_438">::GetKeyValue</a></a> &#34;show esrp&#34; $parameterList];
    if {($val1 == &#34;Master&#34;) &amp;&amp; ($val2 == &#34;Slave&#34;)} {
        set retval $sw1;
    } elseif {($val1 == &#34;Slave&#34;) &amp;&amp; ($val2 == &#34;Master&#34;)} {   
        set retval $sw2;
    }
    unset parameterList;
    
    return $retval;
}

<strong><a name="::::GetMasterSlaveIP2_96">proc <a href="ESRP.tcl-annot.html#::::GetMasterSlaveIP2">::::GetMasterSlaveIP2</a></a></strong> {vname sw1 sw2 sw3 fd_res} {

    <span class="comment-line"># ----- Environment variables setup</span>
    global DUT1_CONNECT;
    global DUT2_CONNECT;
    global DUT3_CONNECT;
    global DUT4_CONNECT;
    global DUT5_CONNECT;
        
    set x $sw1;
    set y $sw2;
    set z $sw3;    
    append x &#34;_CONNECT&#34;;
    append y &#34;_CONNECT&#34;;
    append z &#34;_CONNECT&#34;;    
    set connect1 [set $x];
    set connect2 [set $y]; 
    set connect3 [set $z];          
    set retval &#34;NONE&#34;;
    lappend parameterList &#34;{$vname } 4&#34;;
    <a name="::Login(3)"><a href="./login.tcl.html#::Login_24">::Login</a></a> $connect1
    set val1 [<a name="::GetKeyValue(3)"><a href="./OptionCheck.tcl.html#::GetKeyValue_438">::GetKeyValue</a></a> &#34;show esrp&#34; $parameterList];
    <a name="::Login(4)"><a href="./login.tcl.html#::Login_24">::Login</a></a> $connect2
    set val2 [<a name="::GetKeyValue(4)"><a href="./OptionCheck.tcl.html#::GetKeyValue_438">::GetKeyValue</a></a> &#34;show esrp&#34; $parameterList];
    <a name="::Login(5)"><a href="./login.tcl.html#::Login_24">::Login</a></a> $connect3
    set val3 [<a name="::GetKeyValue(5)"><a href="./OptionCheck.tcl.html#::GetKeyValue_438">::GetKeyValue</a></a> &#34;show esrp&#34; $parameterList]; 
    unset parameterList;      
    lappend ret $val1;
    lappend ret $val2;
    lappend ret $val3;
    set m 0;
    set s 0;        
    foreach k $ret {
        if {$k == &#34;Master&#34;} {
            incr m;
        } elseif {$k == &#34;Slave&#34;} {
            incr s;
        }
    }
    unset ret;
    if {($m == 1) &amp;&amp; ($s == 2)} {
        if {$val1 == &#34;Master&#34;} {
            return $sw1;
        } elseif {$val2 == &#34;Master&#34;} {
            return $sw2;        
        } elseif {$val3 == &#34;Master&#34;} {
            return $sw3;        
        } else {
            return &#34;NONE&#34;;        
        }
    } else {
        return &#34;NONE&#34;;
    }
}

<strong><a name="::::GetHexNumber_151">proc <a href="ESRP.tcl-annot.html#::::GetHexNumber">::::GetHexNumber</a></a></strong> {number} {

    set nh [format &#34;%06X&#34; $number];
    set x1 [string range $nh 0 1];
    set x2 [string range $nh 2 3];
    set x3 [string range $nh 4 end];
    
    set val &#34;00:A1:11:&#34;;
    append val $x1;
    append val &#34;:&#34;;
    append val $x2;
    append val &#34;:&#34;;
    append val $x3;
    return $val;        
}

<span class="comment-line">##################################################################</span>
<span class="comment-line"># Description:</span>
<span class="comment-line">#     This proc can will check if the port is able to forwarding the</span>
<span class="comment-line">#     packets or not.</span>
<span class="comment-line">#</span>
<span class="comment-line"># Input args:</span>
<span class="comment-line">#            portn - port number to check</span>
<span class="comment-line">#            flag  - 1 means forwarding</span>
<span class="comment-line">#                    0 means not forwarding</span>
<span class="comment-line">#            dut   - DUT name (DUT1)</span>
<span class="comment-line">#            vlan  - vlan name</span>
<span class="comment-line">#</span>
<span class="comment-line"># Output args: None.</span>
<span class="comment-line">#</span>
<span class="comment-line"># Typical usage:</span>
<span class="comment-line"># CheckDisplayvpst &#34;3:1&#34; 1 &#34;DUT2&#34; &#34;vlanlink&#34;</span>
<span class="comment-line">#</span>
<span class="comment-line"># Category Types (SetupSwitch,GetSwitchInfo,SendTraffic,CaptureTraffic,</span>
<span class="comment-line">#                 SetupTestTool,VerifySwitchOutput,Utility,VerifyTraffic)</span>
<span class="comment-line"># Category: VerifySwitchOutput</span>
<span class="comment-line">##################################################################</span>
<strong><a name="::::CheckDisplayvpst_188">proc <a href="ESRP.tcl-annot.html#::::CheckDisplayvpst">::::CheckDisplayvpst</a></a></strong> {portn flag dut {<a name="::vlan(1)"><a href="./ePTClient.tcl.html#::vlan_772">::vlan</a></a> &#34;&#34;}} {
    set platform [<a name="::GetPlatform(1)"><a href="./misc.tcl.html#::GetPlatform_478">::GetPlatform</a></a> $dut];
    global gnssPlatform i386Platform bcmPlatform pioneerPlatform
    if {[regexp -nocase &#34;$gnssPlatform|$pioneerPlatform&#34; $platform]} {
        <a name="::report_start_test(1)"><a href="./report.tcl.html#::report_start_test_79">::report_start_test</a></a> &#34;CheckDisplayvpst $portn $flag $dut $vlan on $platform&#34;;
        lappend parameterList &#34;{$vlan } 1&#34;;
        set vid [<a name="::GetKeyValue(6)"><a href="./OptionCheck.tcl.html#::GetKeyValue_438">::GetKeyValue</a></a> &#34;show vlan&#34; $parameterList];
        unset parameterList;
	set ret [regexp {([0-9]+):([0-9]+)} $portn y slot port];
        lappend parameterList &#34;{(^| )$port=} 1&#34;;
        set ver [<a name="::GetVersion(1)"><a href="./misc.tcl.html#::GetVersion_303">::GetVersion</a></a> $dut];
        if {[<a name="::CompareRelease(1)"><a href="./misc.tcl.html#::CompareRelease_891">::CompareRelease</a></a> $ver 11.7.0.1] &gt;= 0} {
           <a name="::EnableDebugMode(1)"><a href="./misc.tcl.html#::EnableDebugMode_2430">::EnableDebugMode</a></a>
           set vpstList [<a name="::GetKeyValue(7)"><a href="./OptionCheck.tcl.html#::GetKeyValue_438">::GetKeyValue</a></a> &#34;debug hal show iomodule vpst $slot $vid&#34; $parameterList];
        } else {
           set vpstList [<a name="::GetKeyValue(8)"><a href="./OptionCheck.tcl.html#::GetKeyValue_438">::GetKeyValue</a></a> &#34;show platform iomodule vpst $slot $vid&#34; $parameterList];
        }
	<a name="::result_debug(1)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;vpstList for slot $slot vid $vid port $port: $vpstList&#34;;
	set vpst [lindex $vpstList 0];
	<a name="::result_debug(2)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;vpst for slot $slot vid $vid port $port: $vpst&#34;;
        if {[regexp -nocase &#34;KEY_NOT_FOUND&#34; $vpst]!=1} {
	set forward [expr (0x$vpst % 2)];
	if {$forward == $flag} {
	    <a name="::result_ok(1)"><a href="./lconsoles.tcl.html#::result_ok_9">::result_ok</a></a> &#34; forward: $forward and flag: $flag is the same&#34;;
        } else {
	    <a name="::result_error(1)"><a href="./lconsoles.tcl.html#::result_error_6">::result_error</a></a> &#34; forward: $forward and flag: $flag is different&#34;;
        }
        }
    } elseif {[regexp -nocase &#34;$i386Platform|$bcmPlatform&#34; $platform]} {
        <a name="::report_start_test(2)"><a href="./report.tcl.html#::report_start_test_79">::report_start_test</a></a> &#34;CheckDisplayvpst $portn $flag $dut $vlan on $platform&#34;;
        <span class="comment-line"># --- summitx450 needs to prepend the slot number</span>
        global i386Stackable stackable
        if {[regexp -nocase &#34;$stackable|$i386Stackable&#34; $platform]} {
           set portn &#34;1:$portn&#34;;
        }
        set ver [<a name="::GetVersion(2)"><a href="./misc.tcl.html#::GetVersion_303">::GetVersion</a></a> $dut];
        <a name="::EnableDebugMode(2)"><a href="./misc.tcl.html#::EnableDebugMode_2430">::EnableDebugMode</a></a>;
        if {[<a name="::CompareRelease(2)"><a href="./misc.tcl.html#::CompareRelease_891">::CompareRelease</a></a> $ver 11.1.0.10] &gt;= 0} {
           if {[<a name="::CompareRelease(3)"><a href="./misc.tcl.html#::CompareRelease_891">::CompareRelease</a></a> $ver 11.4.0.2] &gt;= 0} {
            lappend parameterList &#34;{vlan: *$vlan, *port:$portn,} 2 1&#34;;
            if {[<a name="::CompareRelease(4)"><a href="./misc.tcl.html#::CompareRelease_891">::CompareRelease</a></a> $ver 12.1.0.53] &gt;= 0} {
	       set egres [<a name="::GetKeyValue(9)"><a href="./OptionCheck.tcl.html#::GetKeyValue_438">::GetKeyValue</a></a> &#34;jerry vlan show vpifs&#34; $parameterList];
            } else {
	       set egres [<a name="::GetKeyValue(10)"><a href="./OptionCheck.tcl.html#::GetKeyValue_438">::GetKeyValue</a></a> &#34;jerry show vlan vpifs&#34; $parameterList];
            }
	    unset parameterList;
           } else {
            lappend parameterList &#34;{vlan: *$vlan, *port:$portn,} 0 1&#34;;
	    set egres [<a name="::GetKeyValue(11)"><a href="./OptionCheck.tcl.html#::GetKeyValue_438">::GetKeyValue</a></a> &#34;jerry show vlan vpifs&#34; $parameterList];
	    unset parameterList;
	    set egres [string trimleft $egres &#34;Egres:&#34;];
           }
	    set egres [string trimright $egres &#34;,&#34;];
           if {[<a name="::CompareRelease(5)"><a href="./misc.tcl.html#::CompareRelease_891">::CompareRelease</a></a> $ver 11.4.0.2] &gt;= 0} {
            lappend parameterList &#34;{vlan: *$vlan, *port:$portn,} 0 1&#34;;
            if {[<a name="::CompareRelease(6)"><a href="./misc.tcl.html#::CompareRelease_891">::CompareRelease</a></a> $ver 12.1.0.53] &gt;= 0} {
	       set ingres [<a name="::GetKeyValue(12)"><a href="./OptionCheck.tcl.html#::GetKeyValue_438">::GetKeyValue</a></a> &#34;jerry vlan show vpifs&#34; $parameterList];
            } else {
	       set ingres [<a name="::GetKeyValue(13)"><a href="./OptionCheck.tcl.html#::GetKeyValue_438">::GetKeyValue</a></a> &#34;jerry show vlan vpifs&#34; $parameterList];
            }
	    unset parameterList;
	    set ingres [string trimleft $ingres &#34;Ingress:&#34;];
           } else {
            lappend parameterList &#34;{vlan: *$vlan, *port:$portn,} 2 1&#34;;
	    set ingres [<a name="::GetKeyValue(14)"><a href="./OptionCheck.tcl.html#::GetKeyValue_438">::GetKeyValue</a></a> &#34;jerry show vlan vpifs&#34; $parameterList];
	    unset parameterList;
           }
	    set ingres [string trimright $ingres &#34;,&#34;];
        } else {
            lappend parameterList &#34;{vlan: *$vlan, *port:$portn, *.* egState: } 1&#34;;
	    set egres [<a name="::GetKeyValue(15)"><a href="./OptionCheck.tcl.html#::GetKeyValue_438">::GetKeyValue</a></a> &#34;jerry show vlan 7&#34; $parameterList];
	    unset parameterList;
	    set egres [string trimright $egres &#34;,&#34;];
            lappend parameterList &#34;{vlan: *$vlan, *port:$portn, *.* inState: } 1&#34;;
	    set ingres [<a name="::GetKeyValue(16)"><a href="./OptionCheck.tcl.html#::GetKeyValue_438">::GetKeyValue</a></a> &#34;jerry show vlan 7&#34; $parameterList];
	    unset parameterList;
	    set ingres [string trimright $ingres &#34;,&#34;];
        }
	if {$flag == 1} { 
            if {$egres == &#34;0x1&#34; &amp;&amp; $ingres == &#34;0x5&#34;} {
	        <a name="::result_ok(2)"><a href="./lconsoles.tcl.html#::result_ok_9">::result_ok</a></a> &#34; flag: $flag and egres: $egres, ingres: $ingres&#34;;
	    } else {
	        <a name="::result_error(2)"><a href="./lconsoles.tcl.html#::result_error_6">::result_error</a></a> &#34; flag: $flag BUT egres: $egres, ingres: $ingres&#34;;
	    }
	} else {
            if {$egres == &#34;0x8&#34; &amp;&amp; $ingres == &#34;0x42&#34;} {
	        <a name="::result_ok(3)"><a href="./lconsoles.tcl.html#::result_ok_9">::result_ok</a></a> &#34; flag: $flag and egres: $egres, ingres: $ingres&#34;;
	    } else {
	        <a name="::result_error(3)"><a href="./lconsoles.tcl.html#::result_error_6">::result_error</a></a> &#34; flag: $flag BUT egres: $egres, ingres: $ingres&#34;;
	    }
	}
    } else {
        <a name="::report_start_test(3)"><a href="./report.tcl.html#::report_start_test_79">::report_start_test</a></a> &#34;CheckDisplayvpst $portn $flag $dut $vlan not supported on $platform&#34;;
        <a name="::result_error(4)"><a href="./lconsoles.tcl.html#::result_error_6">::result_error</a></a> &#34;Displayvpst not supported on $platform&#34;;
    }
    <a name="::report_end_test(1)"><a href="./report.tcl.html#::report_end_test_122">::report_end_test</a></a>
}
</pre>
<hr>
<div class="index-selector">
	<a href="index_main.html#byfilename">file name</a> 
 | 
	<a href="index_main.html#byprocname">procedure name</a> 
 | 
	<a href="index_main.html#bycall">procedure call</a> 
 | 
	<a href="index_annot_full.html">annotation</a> 

<br>
<cite>File generated 2018-06-14 at 17:09.</cite>
</div>

</body>
</html>
