<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                       "http://www.w3.org/TR/html4/transitional.dtd">
<!-- Generated by TclDoc @@VERSION@@ -->
<html>
<head>
  <title>mysqlGoldenExtraRun.tcl</title>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <link rel="stylesheet" type="text/css" href="default.css">
</head>
<body class="src-html">
<div class="index-selector">
<!-- index for tcl source files -->
	Index by: 
	<a href="index_main.html#mysqlGoldenExtraRun.tcl">file name</a> | 
	<a href="index_main.html#byprocname">procedure name</a> | 
	<a href="index_main.html#bycall">procedure call</a> | 
	<a href="index_annot_full.html">annotation</a>

</div>
<hr>

<p><strong>mysqlGoldenExtraRun.tcl</strong>&nbsp;&nbsp;<span class="filetype-link">(<a href="mysqlGoldenExtraRun.tcl-annot.html">annotations</a> | <a href="mysqlGoldenExtraRun.tcl.txt">original source</a>)</span>
</p>
<pre class="src-code">
<span class="comment-line">#!/usr/bin/tclsh</span>


package require http 1.0;
package require Tclx
source ../Lib/mainLib.tcl

set LIB_PATH &#34;../Lib&#34;
lappend auto_path $LIB_PATH

source ../Lib/parse_args.tcl
source ../Lib/mainLib.tcl
load [lindex [glob &#34;/usr/lib/libexpect*so*&#34;] 0]
set LIB_PATH &#34;../Lib&#34;
lappend auto_path $LIB_PATH
<a name="::::gen_index(1)"><a href="./summarize.tcl.html#::::gen_index_76">::::gen_index</a></a> ../Lib
<a name="::::gen_index(2)"><a href="./summarize.tcl.html#::::gen_index_76">::::gen_index</a></a> .

source ../Lib/mysqlLib.tcl
source ../Lib/mainLib.tcl
source ../main/cfg/common.cfg


<span class="comment-line"># Default config file</span>
set cfgFile ../main/runReg.cfg

<span class="comment-line"># Source config file that has Regression PC information</span>
if [file exists $cfgFile] {
    puts &#34;Sourcing $cfgFile now&#34;
    catch {source $cfgFile} reason
} else {
    puts &#34;!!! Configuration file $cfgFile not found !!!&#34;
    return 0
}

global mysqlIP my_db
set host $mysqlIP
set db $my_db

<span class="comment-line"># ------------------------------------------------------------------------------</span>
<span class="comment-line"># Dump out usage information</span>
<span class="comment-line"># ------------------------------------------------------------------------------</span>
<strong><a name="::::print_usage_43">proc <a href="mysqlGoldenExtraRun.tcl-annot.html#::::print_usage">::::print_usage</a></a></strong> {} {
  puts {Usage: mysqlGoldenExtraRun.tcl -regId &lt;regression_id&gt; -mode &lt;mode&gt; -module &lt;module&gt; -cfg &lt;config file&gt; [-lst &lt;test list&gt;|-tcList] [-regPath &lt;regression Path&gt;] [-cliFlag &lt;cliFlag&gt;] [-build &lt;xos build1&gt;] [-subversion &lt;subversion&gt;] [-obuild &lt;xos build2&gt;] [-moduleArg &lt;module specific arg&gt;] [-debugLevel &lt;error debug level&gt;] [-efence &lt;process list&gt;] [-saveConfigPerTest &lt;yes/no&gt;] [-stopRegOn &lt;condition to abort&gt;] [-heapTracingProcess &lt;process list&gt;]}

}



    global regId
    global regType
    global regSubType
    global mode
    global module
    global cfg
    global lst
    global tcList
    global regPath
    global cliFlag
    global build
    global subversion
    global obuild
    global moduleArg
    global debugLevel
    global efence
    global saveConfigPerTest
    global stopRegOn
    global heapTracingProcess

    <a name="::parse_args(1)"><a href="./parse_args.tcl.html#::parse_args_29">::parse_args</a></a> mysqlGoldenExtraRun $argv {
        regId &#34;&#34;
        mode &#34;&#34;
        module &#34;&#34;
        cfg &#34;&#34;
        lst &#34;&#34;
        tcList &#34;&#34;
        regPath &#34;&#34;
        cliFlag &#34;&#34;
        build &#34;&#34;
        subversion &#34;&#34;
        obuild &#34;&#34;
        moduleArg &#34;&#34;
        debugLevel &#34;&#34;
        efence &#34;no&#34;
        saveConfigPerTest &#34;&#34;
        stopRegOn &#34;&#34;
        heapTracingProcess &#34;&#34;
    }

set regression_id $regId

global randomIndex
<span class="comment-line">#this is needed to create result directory by main.tcl known to mysqlRunall_monitor</span>
set range 1000000
set randomIndex [expr {int(rand()*$range)}]

set mainStr &#34; -mode $mode \
        -module $module \
        -cfg $cfg -subversion $subversion \
         -tcList $tcList \
        -randomIndex $randomIndex \
        -efence $efence \
        -saveConfigPerTest $saveConfigPerTest&#34;

puts &#34;main cmd $mainStr&#34;
catch { exec {tclsh} main.tcl -mode $mode \
        -module $module \
        -cfg $cfg -subversion $subversion \
         -tcList $tcList \
        -randomIndex $randomIndex \
        -efence $efence \
        -saveConfigPerTest $saveConfigPerTest | \
        tee   &gt;@stdout } result

puts &#34;DANY result $result&#34;

<a name="::conn_to_db(1)"><a href="./mysqlLib.tcl.html#::conn_to_db_8">::conn_to_db</a></a> $host $db

<span class="comment-line"># ----------------------------------------------------------------</span>
<span class="comment-line"># Post results to autoweb</span>
<span class="comment-line"># ----------------------------------------------------------------</span>
puts &#34;CALLING mysqlAutomate WITH:&#34;
puts &#34;regId $regression_id host $host \
                                 module $module&#34;

if {[catch { exec {tclsh} mysqlAutomate.tcl -regId $regression_id \
                             -module $module  } \
                             result]} {
puts &#34;mysqlAutomate.tcl returned an error&#34;
}

puts &#34;RESULTS OF mysqlAutomate: $result&#34;
<span class="comment-line"># ----------------------------------------------------------------</span>
<span class="comment-line"># --------------- testing mysqlAutomate.tcl end ------------------</span>
puts &#34;sleeping for 20 secs to give failAnalysis.php time&#34;
sleep 20

<span class="comment-line"># re-connect db if needed</span>
<a name="::conn_to_db(2)"><a href="./mysqlLib.tcl.html#::conn_to_db_8">::conn_to_db</a></a> $host $db



<span class="comment-line"># stats correction.</span>

<span class="comment-line"># get regression data</span>
set res_list [mysqlsel $mysql_handler &#34;SELECT feature_type, feature_sub_type FROM regression_table WHERE regression_id = \&#34;$regression_id\&#34;&#34; -flatlist]
set feature_type [lindex $res_list 0]
set feature_sub_type [lindex $res_list 1]
puts &#34;got feature_type: $feature_type&#34;
puts &#34;got feature_sub_type: $feature_sub_type&#34;

<span class="comment-line"># get feature_id</span>
set sel_clause &#34;SELECT feature_id FROM feature_table WHERE  feature_directory = '$module' AND \
        feature_type='$feature_type' AND feature_sub_type='$feature_sub_type'&#34;
puts &#34;sel_clause $sel_clause&#34;

set feature_id_list [mysqlsel $mysql_handler $sel_clause -flatlist]
set feature_id [lindex $res_list 0]

set feature_id [lindex $feature_id_list end]
puts &#34;got feature_id: $feature_id&#34;

<span class="comment-line"># get this report_id</span>
set sel_clause &#34;SELECT report_id FROM report_table WHERE  regression_id = '$regression_id' AND \
        feature_id ='$feature_id'&#34;
puts &#34;sel_clause $sel_clause&#34;
set rslt_list [mysqlsel $mysql_handler $sel_clause -flatlist]
set report_id_this [lindex $rslt_list end]
puts &#34;got report_id_this: $report_id_this&#34;


<span class="comment-line"># first get report_id of run number 1 </span>
set sel_clause &#34;SELECT report_id FROM report_table WHERE \
            regression_id= '$regression_id' AND \
            run_number= '1' AND \
            feature_id= '$feature_id'&#34;
puts &#34;sel_clause $sel_clause&#34;

set report_id_list [mysqlsel $mysql_handler $sel_clause -flatlist]
set report_id_1 [lindex $report_id_list 0]
puts &#34;got report_id_1: $report_id_1&#34;

<span class="comment-line"># do we have entry in aux2_report_table, if yes get valid report_id</span>
set sel_clause &#34;SELECT valid_report_id, valid_aux_report_id FROM aux2_report_table WHERE \
            regression_id= '$regression_id' AND \
            feature_id= '$feature_id'&#34;
puts &#34;sel_clause $sel_clause&#34;
set rpvld_list [mysqlsel $mysql_handler $sel_clause -flatlist]
if {[llength $rpvld_list] &gt; 1} {
  set valid_report_id [lindex $rpvld_list 0]
  set valid_aux_report_id [lindex $rpvld_list 1]
  puts &#34;entry in aux2_report_table exists  - got valid_report_id: $valid_report_id&#34;
  puts &#34;entry in aux2_report_table exists  - got valid_aux_report_id: $valid_aux_report_id&#34;
} else {
  set valid_report_id $report_id_1
  <span class="comment-line"># get valid_aux_report_id</span>
  set sel_clause &#34;SELECT aux_report_id FROM aux_report_table WHERE \
            report_id = '$report_id_1'&#34;
  puts &#34;sel_clause $sel_clause&#34;
  set rslt_list [mysqlsel $mysql_handler $sel_clause -flatlist]
  set valid_aux_report_id [lindex $rslt_list 0]
  puts &#34;entry in aux2_report_table DOESN'T exist  - got valid_report_id: $valid_report_id&#34;
  puts &#34;entry in aux2_report_table DOESN'T exist  - got valid_aux_report_id: $valid_aux_report_id&#34;
}

<span class="comment-line"># loop through the test cases</span>
set number_passed_subtestcases_delta 0
set number_failed_subtestcases_delta 0
set number_skipped_subtestcases_delta 0

set number_passed_testcases_delta 0
set number_failed_testcases_delta 0
set number_skipped_testcases_delta 0

foreach test_case_nmbr $tcList {
  <span class="comment-line"># get log_id_this</span>
  set sel_clause &#34;SELECT \
                log_id, status \
                FROM log_table WHERE \
                report_id = \&#34;$report_id_this\&#34; AND \
                feature_test_script_name = \&#34;$test_case_nmbr\&#34;&#34;
  puts &#34;sel_clause $sel_clause&#34;
  set res_list [mysqlsel $mysql_handler $sel_clause -flatlist]
  set log_id_this [lindex $res_list 0]
  set status_this [lindex $res_list 1]
  <span class="comment-line"># get subtestcase stats</span>
  set sel_clause &#34;SELECT \
                number_passed_subtestcases, number_failed_subtestcases, number_skipped_subtestcases \
                FROM aux2_log_table WHERE log_id = \&#34;$log_id_this\&#34;&#34;
  puts &#34;sel_clause $sel_clause&#34;
  set res_list [mysqlsel $mysql_handler $sel_clause -flatlist]
  set number_passed_subtestcases_this [lindex $res_list 0]
  set number_failed_subtestcases_this [lindex $res_list 1]
  set number_skipped_subtestcases_this [lindex $res_list 2]
  puts &#34;number_passed_subtestcases_this $number_passed_subtestcases_this&#34;
  puts &#34;number_failed_subtestcases_this $number_failed_subtestcases_this&#34;
  puts &#34;number_skipped_subtestcases_this $number_skipped_subtestcases_this&#34;


  <span class="comment-line"># get old log_id</span>
  <span class="comment-line"># let's see if we have old results for this test case</span>
  set number_passed_subtestcases_old 0
  set number_failed_subtestcases_old 0
  set number_skipped_subtestcases_old 0
  <span class="comment-line"># get old results</span>
  set old_exists &#34;no&#34;
  set sel_clause &#34;SELECT \
                log_id \
                FROM log_table WHERE \
                report_id = \&#34;$valid_report_id\&#34; AND \
                feature_test_script_name = \&#34;$test_case_nmbr\&#34;&#34;
  puts &#34;sel_clause $sel_clause&#34;
  set res_list [mysqlsel $mysql_handler $sel_clause -flatlist]
  puts &#34;res_list $res_list&#34;
  if {[llength $res_list] &gt; 0} {
    set old_exists &#34;yes&#34;
    set log_id_old [lindex $res_list 0]
    <span class="comment-line"># get subtestcase stats</span>
    set sel_clause &#34;SELECT \
                  aux2_log_id, number_passed_subtestcases, number_failed_subtestcases, number_skipped_subtestcases \
                  FROM aux2_log_table WHERE log_id = \&#34;$log_id_old\&#34;&#34;
    puts &#34;sel_clause $sel_clause&#34;
    set res_list [mysqlsel $mysql_handler $sel_clause -flatlist]
    set aux2_log_id_this [lindex $res_list 0]
    set number_passed_subtestcases_old [lindex $res_list 1]
    set number_failed_subtestcases_old [lindex $res_list 2]
    set number_skipped_subtestcases_old [lindex $res_list 3]
    puts &#34;aux2_log_id_this $aux2_log_id_this&#34;
    puts &#34;number_passed_subtestcases_old $number_passed_subtestcases_old&#34;
    puts &#34;number_failed_subtestcases_old $number_failed_subtestcases_old&#34;
    puts &#34;number_skipped_subtestcases_old $number_skipped_subtestcases_old&#34;
  }

  set number_passed_subtestcases_delta \
      [expr $number_passed_subtestcases_delta + $number_passed_subtestcases_this - $number_passed_subtestcases_old]
  set number_failed_subtestcases_delta  \
      [expr $number_failed_subtestcases_delta + $number_failed_subtestcases_this - $number_failed_subtestcases_old]
  set number_skipped_subtestcases_delta \
      [expr $number_skipped_subtestcases_delta + $number_skipped_subtestcases_this - $number_skipped_subtestcases_old]

  puts &#34;number_passed_subtestcases_delta $number_passed_subtestcases_delta&#34;
  puts &#34;number_failed_subtestcases_delta $number_failed_subtestcases_delta&#34;
  puts &#34;number_skipped_subtestcases_delta $number_skipped_subtestcases_delta&#34;

  <span class="comment-line"># update the old subtestcase stats if the log exists</span>
  if {$old_exists == &#34;yes&#34;} {
    set update_clause &#34;UPDATE  aux2_log_table SET number_passed_subtestcases = \&#34;$number_passed_subtestcases_this\&#34;, \
                         number_failed_subtestcases = \&#34;$number_failed_subtestcases_this\&#34;, \
                         number_skipped_subtestcases = \&#34;$number_skipped_subtestcases_this\&#34; \
                         WHERE aux2_log_id = \&#34;$aux2_log_id_this\&#34;&#34;
    puts &#34;update_clause $update_clause&#34;
    mysqlexec $mysql_handler $update_clause
  }

 
  <span class="comment-line"># status of this log</span>
  if {($status_this == &#34;passed&#34;) &amp;&amp; ($number_passed_subtestcases_delta  != 0)} {
    incr number_passed_testcases_delta
    set number_failed_testcases_delta [expr $number_failed_testcases_delta - 1]
  }
  if {($status_this == &#34;failed&#34;) &amp;&amp; ($number_failed_subtestcases_delta  != 0)} {
    incr number_failed_testcases_delta
    set number_passed_testcases_delta [expr $number_passed_testcases_delta - 1]
  }
  puts &#34;new number_passed_testcases_delta $number_passed_testcases_delta status_this $status_this&#34;
  puts &#34;new number_failed_testcases_delta $number_failed_testcases_delta status_this $status_this&#34;
  
}

<span class="comment-line"># update subtestcases sums</span>
<span class="comment-line"># get the old sums</span>
set sel_clause &#34;SELECT number_passed_tests, number_failed_tests FROM regression_table WHERE \
        regression_id = '$regression_id'&#34;
set res_list [mysqlsel $mysql_handler $sel_clause -flatlist]
set number_passed_subtests_sum [lindex $res_list 0]
set number_failed_subtests_sum [lindex $res_list 1]

puts &#34;number_passed_subtests_sum $number_passed_subtests_sum&#34;
puts &#34;number_failed_subtests_sum $number_failed_subtests_sum&#34;

set number_passed_subtests_sum [expr $number_passed_subtests_sum + $number_passed_subtestcases_delta]
set number_failed_subtests_sum [expr $number_failed_subtests_sum + $number_failed_subtestcases_delta]

puts &#34;new number_passed_subtests_sum $number_passed_subtests_sum&#34;
puts &#34;new number_failed_subtests_sum $number_failed_subtests_sum&#34;

<span class="comment-line"># update regression_table with new numbers</span>
set update_clause &#34;UPDATE regression_table SET  number_passed_tests = \&#34;$number_passed_subtests_sum\&#34;, \
                         number_failed_tests = \&#34;$number_failed_subtests_sum\&#34; \
                         WHERE regression_id = \&#34;$regression_id\&#34;&#34;
puts &#34;update_clause $update_clause&#34;
mysqlexec $mysql_handler $update_clause

<span class="comment-line">#update test case stats in aux_report_table</span>
<span class="comment-line"># get the old sums</span>
set sel_clause &#34;SELECT \
        number_passed_testcases, number_failed_testcases, number_skipped_testcases FROM aux_report_table WHERE \
        report_id = '$valid_report_id'&#34;
puts &#34;sel_clause $sel_clause&#34;
set res_list [mysqlsel $mysql_handler $sel_clause -flatlist]
set number_passed_testcases_sum [lindex $res_list 0]
set number_failed_testcases_sum [lindex $res_list 1]
set number_skipped_testcases_sum [lindex $res_list 2]

puts &#34;number_passed_testcases_sum $number_passed_testcases_sum&#34;
puts &#34;number_failed_testcases_sum $number_failed_testcases_sum&#34;
puts &#34;number_skipped_testcases_sum $number_skipped_testcases_sum&#34;

set number_passed_testcases_sum [expr $number_passed_testcases_sum + $number_passed_testcases_delta]
set number_failed_testcases_sum [expr $number_failed_testcases_sum + $number_failed_testcases_delta]
set number_skipped_testcases_sum [expr $number_skipped_testcases_sum + $number_skipped_testcases_delta]

puts &#34;new number_passed_testcases_sum $number_passed_testcases_sum&#34;
puts &#34;new number_failed_testcases_sum $number_failed_testcases_sum&#34;
puts &#34;new number_skipped_testcases_sum $number_skipped_testcases_sum&#34;


<span class="comment-line"># update aux_report_table with new numbers</span>
set update_clause &#34;UPDATE aux_report_table SET  number_passed_testcases = \&#34;$number_passed_testcases_sum\&#34;, \
                         number_failed_testcases = \&#34;$number_failed_testcases_sum\&#34;, \
                         number_skipped_testcases = \&#34;$number_skipped_testcases_sum\&#34; \
                         WHERE report_id = \&#34;$valid_report_id\&#34;&#34;
puts &#34;update_clause $update_clause&#34;
mysqlexec $mysql_handler $update_clause



</pre>
<hr>
<div class="index-selector">
	<a href="index_main.html#byfilename">file name</a> 
 | 
	<a href="index_main.html#byprocname">procedure name</a> 
 | 
	<a href="index_main.html#bycall">procedure call</a> 
 | 
	<a href="index_annot_full.html">annotation</a> 

<br>
<cite>File generated 2018-06-14 at 17:09.</cite>
</div>

</body>
</html>
