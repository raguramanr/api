<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                       "http://www.w3.org/TR/html4/transitional.dtd">
<!-- Generated by TclDoc @@VERSION@@ -->
<html>
<head>
  <title>taclogin.tcl</title>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <link rel="stylesheet" type="text/css" href="default.css">
</head>
<body class="src-html">
<div class="index-selector">
<!-- index for tcl source files -->
	Index by: 
	<a href="index_main.html#taclogin.tcl">file name</a> | 
	<a href="index_main.html#byprocname">procedure name</a> | 
	<a href="index_main.html#bycall">procedure call</a> | 
	<a href="index_annot_full.html">annotation</a>

</div>
<hr>

<p><strong>taclogin.tcl</strong>&nbsp;&nbsp;<span class="filetype-link">(<a href="taclogin.tcl-annot.html">annotations</a> | <a href="taclogin.tcl.txt">original source</a>)</span>
</p>
<pre class="src-code">

<span class="comment-line">#load {expect52.dll}</span>
set auto_path [linsert $auto_path 0 . ];

<span class="comment-line">################################################################## </span>
<span class="comment-line"># Procedure Name: tacLogin</span>
<span class="comment-line">#   </span>
<span class="comment-line"># Description: proc that used to login to a switch through console IP</span>
<span class="comment-line">#              or serial com</span>
<span class="comment-line">#</span>
<span class="comment-line">#</span>
<span class="comment-line"># Input args: </span>
<span class="comment-line">#       device: ip address of the switch, or the ip address </span>
<span class="comment-line">#                     of the terminal server or the serial port from</span>
<span class="comment-line">#		      com1 to com4 where switch serial connection is made</span>
<span class="comment-line">#       fd: a file descriptor for log/debug purposetftpServerList, filename</span>
<span class="comment-line">#       newconn :explicitly force a new connection even if a connection to the</span>
<span class="comment-line">#                ip already exists  </span>
<span class="comment-line"># Output args: none</span>
<span class="comment-line"># Typical usage:</span>
<span class="comment-line">#             tacLogin $DUT1_CONNECT</span>
<span class="comment-line">#</span>
<span class="comment-line"># Category Types (Setup,GetSwitchInfo,SendTraffic,CaptureTraffic,VerifySwitchOutput</span>
<span class="comment-line">#                          VerifyTraffic)</span>
<span class="comment-line"># Category: Setup</span>
<span class="comment-line">##################################################################</span>
<strong><a name="::::tacLogin_27">proc <a href="taclogin.tcl-annot.html#::::tacLogin">::::tacLogin</a></a></strong><a name="::::tacLogin"></a> {{device &#34;0.0.0.0&#34;} {fd &#34;NULL&#34;} {userid &#34;a d m i n&#34;} \
               {newconn 0}} {
  global numDUT;
  global whichDutNow;
  for {set i 1} {$i &lt;= $numDUT} {incr i} {
     global DUT${i}_CONNECT DUT${i}_IP;
     if {$device==[set DUT${i}_CONNECT] || $device==[set DUT${i}_IP]} {
       set whichDutNow $i;
       break;
     }     
  }
  <span class="comment-line"># Open appropriate device</span>
  <a name="::result_debug(1)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;Login on device $device&#34;;
  switch -glob -- $device \
      &#34;com?&#34; {
         <a name="::::tac_login_comm(1)"><a href="./taclogin.tcl.html#::::tac_login_comm_146">::::tac_login_comm</a></a> $device $fd $userid;
  } default {
         set loginresult [<a name="::::tac_login_telnet(1)"><a href="./taclogin.tcl.html#::::tac_login_telnet_74">::::tac_login_telnet</a></a> $device $fd $userid $newconn 1];
         if {$loginresult &lt;=1} {
            return $loginresult;
         } else {
            return [<a name="::::tac_login_telnet(2)"><a href="./taclogin.tcl.html#::::tac_login_telnet_74">::::tac_login_telnet</a></a> $device $fd $userid $newconn 0];
           }  
     }
}

<span class="comment-line">################################################################## </span>
<span class="comment-line"># Procedure Name: tac_login_telnet</span>
<span class="comment-line">#   </span>
<span class="comment-line"># Description: internal proc that used to login to a switch through telnet ip address</span>
<span class="comment-line">#</span>
<span class="comment-line"># Input args: </span>
<span class="comment-line">#       ipaddr : ip address of the switch</span>
<span class="comment-line">#       fd     : a file descriptor for log/debug purpose</span>
<span class="comment-line">#       userid : User id to login</span>
<span class="comment-line">#       newconn :explicitly force a new connection even if a connection to the</span>
<span class="comment-line">#                ip already exists  </span>
<span class="comment-line">#       PowerCycler : 1 or 0 to indicate powercycling or not</span>
<span class="comment-line">#        </span>
<span class="comment-line"># Output args: none</span>
<span class="comment-line"># Typical usage:</span>
<span class="comment-line">#         tac_login_telnet $device $fd &#34;admin&#34; 0</span>
<span class="comment-line">#</span>
<span class="comment-line"># Category Types (Setup,GetSwitchInfo,SendTraffic,CaptureTraffic,VerifySwitchOutput</span>
<span class="comment-line">#                          VerifyTraffic)</span>
<span class="comment-line"># Category: Setup</span>
<span class="comment-line">##################################################################</span>
<strong><a name="::::tac_login_telnet_74">proc <a href="taclogin.tcl-annot.html#::::tac_login_telnet">::::tac_login_telnet</a></a></strong><a name="::::tac_login_telnet"></a> {ipAddr {fd &#34;NULL&#34;} {userid &#34;a d m i n&#34;} {newconn 0} \
                      PowerCycler}  {
  global spawn_id;
  global hostname;
  global spawn_ids;
<span class="comment-line">#exp_internal 1</span>
  set newConnection 1;
  <span class="comment-line">#check for existing connection</span>
  if { $newconn != 1 &amp;&amp; [ info exists hostname ] == &#34;1&#34; } {
    foreach name $hostname {
      if { $name == $ipAddr } {
        set spawn_id $spawn_ids($name);
        if { $spawn_id != &#34;INVALID&#34; } {
          <span class="comment-line"># --- use it for delay without using sleep</span>
          <span class="comment-line">#puts &#34;Login $ipAddr - Connection already exists pid=$spawn_id&#34;</span>
          set newConnection 0;
        }
      }
    }
    <span class="comment-line">#if brand new connection, add to host name list</span>
    if { [lsearch $hostname $ipAddr] == -1 } {
       lappend hostname $ipAddr;
    }
  } else {
       lappend hostname $ipAddr;
  }
  <span class="comment-line">#spawn new connection if not exists</span>
  if { $newConnection == 1 } {
    <span class="comment-line"># give a delay to avoid connection refused problem</span>
    after 1000;
    if [catch &#34;spawn telnet $ipAddr&#34; reason] {
       <a name="::result_debug(2)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;failed to spawn program: $reason\n&#34;;
       error &#34;failed to spawn program: $reason\n&#34;;
    }
    set spawn_ids($ipAddr) $spawn_id;
    global connectionTimeout;
    set timeout $connectionTimeout;
    <a name="::result_debug(3)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;Login telnet $ipAddr,  pid=$spawn_id&#34;;
    <span class="comment-line">#wait for connection</span>
    expect {
      &#34;?nable to ?onnect&#34; {
        <a name="::result_error(1)"><a href="./lconsoles.tcl.html#::result_error_6">::result_error</a></a> $expect_out(buffer);
        expect *
        <a name="::result_error(2)"><a href="./lconsoles.tcl.html#::result_error_6">::result_error</a></a> $expect_out(buffer);
        error &#34;Unable to connect&#34;;
        }
      &#34;?onnected to&#34; {
        <span class="comment-line">#wait for all remaining characters to come</span>
        sleep 1;
        }
    }
  } 
return [<a name="::::tac_login_and_verify_result(1)"><a href="./taclogin.tcl.html#::::tac_login_and_verify_result_209">::::tac_login_and_verify_result</a></a>  $PowerCycler ];
}
<span class="comment-line">################################################################## </span>
<span class="comment-line"># Procedure Name: tac_login_comm</span>
<span class="comment-line">#   </span>
<span class="comment-line"># Description: internal proc that used to login to a switch through serial com</span>
<span class="comment-line">#</span>
<span class="comment-line"># Input args: </span>
<span class="comment-line">#       comm_port: come1 or com2</span>
<span class="comment-line">#       fd: a file descriptor for log/debug purpose</span>
<span class="comment-line">#       userid : User id to login</span>
<span class="comment-line">#       PowerCycler : 1 or 0 to indicate powercycling or not</span>
<span class="comment-line"># Output args: none</span>
<span class="comment-line"># Typical usage:</span>
<span class="comment-line">#         login_comm $device $fd &#34;admin&#34; 0</span>
<span class="comment-line">#</span>
<span class="comment-line"># Category Types (Setup,GetSwitchInfo,SendTraffic,CaptureTraffic,VerifySwitchOutput</span>
<span class="comment-line">#                          VerifyTraffic)</span>
<span class="comment-line"># Category: Setup</span>
<span class="comment-line">##################################################################</span>
<strong><a name="::::tac_login_comm_146">proc <a href="taclogin.tcl-annot.html#::::tac_login_comm">::::tac_login_comm</a></a></strong><a name="::::tac_login_comm"></a> {comm_port {fd &#34;NULL&#34;} {userid &#34;a d m i n&#34;}} {
   global spawn_id;
   global hostname;
   global spawn_ids;   
   
  set newConnection 1;
  <span class="comment-line">#check for existing connection</span>
  if { [ info exists hostname ] == &#34;1&#34; } {
    foreach name $hostname {
      if { $name == $comm_port } {
        set spawn_id $spawn_ids($name);
        if { $spawn_id != &#34;INVALID&#34; } {
          puts &#34;Login $comm_port - Connection already exists pid=$spawn_id&#34;;
          set newConnection 0;
        }
      }
    }
    <span class="comment-line">#if brand new connection, add to host name list</span>
    if { [lsearch $hostname $comm_port] == -1 } {
       lappend hostname $comm_port;
    }
  } else {
       lappend hostname $comm_port;
  }
   <span class="comment-line">#spawn new connection if not exists</span>
   if { $newConnection == 1 } {    
     <span class="comment-line"># s. comm initialization</span>
     set con [open $comm_port RDWR];
     fconfigure $con -buffering none -mode 9600,n,8,1  -blocking 0 \
        -buffersize 8192 -eofchar {} -translation auto;
     if [catch &#34;spawn -open $con&#34; reason] {
        send_user &#34;failed to spawn program: $reason\n&#34;;
        error &#34;failed to spawn program: $reason\n&#34;;
     }
    set spawn_ids($comm_port) $spawn_id;
     <a name="::result_debug(4)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;Login serial $comm_port,  pid=$spawn_id&#34;;
   }
   <span class="comment-line">#initial talking with the switch</span>
return [<a name="::::tac_login_and_verify_result(2)"><a href="./taclogin.tcl.html#::::tac_login_and_verify_result_209">::::tac_login_and_verify_result</a></a>  $PowerCycler ];
}

<span class="comment-line">##############################################################################</span>
<span class="comment-line"># Procedure  : tac_login_and_verify_result  </span>
<span class="comment-line">#</span>
<span class="comment-line"># Description: This proc is a wrapper to tac_login_on_switch.This is used to check for return value of tac_login_on_switch and appropriately call PowerCyclerif needed.</span>
<span class="comment-line">#</span>
<span class="comment-line"># Input args:1 or 0</span>
<span class="comment-line">#            1 specifies that powercycling should be done if logging on to switch times out from tac_login_on_switch.          </span>
<span class="comment-line">#</span>
<span class="comment-line"># Output args: -1 or 0 or 1 or 2</span>
<span class="comment-line">#            : -2 Connection closed by switch</span>
<span class="comment-line">#            : -1 Unexpected error.. No response from switch</span>
<span class="comment-line">#            : 0  Login Successful</span>
<span class="comment-line">#            : 1  Login failed (Authentication failure</span>
<span class="comment-line">#            : 2  DUT went through Power Cycling due to timeout (if proc is called with argument as 1       </span>
<span class="comment-line">#</span>
<span class="comment-line"># Typical usage:</span>
<span class="comment-line">#         tac_login_and_verify_result 0</span>
<span class="comment-line">#</span>
<span class="comment-line"># Category Types (Setup,GetSwitchInfo,SendTraffic,CaptureTraffic,VerifySwitchOutput</span>
<span class="comment-line">#                          VerifyTraffic)</span>
<span class="comment-line"># Category: Setup</span>
<span class="comment-line">##################################################################</span>
<strong><a name="::::tac_login_and_verify_result_209">proc <a href="taclogin.tcl-annot.html#::::tac_login_and_verify_result">::::tac_login_and_verify_result</a></a></strong><a name="::::tac_login_and_verify_result"></a> {PowerCycler} {
  upvar userid userid
  upvar ipAddr ipAddr
  set result [<a name="::::tac_login_on_switch(1)"><a href="./taclogin.tcl.html#::::tac_login_on_switch_273">::::tac_login_on_switch</a></a>  $ipAddr $userid]
  switch -exact -- $result {
   -2 -    
   -1 {return $result} 
    0 { 
        expect {
          &#34;#&#34; { 
             return $result;
           }
          &#34; &gt;&#34; {
             return $result;
           }
          timeout {
             <a name="::result_error(3)"><a href="./lconsoles.tcl.html#::result_error_6">::result_error</a></a> &#34;Unexpected timeout after successful login&#34;;
             return -1;
          }
        }
      }
   1 {return $result}
   2 { if {$PowerCycler == 1} {
         set pcycleresult [<a name="::::try_powercycler(1)"><a href="./taclogin.tcl.html#::::try_powercycler_388">::::try_powercycler</a></a> $ipAddr]
         if {$pcycleresult== 1} {
           <a name="::result_ok(1)"><a href="./lconsoles.tcl.html#::result_ok_9">::result_ok</a></a> &#34;Successfully power cycled DUT&#34;;
           <a name="::result_debug(5)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;Wait for 50 secs for rebooted DUT to come up...&#34;;
           sleep 50;
           return 2;
         } else { 
             <a name="::result_error(4)"><a href="./lconsoles.tcl.html#::result_error_6">::result_error</a></a> &#34;Could not power cycle DUT&#34;;
             <span class="comment-line">#no communication or unexpected behavior</span>
             <a name="::result_error(5)"><a href="./lconsoles.tcl.html#::result_error_6">::result_error</a></a> &#34;Trouble talking with the sw on $ipAddr&#34;;
             <a name="::result_error(6)"><a href="./lconsoles.tcl.html#::result_error_6">::result_error</a></a> &#34; Check connection and settings \r\r&#34;;
           return -1;
         } 
       } else {
<span class="comment-line">#This is because the proc is first called with powercycler as 1 and then as 0.Hence it means that previous attempt to login to the switch has failed and it was rebooted and still there is login problem for the second time which is an error.</span>
              <a name="::result_error(7)"><a href="./lconsoles.tcl.html#::result_error_6">::result_error</a></a> &#34;No response from switch&#34;; 
              return -1;
         }
     }
           
  }
}

<span class="comment-line">################################################################## </span>
<span class="comment-line"># Procedure Name: tac_login_on_switch</span>
<span class="comment-line">#   </span>
<span class="comment-line"># Description: internal proc that sends login prompt and password slower each char at a time.</span>
<span class="comment-line">#</span>
<span class="comment-line"># Input args: string : ip address of the DUT ,userid (optional)</span>
<span class="comment-line"># Output args: Integer denoting the result</span>
<span class="comment-line">#             -1 :Unexpected Error</span>
<span class="comment-line">#              0 :Login successful</span>
<span class="comment-line">#              1 :Login failed (authentication failure)</span>
<span class="comment-line">#              2 :Login attempt was not successful after 10 attempts </span>
<span class="comment-line"># Typical usage:</span>
<span class="comment-line">#         tac_login_on_switch  $ipAddr</span>
<span class="comment-line">#</span>
<span class="comment-line"># Category Types (Setup,GetSwitchInfo,SendTraffic,CaptureTraffic,VerifySwitchOutput</span>
<span class="comment-line">#                          VerifyTraffic)</span>
<span class="comment-line"># Category: Setup	</span>
<span class="comment-line">##################################################################</span>
<strong><a name="::::tac_login_on_switch_273">proc <a href="taclogin.tcl-annot.html#::::tac_login_on_switch">::::tac_login_on_switch</a></a></strong><a name="::::tac_login_on_switch"></a> {string {userid &#34;a d m i n&#34;}} {
  global spawn_id;
  log_user 2;
  set timeout 5;
  <span class="comment-line">#try 10 times</span>
  send &#34;\r&#34;;
  for {set i 0} {$i &lt; 10} {incr i} {
    expect {
      &#34;login:&#34; {
          global module;
	  global DUTs_info;
	  global PD2_108161729;
          if {[info exists DUTs_info(DUT1,version)]} {
             if {[info exists PD2_108161729] &amp;&amp; [eval $PD2_108161729]} {
                <a name="::result_debug(6)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;sleep for 2 sec due to tacacs PD2-108161729&#34;;
                after 2000;
             }
          }
          <span class="comment-line">##foreach letter {a d m i n}</span>
           foreach letter $userid {
             send $letter
             expect {
                &#34;$letter&#34; {
                    after 10;
                }
                timeout {
                   for {set c 0} {$c&lt;10} {incr c} {
                      send $letter;
                      expect {
                         &#34;$letter&#34; {
                            break;
                         }
                         timeout {
                            after 10;
                         }
                      }
                   }
                }
             }
          }
          send &#34;\r&#34;;
          expect &#34;password:&#34;;
          send &#34;\r&#34;;
          expect {
                &#34;#&#34; {
                      send &#34;\r&#34;;
                      return 0;
                }
                &#34; &gt;&#34; {
                     send &#34;\r&#34;;
                     return 0;
                }
               &#34;Login failed&#34; {
                   return 1;
                }        
          }                                
      }
      &#34; &gt;&#34; {
          send &#34;logout\r&#34;;
          expect { 
             -nocase -re  &#34;(y*/n*)&#34; {
                send &#34;n\r&#34;;
             }
          }     
      }
      &#34;#&#34; {
          send &#34;logout\r&#34;;
          expect {
            -nocase -re &#34;(y*/n*)&#34; {
              send &#34;n\r&#34;;
             }
          }
      }
      &#34;\\-&gt;&#34; {
         if {[regexp -nocase {\-&gt;$} $expect_out(buffer)]} {
            send &#34;shswitch\r&#34;;
            expect {
               &#34;#&#34; {
                   send &#34;logout\r&#34;;
                   expect {
                      -nocase -re &#34;(y*/n*)&#34; {
                         send &#34;n\r&#34;;
                       }
                   }
               }
               &#34; &gt;&#34; {
                   send &#34;logout\r&#34;;
                   expect {
                      -nocase -re &#34;(y*/n*)&#34; {
                         send &#34;n\r&#34;;
                       }
                   }
               }
               timeout {
                   <a name="::result_error(8)"><a href="./lconsoles.tcl.html#::result_error_6">::result_error</a></a> &#34;Unexpected timeout after finding nofeep&#34;;
                   return -1;
               }
            }
         } else {
             send &#34;logout\r&#34;;
         }
      }
      &#34;closed&#34; {
         <a name="::result_debug(7)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;Connection closed by switch&#34;;
         return -2;
      }
      timeout {
         <span class="comment-line">#want to get a Login prompt or #</span>
         send &#34;\r&#34;;
      }
    }
  }
 return 2;
}
<span class="comment-line">################################################################################</span>
<strong><a name="::::try_powercycler_388">proc <a href="taclogin.tcl-annot.html#::::try_powercycler">::::try_powercycler</a></a></strong><a name="::::try_powercycler"></a> {ipAddr} {
  global POWERCYCLE_IP;
  if {[info exists POWERCYCLE_IP]} {
     for {set numDUT 1; global DUT${numDUT}_CONNECT} { [info exists DUT${numDUT}_CONNECT] } {incr numDUT ; global DUT${numDUT}_CONNECT} {
        set connect [set DUT${numDUT}_CONNECT];
        if {[string compare $ipAddr $connect]==0} {
           set dut $numDUT;
           return [<a name="::PowerCycleDUT(1)"><a href="./poweroutlet.tcl.html#::PowerCycleDUT_377">::PowerCycleDUT</a></a> $POWERCYCLE_IP $dut];
        }
     }
  }
}
<span class="comment-line">################################################################################</span>
</pre>
<hr>
<div class="index-selector">
	<a href="index_main.html#byfilename">file name</a> 
 | 
	<a href="index_main.html#byprocname">procedure name</a> 
 | 
	<a href="index_main.html#bycall">procedure call</a> 
 | 
	<a href="index_annot_full.html">annotation</a> 

<br>
<cite>File generated 2018-06-14 at 17:09.</cite>
</div>

</body>
</html>
