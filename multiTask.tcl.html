<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                       "http://www.w3.org/TR/html4/transitional.dtd">
<!-- Generated by TclDoc @@VERSION@@ -->
<html>
<head>
  <title>multiTask.tcl</title>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <link rel="stylesheet" type="text/css" href="default.css">
</head>
<body class="src-html">
<div class="index-selector">
<!-- index for tcl source files -->
	Index by: 
	<a href="index_main.html#multiTask.tcl">file name</a> | 
	<a href="index_main.html#byprocname">procedure name</a> | 
	<a href="index_main.html#bycall">procedure call</a> | 
	<a href="index_annot_full.html">annotation</a>

</div>
<hr>

<p><strong>multiTask.tcl</strong>&nbsp;&nbsp;<span class="filetype-link">(<a href="multiTask.tcl-annot.html">annotations</a> | <a href="multiTask.tcl.txt">original source</a>)</span>
</p>
<pre class="src-code">

<span class="comment-line">################################################################</span>
<span class="comment-line">#  Procedure Name: MultiTask</span>
<span class="comment-line">#  </span>
<span class="comment-line">#  Description:</span>
<span class="comment-line">#     This procedure is used to execute more than one test case simultaneoulsy</span>
<span class="comment-line">#     by creating separate process for each procedure and execute them. </span>
<span class="comment-line">#     Assumptions</span>
<span class="comment-line">#     -----------</span>
<span class="comment-line">#       1. All the test cases use telnet connection with the DUT to execute</span>
<span class="comment-line">#          the CLI commands. No test script should use console connection to</span>
<span class="comment-line">#          send CLI commands to DUT</span>
<span class="comment-line">#</span>
<span class="comment-line">#       2. Test cases which involves rebooting the DUT, downloading the</span>
<span class="comment-line">#          configuration, etc should not be combined</span>
<span class="comment-line">#    </span>
<span class="comment-line">#       3. Since all the test cases are executed simultaneously, user should</span>
<span class="comment-line">#          takecare not to use the confliting configurations. For example</span>
<span class="comment-line">#          two test cases should not try to use the same IXIA port</span>
<span class="comment-line">#</span>
<span class="comment-line">#  Input Variables:</span>
<span class="comment-line">#     procList -  List of procedures that needs to be executed simultaneously</span>
<span class="comment-line"># </span>
<span class="comment-line">#  Optional Args:</span>
<span class="comment-line">#     None</span>
<span class="comment-line"># </span>
<span class="comment-line">#  Output Variables: </span>
<span class="comment-line">#     None</span>
<span class="comment-line">#</span>
<span class="comment-line">#  Return Variables:</span>
<span class="comment-line">#     None</span>
<span class="comment-line">#</span>
<span class="comment-line">#  Possible Usage:</span>
<span class="comment-line">#     lappend procList &#34;1.1.1_2&#34;</span>
<span class="comment-line">#     lappend procList &#34;5.4.10&#34;</span>
<span class="comment-line">#     lappend procList &#34;snmp_test&#34;</span>
<span class="comment-line">#     MultiTask $procList</span>
<span class="comment-line">###############################################################</span>
<strong><a name="::::MultiTask_39">proc <a href="multiTask.tcl-annot.html#::::MultiTask">::::MultiTask</a></a></strong> { procList {result 0}} {
    global EX_REPORT_DATA MULTITASKCOUNTERON passCount failCount skipCount
    global DUTs_info MAIN PLANMAIN 
    global DUTs_Slot_info
    global MTASK;<span class="comment-line"># 2D array to pid,variable = value for tracking state</span>

    set passIn $passCount
    set failIn $failCount
    set skipIn $skipCount
    set passOut 0
    set failOut 0
    set skipOut 0
    set MAIN(MULTITASKON) 1
    if {[info exists MULTITASKCOUNTERON] &amp;&amp; $MULTITASKCOUNTERON == 1} {
        set result 1
    }
    if $result {
        set p [pid]
        if [file exists /tmp/multRes_$p] {
            file delete -force /tmp/multRes_$p
        }
        <span class="comment-line">#set rfile [open &#34;/tmp/multRes_$p&#34; &#34;w&#34;]</span>
    }

    set numProc [llength $procList]

    if {[info exists EX_REPORT_DATA]} {
        set EX_BACK_DATA $EX_REPORT_DATA
    } else {
        set EX_BACK_DATA &#34;&#34;
        set EX_REPORT_DATA &#34;&#34;
    }
    set fpid [pid]
    for { set i 0 } { $i &lt; $numProc } {incr i } {
        set mPid [fork]
        lappend childPid $mPid
        <span class="comment-line">#---  delete any preexisting variable files</span>
        if [file exists &#34;/tmp/${mPid}_setvars&#34;] {catch {file delete &#34;/tmp/${mPid}_setvars&#34;} why}
        set MTASK(${mPid},fPipe) &#34;null&#34;
        after 1000
        if {[lindex $childPid $i]} {
            <span class="comment-line"># ---- This is the PARENT process</span>
            if { $i == [expr $numProc - 1] } {
                foreach pid $childPid {
                    set status [wait $pid]
                }

                <span class="comment-line"># restore the original buffer</span>
                set EX_REPORT_DATA $EX_BACK_DATA
                <span class="comment-line"># ---- Each child process writes the result file in a</span>
                <span class="comment-line">#      temp file. Read all the file contents and update the </span>
                <span class="comment-line">#      global variable for writting the consolidated report file</span>
                foreach param $procList {
                    <span class="comment-line">#Rebuild global EX_REPORT_DATA</span>
                    append EX_REPORT_DATA [<a name="::ex_cat(1)"><a href="./result.tcl.html#::ex_cat_161">::ex_cat</a></a> &#34;Tmp/${fpid}_$param&#34;]
                    catch {file delete &#34;Tmp/${fpid}_$param&#34;} why
                    if {$result} {
                        <span class="comment-line">#Rebuild globals pass/fail/skip counts</span>
                        source &#34;Tmp/${fpid}_stat_$param&#34;
                        set passCount [expr $passCount + $passOut]
                        set failCount [expr $failCount + $failOut]
                        set skipCount [expr $skipCount + $skipOut]
                        catch {file delete &#34;Tmp/${fpid}_stat_$param&#34;} why
                    }
                }
                <a name="::_endSetMultiTaskVar(1)"><a href="./multiTask.tcl.html#::_endSetMultiTaskVar_186">::_endSetMultiTaskVar</a></a> $fpid
            }
        } else {
            <span class="comment-line"># ---- This is the CHILD process</span>
            set EX_REPORT_DATA &#34;&#34;
            <span class="comment-line"># ---- Execute each test script</span>
            if [catch {eval [lindex $procList $i]} reason] {
                global errorInfo
                set pid _[pid]
                <a name="::report_start_test(1)"><a href="./report.tcl.html#::report_start_test_79">::report_start_test</a></a> &#34;Child process $pid crashed - Reason: &lt;$reason&gt;&#34;
                <a name="::result_debug(1)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;Child process $pid crashed - Resaon: $reason\n&#34;
                <a name="::result_debug(2)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> $errorInfo
                <a name="::result_error(1)"><a href="./lconsoles.tcl.html#::result_error_6">::result_error</a></a> &#34;Child process $pid crashed - Resaon: $reason\n&#34;
                <a name="::report_end_test(1)"><a href="./report.tcl.html#::report_end_test_122">::report_end_test</a></a>
                <span class="comment-line">#fix_report_level</span>
            }

            <span class="comment-line"># ---- Each child writes the result file in a temp file</span>
            set fd_in [open &#34;Tmp/${fpid}_[lindex $procList $i]&#34; &#34;w&#34;]
            puts -nonewline $fd_in &#34;$EX_REPORT_DATA&#34;
            flush $fd_in
            close $fd_in
            if {$result} {
                <span class="comment-line"># ---- File to hold pass/fail/skip count for each child</span>
                set fd_st [open &#34;Tmp/${fpid}_stat_[lindex $procList $i]&#34; &#34;w&#34;]
                set passDiff [expr $passCount - $passIn]
                set failDiff [expr $failCount - $failIn]
                set skipDiff [expr $skipCount - $skipIn]
                set passOut [expr $passOut + $passDiff]
                set failOut [expr $failOut + $failDiff]
                set skipOut [expr $skipOut + $skipDiff]
                puts $fd_st &#34;set passOut $passOut&#34;
                puts $fd_st &#34;set failOut $failOut&#34;
                puts $fd_st &#34;set skipOut $skipOut&#34;
                flush $fd_st
                close $fd_st
            }
            exit
        }
    }
    if $result {
        <span class="comment-line">#multiTaskResult /tmp/multRes_$p</span>
    }
    <span class="comment-line"># Source all pid_setvars files if by chance the called procs have set the name format</span>
    foreach p $childPid {
        if {[file exists &#34;/tmp/${p}_setvars&#34; ]} {
            catch {source &#34;/tmp/${p}_setvars&#34;} oops
            catch {file delete -force &#34;/tmp/${p}_setvars&#34;} oops
        }
        if {[file exists &#34;/tmp/${p}_showout&#34; ]} {
            catch {source &#34;/tmp/${p}_showout&#34;} oops
            catch {file delete -force &#34;/tmp/${p}_showout&#34;} oops
        }
    }
    set MAIN(MULTITASKON) 0
}
<span class="comment-line">##############################################################################################</span>
<span class="comment-line"># procedure: _setMultiTaskVar</span>
<span class="comment-line">#</span>
<span class="comment-line">#  Write a variable to a tmp file for a forked pid. So that it can be sourced later and put</span>
<span class="comment-line">#    in the parent scope</span>
<span class="comment-line">#</span>
<span class="comment-line">##############################################################################################</span>
<strong><a name="::::_setMultiTaskVar_167">proc <a href="multiTask.tcl-annot.html#::::_setMultiTaskVar">::::_setMultiTaskVar</a></a></strong> {mVar mVal} {
    global MAIN MTASK
    <span class="comment-line"># Check if this is executed within the MultiTask proc.</span>
    if {![info exists MAIN(MULTITASKON)] || !$MAIN(MULTITASKON)} {
        return
    }
    <span class="comment-line"># Open the formatted name to store each processes variables</span>
    if {![info exists MTASK([pid],fPipe)] || $MTASK([pid],fPipe) == &#34;null&#34;} {
        set MTASK([pid],fPipe) [open &#34;/tmp/[pid]_setvars&#34; &#34;w&#34;]
    }
    puts $MTASK([pid],fPipe) &#34;set $mVar \&#34;$mVal\&#34;&#34;
}
<span class="comment-line">##############################################################################################</span>
<span class="comment-line"># procedure: _endSetMultiTaskVar</span>
<span class="comment-line">#</span>
<span class="comment-line"># Close the tmp file that holds the child pid variables.</span>
<span class="comment-line">#</span>
<span class="comment-line">#</span>
<span class="comment-line">##############################################################################################</span>
<strong><a name="::::_endSetMultiTaskVar_186">proc <a href="multiTask.tcl-annot.html#::::_endSetMultiTaskVar">::::_endSetMultiTaskVar</a></a></strong> {mpid} {
    global MAIN MTASK
    <span class="comment-line"># Close the file</span>
    if {[info exists MTASK(${mpid},fPipe)] &amp;&amp; $MTASK(${mpid},fPipe) != &#34;null&#34;} {
        close $MTASK(${mpid},fPipe)
    }
}
<span class="comment-line">##############################################################################################</span>
<span class="comment-line">#</span>
<span class="comment-line">#</span>
<span class="comment-line">#</span>
<span class="comment-line">##############################################################################################</span>
<strong><a name="::::_saveOutputIfMultiTasked_198">proc <a href="multiTask.tcl-annot.html#::::_saveOutputIfMultiTasked">::::_saveOutputIfMultiTasked</a></a></strong> {mfile} {
    global MAIN MTASK whichDutNow
    if {![info exists MAIN(MULTITASKON)] || !$MAIN(MULTITASKON)} {
        return
    }

    set fp [open &#34;$mfile&#34; r]
    set show_data [read $fp]
    close $fp
    set fd_so [open &#34;/tmp/[pid]_showout&#34; &#34;w&#34;]

    if {[info exists whichDutNow]} {
        set dut $whichDutNow
        puts $fd_so &#34;set DUTs_info(DUT$dut,show_output) \{$show_data\}&#34;
    } else {
        puts $fd_so &#34;set MAIN(multiTask_output) \{$show_data\}&#34;
    }
    close $fd_so
}
<span class="comment-line">######################################################################################################################</span>
<span class="comment-line"># proc : checkUploadDownloadConfigParallel</span>
<span class="comment-line"># input : dutList </span>
<span class="comment-line">#         The dutList must be provided in ascending order e.g. {1 2 3}  or {1 2 3 4 5}</span>
<span class="comment-line"># description:  For the given number of duts, uploads/downloads the config  </span>
<span class="comment-line">#        to save time does this in parallel</span>
<span class="comment-line">######################################################################################################################</span>
<strong><a name="::::checkUploadDownloadConfigParallel_224">proc <a href="multiTask.tcl-annot.html#::::checkUploadDownloadConfigParallel">::::checkUploadDownloadConfigParallel</a></a></strong> {dutList} {
set time2 [clock seconds]
set lastDUT [lindex $dutList end]

foreach dut $dutList {

    global tftpServerList
    set DUTName [format %s%d DUT $dut]
    global ${DUTName}_CONNECT
    <a name="::Login(1)"><a href="./login.tcl.html#::Login_24">::Login</a></a> [set ${DUTName}_CONNECT]

    set sec [clock seconds]
    lappend childPids [fork]
    after 1000 ;<span class="comment-line"># required to avoid children getting the same tmp file sometimes being too fast</span>
    if {[lindex $childPids [expr $dut-1]]} {
        if {$dut == $lastDUT} {
            set co 1
            foreach childPid $childPids {
                <a name="::result_debug(3)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;Parent now waiting for child # $co with pid $childPid&#34;
                wait $childPid    ;<span class="comment-line"># parent waits here for child to complete</span>
                <a name="::result_debug(4)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;Now child returned with pid $childPid&#34;
                incr co
            }
        }
    } else {
       <a name="::result_debug(5)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;child # $dut enters with pid [pid]&#34;

        set tmpTime [clock seconds];
        set tftpServer [<a name="::CheckUploadConfig(1)"><a href="./SendSwCmd.tcl.html#::CheckUploadConfig_1925">::CheckUploadConfig</a></a> $tftpServerList &#34;emistpDUT${dut}$tmpTime.cfg&#34;];
        if {$tftpServer == &#34;error&#34;} {
            <a name="::result_error(2)"><a href="./lconsoles.tcl.html#::result_error_6">::result_error</a></a> &#34;Failed to upload to from $box&#34;;
        } else {
            set status [<a name="::CheckDownloadConfig(1)"><a href="./SendSwCmd.tcl.html#::CheckDownloadConfig_1046">::CheckDownloadConfig</a></a> $tftpServer &#34;emistpDUT${dut}$tmpTime.cfg&#34;];
            if {$tftpServer == &#34;error&#34;} {
                <a name="::result_error(3)"><a href="./lconsoles.tcl.html#::result_error_6">::result_error</a></a> &#34;Failed to download to DUT $dut&#34;;
            }
        }
        exit   ;<span class="comment-line"># Child exits here, returns back to the waiting parent</span>
        <span class="comment-line"># end of fork construct</span>
    }
}
set time3 [clock seconds]

<a name="::result_debug(6)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;Parallel UploadDownloadConfig Time = [expr $time3 - $time2] &#34;
}

<span class="comment-line">######################################################################################################################</span>
<span class="comment-line"># proc : checkDownloadConfigParallel</span>
<span class="comment-line"># input : dutList </span>
<span class="comment-line">#         The dutList must be provided in ascending order e.g. {1 2 3}  or {1 2 3 4 5}</span>
<span class="comment-line">#         filenameList {dut1cfg dut2cfg dut3cfg}</span>
<span class="comment-line">#</span>
<span class="comment-line">#    N O T E :  Put the files on the tftp server WITHOUT the .xsf extension</span>
<span class="comment-line">#</span>
<span class="comment-line"># description:  For the given number of duts, uploads/downloads the config  </span>
<span class="comment-line">#        to save time does this in parallel</span>
<span class="comment-line">######################################################################################################################</span>
<strong><a name="::::checkDownloadConfigParallel_281">proc <a href="multiTask.tcl-annot.html#::::checkDownloadConfigParallel">::::checkDownloadConfigParallel</a></a></strong> {dutList filenameList args } {
    <a name="::parse_args(1)"><a href="./parse_args.tcl.html#::parse_args_29">::parse_args</a></a> checkDownloadConfigParallel $args {
        wait &#34;90&#34;
        timeout &#34;90&#34;
        incremental &#34;0&#34;
    }

set time2 [clock seconds]
set lastDUT [lindex $dutList end]

global DUTs_info
global connectionTimeout

set oldConnTimeout $connectionTimeout
set connectionTimeout $timeout
foreach dut $dutList {

    global tftpServerList
    set DUTName [format %s%d DUT $dut]
    global ${DUTName}_CONNECT
    <a name="::Login(2)"><a href="./login.tcl.html#::Login_24">::Login</a></a> [set ${DUTName}_CONNECT]

    set sec [clock seconds]
    lappend childPids [fork]
    after 1000 ;<span class="comment-line"># required to avoid children getting the same tmp file sometimes being too fast</span>
    if {[lindex $childPids [expr $dut-1]]} {
        if {$dut == $lastDUT} {
            set co 1
            foreach childPid $childPids {
                <a name="::result_debug(7)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;Parent now waiting for child # $co with pid $childPid&#34;
                wait $childPid    ;<span class="comment-line"># parent waits here for child to complete</span>
                <a name="::result_debug(8)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;Now child returned with pid $childPid&#34;
                incr co
            }
        }
    } else {
        <a name="::result_debug(9)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;child # $dut enters with pid [pid]&#34;
        set tmpTime [clock seconds];
        set myIndex [expr $dut - 1]
        set status [<a name="::CheckDownloadConfig(2)"><a href="./SendSwCmd.tcl.html#::CheckDownloadConfig_1046">::CheckDownloadConfig</a></a> [lindex $tftpServerList 0] &#34;[lindex $filenameList $myIndex]&#34; 0 -wait $wait -nameFormat &#34;fixed&#34; ];
        if {$status == &#34;illegal&#34;} {
            <a name="::result_error(4)"><a href="./lconsoles.tcl.html#::result_error_6">::result_error</a></a> &#34;Failed to download to DUT $dut&#34;;
        } else {
            set DUTs_info(DUT$dut,CfgLoaded) 1 
        }
        exit   ;<span class="comment-line"># Child exits here, returns back to the waiting parent</span>
        <span class="comment-line"># end of fork construct</span>
    }
}
set time3 [clock seconds]
set connectionTimeout $oldConnTimeout

<a name="::result_debug(10)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;Parallel DownloadConfig Time = [expr $time3 - $time2] &#34;
}

<span class="comment-line">################################################################</span>
<span class="comment-line">#  Procedure Name: copyRes</span>
<span class="comment-line">#</span>
<span class="comment-line">#  Description:</span>
<span class="comment-line">#     This procedure is used to copy the values of the global counters</span>
<span class="comment-line">#     pass, fail, skip of the child process to a common file &#34;multRes&#34;</span>
<span class="comment-line">#     this proc needs to be added at the end of each proc given as input</span>
<span class="comment-line">#     to the MultiTask proc </span>
<span class="comment-line">#</span>
<span class="comment-line">#</span>
<span class="comment-line">#  Input Variables:</span>
<span class="comment-line">#     none</span>
<span class="comment-line">#</span>
<span class="comment-line">#  Optional Args:</span>
<span class="comment-line">#     None</span>
<span class="comment-line">#</span>
<span class="comment-line">#  Output Variables:</span>
<span class="comment-line">#     file &#34;multRes&#34; would be created</span>
<span class="comment-line">#</span>
<span class="comment-line">#  Return Variables:</span>
<span class="comment-line">#     None</span>
<span class="comment-line">#</span>
<span class="comment-line">#  Possible Usage:</span>
<span class="comment-line">#    copyRes</span>
<span class="comment-line">###############################################################</span>

<strong><a name="::::copyRes_362">proc <a href="multiTask.tcl-annot.html#::::copyRes">::::copyRes</a></a></strong> {} {
global passCount
global failCount
global skipCount

set fs [open &#34;multRes&#34; a+]
<span class="comment-line">#flock -write $fs</span>
puts $fs &#34;passCount $passCount&#34;
puts $fs &#34;failCount $failCount&#34;
puts $fs &#34;skipCount $skipCount&#34;
<span class="comment-line">#funlock $fs</span>
close $fs

}

<span class="comment-line">################################################################</span>
<span class="comment-line">#  Procedure Name: multiTaskResult</span>
<span class="comment-line">#</span>
<span class="comment-line">#  Description:</span>
<span class="comment-line">#     This procedure is used to calculate  the global counters</span>
<span class="comment-line">#     pass, fail, skip after each MultiTask ccommand is invoked</span>
<span class="comment-line">#     This proc takes the input from file multRes, created </span>
<span class="comment-line">#     through the proc copyRes .  This proc can be invoked </span>
<span class="comment-line">#     by the MultiTask proc with the second argument as 1 (true)</span>
<span class="comment-line">#</span>
<span class="comment-line">#</span>
<span class="comment-line">#  Input Variables:</span>
<span class="comment-line">#     none</span>
<span class="comment-line">#</span>
<span class="comment-line">#  Optional Args:</span>
<span class="comment-line">#     None</span>
<span class="comment-line">#</span>
<span class="comment-line">#  Output Variables:</span>
<span class="comment-line">#     None</span>
<span class="comment-line">#</span>
<span class="comment-line">#  Return Variables:</span>
<span class="comment-line">#     None</span>
<span class="comment-line">#</span>
<span class="comment-line">#  Possible Usage:</span>
<span class="comment-line">#  Possible Usage:</span>
<span class="comment-line">#     lappend procList &#34;1.1.1_2&#34;</span>
<span class="comment-line">#     lappend procList &#34;5.4.10&#34;</span>
<span class="comment-line">#     lappend procList &#34;snmp_test&#34;</span>
<span class="comment-line">#     MultiTask $procList 1</span>
<span class="comment-line">#</span>
<span class="comment-line">#    </span>
<span class="comment-line">###############################################################</span>


<strong><a name="::::multiTaskResult_411">proc <a href="multiTask.tcl-annot.html#::::multiTaskResult">::::multiTaskResult</a></a></strong> {} {

set fd [open multRes r]

global passCount
global failCount
global skipCount
set pass $passCount
set fail $failCount
set skip $skipCount
while {[gets $fd line] &gt;= 0} {
   if [regexp  passCount $line] {
      regexp {[0-9]+} $line x
      set x [expr $x -$pass]
      incr passCount $x
   } elseif [regexp failCount $line] {
      regexp {[0-9]+} $line y
      set y [expr $y - $fail]
      incr failCount $y
   } elseif [regexp skipCount $line] {
      regexp {[0-9]+} $line z
      set z [expr $z - $skip]
      incr skipCount $z
   }
}
close $fd
file delete -force multRes
}

</pre>
<hr>
<div class="index-selector">
	<a href="index_main.html#byfilename">file name</a> 
 | 
	<a href="index_main.html#byprocname">procedure name</a> 
 | 
	<a href="index_main.html#bycall">procedure call</a> 
 | 
	<a href="index_annot_full.html">annotation</a> 

<br>
<cite>File generated 2018-06-14 at 17:09.</cite>
</div>

</body>
</html>
