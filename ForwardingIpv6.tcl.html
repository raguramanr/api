<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                       "http://www.w3.org/TR/html4/transitional.dtd">
<!-- Generated by TclDoc @@VERSION@@ -->
<html>
<head>
  <title>ForwardingIpv6.tcl</title>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <link rel="stylesheet" type="text/css" href="default.css">
</head>
<body class="src-html">
<div class="index-selector">
<!-- index for tcl source files -->
	Index by: 
	<a href="index_main.html#ForwardingIpv6.tcl">file name</a> | 
	<a href="index_main.html#byprocname">procedure name</a> | 
	<a href="index_main.html#bycall">procedure call</a> | 
	<a href="index_annot_full.html">annotation</a>

</div>
<hr>

<p><strong>ForwardingIpv6.tcl</strong>&nbsp;&nbsp;<span class="filetype-link">(<a href="ForwardingIpv6.tcl-annot.html">annotations</a> | <a href="ForwardingIpv6.tcl.txt">original source</a>)</span>
</p>
<pre class="src-code">

<strong><a name="::::CheckIpv6Forwarding_2">proc <a href="ForwardingIpv6.tcl-annot.html#::::CheckIpv6Forwarding">::::CheckIpv6Forwarding</a></a></strong> {args} {

   <a name="::parse_args(1)"><a href="./parse_args.tcl.html#::parse_args_29">::parse_args</a></a> CheckIpv6Forwarding $args {
     txPortId &#34;1&#34;
     rxPortId &#34;0&#34;  
     <a name="::protocol(1)"><a href="./ePTClient.tcl.html#::protocol_728">::protocol</a></a> &#34;ipV6&#34;
     nHeader &#34;tcp&#34;
     trafficClass &#34;3&#34;
     flowLabel &#34;0&#34;
     hopLimit &#34;255&#34;
     tag      &#34;none&#34;
     generateArpReq &#34;1&#34;
<span class="comment-line">#     inSaMac &#34;default&#34;</span>
<span class="comment-line">#     inDaMac &#34;00:00:00:00:00:01&#34;</span>

  inSaMac &#34;default&#34;
     inDaMac &#34;FF:FF:FF:FF:FF:FF&#34;
     sIpAddr &#34;3ffe:2::2&#34;
     dIpAddr &#34;3ffe:1::1&#34;
     gIpAddr &#34;0.0.0.0&#34;    
     sPort &#34;1000&#34;
     dPort &#34;2000&#34;
     frameSize &#34;128&#34;
     icmpType &#34;0&#34;
     icmpCode &#34;0&#34;
     <span class="comment-line">#dontFrag &#34;true&#34;</span>
     <span class="comment-line">#ttl &#34;64&#34;</span>
     <span class="comment-line">#ttlDecr &#34;1&#34;</span>
     checkPortList {&#34;2 forwarded 1 exact&#34;} 
     numLearnFrame &#34;1&#34;
     numIpV6Frame &#34;1&#34;
     frameRate &#34;default&#34;
     filePt &#34;NULL&#34;
     ipDaMode &#34;ipIdle&#34;
     ipSaMode &#34;ipIdle&#34;
     ipDaCount &#34;&#34;
     ethernetType &#34;noType&#34;
     frameType &#34;86 DD&#34;
     ipSaCount &#34;&#34;
     <span class="comment-line">#ipOptions &#34;&#34;</span>
     tcpSynFlag &#34;false&#34;
     tcpFinFlag &#34;false&#34;
     tcpRstFlag &#34;false&#34;
     tcpAckFlag &#34;false&#34;
     tcpPushFlag &#34;false&#34;
     tcpUrgFlag &#34;false&#34;
     checkMirroringTag &#34;yes&#34;
     mirroringPort &#34;0&#34;
     <span class="comment-line">#TOS &#34;default&#34;</span>
     userPriority &#34;0&#34;
     careTotalIp &#34;no&#34; 
     CRC &#34;good&#34;
     comment &#34;&#34;
     rate &#34;null&#34;
     udfEnable &#34;false&#34;
     udfInitval &#34;00&#34;
     udfOffset &#34;0&#34;
     udfCountertype &#34;c8&#34;
     udfContinuousCount &#34;false&#34;
   }

   set rc 0

   if { $gIpAddr == &#34;0.0.0.0&#34; } { set gIpAddr $dIpAddr }

   set pPattern &#34;abcd&#34;   

   if {$rxPortId == $txPortId} {
      <a name="::result_error(1)"><a href="./lconsoles.tcl.html#::result_error_6">::result_error</a></a> &#34;Invalid port specification: txPortId=rxPortId&#34;
      return
   }
   foreach checkPort $checkPortList {
      lappend portMonitorList [lindex $checkPort 0]
   }
   
   if {$careTotalIp == &#34;yes&#34;} { set totalIpPacketReceived 0 }
   if {[lindex $tag 0]!=&#34;none&#34;&amp;&amp;$frameSize==64} {set frameSize 68}

   <a name="::report_start_test(1)"><a href="./report.tcl.html#::report_start_test_79">::report_start_test</a></a> &#34;Frame $protocol L2 forwarding check on \
                    			Txport $txPortId $comment&#34;

   <span class="comment-line">#turn on capturing function on all the monitor ports</span>
   <a name="::StartPortsCapture(1)"><a href="./ePTRx.tcl.html#::StartPortsCapture_820">::StartPortsCapture</a></a> $portMonitorList

         
   set numExpectedFrame $numIpV6Frame
   <span class="comment-line">#retrieve data</span>
 
      
         set destMacAddrTx $inDaMac

        set rxTag &#34;none&#34;
         if {[llength $tag] &gt; 1} { set rxTag [lindex $tag 1] }
        set txTag [lindex $tag 0]
         

         <span class="comment-line"># Send a single IP frame to seed the FDB, and IP FDB tables.</span>

   <span class="comment-line">#      if {$rxPortId &gt; 0 &amp;&amp; $numIpV6Frame &gt; 1} {</span>
   <span class="comment-line">#          SendIpv6Frame -txPortId $txPortId -sourceIp $sIpAddr \</span>
   <span class="comment-line">#                      -destMac $destMacAddrTx \</span>
   <span class="comment-line">#                      -rxPortId $rxPortId -destIp $dIpAddr</span>
   <span class="comment-line">#      }</span>

         <span class="comment-line">#turn on capturing function on all the monitor ports</span>
         <a name="::StartPortsCapture(2)"><a href="./ePTRx.tcl.html#::StartPortsCapture_820">::StartPortsCapture</a></a> $portMonitorList
         
         <span class="comment-line">#send packets</span>

    <a name="::result_debug(1)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;\n$numIpV6Frame IPv6 Frames  sent on portId $txPortId:&#34;

   set frameSent [<a name="::SendIpv6Frame(1)"><a href="./SendPacketIpv6.tcl.html#::SendIpv6Frame_1">::SendIpv6Frame</a></a> -txPortId $txPortId -protocol $protocol -tag $txTag \
                        -frameType $frameType -protocol $protocol -nHeader $nHeader \
                        -destPort $dPort -sourcePort $sPort -trafficClass $trafficClass \
                        -ipDaMode $ipDaMode -ipDaCount $ipDaCount -hopLimit $hopLimit \
                        -ipSaMode $ipSaMode -ipSaCount $ipSaCount \
                        -type $icmpType -code $icmpCode -frameRate $frameRate \
                        -tcpSynFlag $tcpSynFlag -tcpFinFlag $tcpFinFlag \
                        -tcpRstFlag $tcpRstFlag -tcpAckFlag $tcpAckFlag \
                        -tcpPushFlag $tcpPushFlag -tcpUrgFlag $tcpUrgFlag \
                        -dataPattern $pPattern -numFrames $numIpV6Frame \
                        -frameSize $frameSize -sourceMac $inSaMac \
                        -destMac $destMacAddrTx -sourceIp $sIpAddr \
                        -destIp $dIpAddr -udfEnable $udfEnable  \
                        -udfInitval $udfInitval -udfOffset $udfOffset -udfCountertype \
                         $udfCountertype -udfContinuousCount $udfContinuousCount]





        <span class="comment-line"># result_debug &#34;Ipv6 frame sent is $frameSent&#34;</span>
         set numExpectedFrame $numIpV6Frame



	foreach portId $portMonitorList {

           set numPacketReceived($portId) 0
           set rawPortData [<a name="::GetCapturedFrames(1)"><a href="./ePTRx.tcl.html#::GetCapturedFrames_982">::GetCapturedFrames</a></a> $portId]
           foreach frameReceived $rawPortData {

              set frameSizeSent [string length $frameSent]
             set frameSizeReceived [string length $frameReceived]


    set sourceMacRecv [<a name="::GetSourceMacAddress(1)"><a href="./MessageDecoding.tcl.html#::GetSourceMacAddress_40">::GetSourceMacAddress</a></a> $frameReceived]
    set destMacRecv [<a name="::GetDestMacAddress(1)"><a href="./MessageDecoding.tcl.html#::GetDestMacAddress_19">::GetDestMacAddress</a></a> $frameReceived]

    set sourceIpSent [string range $frameSent 78 125 ]
    set destIpSent [string range $frameSent 126 173 ]
    set sourceIpRecv [string range $frameReceived 78 125 ]
    set destIpRecv [string range $frameReceived 126 173 ]
    <span class="comment-line">#set sourceIpRecv [GetSourceIPAddress $frameReceived] ;#</span>
   <span class="comment-line"># set destIpRecv [GetDestIPAddress $frameReceived] ;#</span>
   <span class="comment-line"># result_debug &#34;Source and Dest Ip on  Portd $txPortId&#34;</span>
 <span class="comment-line">#   result_debug &#34; SourceMac: $inSaMac  DestMac: $destMacSent&#34;</span>
  <span class="comment-line"># result_debug &#34; SourceIP : $sourceIpSent  DestIp : $destIpSent&#34;</span>
  <span class="comment-line">#  result_debug &#34;Source and Dest Ip on Portd $rxPortId&#34;</span>
  <span class="comment-line">#  result_debug &#34;SourceIp: $sourceIpRecv DestIp: $destIpRecv&#34;</span>
  <span class="comment-line">#  result_debug &#34; SourceMac: $sourceMacRecv  DestMac: $destMacRecv&#34;</span>

    set typeSent [string range $frameSent 36 40]
    set typeReceived [string range $frameReceived 36 40]

    <span class="comment-line">#L2 forwarding</span>

          if { ($sourceIpRecv == $sourceIpSent ) &amp;&amp; \
               ($destIpRecv == $destIpSent) &amp;&amp; [<a name="::CheckTag(1)"><a href="./ePTForwarding.tcl.html#::CheckTag_978">::CheckTag</a></a> $frameReceived [lindex $tag 1] ]} {
 
            incr numPacketReceived($portId) 1
             <a name="::result_debug(2)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;Source and Dest IP check pass&#34;
             <span class="comment-line">#check data</span>
             }
           }
           <a name="::result_debug(3)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;numPacketReceived($portId)= $numPacketReceived($portId)&#34;
           if {$careTotalIp == &#34;yes&#34;} {incr totalIpPacketReceived $numPacketReceived($portId)}
        }



   <span class="comment-line">#now check received data against checkList to see if matched</span>
   set testResult &#34;good&#34;
   foreach checkPort $checkPortList {
      set portId [lindex $checkPort 0]
      set portFlag [lindex $checkPort 1]
      set expectedRange &#34;exact&#34;
      switch -- $portFlag \
         &#34;forwarded&#34; {
            if {[lindex $checkPort 2] == &#34;&#34;} {
              set expectedPacket $numExpectedFrame
            } else {  
              set expectedPacket [lindex $checkPort 2]
              if { [lindex $checkPort 3] != &#34;&#34;} { 
                 set expectedRange [lindex $checkPort 3] ;<span class="comment-line"># could be up or down</span>
              }  
            }   
      }  &#34;notForwarded&#34; {
            set expectedPacket 0
      }  default {
            set expectedPacket $portFlag
      }
                        
      switch -- $expectedRange {
         &#34;up&#34; {
            if { ($numPacketReceived($portId) &gt;= $expectedPacket) } {
               <a name="::result_debug(4)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;Forwarding on port $portId checked Ok  \
                                  ($numPacketReceived($portId)). Was $portFlag&#34;
               set testResult &#34;good&#34;
            } else {

               <a name="::result_error(2)"><a href="./lconsoles.tcl.html#::result_error_6">::result_error</a></a> &#34;Forwarding criteria failed on port $portId.&#34;
               <a name="::result_debug(5)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;numPacketReceived= $numPacketReceived($portId) \
                                        BUT expectedPackets= $expectedPacket&#34;
               set testResult &#34;bad&#34;
            }
         } 
         &#34;down&#34; {
            if { ($numPacketReceived($portId) &lt;= $expectedPacket) } {
               <a name="::result_debug(6)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;Forwarding on port $portId checked Ok \
                                 ($numPacketReceived($portId)). Was $portFlag&#34;
            } else {

               <a name="::result_error(3)"><a href="./lconsoles.tcl.html#::result_error_6">::result_error</a></a> &#34;Forwarding criteria failed on port $portId.&#34;
               <a name="::result_debug(7)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;numPacketReceived= $numPacketReceived($portId) \
                                    BUT expectedPackets= $expectedPacket&#34;
               set testResult &#34;bad&#34;
            }
         }
         &#34;exact&#34; -
         default {
           if { ($numPacketReceived($portId) == $expectedPacket) } {

              <a name="::result_debug(8)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;Forwarding on port $portId checked Ok \
                             ($numPacketReceived($portId)). Was $portFlag&#34;

           } else {

              <a name="::result_error(4)"><a href="./lconsoles.tcl.html#::result_error_6">::result_error</a></a> &#34;Forwarding criteria failed on port $portId.&#34;
              <a name="::result_debug(9)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;numPacketReceived= $numPacketReceived($portId) \
                                          BUT expectedPackets= $expectedPacket&#34;
              set testResult &#34;bad&#34;

           }
         }
      }    
   }
   if {$careTotalIp == &#34;yes&#34;} {
     if {$totalIpPacketReceived == $numIpV6Frame } {

        <a name="::result_debug(10)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;Forwarding on total received IP packets checked Ok&#34;

    } else {

        <a name="::result_error(5)"><a href="./lconsoles.tcl.html#::result_error_6">::result_error</a></a> &#34;Forwarding failed on total received IP packets \
                                                 from all forwarded ports&#34;

        <a name="::result_debug(11)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;total no. Packet Received($totalIpPacketReceived) \
                                      &lt;&gt; total no. IP packets sent($numIpFrame)&#34;

        set testResult &#34;bad&#34;        
     }            
   }
   if {$testResult == &#34;good&#34;} {
      <a name="::result_ok(1)"><a href="./lconsoles.tcl.html#::result_ok_9">::result_ok</a></a> &#34;Check data forwarding passed&#34;
      set rc 1
   } else {
      <a name="::result_error(6)"><a href="./lconsoles.tcl.html#::result_error_6">::result_error</a></a> &#34;Check data forwarding failed&#34;
      set rc 0
   }  
   <a name="::report_end_test(1)"><a href="./report.tcl.html#::report_end_test_122">::report_end_test</a></a>

   return $rc
}



















</pre>
<hr>
<div class="index-selector">
	<a href="index_main.html#byfilename">file name</a> 
 | 
	<a href="index_main.html#byprocname">procedure name</a> 
 | 
	<a href="index_main.html#bycall">procedure call</a> 
 | 
	<a href="index_annot_full.html">annotation</a> 

<br>
<cite>File generated 2018-06-14 at 17:09.</cite>
</div>

</body>
</html>
