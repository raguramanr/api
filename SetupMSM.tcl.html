<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                       "http://www.w3.org/TR/html4/transitional.dtd">
<!-- Generated by TclDoc @@VERSION@@ -->
<html>
<head>
  <title>SetupMSM.tcl</title>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <link rel="stylesheet" type="text/css" href="default.css">
</head>
<body class="src-html">
<div class="index-selector">
<!-- index for tcl source files -->
	Index by: 
	<a href="index_main.html#SetupMSM.tcl">file name</a> | 
	<a href="index_main.html#byprocname">procedure name</a> | 
	<a href="index_main.html#bycall">procedure call</a> | 
	<a href="index_annot_full.html">annotation</a>

</div>
<hr>

<p><strong>SetupMSM.tcl</strong>&nbsp;&nbsp;<span class="filetype-link">(<a href="SetupMSM.tcl-annot.html">annotations</a> | <a href="SetupMSM.tcl.txt">original source</a>)</span>
</p>
<pre class="src-code">
<span class="comment-line">###################################################################</span>
<span class="comment-line">#     Verify MSM A is the Master</span>
<span class="comment-line">###################################################################</span>
<strong><a name="::::VerifyMsmAMaster_4">proc <a href="SetupMSM.tcl-annot.html#::::VerifyMsmAMaster">::::VerifyMsmAMaster</a></a></strong> {} {
    global DUTx_CONNECTA

    global DUT1_Stacking_msma_slot
    global DUT1_Stacking_msmb_slot

    <span class="comment-line"># Verify MSM A = Master</span>
    <span class="comment-line">###########################################################</span>
    set subTest &#34;Verify MSM A is the Master&#34;
    <span class="comment-line">###########################################################</span>
    result_h2 &#34;$subTest&#34;
    <a name="::report_start_test(1)"><a href="./report.tcl.html#::report_start_test_79">::report_start_test</a></a> &#34;$subTest&#34;

    <span class="comment-line"># Login</span>
    <a name="::Login(1)"><a href="./login.tcl.html#::Login_24">::Login</a></a> $DUTx_CONNECTA -masterCheck 0
    if { [info exists DUT1_Stacking_msma_slot] } {
	set result [<a name="::VerifyMsmAMasterStacking(1)"><a href="./SetupMSM.tcl.html#::VerifyMsmAMasterStacking_64">::VerifyMsmAMasterStacking</a></a>]
    } else {
	lappend checkKeyList &#34;{Current State: *MASTER} exist&#34;
	set result [<a name="::CheckKeyValue(1)"><a href="./OptionCheck.tcl.html#::CheckKeyValue_47">::CheckKeyValue</a></a> &#34;show switch&#34; $checkKeyList -comment &#34;$subTest&#34; \
		-time {s: 1 t: 2 d: 30 f: 40 r}]
	unset checkKeyList
    }

    <a name="::report_end_test(1)"><a href="./report.tcl.html#::report_end_test_122">::report_end_test</a></a>
    return $result
}

<span class="comment-line">###################################################################</span>
<span class="comment-line">#     Verify MSM B is the Master</span>
<span class="comment-line">###################################################################</span>
<strong><a name="::::VerifyMsmBMaster_35">proc <a href="SetupMSM.tcl-annot.html#::::VerifyMsmBMaster">::::VerifyMsmBMaster</a></a></strong> {} {
    global DUTx_CONNECTB

    global DUT1_Stacking_msma_slot
    global DUT1_Stacking_msmb_slot

    <span class="comment-line"># Verify MSM B = Master</span>
    <span class="comment-line">###########################################################</span>
    set subTest &#34;Verify MSM B is the Master&#34;
    <span class="comment-line">###########################################################</span>
    result_h2 &#34;$subTest&#34;
    <a name="::report_start_test(2)"><a href="./report.tcl.html#::report_start_test_79">::report_start_test</a></a> &#34;$subTest&#34;

    <a name="::Login(2)"><a href="./login.tcl.html#::Login_24">::Login</a></a> $DUTx_CONNECTB -masterCheck 0
    if { [info exists DUT1_Stacking_msma_slot] } {
	set result [<a name="::VerifyMsmBMasterStacking(1)"><a href="./SetupMSM.tcl.html#::VerifyMsmBMasterStacking_76">::VerifyMsmBMasterStacking</a></a>]
    } else {
	<span class="comment-line"># Login</span>
	lappend checkKeyList &#34;{Current State: *MASTER} notExist&#34;
	lappend checkKeyList &#34;{Current State: *.* *MASTER} exist&#34;
	set result [<a name="::CheckKeyValue(2)"><a href="./OptionCheck.tcl.html#::CheckKeyValue_47">::CheckKeyValue</a></a> &#34;show switch&#34; $checkKeyList -comment &#34;$subTest&#34; \
		-time {s: 1 t: 2 d: 30 f: 40 r}]
	unset checkKeyList
    }

    <a name="::report_end_test(2)"><a href="./report.tcl.html#::report_end_test_122">::report_end_test</a></a>
    return $result
}

<strong><a name="::::VerifyMsmAMasterStacking_64">proc <a href="SetupMSM.tcl-annot.html#::::VerifyMsmAMasterStacking">::::VerifyMsmAMasterStacking</a></a></strong> { } {

    global DUT1_Stacking_msma_slot

    lappend checkKeyList &#34;{Slot: *Slot-$DUT1_Stacking_msma_slot} exist&#34;
    lappend checkKeyList &#34;{Current State: *MASTER} exist&#34;
    set result [<a name="::CheckKeyValue(3)"><a href="./OptionCheck.tcl.html#::CheckKeyValue_47">::CheckKeyValue</a></a> &#34;show switch&#34; $checkKeyList -time {s: 1 t: 2 d: 30 f: 40 r}]
    unset checkKeyList

    return $result
}

<strong><a name="::::VerifyMsmBMasterStacking_76">proc <a href="SetupMSM.tcl-annot.html#::::VerifyMsmBMasterStacking">::::VerifyMsmBMasterStacking</a></a></strong> { } {

    global DUT1_Stacking_msmb_slot

    lappend checkKeyList &#34;{Slot: *Slot-$DUT1_Stacking_msmb_slot} exist&#34;
    lappend checkKeyList &#34;{Current State: *MASTER} exist&#34;
    set result [<a name="::CheckKeyValue(4)"><a href="./OptionCheck.tcl.html#::CheckKeyValue_47">::CheckKeyValue</a></a> &#34;show switch&#34; $checkKeyList -time {s: 1 t: 2 d: 30 f: 40 r}]
    unset checkKeyList

    return $result
}

<span class="comment-line">###################################################################</span>
<span class="comment-line">#     MakeMSMAMaster</span>
<span class="comment-line">###################################################################</span>
<strong><a name="::::MakeMSMAMaster_91">proc <a href="SetupMSM.tcl-annot.html#::::MakeMSMAMaster">::::MakeMSMAMaster</a></a></strong> { } {
    global DUTx_CONNECTA
    global DUTx_CONNECTB
    
    if {[<a name="::Login(3)"><a href="./login.tcl.html#::Login_24">::Login</a></a> $DUTx_CONNECTA -masterCheck 1]} {
       if {[<a name="::CheckOperational(1)"><a href="./login.tcl.html#::CheckOperational_653">::CheckOperational</a></a>]} {
          return &#34;ok&#34;
       } else {
          return error
       }
    } else {
       return &#34;error&#34;
    }
}

<span class="comment-line">###################################################################</span>
<span class="comment-line">#     MakeMSMBMaster</span>
<span class="comment-line">###################################################################</span>
<strong><a name="::::MakeMSMBMaster_109">proc <a href="SetupMSM.tcl-annot.html#::::MakeMSMBMaster">::::MakeMSMBMaster</a></a></strong> { } {
    global DUTx_CONNECTA
    global DUTx_CONNECTB
    
    if {[<a name="::Login(4)"><a href="./login.tcl.html#::Login_24">::Login</a></a> $DUTx_CONNECTB -masterCheck 1]} {
       if {[<a name="::CheckOperational(2)"><a href="./login.tcl.html#::CheckOperational_653">::CheckOperational</a></a>]} {
          return &#34;ok&#34;
       } else {
          return error
       }
    } else {
       return &#34;error&#34;
    }
}

<span class="comment-line">###################################################################</span>
<span class="comment-line">#     SetupMsmTestAB</span>
<span class="comment-line">###################################################################</span>
<strong><a name="::::SetupMsmTestAB_127">proc <a href="SetupMSM.tcl-annot.html#::::SetupMsmTestAB">::::SetupMsmTestAB</a></a></strong> { } {
    global DUTx
    global DUTx_CONNECTA
    global DUTx_CONNECTB
    
    <a name="::Login(5)"><a href="./login.tcl.html#::Login_24">::Login</a></a> $DUTx_CONNECTA -masterCheck 0
    set getKeyList &#34;{{Current State:} 1}&#34; 
    set stateA_A [<a name="::GetKeyValue(1)"><a href="./OptionCheck.tcl.html#::GetKeyValue_438">::GetKeyValue</a></a> &#34;show switch&#34; $getKeyList]
    set getKeyList &#34;{{Current State:} 2}&#34; 
    set stateB_A [<a name="::GetKeyValue(2)"><a href="./OptionCheck.tcl.html#::GetKeyValue_438">::GetKeyValue</a></a> &#34;show switch&#34; $getKeyList]
    
    <a name="::Login(6)"><a href="./login.tcl.html#::Login_24">::Login</a></a> $DUTx_CONNECTB -masterCheck 0
    set getKeyList &#34;{{Current State:} 1}&#34; 
    set stateA_B [<a name="::GetKeyValue(3)"><a href="./OptionCheck.tcl.html#::GetKeyValue_438">::GetKeyValue</a></a> &#34;show switch&#34; $getKeyList]
    set getKeyList &#34;{{Current State:} 2}&#34; 
    set stateB_B [<a name="::GetKeyValue(4)"><a href="./OptionCheck.tcl.html#::GetKeyValue_438">::GetKeyValue</a></a> &#34;show switch&#34; $getKeyList]
    
    <a name="::Login(7)"><a href="./login.tcl.html#::Login_24">::Login</a></a> $DUTx_CONNECTA -masterCheck 0
    if { $stateA_A==&#34;MASTER&#34; &amp;&amp; $stateB_A==&#34;BACKUP&#34; &amp;&amp; \
	    $stateA_B==&#34;MASTER&#34; &amp;&amp; $stateB_B==&#34;BACKUP&#34; } {
	set result [<a name="::CheckOperational(3)"><a href="./login.tcl.html#::CheckOperational_653">::CheckOperational</a></a>]
	if { $result == 0 } {
	    <a name="::MyCheckReboot(1)"><a href="./SetupMSM.tcl.html#::MyCheckReboot_301">::MyCheckReboot</a></a>
	} else {
	    <a name="::Login(8)"><a href="./login.tcl.html#::Login_24">::Login</a></a> $DUTx_CONNECTB -masterCheck 0
	    set result [<a name="::CheckOperational(4)"><a href="./login.tcl.html#::CheckOperational_653">::CheckOperational</a></a>]
	    if { $result == 0 } {
		<a name="::Login(9)"><a href="./login.tcl.html#::Login_24">::Login</a></a> $DUTx_CONNECTA -masterCheck 0
		<a name="::MyCheckReboot(2)"><a href="./SetupMSM.tcl.html#::MyCheckReboot_301">::MyCheckReboot</a></a> -msm &#34;B&#34;
	    }
	}
	return $result
    } else { 
	if {$stateA_A==&#34;MASTER&#34;} {
	    <a name="::Login(10)"><a href="./login.tcl.html#::Login_24">::Login</a></a> $DUTx_CONNECTA -masterCheck 0
	    <a name="::SendACmd(1)"><a href="./SendSwCmd.tcl.html#::SendACmd_157">::SendACmd</a></a> &#34;config sys-recovery-level all&#34;
	    <a name="::MyCheckReboot(3)"><a href="./SetupMSM.tcl.html#::MyCheckReboot_301">::MyCheckReboot</a></a>
	} else {
	    <a name="::Login(11)"><a href="./login.tcl.html#::Login_24">::Login</a></a> $DUTx_CONNECTB -masterCheck 0
	    <a name="::SendACmd(2)"><a href="./SendSwCmd.tcl.html#::SendACmd_157">::SendACmd</a></a> &#34;config sys-recovery-level all&#34;
	    <a name="::MyCheckReboot(4)"><a href="./SetupMSM.tcl.html#::MyCheckReboot_301">::MyCheckReboot</a></a> -masterCheck 0
	}
	return &#34;error&#34;
    }
}

<span class="comment-line">###################################################################</span>
<span class="comment-line">#     SetupMsmTestBA</span>
<span class="comment-line">###################################################################</span>
<strong><a name="::::SetupMsmTestBA_176">proc <a href="SetupMSM.tcl-annot.html#::::SetupMsmTestBA">::::SetupMsmTestBA</a></a></strong> { } {
    global DUTx
    global DUTx_CONNECTA
    global DUTx_CONNECTB
    
    <a name="::Login(12)"><a href="./login.tcl.html#::Login_24">::Login</a></a> $DUTx_CONNECTA -masterCheck 0
    set getKeyList &#34;{{Current State:} 1}&#34; 
    set stateA_A [<a name="::GetKeyValue(5)"><a href="./OptionCheck.tcl.html#::GetKeyValue_438">::GetKeyValue</a></a> &#34;show switch&#34; $getKeyList]
    set getKeyList &#34;{{Current State:} 2}&#34; 
    set stateB_A [<a name="::GetKeyValue(6)"><a href="./OptionCheck.tcl.html#::GetKeyValue_438">::GetKeyValue</a></a> &#34;show switch&#34; $getKeyList]
    
    <a name="::Login(13)"><a href="./login.tcl.html#::Login_24">::Login</a></a> $DUTx_CONNECTB -masterCheck 0
    set getKeyList &#34;{{Current State:} 1}&#34; 
    set stateA_B [<a name="::GetKeyValue(7)"><a href="./OptionCheck.tcl.html#::GetKeyValue_438">::GetKeyValue</a></a> &#34;show switch&#34; $getKeyList]
    set getKeyList &#34;{{Current State:} 2}&#34; 
    set stateB_B [<a name="::GetKeyValue(8)"><a href="./OptionCheck.tcl.html#::GetKeyValue_438">::GetKeyValue</a></a> &#34;show switch&#34; $getKeyList]
    set getKeyList &#34;{{Current State:} 4}&#34; 
    set stateB1_B [<a name="::GetKeyValue(9)"><a href="./OptionCheck.tcl.html#::GetKeyValue_438">::GetKeyValue</a></a> &#34;show switch&#34; $getKeyList]
    
    if { $stateA_A==&#34;BACKUP&#34; &amp;&amp; $stateB_A==&#34;MASTER&#34; &amp;&amp; \
	    $stateA_B==&#34;BACKUP&#34; &amp;&amp; 
    ( $stateB_B==&#34;MASTER&#34; || $stateB1_B==&#34;MASTER&#34;) } {
	set result [<a name="::CheckOperational(5)"><a href="./login.tcl.html#::CheckOperational_653">::CheckOperational</a></a>]
	if { $result == 0 } {
	    <a name="::MyCheckReboot(5)"><a href="./SetupMSM.tcl.html#::MyCheckReboot_301">::MyCheckReboot</a></a>
	} else {
	    <a name="::Login(14)"><a href="./login.tcl.html#::Login_24">::Login</a></a> $DUTx_CONNECTA -masterCheck 0
	    set result [<a name="::CheckOperational(6)"><a href="./login.tcl.html#::CheckOperational_653">::CheckOperational</a></a>]
	    if { $result == 0 } {
		<a name="::Login(15)"><a href="./login.tcl.html#::Login_24">::Login</a></a> $DUTx_CONNECTB -masterCheck 0
		<a name="::MyCheckReboot(6)"><a href="./SetupMSM.tcl.html#::MyCheckReboot_301">::MyCheckReboot</a></a> -msm &#34;A&#34;
	    }
	}
	return $result
    } else { 
	if {$stateA_A==&#34;MASTER&#34;} {
	    <a name="::Login(16)"><a href="./login.tcl.html#::Login_24">::Login</a></a> $DUTx_CONNECTA -masterCheck 0
	    <a name="::SendACmd(3)"><a href="./SendSwCmd.tcl.html#::SendACmd_157">::SendACmd</a></a> &#34;config sys-recovery-level all&#34;
	} else {
	    <a name="::Login(17)"><a href="./login.tcl.html#::Login_24">::Login</a></a> $DUTx_CONNECTB -masterCheck 0
	    <a name="::SendACmd(4)"><a href="./SendSwCmd.tcl.html#::SendACmd_157">::SendACmd</a></a> &#34;config sys-recovery-level all&#34;
	}
	<a name="::MyCheckReboot(7)"><a href="./SetupMSM.tcl.html#::MyCheckReboot_301">::MyCheckReboot</a></a> -msm &#34;A&#34;
	return &#34;error&#34;
    }
}

<span class="comment-line">###################################################################</span>
<span class="comment-line">#     KillXOSProcess</span>
<span class="comment-line">###################################################################</span>
<strong><a name="::::KillXOSProcess_226">proc <a href="SetupMSM.tcl-annot.html#::::KillXOSProcess">::::KillXOSProcess</a></a></strong> { msm processName } {
    global DUTx_CONNECTA
    global DUTx_CONNECTB
    global validstring
    <a name="::Login(18)"><a href="./login.tcl.html#::Login_24">::Login</a></a> [set DUTx_CONNECT[set msm]] -masterCheck 0
    
    <span class="comment-line">#####################################</span>
    set subTest &#34;Kill $processName&#34;
    <span class="comment-line">#####################################</span>
    result_h2 &#34;$subTest&#34;
    <a name="::report_start_test(3)"><a href="./report.tcl.html#::report_start_test_79">::report_start_test</a></a> &#34;$subTest&#34;
    set validstring(KillMSMProcess) &#34;Crit:DM.Critical&#34; 
    
    lappend pidList &#34;$processName 1&#34;
    set pid [<a name="::GetKeyValue(10)"><a href="./OptionCheck.tcl.html#::GetKeyValue_438">::GetKeyValue</a></a> &#34;show process $processName detail slot $msm&#34; $pidList]
    regsub -all {main} $pid &#34;&#34; pid;
    if { $pid != &#34;&#34; } {
	<a name="::EnableDebugMode(1)"><a href="./misc.tcl.html#::EnableDebugMode_2430">::EnableDebugMode</a></a>
	if { [<a name="::CheckCmdLegal(1)"><a href="./checkCmdLegality.tcl.html#::CheckCmdLegal_58">::CheckCmdLegal</a></a> &#34;!kill -9 $pid&#34;] == &#34;illegal&#34; } {
	    set rtnCode 0
	    <a name="::result_error(1)"><a href="./lconsoles.tcl.html#::result_error_6">::result_error</a></a> &#34;can not kill process $processName!&#34;
	} else {
	    set rtnCode 1
	    <a name="::result_ok(1)"><a href="./lconsoles.tcl.html#::result_ok_9">::result_ok</a></a> &#34;Process $processName killed&#34;
	}
        <span class="comment-line"># Need sleep here because of delay between killing process and msm rebooting</span>
        <a name="::exSleep(1)"><a href="./sleep.tcl.html#::exSleep_248">::exSleep</a></a> 30
    } else {
	set rtnCode 1
	<a name="::result_ok(2)"><a href="./lconsoles.tcl.html#::result_ok_9">::result_ok</a></a> &#34;Process $processName gone already!&#34;
    }
    unset validstring(KillMSMProcess) 
    <a name="::report_end_test(3)"><a href="./report.tcl.html#::report_end_test_122">::report_end_test</a></a>
    return $rtnCode
}

<span class="comment-line">###################################################################</span>
<span class="comment-line">#   explicitFailOver</span>
<span class="comment-line">###################################################################</span>
<strong><a name="::::ExplicitFailOver_265">proc <a href="SetupMSM.tcl-annot.html#::::ExplicitFailOver">::::ExplicitFailOver</a></a></strong> { msm } {
    global DUTx_CONNECTA
    global DUTx_CONNECTB
    global hostname
    global spawn_ids
    global spawn_id
    
    <span class="comment-line">#####################################</span>
    set subTest &#34;run msm-failover force on MSM $msm&#34;
    <span class="comment-line">#####################################</span>
    result_h2 &#34;$subTest&#34;
    <a name="::report_start_test(4)"><a href="./report.tcl.html#::report_start_test_79">::report_start_test</a></a> &#34;$subTest&#34;
    set pid _[pid]
    <a name="::Login(19)"><a href="./login.tcl.html#::Login_24">::Login</a></a> [set DUTx_CONNECT$msm] -masterCheck 0
    <span class="comment-line"># can not use SendACmd</span>
<span class="comment-line">#    send &#34;run msm-failover force\r&#34;</span>
    <a name="::SendACmd(5)"><a href="./SendSwCmd.tcl.html#::SendACmd_157">::SendACmd</a></a> &#34;run msm-failover force&#34;
    <a name="::exSleep(2)"><a href="./sleep.tcl.html#::exSleep_248">::exSleep</a></a> 20 ;<span class="comment-line"># do not return immediately, as new slave is still rebooting, hits bootrom</span>
    <a name="::report_end_test(4)"><a href="./report.tcl.html#::report_end_test_122">::report_end_test</a></a> 1
}


<span class="comment-line">################################################################## </span>
<span class="comment-line"># Procedure Name: MyCheckReboot</span>
<span class="comment-line">#   </span>
<span class="comment-line"># Description: Reboots the current Login DUT, saves the current config</span>
<span class="comment-line">#</span>
<span class="comment-line"># Input args: duts, save</span>
<span class="comment-line"># Output args: none</span>
<span class="comment-line"># Typical usage:</span>
<span class="comment-line">#             CheckReboot -save no -msm A</span>
<span class="comment-line">#</span>
<span class="comment-line"># Category Types (Setup,GetSwitchInfo,SendTraffic,CaptureTraffic,</span>
<span class="comment-line">#                 VerifySwitchOutput,VerifyTraffic)</span>
<span class="comment-line"># Category: Setup</span>
<span class="comment-line">##################################################################</span>
<strong><a name="::::MyCheckReboot_301">proc <a href="SetupMSM.tcl-annot.html#::::MyCheckReboot">::::MyCheckReboot</a></a></strong> {args} {
    global DUT
    global DUTs_info
    global DUTx_CONNECTA
    global DUTx_CONNECTB
    global DUT1_Stacking_msma_slot
    global DUT1_Stacking_msmb_slot
    
    <a name="::parse_args(1)"><a href="./parse_args.tcl.html#::parse_args_29">::parse_args</a></a> MyCheckReboot $args {
	save &#34;yes&#34;
	maxWait 90
	msm &#34;&#34;
	masterCheck 1
    }
    <a name="::DBug(1)"><a href="./misc.tcl.html#::DBug_951">::DBug</a></a> 1 &#34;the CheckReboot args vals: save $save, maxWait $maxWait, msm $msm&#34;

    set msm [string tolower $msm]
    if {$msm != &#34;&#34; } {
	if { [info exists DUT1_Stacking_msma_slot] } {
	    <a name="::result_debug(1)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;Rebooting slot [set DUT1_Stacking_msm${msm}_slot] ...&#34;
	    <a name="::result_debug(2)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;send reboot slot [set DUT1_Stacking_msm${msm}_slot]&#34;
	    send &#34;reboot slot [set DUT1_Stacking_msm${msm}_slot] \n&#34;
	} else {
	    <a name="::result_debug(3)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;Rebooting msm $msm ...&#34;
	    <a name="::result_debug(4)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;send reboot msm$msm&#34;
	    send	&#34;reboot msm $msm\n&#34;
	}
    } else {
	<a name="::result_debug(5)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;send reboot&#34;
	send	&#34;reboot\n&#34;
    }
    set msm [string toupper $msm]

    expect &#34;y - save&#34;
    if {[regexp -nocase &#34;^n&#34; $save]} {
	send &#34;n\n&#34;
    } else {
	send &#34;y\n&#34;
    }
    expect &#34;#&#34;
    <span class="comment-line">#   send &#34;\n&#34;</span>
    <span class="comment-line">#   expect &#34; #&#34;</span>
    <a name="::result_debug(6)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;Rebooting switch ...&#34;
    if {$msm != &#34;&#34; } {
	if { [info exists DUT1_Stacking_msma_slot] } {
	    set wait 120
	} else {
	    set wait 60
	}
	<a name="::result_debug(7)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;wait $wait before switch to other port...&#34;
	<a name="::exSleep(3)"><a href="./sleep.tcl.html#::exSleep_248">::exSleep</a></a> $wait
	set status [<a name="::Login(20)"><a href="./login.tcl.html#::Login_24">::Login</a></a> [set DUTx_CONNECT[set msm]] -masterCheck 0]
	if {$status} {
	    return &#34;ok&#34;
	} else {
	    <a name="::report_start_test(5)"><a href="./report.tcl.html#::report_start_test_79">::report_start_test</a></a> &#34;Failed to connect to switch after reboot&#34;
	    <a name="::result_error(2)"><a href="./lconsoles.tcl.html#::result_error_6">::result_error</a></a> &#34;Failed to connect to switch after reboot&#34;
	    <a name="::report_end_test(5)"><a href="./report.tcl.html#::report_end_test_122">::report_end_test</a></a>
	    return &#34;error&#34;
	}
    } else {
	set status [<a name="::::MyWaitForReboot(1)"><a href="./upgradecheck.tcl.html#::::MyWaitForReboot_774">::::MyWaitForReboot</a></a> $maxWait &#34;after sending reboot command to the DUT&#34; $masterCheck]
	if {$status == &#34;error&#34;} {
	    <a name="::report_start_test(6)"><a href="./report.tcl.html#::report_start_test_79">::report_start_test</a></a> &#34;Failed to connect to switch after reboot&#34;
	    <a name="::result_error(3)"><a href="./lconsoles.tcl.html#::result_error_6">::result_error</a></a> &#34;Failed to connect to switch after reboot&#34;
	    <a name="::report_end_test(6)"><a href="./report.tcl.html#::report_end_test_122">::report_end_test</a></a>
	} else {
	    <a name="::SendACmd(6)"><a href="./SendSwCmd.tcl.html#::SendACmd_157">::SendACmd</a></a> &#34;config default delete port all&#34;
	    <a name="::SendACmd(7)"><a href="./SendSwCmd.tcl.html#::SendACmd_157">::SendACmd</a></a> &#34;disable clipaging&#34;
         <span class="comment-line">#EnableDebugMode</span>
         <span class="comment-line">#SendACmd &#34;!echo dump_stack &gt; /sys/module/watchdog/parameters/watchdog_warn_behavior&#34;</span>
	}
	return $status
    }
}

<span class="comment-line">################################################################## </span>
<span class="comment-line"># Procedure Name: MSMFailoverCapable</span>
<span class="comment-line">#   </span>
<span class="comment-line"># Description: Determine if msm-failover is ok to be run on the DUT</span>
<span class="comment-line">#</span>
<span class="comment-line"># Input args: None</span>
<span class="comment-line">#</span>
<span class="comment-line"># Output args: 1/0</span>
<span class="comment-line">#</span>
<span class="comment-line"># Typical usage:</span>
<span class="comment-line">#             if { [MSMFailoverCapable] } { ExplicitFailOver &#34;A&#34; }</span>
<span class="comment-line">#</span>
<span class="comment-line"># Category: Setup</span>
<span class="comment-line">##################################################################</span>
<strong><a name="::::MSMFailoverCapable_391">proc <a href="SetupMSM.tcl-annot.html#::::MSMFailoverCapable">::::MSMFailoverCapable</a></a></strong> { } {

    global DUTx
    global DUTx_CONNECTA
    global DUTx_CONNECTB
    global DUT1_CONNECT DUT1_CONNECTB DUT2_CONNECT DUT2_CONNECTB
    global chassis

    if {[regexp -nocase &#34;$chassis&#34; [<a name="::GetPlatform(1)"><a href="./misc.tcl.html#::GetPlatform_478">::GetPlatform</a></a>]] == 1 &amp;&amp; [info exists DUT1_CONNECTB]} {
	set DUTx 1
	set DUTx_CONNECTA $DUT1_CONNECT
	if {[info exists DUT1_CONNECTB]} {
	    set DUTx_CONNECTB $DUT1_CONNECTB
	} elseif {[info exists DUT1_CONNECT_BACKUP]} { 
	    set DUTx_CONNECTB $DUT1_CONNECT_BACKUP
	}
	<a name="::result_ok(3)"><a href="./lconsoles.tcl.html#::result_ok_9">::result_ok</a></a> &#34;DUT1 is used for MSM FailOver test&#34;
    } elseif {[regexp -nocase &#34;$chassis&#34; [<a name="::GetPlatform(2)"><a href="./misc.tcl.html#::GetPlatform_478">::GetPlatform</a></a> DUT2]] == 1 &amp;&amp; [info exists DUT2_CONNECTB]} {
	set DUTx 2
	set DUTx_CONNECTA $DUT2_CONNECT
	if {[info exists DUT1_CONNECTB]} {
	    set DUTx_CONNECTB $DUT2_CONNECTB
	} elseif {[info exists DUT2_CONNECT_BACKUP]} { 
	    set DUTx_CONNECTB $DUT2_CONNECT_BACKUP
	}
	<a name="::result_ok(4)"><a href="./lconsoles.tcl.html#::result_ok_9">::result_ok</a></a> &#34;DUT2 is used for MSM FailOver test&#34;
    } else {
	<a name="::result_ok(5)"><a href="./lconsoles.tcl.html#::result_ok_9">::result_ok</a></a> &#34;neither DUT1 nor DUT2 can not be used for MSM Fail Over test&#34;
	return 0
    }
    return 1
}
<span class="comment-line">################################################################## </span>
<span class="comment-line"># Procedure Name: findslotsystemdump</span>
<span class="comment-line">#   </span>
<span class="comment-line"># Description: clear debug system-dump on all slots plus MSM/MM</span>
<span class="comment-line">#</span>
<span class="comment-line"># Input args: None</span>
<span class="comment-line">#</span>
<span class="comment-line"># Output args: None</span>
<span class="comment-line">#</span>
<span class="comment-line"># Typical usage:</span>
<span class="comment-line">#             findslotsystemdump</span>
<span class="comment-line">#</span>
<span class="comment-line"># Category: Verify</span>
<span class="comment-line">##################################################################</span>
<strong><a name="::::findslotsystemdump_437">proc <a href="SetupMSM.tcl-annot.html#::::findslotsystemdump">::::findslotsystemdump</a></a></strong> {} {
    global DUT1_CONNECT
    global DUT2_CONNECT
    global DUT3_CONNECT
    global DUT4_CONNECT
    global DUT5_CONNECT
    global chassis
    global DUTs_info
    global bladeType
    global platform
    global stacking
    global gnssPlatform
    
    for {set k 1} {$k &lt;= 5} {incr k} {
        if {![info exists DUT${k}_CONNECT]} {
            continue;
        }
        set platform [<a name="::GetPlatform(3)"><a href="./misc.tcl.html#::GetPlatform_478">::GetPlatform</a></a> DUT${k}]
        <a name="::Login(21)"><a href="./login.tcl.html#::Login_24">::Login</a></a> [set DUT${k}_CONNECT]
        <a name="::result_debug(8)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;platform : $platform&#34;
        if {[regexp -nocase &#34;$stacking&#34; $DUTs_info(DUT${k},platform)]} {
            set slotName $DUTs_info(DUT${k},hwList)
            puts &#34;slotName value is $slotName&#34;
            set Slot 1
            <span class="comment-line"># Clear system dumps for each stackable in the stack</span>
            foreach i $slotName {
                puts &#34;I value is : $i&#34;
                if {&#34;$i&#34; != &#34;Empty&#34;} {
                    <a name="::result_debug(9)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;slot is $Slot&#34;
                    lappend parameterList &#34;{core_dump_info|failure:} notExist&#34;
                    if { [<a name="::CheckKeyValue(5)"><a href="./OptionCheck.tcl.html#::CheckKeyValue_47">::CheckKeyValue</a></a> &#34;show debug system-dump slot $Slot&#34; $parameterList \
                                      -comment &#34;Check core in slot-$Slot DUT$k&#34;] != &#34;ok&#34; } {
                        <a name="::SendACmd(8)"><a href="./SendSwCmd.tcl.html#::SendACmd_157">::SendACmd</a></a> &#34;clear debug system-dump slot $Slot&#34;
                        <a name="::result_debug(10)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;system-dump cleared on slot-$Slot DUT$k&#34;
                    }
                    unset parameterList
                }
                incr Slot
            }
        } elseif {[regexp -nocase &#34;BD-X8|$chassis&#34; $DUTs_info(DUT${k},platform)]} {
            set slotName $DUTs_info(DUT${k},hwList)
            puts &#34;slotName value is $slotName&#34;
            set Slot 1
            <span class="comment-line"># Clear all of the line card system dumps if they exist</span>
            foreach i $slotName {
                puts &#34;I value is : $i&#34;
                if {&#34;$i&#34; != &#34;Empty&#34;} {
                    <a name="::result_debug(11)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;slot is $Slot&#34;
                    lappend parameterList &#34;{core_dump_info|failure:} notExist&#34;
                    if { [<a name="::CheckKeyValue(6)"><a href="./OptionCheck.tcl.html#::CheckKeyValue_47">::CheckKeyValue</a></a> &#34;show debug system-dump slot $Slot&#34; $parameterList \
                                      -comment &#34;Check core in slot-$Slot DUT$k&#34;] != &#34;ok&#34; } {
                        <a name="::SendACmd(9)"><a href="./SendSwCmd.tcl.html#::SendACmd_157">::SendACmd</a></a> &#34;clear debug system-dump slot $Slot&#34;
                        <a name="::result_debug(12)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;system-dump cleared on slot-$Slot DUT$k&#34;
                    }
                    unset parameterList
                }
                incr Slot
            }
            <span class="comment-line"># Check to see if MSM-A or MM-A exit</span>
            lappend msm_key &#34;{M(S)?M-A} Operational inLine Exist&#34;
            if {[<a name="::CheckKeyValue(7)"><a href="./OptionCheck.tcl.html#::CheckKeyValue_47">::CheckKeyValue</a></a> &#34;show slot&#34; $msm_key -reportResults 0 \
                               -comment &#34;Checking MSM availability&#34;] == &#34;ok&#34; } {
                <span class="comment-line"># Check to see if there is a system-dump on msm/mm a</span>
                lappend parameterList &#34;{core_dump_info|failure:} notExist&#34;
                if { [<a name="::CheckKeyValue(8)"><a href="./OptionCheck.tcl.html#::CheckKeyValue_47">::CheckKeyValue</a></a> &#34;show debug system-dump msm a&#34; $parameterList \
                                   -comment &#34;Check core in MSM-A DUT$k&#34;] != &#34;ok&#34; } {
                    <a name="::SendACmd(10)"><a href="./SendSwCmd.tcl.html#::SendACmd_157">::SendACmd</a></a> &#34;clear debug system-dump msm a&#34;
                    <a name="::result_debug(13)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;system-dump cleared on MSM-A DUT$k&#34;
                }
            }
            unset msm_key
            <span class="comment-line"># Check to see if MSM-B or MM-B exit</span>
            lappend msm_key &#34;{M(S)?M-B} Operational inLine Exist&#34;
            if {[<a name="::CheckKeyValue(9)"><a href="./OptionCheck.tcl.html#::CheckKeyValue_47">::CheckKeyValue</a></a> &#34;show slot&#34; $msm_key -reportResults 0 \
                               -comment &#34;Checking MSM availability&#34;] == &#34;ok&#34; } {
                <span class="comment-line"># Check to see if there is a system-dump on msm/mm b</span>
                lappend parameterList &#34;{core_dump_info|failure:} notExist&#34;
                if { [<a name="::CheckKeyValue(10)"><a href="./OptionCheck.tcl.html#::CheckKeyValue_47">::CheckKeyValue</a></a> &#34;show debug system-dump msm b&#34; $parameterList \
                                    -comment &#34;Check core in MSM-B DUT$k&#34;] != &#34;ok&#34; } {
                    <a name="::SendACmd(11)"><a href="./SendSwCmd.tcl.html#::SendACmd_157">::SendACmd</a></a> &#34;clear debug system-dump msm b&#34;
                    <a name="::result_debug(14)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;system-dump cleared on MSM-B DUT$k&#34;
                }
            }
        } else {
            <span class="comment-line"># Stackable case</span>
            set parameterList &#34;&#34;
            lappend parameterList &#34;{core_dump_info|failure:} notExist&#34;
            if {[<a name="::CheckKeyValue(11)"><a href="./OptionCheck.tcl.html#::CheckKeyValue_47">::CheckKeyValue</a></a> &#34;show debug system-dump&#34; $parameterList \
                               -comment &#34;Check core in DUT$k&#34;] != &#34;ok&#34;} {
                <a name="::SendACmd(12)"><a href="./SendSwCmd.tcl.html#::SendACmd_157">::SendACmd</a></a> &#34;clear debug system-dump&#34;
                <a name="::result_debug(15)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;system-dump cleared on DUT$k&#34;
            }
            unset parameterList
            <a name="::result_debug(16)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;Stand Alone switch is $k&#34;
        }
    }
}
</pre>
<hr>
<div class="index-selector">
	<a href="index_main.html#byfilename">file name</a> 
 | 
	<a href="index_main.html#byprocname">procedure name</a> 
 | 
	<a href="index_main.html#bycall">procedure call</a> 
 | 
	<a href="index_annot_full.html">annotation</a> 

<br>
<cite>File generated 2018-06-14 at 17:09.</cite>
</div>

</body>
</html>
