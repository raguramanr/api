<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                       "http://www.w3.org/TR/html4/transitional.dtd">
<!-- Generated by TclDoc @@VERSION@@ -->
<html>
<head>
  <title>RegressionWatchDog.tcl</title>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <link rel="stylesheet" type="text/css" href="default.css">
</head>
<body class="src-html">
<div class="index-selector">
<!-- index for tcl source files -->
	Index by: 
	<a href="index_main.html#RegressionWatchDog.tcl">file name</a> | 
	<a href="index_main.html#byprocname">procedure name</a> | 
	<a href="index_main.html#bycall">procedure call</a> | 
	<a href="index_annot_full.html">annotation</a>

</div>
<hr>

<p><strong>RegressionWatchDog.tcl</strong>&nbsp;&nbsp;<span class="filetype-link">(<a href="RegressionWatchDog.tcl-annot.html">annotations</a> | <a href="RegressionWatchDog.tcl.txt">original source</a>)</span>
</p>
<pre class="src-code">
<span class="comment-line">#!/usr/bin/tclsh</span>

set HOST [exec hostname -s]
if {[regexp -nocase &#34;autoregeni|autoregrdu&#34; $HOST]} {
    source /auto/branch/automation/Lib/mainLib.tcl
    source /auto/branch/automation/Lib/parse_args.tcl
    source /auto/branch/automation/Lib/mysqlLib.tcl
} else {
    source /auto/automation/Lib/mainLib.tcl
    source /auto/automation/Lib/parse_args.tcl
    source /auto/automation/Lib/mysqlLib.tcl
}


  set regression_ip     &#34;NULL&#34;
  set regression_id     &#34;NULL&#34;
  set regression_id     &#34;NULL&#34;

  <strong><a name="::::myIP_19">proc <a href="RegressionWatchDog.tcl-annot.html#::::myIP">::::myIP</a></a></strong> {} {
   set host 10.69.6.211
   set anyport 5555 ;<span class="comment-line"># Any random port number</span>
   set sock [socket -async $host $anyport]
   set sock_name [fconfigure $sock -sockname]
   set ip_list [split $sock_name &#34; &#34;]
   set ip [lindex $ip_list 0] 
   close $sock
   return $ip
  }

  <strong><a name="::::connToDb_30">proc <a href="RegressionWatchDog.tcl-annot.html#::::connToDb">::::connToDb</a></a></strong> { host db } {
  global mysqlstatus mysql_handler
  set user regression_user
  set password extreme
  catch {mysqlconnect -host $host -user $user -password $password -db $db} mysql_handler
  <span class="comment-line">#puts $mysqlstatus(code);</span>
  if {$mysqlstatus(code) !=0} {
      <span class="comment-line">#puts stderr $mysqlstatus(message)</span>
      <span class="comment-line">#mysqlclose $mysql_handler</span>
     return $mysqlstatus(code)
  }
  <span class="comment-line">#mysqlexec  $mysql_handler &#34;SET max_allowed_packet=50000000&#34;</span>
  return $mysqlstatus(code)
 }

  
  global mysqlIP
  set mysqlIP [lindex $argv 0]
  set db [lindex $argv 1]
  <span class="comment-line">#puts &#34;mysqlIP $mysqlIP&#34;</span>
  set host $mysqlIP
  global host mysql_handler

  <span class="comment-line">#conn_to_autoweb_db $host</span>
  <span class="comment-line">#set db autoweb_db_2;</span>
  <span class="comment-line">#connToDb $host $db</span>
  <a name="::conn_to_db(1)"><a href="./mysqlLib.tcl.html#::conn_to_db_8">::conn_to_db</a></a> $host $db

  set my_ip [<a name="::myIP(1)"><a href="./RegressionWatchDog.tcl.html#::myIP_19">::myIP</a></a>]
  <span class="comment-line">#puts &#34;my_ip $my_ip&#34;</span>

  while {1} {
    set output &#34;&#34;
    set pid_list {}
    set bulb_regression_ids {}
    set bulb_regression_pids {}
    set bulb_regression_statuss {}
    set bulb_regressions {}

    set rslt [catch {
    <span class="comment-line"># get the latest 3 builds</span>
    set latest_builds [mysqlsel $mysql_handler &#34;SELECT build_id \
                                                     FROM build_table \
                                                     ORDER BY build_id DESC LIMIT 5&#34; -flatlist]
    <span class="comment-line">#puts &#34;latest_builds $latest_builds&#34;</span>
    set build1 [lindex $latest_builds 0]
    set build2 [lindex $latest_builds 1]
    set build3 [lindex $latest_builds 2]
    set build4 [lindex $latest_builds 3]
    set build5 [lindex $latest_builds 4]
    set or_build_st &#34; ( build_id='$build1' OR build_id='$build2' OR build_id='$build3' OR build_id='$build4' OR build_id='$build5' ) &#34;
    <span class="comment-line">#puts &#34;or_build_st $or_build_st&#34;</span>
<span class="comment-line">#exit</span>
    set bulb_regressions [mysqlsel $mysql_handler &#34;SELECT regression_id, \
                                                              regression_pid, \
                                                              status \
                                                              FROM regression_table \
                                                              WHERE regression_ip='$my_ip' \
                                                              AND regression_pid != '' AND $or_build_st \
                                                              ORDER BY regression_id DESC&#34; -flatlist]

   set nmbr_regressions [llength $bulb_regressions]
   <span class="comment-line">#puts &#34;bulb_regressions $bulb_regressions&#34;</span>
   <span class="comment-line">#puts &#34;nmbr_regressions $nmbr_regressions&#34;</span>
   
   for {set i 0} {$i&lt;$nmbr_regressions} {set i [expr $i + 3]} {
     set bulb_regression_id [lindex $bulb_regressions $i] 
     set bulb_regression_pid [lindex $bulb_regressions [expr $i + 1]] 
     set bulb_regression_status [lindex $bulb_regressions [expr $i + 2]] 

     lappend bulb_regression_ids $bulb_regression_id
     lappend bulb_regression_pids $bulb_regression_pid
     lappend bulb_regression_statuss $bulb_regression_status
   }

   <span class="comment-line">#puts &#34;got bulb_regression_ids: $bulb_regression_ids&#34;</span>
   <span class="comment-line">#puts &#34;got bulb_regression_pids: $bulb_regression_pids&#34;</span>
   <span class="comment-line">#puts &#34;got bulb_regression_statuss: $bulb_regression_statuss&#34;</span>
    
    catch {set output [exec /bin/ps -fC tclsh | grep mysqlRunall_monitor]}
    if {[info exists output]} {
      <span class="comment-line">#puts &#34;$output \n\n\n&#34;</span>
      set regr_list [split $output &#34;\n&#34;]
      set lines [llength $regr_list]
      <span class="comment-line">#puts &#34;lines $lines&#34;</span>
      for {set i 0} {$i&lt;$lines} {incr i} {
        <span class="comment-line"># split the line</span>
        set line [lindex $regr_list $i]
        set line_list [split $line &#34; &#34;]
        <span class="comment-line"># skip the empty elements</span>
        set j 1
        set empty_element 1
        while {$empty_element} {
          if {[lindex $line_list $j] == &#34;&#34;} {
             incr j
          } else {
            set empty_element 0
          }
        }
        set pid [lindex $line_list $j]
        <span class="comment-line">#puts &#34;pid $pid&#34;</span>
        lappend pid_list $pid
      }
    }
    <span class="comment-line">#puts &#34;RegressionWatchDog pid_list $pid_list\n\n&#34;</span>
    <span class="comment-line"># see if all the bulb regressions have running regression</span>

    if {[llength $bulb_regression_ids] &gt; 0} {
      foreach bulb_regression_id $bulb_regression_ids \
              bulb_regression_pid $bulb_regression_pids \
              bulb_regression_status $bulb_regression_statuss {
  
       <span class="comment-line">#puts &#34;bulb_regression_id $bulb_regression_id&#34;</span>
       <span class="comment-line">#puts &#34;bulb_regression_pid $bulb_regression_pid&#34;</span>
       <span class="comment-line">#puts &#34;bulb_regression_status $bulb_regression_status&#34;</span>
       <span class="comment-line"># is this regression running?</span>
       set sres [lsearch -exact $pid_list $bulb_regression_pid]
       <span class="comment-line">#puts &#34;are we running?: $sres&#34; </span>
       if {$sres  &lt; 0 } {
         if {$bulb_regression_status == &#34;running&#34;} {
           <span class="comment-line"># DANY - set regression status to crashed</span>
           mysqlexec $mysql_handler &#34;UPDATE regression_table SET status='crashed' WHERE regression_id = '$bulb_regression_id'&#34;
           <span class="comment-line">#puts &#34;crashing regression: $bulb_regression_id&#34;</span>
         }
       } else {
         if {$bulb_regression_status != &#34;running&#34;} {
           <span class="comment-line"># DANY - set regression status to running</span>
           mysqlexec $mysql_handler &#34;UPDATE regression_table SET status='running' WHERE regression_id = '$bulb_regression_id'&#34;
           <span class="comment-line">#puts &#34;restarting regression: $bulb_regression_id&#34;</span>
         }
       }
     }
    }
    } result]
    after 180000
    if {$rslt} {
      <span class="comment-line">#puts &#34;RegressionWatchDog crashed - reason: $result&#34;</span>
      <span class="comment-line">#puts &#34;restarting&#34;</span>
      <span class="comment-line"># re-connect db if needed</span>
      <a name="::conn_to_db(2)"><a href="./mysqlLib.tcl.html#::conn_to_db_8">::conn_to_db</a></a> $host $db
    }
  }


</pre>
<hr>
<div class="index-selector">
	<a href="index_main.html#byfilename">file name</a> 
 | 
	<a href="index_main.html#byprocname">procedure name</a> 
 | 
	<a href="index_main.html#bycall">procedure call</a> 
 | 
	<a href="index_annot_full.html">annotation</a> 

<br>
<cite>File generated 2018-06-14 at 17:09.</cite>
</div>

</body>
</html>
