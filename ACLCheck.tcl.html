<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                       "http://www.w3.org/TR/html4/transitional.dtd">
<!-- Generated by TclDoc @@VERSION@@ -->
<html>
<head>
  <title>ACLCheck.tcl</title>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <link rel="stylesheet" type="text/css" href="default.css">
</head>
<body class="src-html">
<div class="index-selector">
<!-- index for tcl source files -->
	Index by: 
	<a href="index_main.html#ACLCheck.tcl">file name</a> | 
	<a href="index_main.html#byprocname">procedure name</a> | 
	<a href="index_main.html#bycall">procedure call</a> | 
	<a href="index_annot_full.html">annotation</a>

</div>
<hr>

<p><strong>ACLCheck.tcl</strong>&nbsp;&nbsp;<span class="filetype-link">(<a href="ACLCheck.tcl-annot.html">annotations</a> | <a href="ACLCheck.tcl.txt">original source</a>)</span>
</p>
<pre class="src-code">

<span class="comment-line">################################################################## </span>
<span class="comment-line"># Procedure Name: GetAccessListInfo</span>
<span class="comment-line">#   </span>
<span class="comment-line"># Description: Called by CheckAccessListInfo - </span>
<span class="comment-line">#              An internal procedure to gather information about an ACL for hitcount, flags etc.</span>
<span class="comment-line">#     </span>
<span class="comment-line">#     </span>
<span class="comment-line">#</span>
<span class="comment-line"># Input args: accessList fd_res testNo</span>
<span class="comment-line"># Output args: accessListInfoName as array</span>
<span class="comment-line"># Typical usage:</span>
<span class="comment-line">#           GetAccessListInfo accessListInfo $accessList $fd_res $testNo</span>
<span class="comment-line">#</span>
<span class="comment-line"># Category Types (Setup,GetSwitchInfo,SendTraffic,CaptureTraffic,VerifySwitchOutput</span>
<span class="comment-line">#                          VerifyTraffic)</span>
<span class="comment-line"># Category: VerifySwitchOutput</span>
<span class="comment-line">##################################################################</span>

<strong><a name="::::GetAccessListInfo_20">proc <a href="ACLCheck.tcl-annot.html#::::GetAccessListInfo">::::GetAccessListInfo</a></a></strong> {accessListInfoName accessList fd_res testNo} {
   global spawn_id
   upvar $accessListInfoName accessListInfo
   
   <span class="comment-line"># -- called by CheckAccessListInfo</span>
   <span class="comment-line"># -- show access-list and save it to tmp file</span>
   set fd_in [open &#34;Tmp/tmp_$testNo[pid]&#34; &#34;w&#34;]
   <a name="::SendACmd(1)"><a href="./SendSwCmd.tcl.html#::SendACmd_157">::SendACmd</a></a> &#34;show access-list $accessList&#34; $fd_res $fd_in
   close $fd_in
   
   <span class="comment-line"># -- set default values</span>
   set accessListInfo(HitCount) &#34;notFound&#34;
   set accessListInfo(Flags) &#34;notFound&#34;

   <span class="comment-line"># -- open tmp file and get hit/flow and flags values</span>
   <span class="comment-line"># -- then store them in array and return to the caller</span>
   set fd_in [open &#34;Tmp/tmp_$testNo[pid]&#34; &#34;r&#34;]
   while {[gets $fd_in line] != -1} {
      set key [lindex $line 0]
      switch -- $key {
         &#34;Hit&#34; {
            set accessListInfo(HitCount) [lindex $line 2]
            if {  [lindex $line 3] == &#34;Flags:&#34; } {
               set accessListInfo(Flags) [lindex $line 4]
            }
            break
        } &#34;Flow:&#34; {
            if {  [lindex $line 3] == &#34;Count:&#34; } {
               set accessListInfo(HitCount) [lindex $line 4]
            }
            if {  [lindex $line 5] == &#34;Flags:&#34; } {
               set accessListInfo(Flags) [lindex $line 6]
            }
            break
        }
      }
   }      
   close $fd_in
   file delete &#34;Tmp/tmp_$testNo[pid]&#34;
   puts &#34;HitCount: $accessListInfo(HitCount) Flag: $accessListInfo(Flags)&#34;
}

<span class="comment-line">################################################################## </span>
<span class="comment-line"># Procedure Name: CheckAccessListInfo</span>
<span class="comment-line">#   </span>
<span class="comment-line"># Description: proc that is used to check the acl info with sh accesslist command</span>
<span class="comment-line">#              for hitCountThreshold, flagsWanted values.</span>
<span class="comment-line">#              Also, performs logs in report.txt with report_start_test/report_end_test</span>
<span class="comment-line">#     </span>
<span class="comment-line">#     </span>
<span class="comment-line">#</span>
<span class="comment-line"># Input args: accessList hitCountThreshold flagsWanted fd_res testNo</span>
<span class="comment-line"># Output args: none</span>
<span class="comment-line"># Typical usage:</span>
<span class="comment-line">#        CheckAccessListInfo &#34;permitList&#34; 2 &#34;ac&#34; $fd_res $testNo</span>
<span class="comment-line">#</span>
<span class="comment-line"># Category Types (Setup,GetSwitchInfo,SendTraffic,CaptureTraffic,VerifySwitchOutput</span>
<span class="comment-line">#                          VerifyTraffic)</span>
<span class="comment-line"># Category: VerifySwitchOutput</span>
<span class="comment-line">##################################################################</span>

<strong><a name="::::CheckAccessListInfo_81">proc <a href="ACLCheck.tcl-annot.html#::::CheckAccessListInfo">::::CheckAccessListInfo</a></a></strong> {accessList hitCountThreshold flagsWanted fd_res testNo } {
   
   <a name="::report_start_test(1)"><a href="./report.tcl.html#::report_start_test_79">::report_start_test</a></a> &#34;Checking access list $accessList hit count and flags&#34;
   <span class="comment-line"># -- call GetAccessListInfo to get hitcount and flags values  </span>
   <a name="::GetAccessListInfo(1)"><a href="./ACLCheck.tcl.html#::GetAccessListInfo_20">::GetAccessListInfo</a></a> accessListInfo $accessList $fd_res $testNo
   
   <span class="comment-line"># -- get the hitcount and flags values, then compare with input values</span>
   set hitCountFound $accessListInfo(HitCount)
   set flagsFound $accessListInfo(Flags)
   
   <span class="comment-line"># -- check for minimum value if any </span>
   set mode [lindex $hitCountThreshold 1]
   if {$mode == &#34;minimum&#34;} {
      set minimumHit [lindex $hitCountThreshold 0]
      if { $hitCountFound &lt; $minimumHit } {
         <a name="::result_error(1)"><a href="./lconsoles.tcl.html#::result_error_6">::result_error</a></a> &#34;Hit count check failed minimum check. Wanted $hitCountThreshold BUTGOT $hitCountFound&#34;
      } else {
         <a name="::result_ok(1)"><a href="./lconsoles.tcl.html#::result_ok_9">::result_ok</a></a> &#34;Hit count check passed minimum check.&#34;
      }
   } else {
      if { $hitCountFound != $hitCountThreshold } {
         <a name="::result_error(2)"><a href="./lconsoles.tcl.html#::result_error_6">::result_error</a></a> &#34;Hit count check failed exactMode check. Wanted $hitCountThreshold BUTGOT $hitCountFound&#34;
      } else {
         <a name="::result_ok(2)"><a href="./lconsoles.tcl.html#::result_ok_9">::result_ok</a></a> &#34;Hit count check passed exactMode check.&#34;
      }
   }
   if {($flagsWanted != &#34;ignore&#34;) &amp;&amp; ($flagsFound != $flagsWanted) } {
      <a name="::result_error(3)"><a href="./lconsoles.tcl.html#::result_error_6">::result_error</a></a> &#34;Flags check failed check. Wanted $flagsWanted BUTGOT $flagsFound&#34;
   } else {
      <a name="::result_ok(3)"><a href="./lconsoles.tcl.html#::result_ok_9">::result_ok</a></a> &#34;Flags check passed check.&#34;
   }
   <a name="::report_end_test(1)"><a href="./report.tcl.html#::report_end_test_122">::report_end_test</a></a>
}
<span class="comment-line">################################################################## </span>
<span class="comment-line"># Procedure Name: </span>
<span class="comment-line">#   GetACLUsageRulePort</span>
<span class="comment-line"># Description: proc that is used to check the acl info with sh accesslist command</span>
<span class="comment-line">#     </span>
<span class="comment-line">#                   Created to abstract new platforms (870)</span>
<span class="comment-line"># Input args: port</span>
<span class="comment-line"># Output args: none</span>
<span class="comment-line">#                   Returns the INGRESS hit count.</span>
<span class="comment-line">#</span>
<span class="comment-line">#                   Note: 870 has 4 pipes that can hit</span>
<span class="comment-line">#</span>
<span class="comment-line"># Typical usage:</span>
<span class="comment-line">#        set ingressVal2 [GetACLUsageRulePort [MapDUTPortId 1]]</span>
<span class="comment-line">#</span>
<span class="comment-line"># Category Types (Setup,GetSwitchInfo,SendTraffic,CaptureTraffic,VerifySwitchOutput</span>
<span class="comment-line">#                          VerifyTraffic)</span>
<span class="comment-line"># Category: VerifySwitchOutput</span>
<span class="comment-line">##################################################################</span>
<strong><a name="::::GetACLUsageRulePort_133">proc <a href="ACLCheck.tcl-annot.html#::::GetACLUsageRulePort">::::GetACLUsageRulePort</a></a></strong> {<a name="::port(1)"><a href="./ePTClient.tcl.html#::port_510">::port</a></a>} {
    global bcmx870 whichDutNow DUTs_info bpeSlot
    if [regexp -nocase &#34;$bcmx870&#34; $DUTs_info(DUT$whichDutNow,platform)] {
        <span class="comment-line"># Note: several script locations have needed delays prior to exectuting</span>
        <span class="comment-line">#    this command, so just adding a delay here</span>
        <a name="::exSleep(1)"><a href="./sleep.tcl.html#::exSleep_248">::exSleep</a></a> 2
        set parameterList &#34;&#34;
        lappend parameterList &#34;INGRESS 1 2&#34;
        lappend parameterList &#34;INGRESS 1 4&#34;
        lappend parameterList &#34;INGRESS 1 6&#34;
        lappend parameterList &#34;INGRESS 1 8&#34;
        set ingressValList [<a name="::GetKeyValue(1)"><a href="./OptionCheck.tcl.html#::GetKeyValue_438">::GetKeyValue</a></a> &#34;show access-list usage acl-rule port $port&#34; $parameterList]

        set x 0;
        foreach n [lindex $ingressValList 0] {
            if {[string is integer $n]} {
                puts &#34;value - $n&#34;
                set x [expr $n + $x];
            }
        }
        unset parameterList
        <a name="::result_debug(1)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;Ingress Counter match value $x&#34;;
        return $x
    } elseif {[<a name="::::CheckForBpePorts(1)"><a href="./vpex.tcl.html#::::CheckForBpePorts_405">::::CheckForBpePorts</a></a> -dut {$whichDutNow} -portIdList &#34;1&#34;]} {
        set port [<a name="::::GetCascadePortNumber(1)"><a href="./vpex.tcl.html#::::GetCascadePortNumber_264">::::GetCascadePortNumber</a></a> -portId 1 -native 1]
        set parameterList &#34;&#34;
        lappend parameterList &#34;INGRESS 1 1&#34;
        set ingressVal [<a name="::GetKeyValue(2)"><a href="./OptionCheck.tcl.html#::GetKeyValue_438">::GetKeyValue</a></a> &#34;show access-list usage acl-rule port $port&#34; $parameterList]
        unset parameterList
        <a name="::result_debug(2)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;Ingress Counter match value $ingressVal&#34;;
        return $ingressVal
    } else {
        set parameterList &#34;&#34;
        lappend parameterList &#34;INGRESS 1 1&#34;
        set ingressVal [<a name="::GetKeyValue(3)"><a href="./OptionCheck.tcl.html#::GetKeyValue_438">::GetKeyValue</a></a> &#34;show access-list usage acl-rule port $port&#34; $parameterList]
        unset parameterList
        <a name="::result_debug(3)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;Ingress Counter match value $ingressVal&#34;;
        return $ingressVal
    }
}
</pre>
<hr>
<div class="index-selector">
	<a href="index_main.html#byfilename">file name</a> 
 | 
	<a href="index_main.html#byprocname">procedure name</a> 
 | 
	<a href="index_main.html#bycall">procedure call</a> 
 | 
	<a href="index_annot_full.html">annotation</a> 

<br>
<cite>File generated 2018-06-14 at 17:09.</cite>
</div>

</body>
</html>
