<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                       "http://www.w3.org/TR/html4/transitional.dtd">
<!-- Generated by TclDoc @@VERSION@@ -->
<html>
<head>
  <title>linux.tcl</title>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <link rel="stylesheet" type="text/css" href="default.css">
</head>
<body class="src-html">
<div class="index-selector">
<!-- index for tcl source files -->
	Index by: 
	<a href="index_main.html#linux.tcl">file name</a> | 
	<a href="index_main.html#byprocname">procedure name</a> | 
	<a href="index_main.html#bycall">procedure call</a> | 
	<a href="index_annot_full.html">annotation</a>

</div>
<hr>

<p><strong>linux.tcl</strong>&nbsp;&nbsp;<span class="filetype-link">(<a href="linux.tcl-annot.html">annotations</a> | <a href="linux.tcl.txt">original source</a>)</span>
</p>
<pre class="src-code">

<span class="comment-line">################################################################## </span>
<span class="comment-line"># Procedure Name: login_linux </span>
<span class="comment-line">#   </span>
<span class="comment-line"># Description: To log into linux pc</span>
<span class="comment-line">#</span>
<span class="comment-line"># Input args: IP address</span>
<span class="comment-line">#             userid</span>
<span class="comment-line">#             password</span>
<span class="comment-line">#             super user password</span>
<span class="comment-line"># Output args: none</span>
<span class="comment-line"># Typical usage:</span>
<span class="comment-line">#</span>
<span class="comment-line"># Category: Setup</span>
<span class="comment-line">##################################################################</span>
<strong><a name="::::login_linux_16">proc <a href="linux.tcl-annot.html#::::login_linux">::::login_linux</a></a></strong> {ipAddr userid passwd {supasswd &#34;NULL&#34;} {proto &#34;telnet&#34;}} {
    global spawn_id
    global hostname 
    global spawn_ids
    global tspids

    <span class="comment-line">#exp_internal 2</span>
    set newConnection 1
    <span class="comment-line"># -- check for existing connection</span>
    if { [ info exists hostname ] == &#34;1&#34; } {
        foreach name $hostname {
            if { $name == $ipAddr } {
                set spawn_id $spawn_ids($name)
                if { $spawn_id != &#34;INVALID&#34; } {
                    puts &#34;Login $ipAddr - Connection already exists pid=$spawn_id&#34;
                    set newConnection 0
                    <span class="comment-line">#send &#34;\r&#34;</span>
                    if {[catch {exp_send &#34;\r&#34;} reason]} {
                        if {  [regexp -nocase &#34;not open&#34; $reason] } {
                            <a name="::result_print(1)"><a href="./loadConsoles.tcl.html#::result_print_12">::result_print</a></a> &#34;\n~~~~~\nexpec send found spawn id not open \
                            : reconnect\n~~~~~&#34;;
                            <span class="comment-line"># # The connection has been dropped so we have to clean up the spawnId and hostname entries</span>
                            set spawn_ids($name) INVALID
                            if {$proto == &#34;ssh&#34;} {
                                set go &#34;spawn ssh ${userid}@$ipAddr&#34;
                                set goText &#34;ssh ${userid}@$ipAddr&#34;
                            } else {
                                set go &#34;spawn telnet $ipAddr&#34;
                                set goText &#34;telnet $ipAddr&#34;
                            }
                            if [catch &#34;$go&#34; reason] {
                                <a name="::result_debug(1)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;failed to spawn program: $reason\n&#34;
                                error &#34;failed to spawn program: $reason\n&#34;
                            }
                            lappend tspids $spawn_id
                            lappend tspids $ipAddr
                            set spawn_ids($ipAddr) $spawn_id
                            global connectionTimeout
                            set timeout $connectionTimeout
                            <a name="::result_debug(2)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;Login $goText,  pid=$spawn_id&#34;
                        }
                    }
                }
            }
        }
        <span class="comment-line"># -- if brand new connection, add to host name list</span>
        if { [lsearch $hostname $ipAddr] == -1 } {
            lappend hostname $ipAddr
        }
    } else {
        lappend hostname $ipAddr
    }

    <span class="comment-line"># -- spawn new connection if not exists</span>
    if { $newConnection == 1 } {
        if {$proto == &#34;ssh&#34;} {
            set go &#34;spawn ssh ${userid}@$ipAddr&#34;
            set goText &#34;ssh ${userid}@$ipAddr&#34;
        } else {
            set go &#34;spawn telnet $ipAddr&#34;
            set goText &#34;telnet $ipAddr&#34;
        }
        if [catch &#34;$go&#34; reason] {
            <a name="::result_debug(3)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;failed to spawn program: $reason\n&#34;
            error &#34;failed to spawn program: $reason\n&#34;
        }
        lappend tspids $spawn_id
        lappend tspids $ipAddr
        set spawn_ids($ipAddr) $spawn_id
        global connectionTimeout
        set timeout $connectionTimeout
        <a name="::result_debug(4)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;Login $goText,  pid=$spawn_id&#34;
        <span class="comment-line"># -- wait for connection</span>
        expect {
            &#34;?nable to ?onnect&#34; {
                <span class="comment-line">#result_error $expect_out(buffer)</span>
                expect *
                <span class="comment-line">#result_error $expect_out(buffer)</span>
                <a name="::result_error(1)"><a href="./lconsoles.tcl.html#::result_error_6">::result_error</a></a> &#34;Unable to connect&#34;
            }
            &#34;?onnected to&#34; {
                <span class="comment-line"># -- wait for all remaining characters to come</span>
                sleep 1
            }
            &#34;?assword:&#34; {
                send &#34;$passwd\r&#34;;
            }
            -ex &#34;$ &#34; {
                if {$supasswd == &#34;NULL&#34;} {
                    return;
                }
                send &#34;\r&#34;
            }
            &#34;\\?&#34; {
                send &#34;yes\r&#34;;
            }
        }
    }

    log_user 2;
    set timeout 20
    <span class="comment-line"># -- try login to 10 times</span>
    <span class="comment-line">#send &#34;\r&#34;</span>
    for {set i 0} {$i &lt; 10} {incr i} {
        expect {
           -re &#34;login: $&#34; {
                send &#34;$userid\r&#34;
                expect &#34;Password:&#34;
                send &#34;$passwd\r&#34;
                expect {
                    -ex &#34;$ &#34; {
                        send &#34;\r&#34;
                    }
                    &#34;&gt; &#34; {
                        send &#34;\r&#34;
                    }
                    &#34;# &#34; {
                        send &#34;\r&#34;
                    }
                }
                if {[string compare &#34;NULL&#34; $supasswd]!=0} {
                    send &#34;su\r&#34;
                    expect {
                        &#34;Password: &#34; {
                            send &#34;$supasswd\r&#34;
                            expect {
                                &#34;# &#34; {
                                    send &#34;\r&#34;
                                }
                            }
                        }
                        &#34;# &#34; {
                            send &#34;\r&#34;
                        }
                    }
                }
            }
            &#34;assword:&#34; {
                send &#34;$passwd\r&#34;;
                exp_continue;
            }
            -ex &#34;$ &#34; {
                send &#34;\r&#34;
                return
            }
            &#34;&gt; &#34; {
                send &#34;\r&#34;
                return
            }
            &#34;# &#34; {
                send &#34;\r&#34;
                return
            }
            timeout {
                <span class="comment-line"># -- time out then try again</span>
                send &#34;\r&#34;
            }
        }
    }
    <span class="comment-line"># -- no communication or unexpected behavior</span>
}
<span class="comment-line">################################################################## </span>
<span class="comment-line"># Procedure Name: Get_Server_EpochTime </span>
<span class="comment-line">#   </span>
<span class="comment-line"># Description: Get the time from a Linux system.  Used by RADIUS</span>
<span class="comment-line">#              and TACACS+ test modules.</span>
<span class="comment-line">#</span>
<span class="comment-line"># Input args: None.</span>
<span class="comment-line">#             </span>
<span class="comment-line"># Output args: None.</span>
<span class="comment-line">#</span>
<span class="comment-line"># Return value: Integer seconds since the epoch</span>
<span class="comment-line">#</span>
<span class="comment-line"># Typical usage:</span>
<span class="comment-line">#     set SERVER2 10.66.200.11;</span>
<span class="comment-line">#     login_linux $SERVER2 &#34;autotest&#34; &#34;autotest&#34; &#34;extreme&#34;;</span>
<span class="comment-line">#     set epoch [Get_Server_EpochTime];</span>
<span class="comment-line">#</span>
<span class="comment-line"># Category: Setup</span>
<span class="comment-line">##################################################################</span>
<strong><a name="::::Get_Server_EpochTime_196">proc <a href="linux.tcl-annot.html#::::Get_Server_EpochTime">::::Get_Server_EpochTime</a></a></strong> {} {

    set epoch [<a name="::SendACmd(1)"><a href="./SendSwCmd.tcl.html#::SendACmd_157">::SendACmd</a></a> &#34;date +%s&#34;]
    return $epoch;
}; <span class="comment-line"># Get_Server_Date</span>

<span class="comment-line">################################################################## </span>
<span class="comment-line"># Procedure Name: Get_Server_Date </span>
<span class="comment-line">#   </span>
<span class="comment-line"># Description: Get the time from a Linux system.  Used by RADIUS</span>
<span class="comment-line">#              and TACACS+ test modules.</span>
<span class="comment-line">#</span>
<span class="comment-line"># Input args: None.</span>
<span class="comment-line">#             </span>
<span class="comment-line"># Output args: None.</span>
<span class="comment-line">#</span>
<span class="comment-line"># Return value: Date and time.</span>
<span class="comment-line">#</span>
<span class="comment-line"># Typical usage:</span>
<span class="comment-line">#     set SERVER2 10.66.200.11;</span>
<span class="comment-line">#     login_linux $SERVER2 &#34;autotest&#34; &#34;autotest&#34; &#34;extreme&#34;;</span>
<span class="comment-line">#     set datetime [Get_Server_Date];</span>
<span class="comment-line">#</span>
<span class="comment-line"># Category: Setup</span>
<span class="comment-line">##################################################################</span>
<strong><a name="::::Get_Server_Date_221">proc <a href="linux.tcl-annot.html#::::Get_Server_Date">::::Get_Server_Date</a></a></strong> {} {

    set pid _[pid];
    set time1 [clock seconds];
    set tmp &#34;Tmp&#34;;
    <span class="comment-line">#puts &#34;$tmp/tmp_GetKeyValue$time1&#34;</span>
    set fd_in [open &#34;$tmp/tmp_GetKeyValue$time1&#34; &#34;w&#34;];
    <a name="::SendACmd(2)"><a href="./SendSwCmd.tcl.html#::SendACmd_157">::SendACmd</a></a> &#34;date&#34; NULL $fd_in;
    close $fd_in;
    set value &#34;notfound&#34;;
    set fd_in [open &#34;$tmp/tmp_GetKeyValue$time1&#34; &#34;r&#34;];
    
    set dayOfWeek {[A-Z][a-z]+};
    set month {[A-z][a-z]+};
    set dayOfMonth {[0-9]+};
    set timeOfDay {[0-9]+:[0-9]+:[0-9]+};
    set timeZone {[A-Z]+};
    set year {[0-9]+};
    set dateTime &#34;$dayOfWeek *$month *$dayOfMonth *$timeOfDay *$timeZone *$year&#34;;
    
    while {[gets $fd_in line] != -1} {
        <span class="comment-line"># EY-04-23-2003: Changed regexp to use a generic date-time pattern.</span>
        <span class="comment-line"># Earlier version was looking for PDT or PST timezone marker.  This</span>
        <span class="comment-line"># would fail when the RADIUS server was set to a different time zone.</span>
        if {[regexp $dateTime $line] == 1} {
            set value [string range $line 0 18];
            break;
        } 
    }
    close $fd_in;
    <a name="::result_debug(5)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;\nLINUX Server Date Return&#34;
    return $value;
}; <span class="comment-line"># Get_Server_Date</span>

<span class="comment-line">##################################################################</span>
<span class="comment-line"># Procedure Name: linuxSendACmd</span>
<span class="comment-line">#</span>
<span class="comment-line"># Description: Send a command to linux and return result of the command.</span>
<span class="comment-line">#</span>
<span class="comment-line"># Input args: command setTimeout</span>
<span class="comment-line"># Output args: result of the command</span>
<span class="comment-line">#              Error if echo timeout or timeout waiting for prompt</span>
<span class="comment-line"># Typical usage:</span>
<span class="comment-line">#             linuxSendACmd &#34;kill %1&#34;</span>
<span class="comment-line">#</span>
<span class="comment-line"># Category: Setup</span>
<span class="comment-line">##################################################################</span>
<strong><a name="::::linuxSendACmd_268">proc <a href="linux.tcl-annot.html#::::linuxSendACmd">::::linuxSendACmd</a></a></strong> { command {setTimeout 90}} {

    <a name="::result_pre(1)"><a href="./loadConsoles.tcl.html#::result_pre_15">::result_pre</a></a> &#34;--- Linux Send $command&#34;
    if {[<a name="::slow_send(1)"><a href="./SendSwCmd.tcl.html#::slow_send_1567">::slow_send</a></a> $command ] != 1} {
        exp_send &#34;\r&#34;
        <a name="::result_error(2)"><a href="./lconsoles.tcl.html#::result_error_6">::result_error</a></a> &#34;linuxSendACmd timeout getting command echo&#34;
        error &#34;error in linuxSendACmd: timeout getting command echo\n&#34;
    }
    <span class="comment-line">#if last character not a return send a return</span>
    if {[string index $command [expr [string length $command] - 1]] != &#34;\r&#34; } {
        <a name="::slow_send(2)"><a href="./SendSwCmd.tcl.html#::slow_send_1567">::slow_send</a></a> &#34;\r&#34;
    }
    set timeout $setTimeout
    expect {
        -re {.*[&gt;#$]} {
            <a name="::SaveOutputBuffer(1)"><a href="./SendSwCmd.tcl.html#::SaveOutputBuffer_1024">::SaveOutputBuffer</a></a> $expect_out(buffer)
            return $expect_out(buffer)
        }
        timeout {
            <a name="::result_error(3)"><a href="./lconsoles.tcl.html#::result_error_6">::result_error</a></a> \
                &#34;linuxSendACmd $setTimeout seconds timeout: not seeing linux prompt&#34;
                error &#34;error in linuxSendACmd: timeout getting linux prompt\n&#34;
        }
    }
}
<span class="comment-line">##################################################################</span>
<span class="comment-line"># Procedure Name: CheckLinuxUser</span>
<span class="comment-line">#</span>
<span class="comment-line"># Description: Check if user is active user.</span>
<span class="comment-line">#</span>
<span class="comment-line"># Input args: user</span>
<span class="comment-line"># Output args: ok or error</span>
<span class="comment-line">#             </span>
<span class="comment-line"># Typical usage:</span>
<span class="comment-line">#             if {[CheckLinuxUser root] != &#34;ok&#34;} {suToRoot} </span>
<span class="comment-line">#</span>
<span class="comment-line"># Category: Setup</span>
<span class="comment-line">##################################################################</span>
<strong><a name="::::CheckLinuxUser_306">proc <a href="linux.tcl-annot.html#::::CheckLinuxUser">::::CheckLinuxUser</a></a></strong> {user} {
    set parameterList &#34;&#34;;
    lappend parameterList &#34;{$user} exist&#34;;
    set res [<a name="::CheckKeyValue(1)"><a href="./OptionCheck.tcl.html#::CheckKeyValue_47">::CheckKeyValue</a></a> &#34;whoami&#34; $parameterList \
       -comment &#34;Am I linux user $user&#34; -reportResults 0 -showError &#34;false&#34;]

    return $res
}
</pre>
<hr>
<div class="index-selector">
	<a href="index_main.html#byfilename">file name</a> 
 | 
	<a href="index_main.html#byprocname">procedure name</a> 
 | 
	<a href="index_main.html#bycall">procedure call</a> 
 | 
	<a href="index_annot_full.html">annotation</a> 

<br>
<cite>File generated 2018-06-14 at 17:09.</cite>
</div>

</body>
</html>
