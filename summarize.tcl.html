<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                       "http://www.w3.org/TR/html4/transitional.dtd">
<!-- Generated by TclDoc @@VERSION@@ -->
<html>
<head>
  <title>summarize.tcl</title>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <link rel="stylesheet" type="text/css" href="default.css">
</head>
<body class="src-html">
<div class="index-selector">
<!-- index for tcl source files -->
	Index by: 
	<a href="index_main.html#summarize.tcl">file name</a> | 
	<a href="index_main.html#byprocname">procedure name</a> | 
	<a href="index_main.html#bycall">procedure call</a> | 
	<a href="index_annot_full.html">annotation</a>

</div>
<hr>

<p><strong>summarize.tcl</strong>&nbsp;&nbsp;<span class="filetype-link">(<a href="summarize.tcl-annot.html">annotations</a> | <a href="summarize.tcl.txt">original source</a>)</span>
</p>
<pre class="src-code">

<strong><a name="::::print_usage_2">proc <a href="summarize.tcl-annot.html#::::print_usage">::::print_usage</a></a></strong><a name="::::print_usage"></a> {} {
   puts &#34;\r&#34;
   puts {Usage: summarize.tcl &lt;buildName&gt; &lt;BladeType&gt; &lt;RegressionType&gt;}
   puts {      &lt;buildName&gt;: Name of the build e.g. 6.1.7b16/617b16}
   puts {      &lt;BladeType&gt;: Type of the blade e.g. FM24T/FM32/GM4X/F48T/F32T/G8X/F96T/F32F/G8T/Alpine3804/Alpine3808/MSM64/Summit7i/Summit48i/Summit5i/Summit24e3}
   puts {      &lt;RegressionType&gt;: Type of the regression e.g. standard(L2,L3 and others)/cli/routing/OSPF}
   puts &#34;\r&#34;
}
<span class="comment-line"># ---------------------------------------------------------------------</span>


<span class="comment-line"># checking command parameters</span>
if {$argc==3} {
   set arg0 [lindex $argv 0]
   set arg1 [lindex $argv 1]
   set arg2 [lindex $argv 2]
} else {
   <a name="::::print_usage(1)"><a href="./summarize.tcl.html#::::print_usage_2">::::print_usage</a></a>
   exit
}

<span class="comment-line"># Check the build name</span>
if {[regexp -nocase {\.} $arg0]==0} {
   scan $arg0 %db%d release buildNum
   if {[string length $release]==3} {
      set f [string index $release 0]
      set s [string index $release 1]
      set t [string index $release 2]
      set build [format %d.%d.%db%d $f $s $t $buildNum]
   } else {
      puts &#34;Error: Wrong build $arg0&#34;
      <a name="::::print_usage(2)"><a href="./summarize.tcl.html#::::print_usage_2">::::print_usage</a></a>
      exit
   }
} else {
   set build $arg0
}

<span class="comment-line"># check the blade name</span>
if {[regexp -nocase &#34;FM24T|FM32|GM4X|F48T|F32T|G8X|F96T|F32F|G8T&#34; $arg1]} {
   set blade [string toupper $arg1]
} elseif {[regexp -nocase &#34;Summit48i|Summit7i|Summit5i|Summit24e3&#34; $arg1]} {
   <span class="comment-line"># since glob is case sensitive, make the right string here for glob to work later on</span>
   set fir [string toupper [string index $arg1 0]]
   set temp [string tolower [string range $arg1 1 5]]
   set last [string tolower [string range $arg1 6 end]]
   set blade [format %s%s%s $fir $temp $last]
} elseif {[regexp -nocase &#34;Alpine3804|Alpine3808&#34; $arg1]} {
   set fir [string toupper [string index $arg1 0]]
   set temp [string tolower [string range $arg1 1 end]]
   set blade [format %s%s $fir $temp]
} elseif {[regexp -nocase &#34;MSM64&#34; $arg1]} {
   set fir [string toupper [string index $arg1 0 2]]
   set temp [string tolower [string range $arg1 3 end]]
   set blade [format %s%s $fir $temp]
} else {
   puts &#34;Error: Invalid blade name :$arg1&#34;
   <a name="::::print_usage(3)"><a href="./summarize.tcl.html#::::print_usage_2">::::print_usage</a></a> 
   exit
}

<span class="comment-line"># Check the regression type</span>
if {[regexp -nocase &#34;standard|routing|ospf|cli&#34; $arg2]} {
   set regType [format %s%s [string tolower $arg2] &#34;RegressionModules&#34;]
} else {
   puts &#34;Error: Invalid RegressionType: $arg2&#34;
   <a name="::::print_usage(4)"><a href="./summarize.tcl.html#::::print_usage_2">::::print_usage</a></a>
   exit
}

<span class="comment-line">############################################################</span>
<span class="comment-line"># Index Generation</span>
<span class="comment-line">############################################################</span>

<strong><a name="::::gen_index_76">proc <a href="summarize.tcl-annot.html#::::gen_index">::::gen_index</a></a></strong><a name="::::gen_index"></a> {dir} {
	set old_dir [pwd]
	cd $dir
	auto_mkindex .
	cd $old_dir
}

<a name="::::gen_index(1)"><a href="./summarize.tcl.html#::::gen_index_76">::::gen_index</a></a> ./
<a name="::::gen_index(2)"><a href="./summarize.tcl.html#::::gen_index_76">::::gen_index</a></a> ../Lib

lappend auto_path ../Lib

set _lock_state [<a name="::check_auto_lock(1)"><a href="./autolock.tcl.html#::check_auto_lock_18">::check_auto_lock</a></a>]

if $_lock_state {
	puts stderr &#34;Found lock (/tmp/sqa_automation_lock) for pid $_lock_state.&#34;
	puts stderr &#34;If this session is no longer running, please delte the lock file.&#34;
	exit 1
}

<a name="::grab_auto_lock(1)"><a href="./autolock.tcl.html#::grab_auto_lock_55">::grab_auto_lock</a></a>


<span class="comment-line"># This is necessary to get an absolute path for logging</span>
set REG_PATH [pwd]

<span class="comment-line">#load {expect52.dll}</span>
if {$tcl_platform(platform) == &#34;windows&#34;} {
  load &#34;expect52.dll&#34;
} else {
  <span class="comment-line">#load &#34;/usr/lib/libexpect.so&#34;</span>
  <span class="comment-line">#load [file join $env(HOME) &#34;ixia/lib/libdp40.so&#34;]</span>
	load [lindex [glob &#34;/usr/lib/libexpect*so*&#34;] 0]
}

log_user 0

set LIB_PATH &#34;../Lib&#34;
if {$tcl_platform(platform) == &#34;windows&#34;} {
	lappend auto_path &#34;C:/Program Files/Ixia/TclScripts/Lib/ixTcl1.0&#34;
} else {
  lappend auto_path [file join $env(HOME) &#34;ixia/lib/ixTcl1.0&#34;]
  lappend auto_path [file join $env(HOME) &#34;ixia/lib/dp4.0&#34;]
}

set auto_path [linsert $auto_path 0 . ]

set resultDir &#34;NULL&#34;

<span class="comment-line"># Procedure to summarize all the Failures from report.txt files to a common summary file.</span>
<strong><a name="::::SummarizeAllFailures_126">proc <a href="summarize.tcl-annot.html#::::SummarizeAllFailures">::::SummarizeAllFailures</a></a></strong><a name="::::SummarizeAllFailures"></a> {buildName bladeType regType fd} {

   <span class="comment-line"># Get all the modules to be summarized</span>
   set sourceFile &#34;modulesToBeSummarized.cfg&#34;
   if {[file exists $sourceFile] == 0} {
      puts &#34;Error: Cannot find config file: $sourceFile, please contact admin.\n&#34;
      puts $fd &#34;SETUPERROR: Can not find the config file $sourceFile, please contact the admin.&#34;
      return -1
   }
   source $sourceFile
   set key &#34;FAILED&#34;
   set regressionType [expr $$regType]
<span class="comment-line">#   set rightDirList &#34;&#34;</span>
   set origBladeType $bladeType
   foreach module $regressionType {
      <span class="comment-line"># Get the first report dir from a list of many dirs for bladeType and buildName</span>
      if {[regexp -nocase &#34;cli&#34; $regType]} {
         set bladeType &#34;$origBladeType $module&#34;
         set module &#34;cli&#34;
         puts $fd &#34;###############################################&#34;
         puts $fd &#34;           Module:cli/$bladeType               &#34;
      } else {
         puts $fd &#34;###############################################&#34;
         puts $fd &#34;           Module:$module                      &#34;
      }
      set dirList [glob -nocomplain -- &#34;../regression/$module/Report/*$bladeType*$buildName*&#34;]
      <span class="comment-line">#check here how many dir we want to grab</span>
 <span class="comment-line">#     unset rightDirList</span>
      if {[regexp -nocase $module &#34;qos&#34;]} {
         set rightDirList [lrange $dirList 0 3]    ;<span class="comment-line"># 4 dirs for QoS</span>
      } elseif {[regexp -nocase $module &#34;ospf&#34;]} {
         set rightDirList [lrange $dirList 0 5]    ;<span class="comment-line"># 6 dirs for OSPF</span>
      } else {
         set rightDirList [lrange $dirList 0 0]    ;<span class="comment-line"># 1 dir for everything else</span>
      }

      if {$rightDirList==&#34;&#34;} {
         puts &#34;Error: NO report.txt file for $module !!!\n&#34;
         puts $fd &#34;Error: NO report.txt for module:$module for $bladeType and $buildName !!!&#34;
         puts $fd &#34;###############################################\n&#34;
         continue
      } else {
         puts $fd &#34;           Report Dir: &#34;
         puts &#34;Found report.txt for $module in Dir:&#34;
         foreach rd $rightDirList {
            puts $fd &#34;               $rd.&#34;
            puts &#34;$rd.&#34;
         }
      }
      puts &#34;\n&#34;
      
      set count 0
      <span class="comment-line"># unset the paragraph for earlier module if exists</span>
      if {[info exists paragraph]} {
         unset paragraph
      }
      foreach rightDir $rightDirList {
         set fd_in [open &#34;$rightDir/report.txt&#34; &#34;r&#34;]
         while {[gets $fd_in line] != -1} {
            set paragraph($count) $line
            incr count
         }
         close $fd_in
      }
      set thisPara &#34;&#34;
      set prevFailed 0
      for {set i 0} {$i&lt;[array size paragraph]} {incr i} {
         set line $paragraph($i)
         if {$line==&#34;&#34;} {
            set fl [<a name="::::verifyResult(1)"><a href="./summarize.tcl.html#::::verifyResult_216">::::verifyResult</a></a> $thisPara $fd]
            set thisPara &#34;&#34;
            if {$fl!=&#34;-1&#34;} {
               set prevFailed 1
            }
            continue
         } else {
            lappend thisPara $line
         }
      }
      set failed [<a name="::::verifyResult(2)"><a href="./summarize.tcl.html#::::verifyResult_216">::::verifyResult</a></a> $thisPara $fd]
      if {($failed==-1)&amp;&amp;($prevFailed==0)} {
         puts &#34;OK: No Test case failed for $module in dir $rightDir )))&#34;
         puts $fd &#34;OK: No Test case failed for $module in dir $rightDir )))&#34;
      }
      puts $fd &#34;###############################################\n&#34;
   }
   return 1
}


<strong><a name="::::verifyResult_216">proc <a href="summarize.tcl-annot.html#::::verifyResult">::::verifyResult</a></a></strong><a name="::::verifyResult"></a> {para fd} {

   <span class="comment-line">#Separately put the time consumption inside the heading</span>
   set timeValueKay &#34;Total test time|hours.*minutes.*seconds&#34;
   for {set i 0} {$i&lt;[llength $para]} {incr i} {
      if {[regexp $timeValueKay [lindex $para $i]]==1} {
<span class="comment-line">#         puts &#34;timeValueKay: |$timeValueKay| line: |[lindex $para $i]|&#34;</span>
         puts $fd [lindex $para $i]
      }
   }

   set key &#34;FAILED&#34;
   set flag -1
   for {set i 0} {$i&lt;[llength $para]} {incr i} {
      if {[regexp $key [lindex $para $i]]==1} {
<span class="comment-line">#         puts &#34;Key: |$key| line: |[lindex $para $i]|&#34;</span>
         set flag $i
      }
   }
   if {$flag!=&#34;-1&#34;} {
      for {set j 0} {$j&lt;=$flag} {incr j} {
      if {(([regexp &#34;OK&#34; [lindex $para $j]]!=1)&amp;&amp;([regexp {[0-9].[0-9]} [lindex $para $j]]==1)) || \
          ([regexp -nocase &#34;System Setup|Total test time|hours.*minutes.*seconds&#34; [lindex $para $j]]) || \
          ([regexp $key [lindex $para $j]])} {
           puts $fd [lindex $para $j]
        }
      }
   }
   
   return $flag
}

if {![file isdirectory Summary]} {
	file mkdir Summary
}

set fd [open &#34;Summary/$build-$blade-summary.txt&#34; &#34;w&#34;]
<a name="::::SummarizeAllFailures(1)"><a href="./summarize.tcl.html#::::SummarizeAllFailures_126">::::SummarizeAllFailures</a></a> $build $blade $regType $fd
close $fd

puts &#34;Summary written to Summary/$build-$blade-summary.txt&#34;
<a name="::release_auto_lock(1)"><a href="./autolock.tcl.html#::release_auto_lock_84">::release_auto_lock</a></a>

</pre>
<hr>
<div class="index-selector">
	<a href="index_main.html#byfilename">file name</a> 
 | 
	<a href="index_main.html#byprocname">procedure name</a> 
 | 
	<a href="index_main.html#bycall">procedure call</a> 
 | 
	<a href="index_annot_full.html">annotation</a> 

<br>
<cite>File generated 2018-06-14 at 17:09.</cite>
</div>

</body>
</html>
