<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                       "http://www.w3.org/TR/html4/transitional.dtd">
<!-- Generated by TclDoc @@VERSION@@ -->
<html>
<head>
  <title>hal.tcl</title>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <link rel="stylesheet" type="text/css" href="default.css">
</head>
<body class="src-html">
<div class="index-selector">
<!-- index for tcl source files -->
	Index by: 
	<a href="index_main.html#hal.tcl">file name</a> | 
	<a href="index_main.html#byprocname">procedure name</a> | 
	<a href="index_main.html#bycall">procedure call</a> | 
	<a href="index_annot_full.html">annotation</a>

</div>
<hr>

<p><strong>hal.tcl</strong>&nbsp;&nbsp;<span class="filetype-link">(<a href="hal.tcl-annot.html">annotations</a> | <a href="hal.tcl.txt">original source</a>)</span>
</p>
<pre class="src-code">
<span class="comment-line"># ----------------------------------------------------------------------------------------------</span>
<span class="comment-line"># proc _verifyDutHALSteady</span>
<span class="comment-line">#</span>
<span class="comment-line">#      A proc that sends a cli to a broadcom switch and will not return until HAL is in sync</span>
<span class="comment-line">#</span>
<span class="comment-line">#</span>
<span class="comment-line"># Args  In: -dut</span>
<span class="comment-line">#       Out: return 1 when completed </span>
<span class="comment-line">#</span>
<span class="comment-line">#</span>
<span class="comment-line"># Typical usage:</span>
<span class="comment-line">#   if {_verifyHALSteady -dut $nDUT} { proceed with test } { else, connectionTimeout will pop an error }</span>
<span class="comment-line">#</span>
<span class="comment-line"># ----------------------------------------------------------------------------------------------</span>
<strong><a name="::::_verifyDutHALSteady_15">proc <a href="hal.tcl-annot.html#::::_verifyDutHALSteady">::::_verifyDutHALSteady</a></a></strong> {args} {
    global MAIN


    <a name="::parse_args(1)"><a href="./parse_args.tcl.html#::parse_args_29">::parse_args</a></a> SendAFileToTftp $args {
       dut &#34;1&#34;
    }
    global DUT${dut}_CONNECT bcmPlatform
    <a name="::_setShowOutput(1)"><a href="./SendSwCmd.tcl.html#::_setShowOutput_3101">::_setShowOutput</a></a> -screen off -log off -res_fmt off
    if {[regexp -nocase &#34;$bcmPlatform&#34; [<a name="::GetSystemType(1)"><a href="./misc.tcl.html#::GetSystemType_513">::GetSystemType</a></a> $dut]]} {
        <a name="::Login(1)"><a href="./login.tcl.html#::Login_24">::Login</a></a> [set DUT${dut}_CONNECT] -CheckOperational 0 -masterCheck 0 ;
        <a name="::SendACmd(1)"><a href="./SendSwCmd.tcl.html#::SendACmd_157">::SendACmd</a></a> &#34;debug hal show platform ipv4mc 1&#34;
    }
    <a name="::_setShowOutput(2)"><a href="./SendSwCmd.tcl.html#::_setShowOutput_3101">::_setShowOutput</a></a> -screen on -log on -res_fmt on
    return 1
}

<span class="comment-line"># -------------------------------------------------------------------------------------</span>
<span class="comment-line"># proc _verifyTestBedHALSteady</span>
<span class="comment-line">#</span>
<span class="comment-line">#   Using MultiTask proc, connect to all DUTs in a test bed</span>
<span class="comment-line">#   and make sure that HAL is in sync for all DUTs before continuing</span>
<span class="comment-line">#</span>
<span class="comment-line"># Typical usage:</span>
<span class="comment-line">#               _verifyTestBedHALSteady</span>
<span class="comment-line">#</span>
<span class="comment-line">#</span>
<span class="comment-line"># -------------------------------------------------------------------------------------</span>
<strong><a name="::::_verifyTestBedHALSteady_43">proc <a href="hal.tcl-annot.html#::::_verifyTestBedHALSteady">::::_verifyTestBedHALSteady</a></a></strong> {} {
    global MAIN bcmPlatform

    <span class="comment-line"># Add stack support??? for Don ?</span>
    <a name="::result_debug(1)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;Check for HAL steady State&#34;
    <a name="::_setShowOutput(3)"><a href="./SendSwCmd.tcl.html#::_setShowOutput_3101">::_setShowOutput</a></a> -screen off -log off -res_fmt off
    set hList &#34;&#34;
    for {set nDUT 1; global DUT${nDUT}_CONNECT} { [info exists DUT${nDUT}_CONNECT] } \
                                             {incr nDUT ; global DUT${nDUT}_CONNECT} {
        <a name="::Login(2)"><a href="./login.tcl.html#::Login_24">::Login</a></a> [set DUT${nDUT}_CONNECT] -CheckOperational 0 -masterCheck 0 ;
    }
    for {set nDUT 1; global DUT${nDUT}_CONNECT} { [info exists DUT${nDUT}_CONNECT] } \
                                             {incr nDUT ; global DUT${nDUT}_CONNECT} {
        if {[regexp -nocase &#34;$bcmPlatform&#34; [<a name="::GetSystemType(2)"><a href="./misc.tcl.html#::GetSystemType_513">::GetSystemType</a></a> $nDUT]]} {
            lappend hList &#34;_verifyHALSteady -dut $nDUT&#34;
        }
    }
    <a name="::MultiTask(1)"><a href="./multiTask.tcl.html#::MultiTask_39">::MultiTask</a></a> $hList
    <a name="::_setShowOutput(4)"><a href="./SendSwCmd.tcl.html#::_setShowOutput_3101">::_setShowOutput</a></a> -screen on -log on -res_fmt on

}
<span class="comment-line"># -------------------------------------------------------------------------------------</span>
<span class="comment-line"># proc _checkIfHalSyncNeeded</span>
<span class="comment-line">#</span>
<span class="comment-line">#  Args In: cmd - The command being sent to the switch</span>
<span class="comment-line">#</span>
<span class="comment-line">#  This proc holds all of the specific CLI that we are going to send the hal check</span>
<span class="comment-line">#</span>
<span class="comment-line"># -------------------------------------------------------------------------------------</span>
<strong><a name="::::_checkIfHalSyncNeeded_72">proc <a href="hal.tcl-annot.html#::::_checkIfHalSyncNeeded">::::_checkIfHalSyncNeeded</a></a></strong> {cmd} {
    global MAIN DUTs_info whichDutNow whichMsmNow


    if {![info exists DUTs_info(DUT${whichDutNow}${whichMsmNow},DEBUGENABLED)]} {
        set DUTs_info(DUT${whichDutNow}${whichMsmNow},DEBUGENABLED) 0;
    }

    set MAIN(checkhalsync) 0
    if {[regexp -nocase &#34;cl\[ear]{0,3} cou\[nters]{0,5}&#34; $cmd]} {
        set MAIN(checkhalsync) 1
    }

    <span class="comment-line">#</span>
    <span class="comment-line"># Add any additional CLI that may need to wait for a hal sync here</span>
    <span class="comment-line">#</span>
    <span class="comment-line">#    Use _verifyHALSteady -dut # or _verifyTestBedHALSteady in test cases if needed</span>
    <span class="comment-line">#</span>
    <span class="comment-line">#    These may be added to traffic if necessary </span>

    if {$MAIN(checkhalsync)} {
        <a name="::result_debug(2)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;A HAL Sync will be initiated after $cmd&#34;
    }

}
<span class="comment-line"># -------------------------------------------------------------------------------------</span>
<span class="comment-line"># proc _sendHalSyncCmd</span>
<span class="comment-line">#     This proc is called at the bottom of SendACmd.  The flag MAIN(checkhalsync)</span>
<span class="comment-line">#        is set by a match proc _checkIfHalSyncNeeded called at the top of SendACmd</span>
<span class="comment-line">#</span>
<span class="comment-line">#</span>
<span class="comment-line">#</span>
<span class="comment-line">#</span>
<span class="comment-line"># -------------------------------------------------------------------------------------</span>
<strong><a name="::::_sendHalSyncCmd_106">proc <a href="hal.tcl-annot.html#::::_sendHalSyncCmd">::::_sendHalSyncCmd</a></a></strong> {} {
    global spawn_id
    global spawn_ids
    global connectionTimeout
    global whichDutNow whichMsmNow
    global DUTs_info timeout
    global hostname MAIN bcmPlatform

    if {[info exists connectionTimeout]} {
        set timeout $connectionTimeout
    }

    if {![info exists DUTs_info(DUT$whichDutNow,platform)]} {
        return;
    }
    if {![regexp -nocase &#34;$bcmPlatform&#34; $DUTs_info(DUT$whichDutNow,platform)]} {
        return;
    }
    if {[info exists MAIN(checkhalsync)] &amp;&amp; $MAIN(checkhalsync)} {
        set t0 [clock seconds]
        exp_send &#34;\r&#34;
        expect {
            -nocase -re &#34;(\\* )?\[a-z0-9()._-]+(:|\\.)\[0-9]+ (#|&gt;) &#34; {
                puts &#34;Ready to send hal message&#34;
            }
            timeout {
                puts &#34;No prompt returned after sending &lt;cr&gt; to switch&#34;
            }
        } 
        <a name="::_setShowOutput(5)"><a href="./SendSwCmd.tcl.html#::_setShowOutput_3101">::_setShowOutput</a></a> -screen off -log off -res_fmt off
        exp_send &#34;debug hal show platform ipv4mc 1\r&#34;
        expect {
            -nocase -re &#34;(\\* )?\[a-z0-9()._-]+(:|\\.)\[0-9]+ (#|&gt;) &#34; {
                expect *; unset expect_out(buffer);
                exp_send &#34;\r&#34;
                expect {
                    -nocase -re &#34;(\\* )?\[a-z0-9()._-]+(:|\\.)\[0-9]+ (#|&gt;) &#34; {}
                    timeout {
                        <a name="::_setShowOutput(6)"><a href="./SendSwCmd.tcl.html#::_setShowOutput_3101">::_setShowOutput</a></a> -screen on -log on -res_fmt on
                        set t [expr [clock seconds] - $t0]
                        <a name="::result_debug(3)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;Verify HAL synced. Hide output - debug hal show platform ipv4mc 1 - Time $t&#34;
                        <a name="::result_debug(4)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;HAL did not sync after $timeout seconds&#34;
                        expect *; unset expect_out(buffer);
                        return 0;
                    }
                }
                <a name="::_setShowOutput(7)"><a href="./SendSwCmd.tcl.html#::_setShowOutput_3101">::_setShowOutput</a></a> -screen on -log on -res_fmt on
                set t [expr [clock seconds] - $t0]
                <a name="::result_debug(5)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;Verify HAL synced. Hide output - debug hal show platform ipv4mc 1 - Time $t&#34;
                expect *; unset expect_out(buffer);
                return 1
            }
            &#34;Bootrom&gt; &#34; {
                <a name="::_setShowOutput(8)"><a href="./SendSwCmd.tcl.html#::_setShowOutput_3101">::_setShowOutput</a></a> -screen on -log on -res_fmt on
                set t [expr [clock seconds] - $t0]
                <a name="::result_debug(6)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;Verify HAL synced. Hide output - debug hal show platform ipv4mc 1 - Time $t&#34;
                expect *; unset expect_out(buffer);
                return 1
            }
            timeout {
                <a name="::_setShowOutput(9)"><a href="./SendSwCmd.tcl.html#::_setShowOutput_3101">::_setShowOutput</a></a> -screen on -log on -res_fmt on
                set t [expr [clock seconds] - $t0]
                <a name="::result_debug(7)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;Verify HAL synced. Hide output - debug hal show platform ipv4mc 1 - Time $t&#34;
                <a name="::result_debug(8)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;HAL did not sync after $timeout seconds&#34;
                expect *; unset expect_out(buffer);
                return 0;
            }
        }
    }

}

<span class="comment-line"># ---------------------------------------------------------------------------------------</span>
<span class="comment-line"># proc _verifyCurrentHALSteady</span>
<span class="comment-line">#</span>
<span class="comment-line"># Enable debug mode and send the debug hal command</span>
<span class="comment-line">#</span>
<span class="comment-line"># ---------------------------------------------------------------------------------------</span>
<strong><a name="::::_verifyCurrentHALSteady_184">proc <a href="hal.tcl-annot.html#::::_verifyCurrentHALSteady">::::_verifyCurrentHALSteady</a></a></strong> {} {
    global MAIN bcmPlatform whichDutNow

    if {[regexp -nocase &#34;$bcmPlatform&#34; [<a name="::GetSystemType(3)"><a href="./misc.tcl.html#::GetSystemType_513">::GetSystemType</a></a> $whichDutNow]]} {
        set _t1 [clock seconds]
        <a name="::result_debug(9)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;Send HAL command to verify sync before continuing&#34;
        <a name="::_setShowOutput(10)"><a href="./SendSwCmd.tcl.html#::_setShowOutput_3101">::_setShowOutput</a></a> -screen off -log off -res_fmt off
        <a name="::SendACmd(2)"><a href="./SendSwCmd.tcl.html#::SendACmd_157">::SendACmd</a></a> &#34;debug hal show platform ipv4mc 1&#34;
        <a name="::_setShowOutput(11)"><a href="./SendSwCmd.tcl.html#::_setShowOutput_3101">::_setShowOutput</a></a> -screen on -log on -res_fmt on
        set _t2 [clock seconds]
        set _stime [expr $_t2 - $_t1]
        <a name="::result_debug(10)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;Sync Check took  $_stime&#34;
    }
    return 1
}

</pre>
<hr>
<div class="index-selector">
	<a href="index_main.html#byfilename">file name</a> 
 | 
	<a href="index_main.html#byprocname">procedure name</a> 
 | 
	<a href="index_main.html#bycall">procedure call</a> 
 | 
	<a href="index_annot_full.html">annotation</a> 

<br>
<cite>File generated 2018-06-14 at 17:09.</cite>
</div>

</body>
</html>
