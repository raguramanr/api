<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                       "http://www.w3.org/TR/html4/transitional.dtd">
<!-- Generated by TclDoc @@VERSION@@ -->
<html>
<head>
  <title>runall_monitor.tcl</title>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <link rel="stylesheet" type="text/css" href="default.css">
</head>
<body class="src-html">
<div class="index-selector">
<!-- index for tcl source files -->
	Index by: 
	<a href="index_main.html#runall_monitor.tcl">file name</a> | 
	<a href="index_main.html#byprocname">procedure name</a> | 
	<a href="index_main.html#bycall">procedure call</a> | 
	<a href="index_annot_full.html">annotation</a>

</div>
<hr>

<p><strong>runall_monitor.tcl</strong>&nbsp;&nbsp;<span class="filetype-link">(<a href="runall_monitor.tcl-annot.html">annotations</a> | <a href="runall_monitor.tcl.txt">original source</a>)</span>
</p>
<pre class="src-code">
<span class="comment-line">#!/usr/bin/tclsh</span>

source ../Lib/mainLib.tcl

set  startTime [exec date]
set  executeBatFile 0
<span class="comment-line">#set  modSummaryCfgPath &#34;./cfg/modulesToBeSummarized.cfg&#34;</span>
<span class="comment-line"># SK: Changed duplicated files to be referred under Autoweb/cgi-bin/cgiScripts</span>
set  modSummaryCfgPath &#34;./../Autoweb/cgi-bin/cgiScripts/modulesToBeSummarized.cfg&#34;

<span class="comment-line"># List of errors returned by main.tcl deemed FATAL</span>
set fatalErrorList [list \
	&#34;Unable to connect to switch after reboot&#34; \
	&#34;Cannot find config file&#34; \
	&#34;connectionBad&#34; \
	&#34;No response from the switch&#34; \
	&#34;Can't create dir&#34; \
	&#34;spawn id .* not open&#34; \
	&#34;invalid command name&#34; \
	&#34;Loop Condition&#34; \
	&#34;Config Booted is Factory Default after save reboot&#34; \
        &#34;CF is corrupted on DUT&#34; \
	]

<span class="comment-line"># Default user to send mail notification to.</span>
set defaultRecipient &#34;sqascauto@extremenetworks.com&#34;

<span class="comment-line"># List of modules that returned errors during run of main.tcl</span>
set erroredModules [list]

load [lindex [glob &#34;/usr/lib/libexpect*so*&#34;] 0]
set LIB_PATH &#34;../Lib&#34;
lappend auto_path $LIB_PATH

<a name="::::gen_index(1)"><a href="./summarize.tcl.html#::::gen_index_76">::::gen_index</a></a> ../Lib
<a name="::::gen_index(2)"><a href="./summarize.tcl.html#::::gen_index_76">::::gen_index</a></a> .

source ../Lib/parse_args.tcl


<span class="comment-line"># ------------------------------------------------------------------------------</span>
<span class="comment-line"># These 4 calls are REQUIRED for all sublevel libraries that use </span>
<span class="comment-line"># result_xxxx functions to work.</span>
set resultDir &#34;RunAllMonitor_logs&#34;
if { ! [file isdirectory $resultDir] } {
    ;<span class="comment-line"># Create it!</span>
    file mkdir $resultDir
}
set tStartTime [clock seconds]
set tStartDate [clock format [clock seconds] -format &#34;%Y-%m-%d %I.%M.%S%p&#34;]
set fd_res [<a name="::open_result_file(1)"><a href="./result.tcl.html#::open_result_file_276">::open_result_file</a></a> &#34;runall-[clock format [clock seconds] -format &#34;%I.%M%p&#34;]-[pid]&#34;]
;<span class="comment-line">#--------------------------------------------------------------</span>

set connectionTimeout 60


<span class="comment-line"># Dump out usage information</span>
<strong><a name="::::print_usage_58">proc <a href="runall_monitor.tcl-annot.html#::::print_usage">::::print_usage</a></a></strong> {} {

    puts &#34;\r&#34;
    puts &#34;USAGE: runall_monitor.tcl \
	    -cfg &lt;config file&gt; \
	    -regType &lt;regType&gt;&#34;
    puts &#34;           -regSubType &lt;SubType&gt; \
	    \[-platform &lt;platform&gt;] \
	    \[-blade &lt;blade&gt;] &#34;
    puts &#34;           \[-exclude &lt;module&gt;] \
	    \[-include &lt;module&gt;] \
	    \[-download &lt;yes|no&gt;
	    \[-mailTo &lt;e-mail address&gt;]&#34;
    puts &#34;  \[-noPost &lt;Y&gt;] &#34;
    puts &#34;  \[-i386ImagePath &lt;image path to i386 image&gt;]&#34;
    puts &#34;  \[-marinerImagePath &lt;image path to mariner image&gt;]&#34;
    puts &#34;  \[-aspenImagePath &lt;image path to aspen image&gt;]&#34;
    puts &#34;  \[-cougarImagePath &lt;image path to cougar image&gt;]&#34;
    puts &#34;  \[-x480ImagePath &lt;image path to x480 image&gt;]&#34;
    puts &#34;  \[-x870ImagePath &lt;image path to x870 image&gt;]&#34;
    puts &#34;  \[-NWIImagePath &lt;image path to NWI image&gt;]&#34;
    puts &#34;  \[-viperImagePath &lt;image path to viper image&gt;]&#34;
    puts &#34;  \[-bootrom &lt;bootrom&gt;]&#34;
    puts &#34;  \[-bootrom &lt;bootrom&gt;]&#34;
    puts &#34;  \[-obuild &lt;software build&gt;]&#34;
    puts &#34;\r&#34;
    puts &#34;      &lt;cfg&gt;: Path of the config file name (e.g. \
	    short/ptgm4x6.2.2b4.cfg)&#34;
    puts &#34;      &lt;regType&gt;: Type of Regression to be run \
	    (functional|snmp|cli|performance|scalability)&#34;
    puts &#34;      &lt;regSubType&gt;: Test Subtype (standard|ipRoute1|ipRoute2|ipRoute3|\
	    uploadanddownload)&#34;
    puts &#34;      \[&lt;platform&gt;]: Name of the platform&#34;
    puts &#34;           BD/Alpine/Summit7i/Summit48i/Summit48si/Summit5i/summit2/\
	    Summit4/Summit24e3/BT/Godzilla&#34;
    puts &#34;      \[&lt;blade&gt;]: &#34;
    puts &#34;          FM24T/FM32T/FM4X/G12SXi/F48Ti/F32T/G8Xi/F96Ti/F32Fi/\
	    G8Ti/Summit7i/Summit5i/Summit48si&#34;
    puts &#34;      \[&lt;exclude&gt;]: modules to be excluded from testing.&#34;
    puts &#34;      \[&lt;include&gt;]: modules to be tested. The regression will only run \
	    those modules you specified&#34;
    puts &#34;	\[-download] &lt;yes|no&gt; Download image before starting. Default: \
	    yes&#34;
    puts &#34;      \[&lt;mailTo&gt;]: The email address to which you want to send the \
	    regression status &#34;
    puts &#34;      \[&lt;-noPost&gt;]: No posting to autoweb will happen if (-noPost Y) \
	    is given Note: no rerun will happen also.&#34;
    puts &#34;      \[&lt;i386ImagePath&gt;]: ./exosi386.tgz&#34;
    puts &#34;      \[&lt;marinerImagePath&gt;]: ./exosmariner.tgz&#34;
    puts &#34;      \[&lt;aspenImagePath&gt;]: ./exosaspen.tgz&#34;
    puts &#34;      \[&lt;cougarImagePath&gt;]: ./exoscougar.tgz&#34;
    puts &#34;      \[&lt;x480ImagePath&gt;]: ./exosx480.tgz&#34;
    puts &#34;      \[&lt;x870ImagePath&gt;]: ./oniex870.tgz&#34;
    puts &#34;      \[&lt;NWIImagePath&gt;]: ./exosNWI.tgz&#34;
    puts &#34;      \[&lt;viperImagePath&gt;]: ./exosviper.tgz&#34;
    puts &#34;      \[&lt;bootrom&gt;]: bootver (assume in root of your location share)&#34;
    puts &#34;      \[&lt;obuild&gt;]: old sofware version (ie. 10.1.2.16)&#34;
}



;<span class="comment-line"># Function to do validation of input arguments</span>
<strong><a name="::::validateArgsRunall_Monitor_120">proc <a href="runall_monitor.tcl-annot.html#::::validateArgsRunall_Monitor">::::validateArgsRunall_Monitor</a></a></strong> { p_blade p_platform p_cfg p_regType p_regSubType \
	p_exclude p_include p_download p_noPost \
	p_mailTo p_i386ImagePath p_marinerImagePath p_aspenImagePath \
        p_cougarImagePath p_x480ImagePath p_NWIImagePath p_viperImagePath p_ImagePath p_image } {

    global defaultRecipient

    ;<span class="comment-line"># From modulesToBeSummarized.cfg</span>
    global clis
    global platformLists
    global bds summits aspens


    upvar $p_blade  blade
    upvar $p_platform platform
    upvar $p_cfg cfg
    upvar $p_regType regType 
    upvar $p_regSubType regSubType
    upvar $p_exclude exclude
    upvar $p_include include
    upvar $p_download download
    upvar $p_noPost noPost
    upvar $p_mailTo mailTo 
    upvar $p_i386ImagePath i386ImagePath 
    upvar $p_marinerImagePath marinerImagePath 
    upvar $p_aspenImagePath aspenImagePath 
    upvar $p_cougarImagePath cougarImagePath 
    upvar $p_x480ImagePath x480ImagePath
    upvar $p_x870ImagePath x870ImagePath
    upvar $p_NWIImagePath NWIImagePath 
    upvar $p_viperImagePath viperImagePath
    upvar $p_image image 

    if {$mailTo == &#34;&#34;} {
	set mailTo $defaultRecipient
    }
    
    if {$regType == &#34;null&#34;} {
	<a name="::result_error(1)"><a href="./lconsoles.tcl.html#::result_error_6">::result_error</a></a> &#34;ERROR: regType: Regression Type to be run is required.&#34;
	return 0
    }
    
    if {$regSubType == &#34;null&#34;} {
	<a name="::result_error(2)"><a href="./lconsoles.tcl.html#::result_error_6">::result_error</a></a> &#34;ERROR: regSubType: Regression Test Sub type required.&#34;
	return 0
    }

    if [regexp -nocase &#34;summit&#34; $platform] {
	set blade &#34;&#34;
    }

    if {$cfg == &#34;null&#34;} {
	<a name="::result_error(3)"><a href="./lconsoles.tcl.html#::result_error_6">::result_error</a></a> &#34;ERROR: cfg name required.&#34;
	return 0
    }
    
    ;<span class="comment-line"># Check that platform/blade is supported by autoweb.  The file written to </span>
    ;<span class="comment-line"># autoweb data files must match what autoweb expects.  If platform/blade </span>
    ;<span class="comment-line"># combo is incorrect, the data will be written, but won't show up when </span>
    ;<span class="comment-line"># display.  For example, an AlpineFM32 directory might be created, but </span>
    ;<span class="comment-line"># autoweb expects AlpineFM32T.</span>
    if [regexp -nocase &#34;cli&#34; $regType] {
	;<span class="comment-line"># Look at  $clis in modulesToBeSummarized.cfg...which is </span>
	;<span class="comment-line"># generated from $cliTableConfig</span>
	set ok 0
	set temp [format &#34;cli%s%s&#34; $platform $blade]
	foreach listMember $clis {
	    if [regexp -nocase $listMember $temp] {
		set ok 1
		break
	    }
	}
	if { $ok == 0 } {
	    regsub -all &#34;cli&#34; $clis &#34;&#34; supportedList 
	    <a name="::result_debug(1)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;WARNING: Unsupported CLI blade/platform combination \
		    $platform:$blade may not post to autoweb correctly.&#34;
	    <a name="::result_debug(2)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;WARNING: Autoweb supported combinations are $supportedList&#34;
	}
    } elseif { [regexp -nocase &#34;func|snmp&#34; $regType] &amp;&amp; \
	    [regexp -nocase &#34;stand&#34; $regSubType] } {
	;<span class="comment-line"># Validate standard regressions</span>
	;<span class="comment-line"># These are generated from xxxTableConfig</span>
	set ok 0
	set temp [format &#34;%s%s&#34; $platform $blade]	
	foreach platList $platformLists {
	    set curList [set $platList]
	    foreach listMember $curList {
		if [regexp -nocase $temp $listMember] {
		    set ok 1
		    break
		}
	    }
	    if {$ok == 1} {
		break
	    }
	}
	if { $ok == 0 } {
	    <a name="::result_debug(3)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;WARNING: Unsupported Standard blade/platform \
		    combination $platform:$blade may not post to autoweb correctly&#34;
	}
    }

    if {($platform == &#34;null&#34;) &amp;&amp; (![regexp -nocase {ipRoute[1-3]} \
	    $regSubType])}  {
	<a name="::result_error(4)"><a href="./lconsoles.tcl.html#::result_error_6">::result_error</a></a> &#34;ERROR: platform name required.&#34;
	return 0
    }
    
    if {($platform != &#34;null&#34;) &amp;&amp; ([regexp -nocase {ipRoute[1-3]} \
	    $regSubType])} {
	<span class="comment-line"># Do not exit, just ignore the extra parameter.</span>
	<a name="::result_debug(4)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;WARNING: regSubType=$regSubType, platform parameter is \
		being ignored.&#34;
    }
    
    if {($blade == &#34;null&#34;) &amp;&amp; (![regexp -nocase {ipRoute[1-3]} \
	    $regSubType])} {
	<span class="comment-line"># Do not exit, just ignore the extra parameter.</span>
	<a name="::result_debug(5)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;WARNING: blade name required.&#34;
    }

    if {($blade != &#34;null&#34;) &amp;&amp; ([regexp -nocase {ipRoute[1-3]} \
	    $regSubType])} {
	<span class="comment-line"># Do not exit, just ignore the extra parameter.</span>
	<a name="::result_debug(6)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;WARNING: regSubType=$regSubType, blade parameter is \
		being ignored.&#34;
    }

    if {($i386ImagePath == &#34;NULL&#34;) &amp;&amp; ($marinerImagePath == &#34;NULL&#34;) &amp;&amp; \
        ($aspenImagePath == &#34;NULL&#34;) &amp;&amp; ($x480ImagePath == &#34;NULL&#34;) &amp;&amp; ($x480ImagePath == &#34;NULL&#34;) &amp;&amp; \
	($viperImagePath == &#34;NULL&#34;) &amp;&amp; ($NWIImagePath == &#34;NULL&#34;) } {
        <span class="comment-line"># error, at least one of them needs to be set</span>
	<a name="::result_error(5)"><a href="./lconsoles.tcl.html#::result_error_6">::result_error</a></a> &#34;ERROR: marinerImagePath ,i386ImagePath,aspenImagePath NWIImagePath or \
                     x480ImagePath must be set&#34;
	return 0
    } else {

        set marinerList [split $marinerImagePath /]
        set marinerFile [lindex $marinerList end]
        <a name="::result_debug(7)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;marinerFile: $marinerFile&#34;
        set i386List [split $i386ImagePath /]
        set i386File [lindex $i386List end]
        <a name="::result_debug(8)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;i386File: $i386File&#34;

        set aspenList [split $aspenImagePath /]
        set aspenFile [lindex $aspenList end]
        <a name="::result_debug(9)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;aspenFile: $aspenFile&#34;

        set cougarList [split $cougarImagePath /]
        set cougarFile [lindex $cougarList end]
        <a name="::result_debug(10)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;cougarFile: $cougarFile&#34;

        set x480List [split $x480ImagePath /]
        set x480File [lindex $x480List end]
        <a name="::result_debug(11)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;x480File: $x480File&#34;

        set x870List [split $x870ImagePath /]
        set x870File [lindex $x870List end]
        <a name="::result_debug(12)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;x870File: $x870File&#34;

        set NWIList [split $NWIImagePath /]
        set NWIFile [lindex $NWIList end]
        <a name="::result_debug(13)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;NWIFile: $NWIFile&#34;

        set viperList [split $viperImagePath /]
        set viperFile [lindex $viperList end]
        <a name="::result_debug(14)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;viperFile: $viperFile&#34;

        <span class="comment-line"># parse out the build number</span>
        if {$marinerImagePath != &#34;NULL&#34;} {
            <span class="comment-line"># use marinerImagePath</span>
            regsub &#34;\.xos&#34; $marinerFile &#34;&#34; marinerFile
            set marinerFileList [split $marinerFile -]
            regsub &#34;[lindex $marinerFileList 0]-&#34; $marinerFile &#34;&#34; image

        } elseif { $aspenImagePath != &#34;NULL&#34;} {
            <span class="comment-line"># use aspenImagePath</span>
            regsub &#34;\.xos&#34; $aspenFile &#34;&#34; aspenFile
            set aspenFileList [split $aspenFile -]
            regsub &#34;[lindex $aspenFileList 0]-&#34; $aspenFile &#34;&#34; image
        }  elseif { $cougarImagePath != &#34;NULL&#34;} {
            <span class="comment-line"># use cougarImagePath</span>
            regsub &#34;\.xos&#34; $cougarFile &#34;&#34; cougarFile
            set cougarFileList [split $cougarFile -]
            regsub &#34;[lindex $cougarFileList 0]-&#34; $cougarFile &#34;&#34; image
        }  elseif { $x480ImagePath != &#34;NULL&#34;} {
            <span class="comment-line"># use x480ImagePath</span>
            regsub &#34;\.xos&#34; $x480File &#34;&#34; x480File
            set x480FileList [split $x480File -]
            regsub &#34;[lindex $x480FileList 0]-&#34; $x480File &#34;&#34; image
        }  elseif { $x870ImagePath != &#34;NULL&#34;} {
            <span class="comment-line"># use x870ImagePath</span>
            regsub &#34;\.xos&#34; $x870File &#34;&#34; x870File
            set x870FileList [split $x870File -]
            regsub &#34;[lindex $x870FileList 0]-&#34; $x480File &#34;&#34; image
        }  elseif { $NWIImagePath != &#34;NULL&#34;} {
            <span class="comment-line"># use NWIImagePath</span>
            regsub &#34;\.xos&#34; $NWIFile &#34;&#34; NWIFile
            set NWIFileList [split $NWIFile -]
            regsub &#34;[lindex $NWIFileList 0]-&#34; $NWIFile &#34;&#34; image
        }  elseif { $viperImagePath != &#34;NULL&#34;} {
            <span class="comment-line"># use viperImagePath</span>
            regsub &#34;\.xos&#34; $viperFile &#34;&#34; viperFile
            set viperFileList [split $viperFile -]
            regsub &#34;[lindex $viperFileList 0]-&#34; $viperFile &#34;&#34; image
        } else { 
            <span class="comment-line"># parse out using i386ImagePath</span>
            regsub &#34;\.xos&#34; $i386File &#34;&#34; i386File
            set i386FileList [split $i386File -]
            set image [lindex $i386FileList end]
       } 
    }
        
    return 1
}


;<span class="comment-line"># Procedure to handle copying the image to the tftp servers, then</span>
;<span class="comment-line"># downloading the image to the DUTs. </span>
<strong><a name="::::handleImageDownload_339">proc <a href="runall_monitor.tcl-annot.html#::::handleImageDownload">::::handleImageDownload</a></a></strong> { cfg i386ImagePath marinerImagePath aspenImagePath \
                           cougarImagePath x480ImagePath NWIImagePath viperImagePath bootrom } {
    
    <a name="::result_debug(15)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;*****************************************************&#34;
    <a name="::result_debug(16)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;          Starting Download Image Process&#34;
    <a name="::result_debug(17)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;*****************************************************&#34;
    

    puts &#34;cfg: $cfg marinerImagePath: $marinerImagePath i386ImagePath: \n
      $i386ImagePath aspenImagePath: $aspenImagePath cougarImagePath: $cougarImagePath x480ImagePath: $x480ImagePath x870ImagePath: $x870ImagePath NWIImagePath: $NWIImagePath viperImagePath: $viperImagePath\
       bootrom: $bootrom&#34;

	    set dlStat [catch {exec tclsh LoadImage.tcl -cfg $cfg \
                -marinerImagePath $marinerImagePath \
                -i386ImagePath $i386ImagePath \
                -aspenImagePath $aspenImagePath \
                -cougarImagePath $cougarImagePath \
                -x480ImagePath $x480ImagePath \
                -x870ImagePath $x870ImagePath \
                -NWIImagePath $NWIImagePath \
                -viperImagePath $viperImagePath \
                -bootrom $bootrom &gt;&amp;@stdout} result]



	
	if {$dlStat != 0} {
	    <a name="::result_error(6)"><a href="./lconsoles.tcl.html#::result_error_6">::result_error</a></a> &#34;\nERROR: Image download failed to DUTs!\nIf you do NOT\
		    want to download image, please use '-download no' option.\n&#34;
	    <a name="::result_error(7)"><a href="./lconsoles.tcl.html#::result_error_6">::result_error</a></a> &#34;$result&#34;
	    return 0
	}
    return 1
}

<strong><a name="::::handleAbortedModule_374">proc <a href="runall_monitor.tcl-annot.html#::::handleAbortedModule">::::handleAbortedModule</a></a></strong> { testModule regType platform blade image } {

    set build $image
    set imageVer [ getBuildNumber $build ]  
    set reportDir [ <a name="::GetReportDir(1)"><a href="./report.tcl.html#::GetReportDir_755">::GetReportDir</a></a> $testModule $regType $platform $blade $imageVer &#34;..&#34;]
    <a name="::result_debug(18)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;Report dir for the aborted module : $reportDir&#34;

    if { [ catch {exec mkdir $reportDir} result ] } {
	<a name="::result_error(8)"><a href="./lconsoles.tcl.html#::result_error_6">::result_error</a></a> &#34;$result&#34;
    }
    if { [ catch { open &#34;$reportDir/report.txt&#34; w } fd ] } {
	<a name="::result_error(9)"><a href="./lconsoles.tcl.html#::result_error_6">::result_error</a></a> &#34;Can't open file : $reportDir/report.txt&#34;
    }
    puts $fd &#34;MODULE_ABORTED&#34;
    close $fd
}


;<span class="comment-line"># Check the result value returned by main.tcl for FATAL errors that we</span>
;<span class="comment-line"># want to ABORT the rest of the run.</span>
<strong><a name="::::checkFatalError_394">proc <a href="runall_monitor.tcl-annot.html#::::checkFatalError">::::checkFatalError</a></a></strong> { result  } {
    
    global fatalErrorList

    foreach errorString $fatalErrorList {
	
	<a name="::result_debug(19)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;$errorString  $result&#34;
	if [regexp -nocase $errorString $result] {
	    return 1
	}
    }
    return 0
}

;<span class="comment-line"># Take care of running regression (main.tcl) and posting to the</span>
;<span class="comment-line"># web (automate.tcl).</span>
<strong><a name="::::runModuleRegression_410">proc <a href="runall_monitor.tcl-annot.html#::::runModuleRegression">::::runModuleRegression</a></a></strong> {testModule modeToUse regPath cfg noPost \
	createConfig regType regSubType platform blade image obuild } {

    global exclude
    global executeBatFile 
    global erroredModules
    global fd_res

    set errorCode 1

    set match &#34;&#34;
    set str &#34;&#34; 
    set skipModule &#34;&#34;

    ;<span class="comment-line"># Check if this module is on the exclude list</span>
    foreach excludeM $exclude {
	if {[regexp -nocase &#34;(^$excludeM.*)&#34;  $testModule match str]} {
	    set skipModule $str
	    break
	} 
    }
   
    if {$skipModule == &#34;&#34;} {

	set moduleStartTime [exec date]
	
	<a name="::result_debug(20)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;Starting regression for $testModule START: $moduleStartTime....&#34;
	<a name="::result_debug(21)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;\tmain.tcl -mode $modeToUse -module $testModule \
		-regPath $regPath -cfg $cfg&#34;

	;<span class="comment-line"># Write logs to file before starting</span>
	flush $fd_res
	catch { exec {tclsh} main.tcl -mode $modeToUse -module $testModule \
		-regPath ../$regPath -cfg $cfg -build $image -obuild $obuild &gt;@stdout } result
<span class="comment-line">#set result &#34;testCompleted&#34;</span>


	<a name="::result_debug(22)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;$testModule   main.tcl returned result: $result&#34;
	;<span class="comment-line"># If we get no result back, we assume abnormal termination</span>
	;<span class="comment-line"># If we get something other than testCompleted or testSkipped, we assume problem</span>
	;<span class="comment-line">#    with the test execution.</span>
	if {(! [regexp -nocase {testCompleted|testSkipped} $result]) || ($result == &#34;&#34;)} {
	    
	    global mailTo
	    ;<span class="comment-line"># Send email notification</span>
	    set  notificationData  &#34;\nHOST PC:  [exec hostname] \
		    \nSTARTED:  $moduleStartTime \
		    \nENDED:    [exec date] \
		    \nIMAGE:    $image \
		    \nCFG:      $cfg \
		    \nPLATFORM: $platform \
		    \nBLADE:    $blade \
		    \nMODULE:   $testModule&#34;
          set subject &#34;$cfg Regression Aborted running $testModule with ERROR&#34;

	    sendMailNotification $mailTo $subject \
		    &#34;MAIN.TCL: $testModule\nERROR:$result\n$notificationData&#34;
	    
	    <a name="::result_error(10)"><a href="./lconsoles.tcl.html#::result_error_6">::result_error</a></a> &#34;MAIN.TCL: $testModule\n$result\n$notificationData&#34;
	    lappend erroredModules $testModule
	    set errorCode 1

            <a name="::handleAbortedModule(1)"><a href="./runall_monitor.tcl.html#::handleAbortedModule_374">::handleAbortedModule</a></a> $testModule $regType $platform $blade $image

	    ;<span class="comment-line"># Check if the string returned from main.tcl constitutes a fatal</span>
	    ;<span class="comment-line"># error where we ABORT the rest of the regression.</span>
	    if {[<a name="::checkFatalError(1)"><a href="./runall_monitor.tcl.html#::checkFatalError_394">::checkFatalError</a></a> $result] == 1} {
		return &#34;FATAL_ERROR&#34;
	    }
	}
	
	after 2000
	
	if {[regexp -nocase -indices &#34;(^Y)&#34; $noPost matchedRange] == 1} {
	    <a name="::result_debug(23)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;\tSkip call to automate.tcl.&#34; 
	    return $errorCode
	}

        if {$regSubType == &#34;upgradedowngrade&#34;} {
            set delimit &#34;:&#34;
        } else {
            set delimit &#34;&#34;
            <span class="comment-line"># make sure to clear obuild since it's not needed</span>
            set obuild &#34;&#34;
        }

	<span class="comment-line"># Post results to autoweb</span>

	<span class="comment-line"># Adjust Aspen platform name if needed for Rushmore (v11.3) and beyond</span>
	if { [regexp -nocase $platform &#34;Aspen&#34;] } {

	    regexp {([0-9]+)\.([0-9]+)\.([0-9]+)\.([0-9]+)} $image match majorver minorver
	    if { ($majorver &gt; 11) || \
                 (($majorver == 11) &amp;&amp; ($minorver &gt;= 3)) } {
		set platform &#34;BD-8810&#34;
	    }
	}

	if {$createConfig == 1} {
	    ;<span class="comment-line"># We run this regardless if there was an error running this module, </span>
	    ;<span class="comment-line"># because we want to process all modules and create a bat file</span>
	    <a name="::result_debug(24)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;\tautomate.tcl -regType $regType \
		    -regSubType $regSubType \
		    -build $image.xtr -platform $platform -blade $blade&#34;
	    <span class="comment-line"># Create rerun bat file</span>
	    catch {exec {tclsh} automate.tcl -regType $regType \
		    -regSubType $regSubType \
		    -build $image$delimit$obuild -platform $platform \
		    -blade $blade &gt;&amp;@stdout } result

	    ;<span class="comment-line"># No rerun required for performance</span>
	    if {! [regexp -nocase &#34;perf&#34; $regType]} {
		set executeBatFile 1
	    }
	} else {

	     <span class="comment-line"># Do NOT create rerun bat file</span>
		<a name="::result_debug(25)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;\tautomate.tcl -regType $regType \
			-regSubType $regSubType -build $image$delimit$obuild \
			-platform $platform -blade $blade -modules $testModule \
			-noconfig&#34;
		<span class="comment-line"># Create rerun bat file</span>
		catch { exec {tclsh} automate.tcl -regType $regType \
			-regSubType $regSubType \
			-build $image$delimit$obuild -platform $platform \
			-blade $blade -modules $testModule -noconfig &gt;&amp;@stdout } \
			result
	}
<span class="comment-line">#set result &#34;&#34;</span>
	if {$result != &#34;&#34;} {
	    <a name="::result_error(11)"><a href="./lconsoles.tcl.html#::result_error_6">::result_error</a></a> &#34;automate.tcl: $result&#34;
	}
    }
    
    return $errorCode

}



<span class="comment-line">################################################################################</span>
<span class="comment-line">#                                M A I N</span>
<span class="comment-line">################################################################################</span>

<a name="::result_debug(26)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;###################################################################&#34;
<a name="::result_debug(27)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;                    RUNALL_MONITOR.TCL STARTED!&#34;
<a name="::result_debug(28)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;###################################################################&#34;
<a name="::result_debug(29)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;[exec date]&#34;

source ../Lib/parse_args.tcl

<a name="::parse_args(1)"><a href="./parse_args.tcl.html#::parse_args_29">::parse_args</a></a> runall_monitor $argv {
    blade &#34;null&#34;
    platform &#34;null&#34;
    cfg &#34;null&#34;
    regType &#34;null&#34;
    regSubType &#34;null&#34;
    exclude &#34;&#34;
    include &#34;&#34;
    download &#34;yes&#34;
    noPost &#34;N&#34;
    mailTo &#34;&#34;
    i386ImagePath   &#34;NULL&#34;
    marinerImagePath   &#34;NULL&#34;
    aspenImagePath   &#34;NULL&#34;
    cougarImagePath   &#34;NULL&#34;
    x480ImagePath   &#34;NULL&#34;
    x870ImagePath   &#34;NULL&#34; 
    NWIImagePath   &#34;NULL&#34;
    viperImagePath   &#34;NULL&#34;
    bootrom &#34;NULL&#34;
    obuild &#34;&#34;
}

<span class="comment-line"># check to see if testModuleList.cfg exists</span>
if {![file exists $modSummaryCfgPath]} {
    <a name="::result_error(12)"><a href="./lconsoles.tcl.html#::result_error_6">::result_error</a></a> &#34;\nERROR: $modSummaryCfgPath could not be found.  Please correct \
	    this error before re-running.\n&#34;
    return 0
}

source $modSummaryCfgPath

set env(EXOS_PLATFORM_TYPE) 2
set image &#34;&#34;

;<span class="comment-line"># NOTE: Pass by reference</span>
if { ! [ validateArgs blade platform cfg regType regSubType exclude \
	include download noPost mailTo i386ImagePath \
        marinerImagePath aspenImagePath cougarImagePath x480ImagePath x870ImagePath NWIImagePath viperImagePath image ] } {
    <a name="::::print_usage(1)"><a href="./summarize.tcl.html#::::print_usage_2">::::print_usage</a></a>
    return 0
}


set regressionModules [getRegressionModuleList $regType $regSubType]
if {$regressionModules == &#34;&#34;} {
    <a name="::result_error(13)"><a href="./lconsoles.tcl.html#::result_error_6">::result_error</a></a> &#34;No modules list for regType:$regType regSubType:$regSubType&#34;
    return 0
}


<span class="comment-line">##################################################</span>
<span class="comment-line">#  Download image if needed </span>
<span class="comment-line">###################################################</span>
if {($image != &#34;&#34;) &amp;&amp; [regexp -nocase &#34;yes&#34; $download] } {

    if {! [<a name="::handleImageDownload(1)"><a href="./runall_monitor.tcl.html#::handleImageDownload_339">::handleImageDownload</a></a> $cfg $i386ImagePath $marinerImagePath \
            $aspenImagePath $cougarImagePath $x480ImagePath $NWIImagePath $viperImagePath $bootrom ]} {
	
	set  notificationData  &#34;\nHOST  PC:  [exec hostname] \
		\nSTARTED:  $startTime \
		\nENDED:    [exec date] \
		\nIMAGE:    $i386ImagePath \
		\nIMAGE:    $marinerImagePath \
		\nIMAGE:    $aspenImagePath \
		\nIMAGE:    $cougarImagePath \
                \nIMAGE:    $x480ImagePath \
                \nIMAGE:    $x870ImagePath \
                \nIMAGE:    $NWIImagePath \
                \nIMAGE:    $viperImagePath \
		\nCFG:      $cfg \
		\nINCLUDE:  $include \
		\nEXCLUDE:  $exclude \
		\nMODULES:  $regressionModules&#34;
	;<span class="comment-line"># Unable to download image.</span>
	sendMailNotification $mailTo \
		&#34;Image download for $cfg FAILED&#34; \
		&#34;Image download for $cfg FAILED. Please debug and restart. \
		$notificationData&#34;
	
	<a name="::result_error(14)"><a href="./lconsoles.tcl.html#::result_error_6">::result_error</a></a> &#34;IMAGE DOWNLOAD Failed!&#34;
	return 0
    }
}
   

sleep 5

;<span class="comment-line"># Get the regPath from head of $regressionModules</span>
set regPath [lindex $regressionModules 0]
<a name="::result_debug(30)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;regPath: $regPath&#34;

if {$include != &#34;&#34;} {
    ;<span class="comment-line"># Rebuild $regressionModules list with only included modules</span>
    unset regressionModules
    set regressionModules $include
} else {
    ;<span class="comment-line"># Remove regPath param from $regressionModules</span>
    set regressionModules [lrange $regressionModules 1 \
	    [expr [llength $regressionModules] - 1] ]
}

set lastModule [lindex $regressionModules [expr \
	[llength $regressionModules] - 1]]

<a name="::result_debug(31)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;REGRESSION MODULES FOR THIS RUN&#34;
<a name="::result_debug(32)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;$regressionModules&#34;

;<span class="comment-line"># Write logs to file</span>
flush $fd_res

set createConfig 0
<span class="comment-line"># Default mode to use for main.tcl (auto | dev | autodev )</span>
set modeToUse &#34;auto&#34;
set modeFast   1  ;<span class="comment-line"># Use auto for first module, then autodev for next</span>

foreach testModule $regressionModules {

    set status &#34;OK&#34;

    puts &#34;LAST: $lastModule  TEST:$testModule&#34;
    if {([string equal -nocase $lastModule $testModule] == 1) &amp;&amp; \
	    (! [regexp -nocase &#34;perf&#34; $regType])} {
	set createConfig 1
	<a name="::result_debug(33)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;****** SETTING CREATE CONFIG to 1 ******&#34;
    } 
    
    <span class="comment-line"># For initial release, keep everything in AUTO mode</span>
    set modeToUse &#34;auto&#34;
    
    puts &#34;*************** RUNNING in $modeToUse *****************&#34; 
    set status [<a name="::runModuleRegression(1)"><a href="./runall_monitor.tcl.html#::runModuleRegression_410">::runModuleRegression</a></a> $testModule $modeToUse $regPath $cfg $noPost \
	    $createConfig $regType $regSubType $platform $blade $image $obuild]
    
    if [regexp -nocase &#34;FATAL_ERROR&#34; $status] {	
	<a name="::result_debug(34)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;######################################################################&#34;
	<a name="::result_debug(35)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;            ** ABORTED ** RUNALL_MONITOR.TCL ** ABORTED **&#34;
	<a name="::result_debug(36)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;######################################################################&#34;

	return 0  ;<span class="comment-line"># QUIT</span>
    }
}

 

;<span class="comment-line"># Only execute re-run batch file if we created it in this run via automate.tcl</span>
set batResult &#34;&#34;
if { $executeBatFile } {
    set nextBatchFile [genRerunBatFileName $regType $regSubType $platform $blade]
    
    <a name="::result_debug(37)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;STARTED: $nextBatchFile on [exec date]&#34;
    after 5000
    catch { exec ./$nextBatchFile &gt;&amp;@stdout } batResult
    if {$batResult != &#34;&#34;} {
	<a name="::result_error(15)"><a href="./lconsoles.tcl.html#::result_error_6">::result_error</a></a> &#34;$batResult&#34;
    }
    <a name="::result_debug(38)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;FINISHED: $nextBatchFile on [exec date]&#34;
}

set  notificationData  &#34;\nHOST PC:  [exec hostname] \
	\nSTARTED:  $startTime \
	\nENDED:    [exec date] \
	\nIMAGE:    $i386ImagePath \
	\nIMAGE:    $marinerImagePath \
	\nIMAGE:    $aspenImagePath \
	\nIMAGE:    $cougarImagePath \
        \nIMAGE:    $x480ImagePath \
        \nIMAGE:    $x870ImagePath \
        \nIMAGE:    $NWIImagePath \
        \nIMAGE:    $viperImagePath \
	\nDOWNLOAD: $download \
	\nCFG:      $cfg \
	\nINCLUDE:  $include \
	\nEXCLUDE:  $exclude \
	\nMODULES:  $regressionModules\n&#34;


if [llength $erroredModules] {
    set notificationData &#34;$notificationData\n\
	    MODULES ABNORMALLY TERMINATED DURING RUN: $erroredModules&#34;
}

if {$batResult != &#34;&#34;} {
    set notificationData &#34;$notificationData\n\nRERUN ERROR: $batResult&#34;
} elseif { $executeBatFile } {
    set notificationData &#34;$notificationData\n\nBATCH FILE USED FOR 2nd PASS: $nextBatchFile\n\
	    [exec cat $nextBatchFile]\n&#34;
}

sendMailNotification $mailTo \
	&#34;RUNALL_MONITOR for $cfg finished&#34; \
	&#34;Congratulations! runall_monitor.tcl for $cfg has completed $regType tests.\n \
	$notificationData&#34;


<a name="::result_debug(39)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;######################################################################&#34;
<a name="::result_debug(40)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;                      RUNALL_MONITOR.TCL FINISHED!&#34;
<a name="::result_debug(41)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;######################################################################&#34;
<a name="::result_debug(42)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;$notificationData&#34;
</pre>
<hr>
<div class="index-selector">
	<a href="index_main.html#byfilename">file name</a> 
 | 
	<a href="index_main.html#byprocname">procedure name</a> 
 | 
	<a href="index_main.html#bycall">procedure call</a> 
 | 
	<a href="index_annot_full.html">annotation</a> 

<br>
<cite>File generated 2018-06-14 at 17:09.</cite>
</div>

</body>
</html>
