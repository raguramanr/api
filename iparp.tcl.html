<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                       "http://www.w3.org/TR/html4/transitional.dtd">
<!-- Generated by TclDoc @@VERSION@@ -->
<html>
<head>
  <title>iparp.tcl</title>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <link rel="stylesheet" type="text/css" href="default.css">
</head>
<body class="src-html">
<div class="index-selector">
<!-- index for tcl source files -->
	Index by: 
	<a href="index_main.html#iparp.tcl">file name</a> | 
	<a href="index_main.html#byprocname">procedure name</a> | 
	<a href="index_main.html#bycall">procedure call</a> | 
	<a href="index_annot_full.html">annotation</a>

</div>
<hr>

<p><strong>iparp.tcl</strong>&nbsp;&nbsp;<span class="filetype-link">(<a href="iparp.tcl-annot.html">annotations</a> | <a href="iparp.tcl.txt">original source</a>)</span>
</p>
<pre class="src-code">

<span class="comment-line">################################################################## </span>
<span class="comment-line"># Procedure Name: iparp_check_data</span>
<span class="comment-line">#   </span>
<span class="comment-line"># Description: proc that checks IP arp rable entries for a ip address list dIpList</span>
<span class="comment-line"># dIpList a list of list.  Every member list contains:</span>
<span class="comment-line">#       shExist: &#34;should exist&#34;, yes or no</span>
<span class="comment-line">#    	ip:  IP address of the target</span>
<span class="comment-line">#       mac: MAC address of the target.	Real MAC, &#34;incomplete&#34; or &#34;-&#34;</span>
<span class="comment-line">#       age: Age of the corresping IP ARP entry	(in minute)</span>
<span class="comment-line">#       static: yes or no</span>
<span class="comment-line">#       vlan: Vlan name</span>
<span class="comment-line">#       vid: Vlan id</span>
<span class="comment-line">#       port: Port number(s)</span>
<span class="comment-line"># Note: Except ip, if any other field is &#34;don't care&#34;, mark it as &#34;-&#34;</span>
<span class="comment-line">#       or leave it empty if no other &#34;care&#34; fields after that.</span>
<span class="comment-line"># Input args: dIpList, fd_res, tesTNo, DUT_C, checkNumArpOnly, targetNumArp, DUT_IP</span>
<span class="comment-line"># Output args: none</span>
<span class="comment-line"># Typical usage:</span>
<span class="comment-line">#           iparp_check_data $ipList $fd_res $testNo $DUT1_CONNECT</span>
<span class="comment-line">#</span>
<span class="comment-line"># Category Types (Setup,GetSwitchInfo,SendTraffic,CaptureTraffic,VerifySwitchOutput</span>
<span class="comment-line">#                          VerifyTraffic)</span>
<span class="comment-line"># Category: VerifySwitchOutput</span>
<span class="comment-line">##################################################################</span>
<strong><a name="::::iparp_check_data_26">proc <a href="iparp.tcl-annot.html#::::iparp_check_data">::::iparp_check_data</a></a></strong> {{dIpList {}}
                       {fd_res &#34;NULL&#34;}
                       {testNo &#34;0&#34;}
                       {DUT_C &#34;127.0.0.1&#34;}
                       {checkNumArpOnly &#34;false&#34;}
                       {targetNumArp &#34;0&#34;}
                       {DUT_IP &#34;127.0.0.1&#34;}} {

   global VERSION
   set numArpFound 0
   set date [clock format [clock seconds] -format &#34;%m-%d-%Y %I.%M.%S%p&#34;]
   <a name="::result_debug(1)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;*** date=$date&#34;

   set fd_in [open &#34;Tmp/tmp_$testNo[pid]&#34; &#34;w+&#34;]
   <a name="::Login(1)"><a href="./login.tcl.html#::Login_24">::Login</a></a> $DUT_C
   <a name="::SendACmd(1)"><a href="./SendSwCmd.tcl.html#::SendACmd_157">::SendACmd</a></a>	&#34;show iparp&#34; $fd_res $fd_in
   <a name="::logout_noSave(1)"><a href="./logout.tcl.html#::logout_noSave_198">::logout_noSave</a></a>
   close $fd_in

   set fd_in [open &#34;Tmp/tmp_$testNo[pid]&#34; &#34;r&#34;]
   foreach ipPair $dIpList {
      set found    &#34;false&#34;
      set check(0) &#34;shExist&#34;;  set check(check(0)) &#34;false&#34;
      set check(1) &#34;ip&#34;;	   set check(check(1)) &#34;false&#34;
      set check(2) &#34;mac&#34;;	   set check(check(2)) &#34;false&#34;
      set check(3) &#34;age&#34;;	   set check(check(3)) &#34;false&#34;
      set check(4) &#34;static&#34;;   set check(check(4)) &#34;false&#34;
      set check(5) &#34;vlan&#34;;	   set check(check(5)) &#34;false&#34;
      set check(6) &#34;vid&#34;;	   set check(check(6)) &#34;false&#34;
      set check(7) &#34;port&#34;;	   set check(check(7)) &#34;false&#34;
      set numField [llength $ipPair]

      for {set i 0} {$i &lt; $numField} {incr i 1} {
         set $check($i) [string tolower [lindex $ipPair $i]] 
	  }
      if { [set $check(2)] == &#34;incomplete&#34; } { set $check(2) &#34;(incomplete)&#34; }

      seek $fd_in 0
      while {[gets $fd_in line] != -1} {
         set inList [<a name="::eSplit(1)"><a href="./misc.tcl.html#::eSplit_115">::eSplit</a></a> $line]
	     set len [llength $inList]
	     if { $len &gt;= 4 } {
			if { $ip == [lindex $inList 0] } {	;<span class="comment-line"># IP addr. match</span>
	           set errMsg &#34;&#34;
			   set check(ip) &#34;true&#34;
			   set found &#34;true&#34;


               switch $VERSION {
                  6  {
                      for {set i 2} {$i &lt; $numField} {incr i 1} {
			             set j [expr $i-1]
				         set inValue [string tolower [lindex $inList $j]]
                         if { ([set $check($i)] == &#34;-&#34;) || ($inValue == [set $check($i)]) } { 
                            set check(check($i)) &#34;true&#34; 
                         } else {
                            if { $i == 3 } {
					           set expAge [set $check(3)]	   ;<span class="comment-line"># age</span>
					           if { ($inValue &gt;= [expr $expAge-1]) || ($inValue &lt;= [expr $expAge+1]) } {
                                  <a name="::result_warning(1)"><a href="./ql_multi.tcl.html#::result_warning_407">::result_warning</a></a> &#34;Real age value=$inValue, target=$expAge&#34;
                                  set check(check(3)) &#34;true&#34;
                               }
                            } else { 
			                   set errMsg [append errMsg &#34;$check($i) &#34;]
			                   set found &#34;true_err&#34;
							}
					     }
                      }
       		       }
				   4  {
                      for {set i 2} {$i &lt; $numField} {incr i 1} {
                         if { $len == 7 } {	
                            set j [expr $i-1]
							set check(check(4)) &#34;true&#34;
			             } else { 
			             	if { $i &lt;= 4 } { set j [expr $i-1] }
			             	if { $i &gt;= 5 } { set j [expr $i-2] }
						 }
				         set inValue [string tolower [lindex $inList $j]]
                         if { $i == 4 } {  ;<span class="comment-line"># Static value</span>
							switch $len {
							   6 { set inValue &#34;no&#34; }
				               7 { if { $inValue == &#34;m&#34; } { set inValue &#34;yes&#34; 
				                   } else { set inValue &#34;no&#34; }
							   }
                            }
					     }

                         if { ([set $check($i)] == &#34;-&#34;) || ($inValue == [set $check($i)]) } { 
                            set check(check($i)) &#34;true&#34; 
                         } else {
                            if { $i == 3 } {
					           set expAge [set $check(3)]	   ;<span class="comment-line"># age</span>
					           if { ($inValue &gt;= [expr $expAge-1]) || ($inValue &lt;= [expr $expAge+1]) } {
                                  <a name="::result_warning(2)"><a href="./ql_multi.tcl.html#::result_warning_407">::result_warning</a></a> &#34;Real age value=$inValue, target=$expAge&#34;
                                  set check(check(3)) &#34;true&#34;
                               }
                            } else { 
			                   set errMsg [append errMsg &#34;$check($i) &#34;]
			                   set found &#34;true_err&#34;
							}
					     }
                      }
				   }
			   }
			}
		 }
	  }
      if { $found == &#34;true&#34; } { 
         set numArpFound [incr numArpFound 1] 
<a name="::result_debug(2)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;@@@ ip=$ip, numArpFound=$numArpFound&#34;
      }

      set DUT_INFO &#34;&#34;
      if { $DUT_IP != &#34;127.0.0.1&#34; } { set DUT_INFO &#34;(${DUT_IP}) &#34; }

<a name="::result_debug(3)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;#### checkNumArpOnly=$checkNumArpOnly&#34;
      if { $checkNumArpOnly == &#34;false&#34; } {
<a name="::result_debug(4)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;#### check(0)=$check(0)&#34;
         switch [set $check(0)] {
            &#34;yes&#34; {
               <a name="::report_start_test(1)"><a href="./report.tcl.html#::report_start_test_79">::report_start_test</a></a> &#34;IpArp check entry $DUT_INFO'$ip $mac'&#34;
               switch $found {
                  &#34;true&#34;     { <a name="::result_ok(1)"><a href="./lconsoles.tcl.html#::result_ok_9">::result_ok</a></a>    &#34;Ip Arp check entry $ip $mac passed&#34; }
                  &#34;true_err&#34; { <a name="::result_error(1)"><a href="./lconsoles.tcl.html#::result_error_6">::result_error</a></a> &#34;Ip Arp check entry $ip $mac found but $errMsg fields wrong&#34; }
                  &#34;false&#34;    { <a name="::result_error(2)"><a href="./lconsoles.tcl.html#::result_error_6">::result_error</a></a> &#34;Ip Arp check entry $ip $mac not found&#34;	}
		       }
		    } 
	        &#34;no&#34; { 
               <a name="::report_start_test(2)"><a href="./report.tcl.html#::report_start_test_79">::report_start_test</a></a> &#34;IpArp check NO entry $DUT_INFO'$ip $mac'&#34;
               switch $found {
                  &#34;true&#34;     { <a name="::result_error(3)"><a href="./lconsoles.tcl.html#::result_error_6">::result_error</a></a> &#34;Ip Arp check NO entry $ip $mac failed&#34; }
                  &#34;true_err&#34; { <a name="::result_ok(2)"><a href="./lconsoles.tcl.html#::result_ok_9">::result_ok</a></a>    &#34;Ip Arp check NO entry $ip $mac passed, $errMsg fields different&#34; }
                  &#34;false&#34;    { <a name="::result_ok(3)"><a href="./lconsoles.tcl.html#::result_ok_9">::result_ok</a></a>    &#34;Ip Arp check NO entry $ip $mac passed&#34; }
		       }
		    }
         }
         <a name="::report_end_test(1)"><a href="./report.tcl.html#::report_end_test_122">::report_end_test</a></a>
      }
   }
   if { $checkNumArpOnly == &#34;true&#34; } {
      <a name="::report_start_test(3)"><a href="./report.tcl.html#::report_start_test_79">::report_start_test</a></a> &#34;Number of IP ARP entry check&#34;
	  if { $numArpFound &gt;= $targetNumArp } {
		 <a name="::result_ok(4)"><a href="./lconsoles.tcl.html#::result_ok_9">::result_ok</a></a>    &#34;Num. of ARP check passed. Found=$numArpFound, target=$targetNumArp&#34;
	  } else {
		 <a name="::result_error(4)"><a href="./lconsoles.tcl.html#::result_error_6">::result_error</a></a> &#34;Num. of ARP check failed. Found=$numArpFound, target=$targetNumArp&#34;
	  }
      <a name="::report_end_test(2)"><a href="./report.tcl.html#::report_end_test_122">::report_end_test</a></a>
   }
   close $fd_in
   file delete &#34;Tmp/tmp_$testNo[pid]&#34;
   return $numArpFound
}

<span class="comment-line">################################################################## </span>
<span class="comment-line"># Procedure Name: iparp_check_timer</span>
<span class="comment-line">#   </span>
<span class="comment-line"># Description: proc that checks IP arp timer enabled/disabled based on enableStatus from</span>
<span class="comment-line">#              show ipc output.</span>
<span class="comment-line">#</span>
<span class="comment-line">#</span>
<span class="comment-line">#</span>
<span class="comment-line"># Input args: enableStatus, timer, fd_res, testNo, DUT</span>
<span class="comment-line"># Output args: none</span>
<span class="comment-line"># Typical usage:</span>
<span class="comment-line">#          iparp_check_timer enabled 10 $fd_res $testNo $DUT1_CONNECT</span>
<span class="comment-line">#</span>
<span class="comment-line"># Category Types (Setup,GetSwitchInfo,SendTraffic,CaptureTraffic,VerifySwitchOutput</span>
<span class="comment-line">#                          VerifyTraffic)</span>
<span class="comment-line"># Category: VerifySwitchOutput</span>
<span class="comment-line">##################################################################</span>
<strong><a name="::::iparp_check_timer_197">proc <a href="iparp.tcl-annot.html#::::iparp_check_timer">::::iparp_check_timer</a></a></strong> {enableStatus timer fd_res testNo DUT} {
   set date [clock format [clock seconds] -format &#34;%m-%d-%Y %I.%M.%S%p&#34;]
   <a name="::result_debug(5)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;*** date=$date&#34;

   set fd_in [open &#34;Tmp/tmp_$testNo[pid]&#34; &#34;w+&#34;]
   <a name="::Login(2)"><a href="./login.tcl.html#::Login_24">::Login</a></a> $DUT
   <a name="::SendACmd(2)"><a href="./SendSwCmd.tcl.html#::SendACmd_157">::SendACmd</a></a>	&#34;show ipc&#34; $fd_res $fd_in
   <a name="::logout_noSave(2)"><a href="./logout.tcl.html#::logout_noSave_198">::logout_noSave</a></a>
   close $fd_in

   set fd_in [open &#34;Tmp/tmp_$testNo[pid]&#34; &#34;r&#34;]
   set result &#34;ok&#34;

   while {[gets $fd_in line] != -1} {
      set inList [<a name="::eSplit(2)"><a href="./misc.tcl.html#::eSplit_115">::eSplit</a></a> $line]
	  if { ([lindex $inList 0] == &#34;ARP&#34;) &amp;&amp; ([lindex $inList 1] == &#34;Timeout&#34;)} {
         set field3 [string tolower [lindex $inList 3]]
         set field4 [string trimleft [lindex $inList 4] \[ ]
<a name="::result_debug(6)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;@@@ field3=$field3&#34;
<a name="::result_debug(7)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;@@@ field4=$field4&#34;
         if { ($field3 != &#34;-&#34;) &amp;&amp; ($field3 != $enableStatus) } {
		    set result &#34;fail&#34;
		 }
         if { ($field4 != &#34;-&#34;) &amp;&amp; ($field4 != $timer) } {
		    set result &#34;fail&#34;
		 }
         break
	  }
   }

   <a name="::report_start_test(4)"><a href="./report.tcl.html#::report_start_test_79">::report_start_test</a></a> &#34;Ip Arp check timer&#34;
   switch $result {
      &#34;ok&#34; { <a name="::result_ok(5)"><a href="./lconsoles.tcl.html#::result_ok_9">::result_ok</a></a> &#34;IpArp timer=$timer, $enableStatus check passed&#34;	}
	  &#34;fail&#34; { <a name="::result_error(5)"><a href="./lconsoles.tcl.html#::result_error_6">::result_error</a></a> &#34;IpArp timer=$timer, $enableStatus check failed&#34; }
   }
   <a name="::report_end_test(3)"><a href="./report.tcl.html#::report_end_test_122">::report_end_test</a></a>
   close $fd_in
   file delete &#34;Tmp/tmp_$testNo[pid]&#34;
}
</pre>
<hr>
<div class="index-selector">
	<a href="index_main.html#byfilename">file name</a> 
 | 
	<a href="index_main.html#byprocname">procedure name</a> 
 | 
	<a href="index_main.html#bycall">procedure call</a> 
 | 
	<a href="index_annot_full.html">annotation</a> 

<br>
<cite>File generated 2018-06-14 at 17:09.</cite>
</div>

</body>
</html>
