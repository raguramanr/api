<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                       "http://www.w3.org/TR/html4/transitional.dtd">
<!-- Generated by TclDoc @@VERSION@@ -->
<html>
<head>
  <title>Forwarding.tcl</title>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <link rel="stylesheet" type="text/css" href="default.css">
</head>
<body class="src-html">
<div class="index-selector">
<!-- index for tcl source files -->
	Index by: 
	<a href="index_main.html#Forwarding.tcl">file name</a> | 
	<a href="index_main.html#byprocname">procedure name</a> | 
	<a href="index_main.html#bycall">procedure call</a> | 
	<a href="index_annot_full.html">annotation</a>

</div>
<hr>

<p><strong>Forwarding.tcl</strong>&nbsp;&nbsp;<span class="filetype-link">(<a href="Forwarding.tcl-annot.html">annotations</a> | <a href="Forwarding.tcl.txt">original source</a>)</span>
</p>
<pre class="src-code">

<span class="comment-line">##################################################################    </span>
<span class="comment-line"># Description:</span>
<span class="comment-line">#     	This proc can be used to send any L2/L3 unicast/multicast</span>
<span class="comment-line">#	packets and verify their forwarding.  In checkPortList input, for </span>
<span class="comment-line">#	each receiving port the number of packets expected to be received</span>
<span class="comment-line">#	can be specify to be any exact number or up/down range.</span>
<span class="comment-line">#</span>
<span class="comment-line"># </span>
<span class="comment-line"># Input args: args</span>
<span class="comment-line">#    -tunnelMode - allows for L3 traffic to verify w/ ttlDecr 0 (before, assumed tllDecr 0 was L2)</span>
<span class="comment-line">#</span>
<span class="comment-line"># Output args: None.</span>
<span class="comment-line"># Typical usage:</span>
<span class="comment-line"># 	lappend checkPortList &#34;5 forwarded 1 up&#34;</span>
<span class="comment-line">#	lappend checkPortList &#34;6 forwarded 7 exact&#34;</span>
<span class="comment-line">#	lappend checkPortList &#34;7 forwarded 5 down&#34;</span>
<span class="comment-line">#	lappend checkPortList &#34;9 notForwarded&#34;</span>
<span class="comment-line">#	CheckForwarding -txPortId 9 -rxPortId 0 -checkPortList $checkPortList -numIpFrame 7 \</span>
<span class="comment-line">#              -protocol &#34;tcp&#34; -dIpAddr &#34;192.168.0.18&#34; -sIpAddr &#34;24.3.89.146&#34; -dPort 21 \</span>
<span class="comment-line">#              -gIpAddr &#34;24.3.89.145&#34; -filePt $fd_res -careTotalIp &#34;yes&#34; -ttlDecr 2 \</span>
<span class="comment-line">#              -comment &#34;- redi.&#34; -ipDaMode &#34;ipIncrHost&#34;</span>
<span class="comment-line"># Category: VerifyTraffic</span>
<span class="comment-line">##################################################################  </span>
<strong><a name="::::CheckForwarding_25">proc <a href="Forwarding.tcl-annot.html#::::CheckForwarding">::::CheckForwarding</a></a></strong> {args} {
   <a name="::parse_args(1)"><a href="./parse_args.tcl.html#::parse_args_29">::parse_args</a></a> CheckForwarding $args {
     txPortId &#34;1&#34;
     rxPortId &#34;0&#34;    ;<span class="comment-line">#default not sending learn arp, otherwise use this port as the 2nd arp port</span>
     <a name="::protocol(1)"><a href="./ePTClient.tcl.html#::protocol_728">::protocol</a></a> &#34;mac&#34;
     tag      &#34;none&#34;
     generateArpReq &#34;1&#34;
     inSaMac &#34;default&#34;
     inDaMac &#34;FF:FF:FF:FF:FF:FF&#34;
     sIpAddr &#34;127.0.0.1&#34;
     dIpAddr &#34;127.0.0.1&#34;
     gIpAddr &#34;0.0.0.0&#34;     ;<span class="comment-line">#gateway address</span>
     sPort &#34;0&#34;
     dPort &#34;0&#34;
     frameSize &#34;64&#34;
     icmpType &#34;0&#34;
     icmpCode &#34;0&#34;
     dontFrag &#34;true&#34;
     lastFrag &#34;true&#34;
     ttl &#34;64&#34;
     ttlDecr &#34;1&#34;
     tunnelMode &#34;0&#34;   
     checkPortList {&#34;2 forwarded 1 exact&#34;} 
     numLearnFrame &#34;1&#34;
     numIpFrame &#34;1&#34;
     filePt &#34;NULL&#34;
     ipDaMode &#34;ipIdle&#34;
     ipSaMode &#34;ipIdle&#34;
     ipDaCount &#34;&#34;
     ethernetType &#34;noType&#34;
     frameType &#34;08 00&#34;
     ipSaCount &#34;&#34;
     ipOptions &#34;&#34;
     tcpSynFlag &#34;false&#34;
     tcpFinFlag &#34;false&#34;
     tcpRstFlag &#34;false&#34;
     tcpAckFlag &#34;false&#34;
     tcpPushFlag &#34;false&#34;
     tcpUrgFlag &#34;false&#34;
     checkMirroringTag &#34;yes&#34;
     mirroringPort &#34;0&#34;
     TOS &#34;default&#34;
     userPriority &#34;0&#34;
     careTotalIp &#34;no&#34; 	;<span class="comment-line"># if to ckeck total IP packets rcvd from all forwarded ports</span>
     CRC &#34;good&#34;
     comment &#34;&#34;
     rate &#34;null&#34;
     udfEnable &#34;false&#34;
     udfInitval &#34;00&#34;
     udfOffset &#34;0&#34;
     udfCountertype &#34;c8&#34;
     udfContinuousCount &#34;false&#34;
     postLearnDelay &#34;null&#34;
   }

   <span class="comment-line"># Global Variables</span>
   global GlobalPostLearnDelay

   <span class="comment-line"># Local Variables</span>
   set rc 0

   if { $gIpAddr == &#34;0.0.0.0&#34; } { set gIpAddr $dIpAddr }

   set pPattern &#34;abcd&#34;   

   if {$rxPortId == $txPortId} {
      <a name="::result_error(1)"><a href="./lconsoles.tcl.html#::result_error_6">::result_error</a></a> &#34;Invalid port specification: txPortId=rxPortId&#34;
      <span class="comment-line"># EY-04-10-2013: Return 0 to indicate a failure to the caller.</span>
      return 0;
   }
   foreach checkPort $checkPortList {
      lappend portMonitorList [lindex $checkPort 0]
      lappend portTagMonitorList [lindex $checkPort 4]
   }
   <a name="::result_debug(1)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;\n\n==================== Check Forwarding $protocol Start ===================&#34; 
   <a name="::ClearPortsStats(1)"><a href="./ePTRx.tcl.html#::ClearPortsStats_951">::ClearPortsStats</a></a> $portMonitorList
   if {$careTotalIp == &#34;yes&#34;} { set totalIpPacketReceived 0 }
   if {[lindex $tag 0]!=&#34;none&#34;&amp;&amp;$frameSize==64} {set frameSize 68}
   switch -- $protocol {
      &#34;mac&#34; -
      &#34;ipx&#34; -
      &#34;mac_ip&#34; -
      &#34;arp&#34; -
      &#34;multicastControl&#34; {
         <a name="::report_start_test(1)"><a href="./report.tcl.html#::report_start_test_79">::report_start_test</a></a> &#34;Frame $protocol L2 forwarding check on Txport $txPortId $comment&#34;
         <span class="comment-line">#turn on capturing function on all the monitor ports</span>
         <a name="::StartPortsCapture(1)"><a href="./ePTRx.tcl.html#::StartPortsCapture_820">::StartPortsCapture</a></a> $portMonitorList
         <span class="comment-line">#MM added sleep for 40G timing issue</span>
         sleep 3
         switch -- $protocol {
            &#34;mac&#34; -
            &#34;mac_ip&#34; -
            &#34;ipx&#34; {
                set prot $protocol
                set rxTag &#34;none&#34;
                if {[llength $tag] &gt; 1} { set rxTag [lindex $tag 1] }
                if {$prot == &#34;mac_ip&#34; } {set prot &#34;ip&#34;}
                if {$rxPortId &gt; 0} {
                    <a name="::result_debug(2)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;--- Send a $prot packet on port $rxPortId for fdb to learn the destination&#34;
                    if {$CRC == &#34;bad&#34;} {
                        set frameSent [<a name="::SendFrame(1)"><a href="./ePTSendPacket.tcl.html#::SendFrame_402">::SendFrame</a></a> -frameRate $rate -txPortId $rxPortId -protocol $prot -tag $rxTag -fcsError $CRC -udfEnable $udfEnable -udfInitval $udfInitval -udfOffset $udfOffset -udfCountertype $udfCountertype -udfContinuousCount $udfContinuousCount]
                    } else {
                        set frameSent [<a name="::SendFrame(2)"><a href="./ePTSendPacket.tcl.html#::SendFrame_402">::SendFrame</a></a> -frameRate $rate -txPortId $rxPortId -protocol $prot -tag $rxTag -frameRate 10 -udfEnable $udfEnable -udfInitval $udfInitval -udfOffset $udfOffset -udfCountertype $udfCountertype -udfContinuousCount $udfContinuousCount]
                    }
                    <a name="::result_debug(3)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;$frameSent&#34;
                    set inDaMac [<a name="::GetSourceMacAddress(1)"><a href="./MessageDecoding.tcl.html#::GetSourceMacAddress_40">::GetSourceMacAddress</a></a> $frameSent]
                    if {[info exists GlobalPostLearnDelay] || $postLearnDelay != &#34;null&#34;} {
                        set learnDelay &#34;&#34;
                        if {$postLearnDelay != &#34;null&#34;} {
                            set learnDelay $postLearnDelay
                        } elseif {[info exists GlobalPostLearnDelay] &amp;&amp; $GlobalPostLearnDelay != &#34;&#34; &amp;&amp; \
                            $GlobalPostLearnDelay &gt; 0} {
                            set learnDelay $GlobalPostLearnDelay
                        } else {
                            set learnDelay 1;
                        }
                        <a name="::result_debug(4)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;\nSleep for $learnDelay seconds after the learning frame is sent&#34;
                        <a name="::exSleep(1)"><a href="./sleep.tcl.html#::exSleep_248">::exSleep</a></a> $learnDelay
                    }
                }
                <span class="comment-line">#sending mac frame</span>
                <a name="::result_debug(5)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;\n==== Forwarding from portId $txPortId -- $numIpFrame ($protocol) Frame(s) ====&#34;
                if {$CRC == &#34;bad&#34;} {
                    set frameSent [<a name="::SendFrame(3)"><a href="./ePTSendPacket.tcl.html#::SendFrame_402">::SendFrame</a></a> -frameRate $rate -txPortId $txPortId -dataPattern $pPattern -tag [lindex $tag 0] \
                          -sourceMac $inSaMac  -destMac $inDaMac -frameSize $frameSize -protocol $prot  \
                          -frameType $frameType -ethernetType $ethernetType \
                          -numFrames $numIpFrame -fcsError $CRC -udfEnable $udfEnable -udfInitval $udfInitval -udfOffset $udfOffset -udfCountertype $udfCountertype -udfContinuousCount $udfContinuousCount]
                } else {
                    set frameSent [<a name="::SendFrame(4)"><a href="./ePTSendPacket.tcl.html#::SendFrame_402">::SendFrame</a></a> -frameRate $rate -txPortId $txPortId -dataPattern $pPattern -tag [lindex $tag 0] \
                          -sourceMac $inSaMac  -destMac $inDaMac -frameSize $frameSize -protocol $prot  \
                          -frameType $frameType -ethernetType $ethernetType \
                          -numFrames $numIpFrame -frameRate 10 -udfEnable $udfEnable -udfInitval $udfInitval -udfOffset $udfOffset -udfCountertype $udfCountertype -udfContinuousCount $udfContinuousCount]
                }
                <a name="::result_debug(6)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;$frameSent&#34;
            }
            &#34;arp&#34; {
                <span class="comment-line">#sending arp frame</span>
                
                if {$CRC == &#34;bad&#34;} {
                    set frameSent [<a name="::SendArpFrame(1)"><a href="./ePTSendPacket.tcl.html#::SendArpFrame_959">::SendArpFrame</a></a> -txPortId $txPortId -sourceIp $sIpAddr \
                                   -destIp $dIpAddr -tag $tag -fcsError $CRC -numFrames $numIpFrame ]
                } else {	
                    set frameSent [<a name="::SendArpFrame(2)"><a href="./ePTSendPacket.tcl.html#::SendArpFrame_959">::SendArpFrame</a></a> -txPortId $txPortId -sourceIp $sIpAddr \
                                   -destIp $dIpAddr -tag $tag -numFrames $numIpFrame]
                }

            }
            &#34;multicastControl&#34; {
                <span class="comment-line">#send an join multicast group igmp packet</span>
                set membershipQuerry 17
                if {$CRC == &#34;bad&#34; } {
                set frameSent [<a name="::SendIgmpFrame(1)"><a href="./ePTSendPacket.tcl.html#::SendIgmpFrame_867">::SendIgmpFrame</a></a> -txPortId $txPortId -type $membershipQuerry -destMac $inDaMac \
                               -sourceIp  $sIpAddr  -destIp $dIpAddr -groupAddr $dIpAddr -fcsError $CRC \
                               -dontFrag $dontFrag \
                               -numFrames $numIpFrame -udfEnable $udfEnable -udfInitval $udfInitval -udfOffset $udfOffset -udfCountertype $udfCountertype -udfContinuousCount $udfContinuousCount]
                } else {
                set frameSent [<a name="::SendIgmpFrame(2)"><a href="./ePTSendPacket.tcl.html#::SendIgmpFrame_867">::SendIgmpFrame</a></a> -txPortId $txPortId -type $membershipQuerry -destMac $inDaMac \
                               -sourceIp  $sIpAddr  -destIp $dIpAddr -groupAddr $dIpAddr  \
                               -dontFrag $dontFrag \
                               -numFrames $numIpFrame -udfEnable $udfEnable -udfInitval $udfInitval -udfOffset $udfOffset -udfCountertype $udfCountertype -udfContinuousCount $udfContinuousCount]
                }

            }
         }
         set numExpectedFrame $numIpFrame
         <span class="comment-line">#retrieve data</span>
         <a name="::result_debug(7)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;========== Get Captured Packets =========&#34;
	 <a name="::exSleep(2)"><a href="./sleep.tcl.html#::exSleep_248">::exSleep</a></a> 3
         set j 0
         foreach portId $portMonitorList {
           set rxTagValue [lindex $portTagMonitorList $j];
           if {$rxTagValue == &#34;&#34;} {
              set rxTagValue &#34;none&#34;
           }
           set numPacketReceived($portId) 0
           set numPacketReceivedByTag(${portId},$rxTagValue) 0
           set badPacketRxTagList &#34;&#34;
           set rawPortData [<a name="::GetCapturedFrames(1)"><a href="./ePTRx.tcl.html#::GetCapturedFrames_982">::GetCapturedFrames</a></a> $portId]
           set k 1
           <a name="::result_debug(8)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;===== Frames received on portId $portId:&#34;
           foreach frameReceived $rawPortData {
               <a name="::result_debug(9)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;Frame $k -- $frameReceived&#34;
               if {($checkMirroringTag == &#34;no&#34;) &amp;&amp; ($mirroringPort == $portId)} {
                  if { [<a name="::CompareFrame(1)"><a href="./Forwarding.tcl.html#::CompareFrame_540">::CompareFrame</a></a> $frameSent $frameReceived 0] } {
                   <a name="::result_debug(10)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;vvvvvvvv&#34;
                     incr numPacketReceived($portId) 1
                  }
               } else {
                  if { [<a name="::CompareFrame(2)"><a href="./Forwarding.tcl.html#::CompareFrame_540">::CompareFrame</a></a> $frameSent $frameReceived 0 ipIdle ipIdle $tag] &amp;&amp; [<a name="::CheckTag(1)"><a href="./Forwarding.tcl.html#::CheckTag_728">::CheckTag</a></a> $frameReceived [lindex $tag 1] ]} {
                  <a name="::result_debug(11)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;nnnnnnnnnn&#34;
                    incr numPacketReceived($portId) 1
                  }
               }
               incr k 
           }
           <a name="::result_debug(12)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;numPacketReceived($portId)= $numPacketReceived($portId)&#34; 
           incr j
        }
      }
      &#34;ip&#34; -
      &#34;icmp&#34; -
      &#34;udp&#34; -
      &#34;tcp&#34; -
      &#34;multicast&#34; {
         if { $ttlDecr == 0 &amp;&amp; !$tunnelMode} { <a name="::report_start_test(2)"><a href="./report.tcl.html#::report_start_test_79">::report_start_test</a></a> &#34;Packet $protocol L2 forwarding check on Txport $txPortId $comment&#34;
         } elseif { $ttlDecr == 0 &amp;&amp; $tunnelMode} { <a name="::report_start_test(3)"><a href="./report.tcl.html#::report_start_test_79">::report_start_test</a></a> &#34;Packet $protocol Tunnel forwarding check on Txport $txPortId $comment&#34;
         } elseif { $ttlDecr == 1} { <a name="::report_start_test(4)"><a href="./report.tcl.html#::report_start_test_79">::report_start_test</a></a> &#34;Packet $protocol L3 forwarding check on Txport $txPortId $comment&#34;
         } elseif { $ttlDecr == &#34;ignore&#34;} { <a name="::report_start_test(5)"><a href="./report.tcl.html#::report_start_test_79">::report_start_test</a></a> &#34;Packet $protocol forwarding check on Txport $txPortId $comment&#34;
         } else { <a name="::report_start_test(6)"><a href="./report.tcl.html#::report_start_test_79">::report_start_test</a></a> &#34;Packet $protocol forwarding check with TTL decr $ttlDecr on Txport $txPortId $comment&#34; }
         <span class="comment-line">#set to user input, will be overwritten when using learn_arp function</span>
         set destMacAddrTx $inDaMac

         if {$protocol == &#34;multicast&#34; } {
            if {[<a name="::GetVersion(1)"><a href="./misc.tcl.html#::GetVersion_303">::GetVersion</a></a> DUT1 4] &lt; &#34;6.2.1&#34; } {
              <span class="comment-line">#send an multicast ip packet, 1st packet is flooded on the vlan, just ignore</span>
              set frameSent [<a name="::SendIpFrame(1)"><a href="./ePTSendPacket.tcl.html#::SendIpFrame_587">::SendIpFrame</a></a> -txPortId $txPortId -protocol &#34;udp&#34; -dataPattern $pPattern \
                  -destMac $inDaMac -sourceIp $sIpAddr  -destIp $dIpAddr -ttl $ttl -udfEnable $udfEnable -udfInitval $udfInitval -udfOffset $udfOffset -udfCountertype $udfCountertype -udfContinuousCount $udfContinuousCount]
              <a name="::result_debug(13)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;1st Frame ($protocol) sent on portId $txPortId: (will be flooded)&#34;
              <a name="::result_debug(14)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;$frameSent&#34;
            }  
            set protocol &#34;udp&#34;
            set rxPortId 0
            set generateArpReq 0
         }
         set rxTag &#34;none&#34;
         if {[llength $tag] &gt; 1} { set rxTag [lindex $tag 1] }
         set txTag [lindex $tag 0]
         
         <span class="comment-line">#enable protocol server for the Rx port, to reponse to ARP request</span>
         if {$rxPortId &gt; 0} {
            <a name="::SaveAndSetProtocolServer(1)"><a href="./ixiaProtSrv.tcl.html#::SaveAndSetProtocolServer_1235">::SaveAndSetProtocolServer</a></a> $rxPortId $dIpAddr $dIpAddr ixInfo \
               -arpService true -tag $rxTag
            if {[lindex $tag 1]!=&#34;&#34;} {
               <a name="::SendArpFrame(3)"><a href="./ePTSendPacket.tcl.html#::SendArpFrame_959">::SendArpFrame</a></a> -txPortId $rxPortId -tag [lindex $tag 1] -sourceIp $dIpAddr
            } else {
               <span class="comment-line"># unreliable ixia protocol server ... send it anyway.</span>
               <a name="::SendArpFrame(4)"><a href="./ePTSendPacket.tcl.html#::SendArpFrame_959">::SendArpFrame</a></a> -txPortId $rxPortId -sourceIp $dIpAddr
            }
            if {[info exists GlobalPostLearnDelay] || $postLearnDelay != &#34;null&#34;} {
                set learnDelay &#34;&#34;
                if {$postLearnDelay != &#34;null&#34;} {
                    set learnDelay $postLearnDelay
                } elseif {[info exists GlobalPostLearnDelay] &amp;&amp; $GlobalPostLearnDelay != &#34;&#34; &amp;&amp; \
                    $GlobalPostLearnDelay &gt; 0} {
                    set learnDelay $GlobalPostLearnDelay
                } else {
                    set learnDelay 1;
                }
                <a name="::result_debug(15)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;\nSleep for $learnDelay seconds after the learning frame is sent&#34;
                <a name="::exSleep(3)"><a href="./sleep.tcl.html#::exSleep_248">::exSleep</a></a> $learnDelay
            }
         }
         <span class="comment-line">#request mac to send ip packet</span>
         if { $generateArpReq == 1} {
           <span class="comment-line">#this section is being implemented this way for the old gen BD</span>
           <span class="comment-line">#since it require 2 arp requests separated by about 1ms </span>
           <span class="comment-line">#in order for the ipf table to get updated</span>
           
           for {set index 0} {$index &lt; $numLearnFrame} { incr index } {
              <a name="::result_debug(16)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;--- Send Arp Request&#34;
              set destMacAddrTx [<a name="::SendArpRequest(1)"><a href="./ePTSendPacket.tcl.html#::SendArpRequest_1127">::SendArpRequest</a></a> $txPortId $sIpAddr $gIpAddr $txTag]
           }
           <span class="comment-line">#need to set this to some invalid mac, otherwise ixia send function won't return</span>
           if {$destMacAddrTx == &#34;NO_ARP_REPLY&#34; } {
               set destMacAddrTx &#34;00 00 00 00 00 00&#34;
           }
         }
         <span class="comment-line">#Send arp request from dPort for numIpFrame</span>
         if {($ipDaMode == &#34;ipIncrHost&#34;) &amp;&amp; \
             ($rxPortId != 0)} {
            set firstPart [string range $dIpAddr 0 [string last . $dIpAddr]]
            set lastPart [string range $dIpAddr [expr [string last . $dIpAddr] +1] [string length $dIpAddr]]
            if {$ipDaCount == &#34;&#34;} {
                set numArps $numIpFrame
            } else {
                set numArps $ipDaCount
            }
            for {set i 1} {$i &lt;= $numArps} {incr i} {
               set tmpIpAddr [format &#34;%s%s&#34; $firstPart $lastPart]
               <span class="comment-line">#sending arp frame</span>
               set frameSent [<a name="::SendArpFrame(5)"><a href="./ePTSendPacket.tcl.html#::SendArpFrame_959">::SendArpFrame</a></a> -txPortId $rxPortId -sourceIp $tmpIpAddr \
                              -destIp $gIpAddr]

               set lastPart [expr $lastPart + 1]
            }

            <span class="comment-line"># Set numIpFrame to be 1 as doesn't seem to send more, verify!!</span>
            <span class="comment-line">#set numIpFrame 1</span>
         }

         <span class="comment-line"># Send a single IP frame to seed the FDB, IP ARP, and IP FDB tables.</span>
         if {$rxPortId &gt; 0 &amp;&amp; $numIpFrame &gt; 1} {
             <a name="::result_debug(17)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;--- Send Learning Frame&#34;
             <a name="::SendIpFrame(2)"><a href="./ePTSendPacket.tcl.html#::SendIpFrame_587">::SendIpFrame</a></a> -txPortId $txPortId -sourceIp $sIpAddr \
                         -destMac $destMacAddrTx -gatewayIp $gIpAddr \
                         -rxPortId $rxPortId -destIp $dIpAddr
             if {[info exists GlobalPostLearnDelay] || $postLearnDelay != &#34;null&#34;} {
                 set learnDelay &#34;&#34;
                 if {$postLearnDelay != &#34;null&#34;} {
                     set learnDelay $postLearnDelay
                 } elseif {[info exists GlobalPostLearnDelay] &amp;&amp; $GlobalPostLearnDelay != &#34;&#34; &amp;&amp; \
                     $GlobalPostLearnDelay &gt; 0} {
                     set learnDelay $GlobalPostLearnDelay
                 } else {
                     set learnDelay 1;
                 }
                 <a name="::result_debug(18)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;\nSleep for $learnDelay seconds after the learning frame is sent&#34;
                 <a name="::exSleep(4)"><a href="./sleep.tcl.html#::exSleep_248">::exSleep</a></a> $learnDelay
             }
         }

         <span class="comment-line">#turn on capturing function on all the monitor ports</span>
         <a name="::StartPortsCapture(2)"><a href="./ePTRx.tcl.html#::StartPortsCapture_820">::StartPortsCapture</a></a> $portMonitorList
         
         <span class="comment-line">#send packets</span>
         <a name="::result_debug(19)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;\n==== Forwarding from portId $txPortId -- $numIpFrame ($protocol) Frame(s) ====&#34;
         set frameSent [<a name="::SendIpFrame(3)"><a href="./ePTSendPacket.tcl.html#::SendIpFrame_587">::SendIpFrame</a></a> -txPortId $txPortId -protocol $protocol -tag $txTag \
                        -frameType $frameType \
                        -destPort $dPort -sourcePort $sPort \
                        -ipDaMode $ipDaMode -ipDaCount $ipDaCount \
                        -ipSaMode $ipSaMode -ipSaCount $ipSaCount \
                        -TOS $TOS -userPriority $userPriority  -dontFrag $dontFrag -lastFrag $lastFrag \
                        -type $icmpType -code $icmpCode -ttl $ttl \
                        -tcpSynFlag $tcpSynFlag -tcpFinFlag $tcpFinFlag -tcpRstFlag $tcpRstFlag -tcpAckFlag $tcpAckFlag \
                 -tcpPushFlag $tcpPushFlag -tcpUrgFlag $tcpUrgFlag \
                        -dataPattern $pPattern -numFrames $numIpFrame -frameSize $frameSize -sourceMac $inSaMac \
                        -destMac $destMacAddrTx -sourceIp $sIpAddr  -destIp $dIpAddr -ipOptions $ipOptions -udfEnable $udfEnable -udfInitval $udfInitval -udfOffset $udfOffset -udfCountertype $udfCountertype -udfContinuousCount $udfContinuousCount]
         <a name="::result_debug(20)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;$frameSent&#34;
         set numExpectedFrame $numIpFrame
         <span class="comment-line">#retrieve data</span>
         <a name="::result_debug(21)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;========== Get Captured Packets =========&#34;
	 <a name="::exSleep(5)"><a href="./sleep.tcl.html#::exSleep_248">::exSleep</a></a> 3
         foreach portId $portMonitorList {
           set numPacketReceived($portId) 0
           set rawPortData [<a name="::GetCapturedFrames(2)"><a href="./ePTRx.tcl.html#::GetCapturedFrames_982">::GetCapturedFrames</a></a> $portId]
           set rxFrameCount 1
           <a name="::result_debug(22)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;===== Frames received on portId $portId:&#34;
           foreach frameReceived $rawPortData {
               <a name="::result_debug(23)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;Rx Frame $rxFrameCount : $frameReceived&#34;
               
               if { [<a name="::CompareFrame(3)"><a href="./Forwarding.tcl.html#::CompareFrame_540">::CompareFrame</a></a> $frameSent $frameReceived $ttlDecr $ipDaMode $ipSaMode $tag $tunnelMode $dontFrag] &amp;&amp; \
                    [<a name="::CheckTag(2)"><a href="./Forwarding.tcl.html#::CheckTag_728">::CheckTag</a></a> $frameReceived [lindex $tag 1] ] } {
                        incr numPacketReceived($portId) 1
               }
               incr rxFrameCount
           }
           <a name="::result_debug(24)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;numPacketReceived($portId)= $numPacketReceived($portId)&#34;
           if {$careTotalIp == &#34;yes&#34;} {incr totalIpPacketReceived $numPacketReceived($portId)}  
        }
        <span class="comment-line"># Restore the protocol server to its state before calling CheckForwarding.</span>
        if {$rxPortId &gt; 0} {
           <a name="::RestoreSavedProtocolServer(1)"><a href="./ixiaProtSrv.tcl.html#::RestoreSavedProtocolServer_1346">::RestoreSavedProtocolServer</a></a> ixInfo
        }

      }
      &#34;proxyArp&#34; {
         <a name="::report_start_test(7)"><a href="./report.tcl.html#::report_start_test_79">::report_start_test</a></a> &#34;Proxy-ARP forwarding check on Txport $txPortId $comment&#34;
         
         <span class="comment-line">#turn on capturing function on all the monitor ports</span>
         <a name="::StartPortsCapture(3)"><a href="./ePTRx.tcl.html#::StartPortsCapture_820">::StartPortsCapture</a></a> $portMonitorList
         
         <a name="::result_debug(25)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;Frame (arp) sent on portId $txPortId:&#34;
<span class="comment-line">#         result_debug &#34;$frameSent&#34;</span>
         
         <span class="comment-line">#sending arp frame</span>
         <span class="comment-line">#this section is being implemented this way for the old gen BD</span>
         <span class="comment-line">#since it require 2 arp requests separated by about 1ms </span>
         <span class="comment-line">#in order for the ipf table to get updated</span>
         for {set index 0} {$index &lt; $numLearnFrame} { incr index } {
             set frameSent [<a name="::SendArpFrame(6)"><a href="./ePTSendPacket.tcl.html#::SendArpFrame_959">::SendArpFrame</a></a> -txPortId $txPortId -sourceIp $sIpAddr \
                            -destIp $dIpAddr -tag $tag]
         }
         <span class="comment-line">#this is set to 1 for any numLearnFrame, since this sendArpFrame will</span>
         <span class="comment-line">#reset the port capturing, a feature in ixia sending function that should be removed</span>
         set numExpectedFrame $numLearnFrame
         <span class="comment-line">#retrieve data</span>
         foreach portId $portMonitorList {
            set numPacketReceived($portId) 0
            set rawPortData [<a name="::GetCapturedFrames(3)"><a href="./ePTRx.tcl.html#::GetCapturedFrames_982">::GetCapturedFrames</a></a> $portId]
            set sourceMac [<a name="::GetDUTMac(1)"><a href="./misc.tcl.html#::GetDUTMac_380">::GetDUTMac</a></a> &#34;DUT1&#34; &#34; &#34;]
            foreach frameReceived $rawPortData {
               <a name="::result_debug(26)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;Frames received on portId $portId:&#34;
               <a name="::result_debug(27)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;$frameReceived&#34;
               <a name="::result_debug(28)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;sourceMac:$sourceMac| sMACRecv:[<a name="::GetSourceMacAddress(2)"><a href="./MessageDecoding.tcl.html#::GetSourceMacAddress_40">::GetSourceMacAddress</a></a> $frameReceived]|&#34;
               if { $sourceMac == [<a name="::GetSourceMacAddress(3)"><a href="./MessageDecoding.tcl.html#::GetSourceMacAddress_40">::GetSourceMacAddress</a></a> $frameReceived] } {
                  <a name="::result_debug(29)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;sIPRecv: [<a name="::GetSourceIPAddress(1)"><a href="./MessageDecoding.tcl.html#::GetSourceIPAddress_411">::GetSourceIPAddress</a></a> $frameReceived] sIPSent: [<a name="::GetSourceIPAddress(2)"><a href="./MessageDecoding.tcl.html#::GetSourceIPAddress_411">::GetSourceIPAddress</a></a> $frameSent]&#34;
                  <a name="::result_debug(30)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;dIPRecv: [<a name="::GetDestIPAddress(1)"><a href="./MessageDecoding.tcl.html#::GetDestIPAddress_447">::GetDestIPAddress</a></a> $frameReceived] dIPSent: [<a name="::GetDestIPAddress(2)"><a href="./MessageDecoding.tcl.html#::GetDestIPAddress_447">::GetDestIPAddress</a></a> $frameSent]&#34;
                  if { [<a name="::GetMessageType(1)"><a href="./MessageDecoding.tcl.html#::GetMessageType_992">::GetMessageType</a></a> $frameReceived] == &#34;ARP_REQUEST&#34; } {
                     if { ([<a name="::GetSourceIPAddress(3)"><a href="./MessageDecoding.tcl.html#::GetSourceIPAddress_411">::GetSourceIPAddress</a></a> $frameReceived] == $gIpAddr) &amp;&amp; \
                          ([<a name="::GetTargetMacAddress(1)"><a href="./MessageDecoding.tcl.html#::GetTargetMacAddress_159">::GetTargetMacAddress</a></a> $frameReceived] == &#34;00 00 00 00 00 00&#34;) &amp;&amp; \
                           ([<a name="::GetDestIPAddress(3)"><a href="./MessageDecoding.tcl.html#::GetDestIPAddress_447">::GetDestIPAddress</a></a> $frameReceived] == [<a name="::GetDestIPAddress(4)"><a href="./MessageDecoding.tcl.html#::GetDestIPAddress_447">::GetDestIPAddress</a></a> $frameSent]) } {
                         incr numPacketReceived($portId) 1
                     }
                  }
               }
            }
            <a name="::result_debug(31)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;numPacketReceived($portId)= $numPacketReceived($portId)&#34; 
         }
      }
      default {
         <a name="::report_start_test(8)"><a href="./report.tcl.html#::report_start_test_79">::report_start_test</a></a> &#34;Unknown protocol $protocol $comment&#34;
         <a name="::result_error(2)"><a href="./lconsoles.tcl.html#::result_error_6">::result_error</a></a> &#34;Invalid protocol.&#34;
      }
   }

   <span class="comment-line">#now check received data against checkList to see if matched</span>
   <a name="::result_debug(32)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;\n ------ Check Forwarding Results ------&#34;;
   set testResult &#34;good&#34;
   foreach checkPort $checkPortList {
      set portId [lindex $checkPort 0]
      set portFlag [lindex $checkPort 1]
      set expectedRange &#34;exact&#34;
      set expectedTag &#34;none&#34;
      switch -- $portFlag \
         &#34;forwarded&#34; {
            if {[lindex $checkPort 2] == &#34;&#34;} {
              set expectedPacket $numExpectedFrame
            } else {  
              set expectedPacket [lindex $checkPort 2]
              if { [lindex $checkPort 3] != &#34;&#34;} { 
                 set expectedRange [lindex $checkPort 3] ;<span class="comment-line"># could be up or down</span>
              }
              if { [lindex $checkPort 4] != &#34;&#34;} { 
                 set expectedTag [lindex $checkPort 4] ;<span class="comment-line"># rx tag for this flow</span>
              }
            }   
      }  &#34;notForwarded&#34; {
            set expectedPacket 0
      }  default {
            set expectedPacket $portFlag
      }
                        
      switch -- $expectedRange {
         &#34;up&#34; {
            if {$expectedTag != &#34;none&#34; &amp;&amp; $numPacketReceivedByTag(${portId},$expectedTag) &gt;= $expectedPacket} {
               <a name="::result_debug(33)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;Forwarding on port $portId Tag $expectedTag checked Ok ($numPacketReceivedByTag(${portId},$expectedTag)). Was $portFlag&#34;
            } elseif { ($numPacketReceived($portId) &gt;= $expectedPacket) } {
               <a name="::result_debug(34)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;Forwarding on port $portId checked Ok ($numPacketReceived($portId)). Was $portFlag&#34;
            } else {
               if {$expectedTag != &#34;none&#34;} {
                  <a name="::result_error(3)"><a href="./lconsoles.tcl.html#::result_error_6">::result_error</a></a> &#34;Forwarding failed on port $portId : Tag= ${expectedTag}. rxPkts= $numPacketReceivedByTag(${portId},$expectedTag) BUT expected= $expectedPacket&#34;
               } else {
                  <a name="::result_error(4)"><a href="./lconsoles.tcl.html#::result_error_6">::result_error</a></a> &#34;Forwarding failed on port $portId : rxPkts= $numPacketReceived($portId) BUT expected= $expectedPacket&#34;
               }
               <a name="::result_debug(35)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;numPacketReceived= $numPacketReceived($portId) BUT expectedPackets= $expectedPacket&#34;
               set testResult &#34;bad&#34;
            }
         } 
         &#34;down&#34; {
            if {$expectedTag != &#34;none&#34; &amp;&amp; $numPacketReceivedByTag(${portId},$expectedTag) &lt;= $expectedPacket} {
               <a name="::result_debug(36)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;Forwarding on port $portId Tag $expectedTag checked Ok ($numPacketReceivedByTag(${portId},$expectedTag)). Was $portFlag&#34;
            } elseif { ($numPacketReceived($portId) &lt;= $expectedPacket) } {
               <a name="::result_debug(37)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;Forwarding on port $portId checked Ok ($numPacketReceived($portId)). Was $portFlag&#34;
            } else {
               if {$expectedTag != &#34;none&#34;} {
                  <a name="::result_error(5)"><a href="./lconsoles.tcl.html#::result_error_6">::result_error</a></a> &#34;Forwarding failed on port $portId : Tag= $expectedTag . rxPkts= $numPacketReceivedByTag(${portId},$expectedTag) BUT expected= $expectedPacket&#34;
               } else {
                  <a name="::result_error(6)"><a href="./lconsoles.tcl.html#::result_error_6">::result_error</a></a> &#34;Forwarding failed on port $portId : rxPkts= $numPacketReceived($portId) BUT expected= $expectedPacket&#34;
               }
               <a name="::result_debug(38)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;numPacketReceived= $numPacketReceived($portId) BUT expectedPackets= $expectedPacket&#34;
               set testResult &#34;bad&#34;
            }
         }
         &#34;exact&#34; -
         default {
           if {$expectedTag != &#34;none&#34; &amp;&amp; $numPacketReceivedByTag(${portId},$expectedTag) == $expectedPacket} {
              <a name="::result_debug(39)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;Forwarding on port $portId Tag $expectedTag checked Ok ($numPacketReceivedByTag(${portId},$expectedTag)). Was $portFlag&#34;
           } elseif { ($numPacketReceived($portId) == $expectedPacket) } {
              <a name="::result_debug(40)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;Forwarding on port $portId checked Ok ($numPacketReceived($portId)). Was $portFlag&#34;
           } else {
               if {$expectedTag != &#34;none&#34;} {
                  <a name="::result_error(7)"><a href="./lconsoles.tcl.html#::result_error_6">::result_error</a></a> &#34;Forwarding failed on port $portId : Tag= $expectedTag . rxPkts= $numPacketReceivedByTag(${portId},$expectedTag) BUT expected= $expectedPacket&#34;
               } else {
                  <a name="::result_error(8)"><a href="./lconsoles.tcl.html#::result_error_6">::result_error</a></a> &#34;Forwarding failed on port $portId : rxPkts= $numPacketReceived($portId) BUT expected= $expectedPacket&#34;
               }
              <a name="::result_debug(41)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;numPacketReceived= $numPacketReceived($portId) BUT expectedPackets= $expectedPacket&#34;
              set testResult &#34;bad&#34;
           }
         }
      }    
   }
   if {$careTotalIp == &#34;yes&#34;} {
     if {$totalIpPacketReceived == $numIpFrame } {
        <a name="::result_debug(42)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;Forwarding on total received IP packets checked Ok&#34;
     } else {
        <a name="::result_error(9)"><a href="./lconsoles.tcl.html#::result_error_6">::result_error</a></a> &#34;Forwarding failed on total received IP packets from all forwarded ports&#34;
        <a name="::result_debug(43)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;total no. Packet Received($totalIpPacketReceived) &lt;&gt; total no. IP packets sent($numIpFrame)&#34;
        set testResult &#34;bad&#34;        
     }            
   }
   if {$testResult == &#34;good&#34;} {
      <a name="::result_ok(1)"><a href="./lconsoles.tcl.html#::result_ok_9">::result_ok</a></a> &#34;Check data forwarding passed&#34;
      set rc 1
   } else {
      <a name="::result_error(10)"><a href="./lconsoles.tcl.html#::result_error_6">::result_error</a></a> &#34;Check data forwarding failed&#34;
      set rc 0
   }  
   <a name="::report_end_test(1)"><a href="./report.tcl.html#::report_end_test_122">::report_end_test</a></a>

   return $rc
}

<span class="comment-line">##################################################################    </span>
<span class="comment-line"># Description:</span>
<span class="comment-line">#     	This proc can be used to compare received frame and sent frame.</span>
<span class="comment-line">#  if ipDaMode or ipSaMode set to ipIncrHost, checks on dest/source IP</span>
<span class="comment-line">#  is/are ignored. </span>
<span class="comment-line">#		If ttlDecr = 0, L2 checking are performed, else L3's</span>
<span class="comment-line"># Input args: args</span>
<span class="comment-line"># Output args: return 0 if two frames are not matched, 1 if matched.</span>
<span class="comment-line"># Typical usage:</span>
<span class="comment-line">#  CompareFrame $frameSent $frameReceived $ttlDecr $ipDaMode $ipSaMode</span>
<span class="comment-line"># Category: VerifyTraffic</span>
<span class="comment-line">##################################################################</span>

<strong><a name="::::CompareFrame_540">proc <a href="Forwarding.tcl-annot.html#::::CompareFrame">::::CompareFrame</a></a></strong> {frameSent frameReceived ttlDecr {ipDaMode &#34;ipIdle&#34;} {ipSaMode &#34;ipIdle&#34;} {tag &#34;none&#34;} {tunnelMode &#34;0&#34;} {dontFrag &#34;true&#34;}} {

    set frameSizeSent [string length $frameSent]
    set frameSizeReceived [string length $frameReceived]
    <span class="comment-line">#for sure not the packet we are looking if length difference is greater than 0</span>
  if {[expr abs( $frameSizeSent - $frameSizeReceived ) ] &gt; 12 } {
       if {$dontFrag == &#34;false&#34;} {
              <a name="::result_debug(44)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;This is a jumbo frame case&#34;
              <a name="::result_debug(45)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;The difference in size is [expr abs($frameSizeSent - $frameSizeReceived)]&#34;           
       } else {
              return 0
       }
   }  
            
    set TTLSent [<a name="::GetTTL(1)"><a href="./MessageDecoding.tcl.html#::GetTTL_192">::GetTTL</a></a> $frameSent]
    set TTLReceived [<a name="::GetTTL(2)"><a href="./MessageDecoding.tcl.html#::GetTTL_192">::GetTTL</a></a> $frameReceived]
    set sourceMacRecv [<a name="::GetSourceMacAddress(4)"><a href="./MessageDecoding.tcl.html#::GetSourceMacAddress_40">::GetSourceMacAddress</a></a> $frameReceived]
    set destMacRecv [<a name="::GetDestMacAddress(1)"><a href="./MessageDecoding.tcl.html#::GetDestMacAddress_19">::GetDestMacAddress</a></a> $frameReceived]
    set typeSent [string range $frameSent 36 40]
    set typeReceived [string range $frameReceived 36 40]
    <a name="::result_debug(46)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;SourceMac: $sourceMacRecv DestMac: $destMacRecv&#34;
    if { $ttlDecr != &#34;0&#34; || $tunnelMode} {
        set sourceIpRecv [<a name="::GetSourceIPAddress(4)"><a href="./MessageDecoding.tcl.html#::GetSourceIPAddress_411">::GetSourceIPAddress</a></a> $frameReceived]
        set destIpRecv [<a name="::GetDestIPAddress(5)"><a href="./MessageDecoding.tcl.html#::GetDestIPAddress_447">::GetDestIPAddress</a></a> $frameReceived]
        <a name="::result_debug(47)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;SourceIp: $sourceIpRecv DestIp: $destIpRecv&#34;
    }
    set rxTagText &#34;&#34;
    set tagRecv &#34;none&#34;
    set txTagText &#34;&#34;
    set tagSent &#34;none&#34;
    if {$typeReceived == &#34;81 00&#34;} {
        set tagRecv [<a name="::GetTagId(1)"><a href="./MessageDecoding.tcl.html#::GetTagId_482">::GetTagId</a></a> $frameReceived]
        <a name="::result_debug(48)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;Tag: $tagRecv&#34;
        set rxTagText &#34;Tag $tagRecv Removed: &#34;
    }
    if {$typeSent == &#34;81 00&#34;} {
        set tagSent [<a name="::GetTagId(2)"><a href="./MessageDecoding.tcl.html#::GetTagId_482">::GetTagId</a></a> $frameSent]
        set txTagText &#34;Tag $tagSent Removed: &#34;
    }
    if { ($ipDaMode == &#34;ipIncrHost&#34;) } {
       set destIpRecv [<a name="::GetDestIPAddress(6)"><a href="./MessageDecoding.tcl.html#::GetDestIPAddress_447">::GetDestIPAddress</a></a> $frameSent]
       <a name="::result_debug(49)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;!!warning: check on received dest Ip is ignored: ipDaMode = ipIncrHost&#34;
    }
    if { ($ipSaMode == &#34;ipIncrHost&#34;) } {
       set sourceIpRecv [<a name="::GetSourceIPAddress(5)"><a href="./MessageDecoding.tcl.html#::GetSourceIPAddress_411">::GetSourceIPAddress</a></a> $frameSent]
       <a name="::result_debug(50)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;!!warning: check on received source Ip is ignored: ipSaMode = ipIncrHost&#34;
    }
    if { ($ipDaMode == &#34;ipIncrHost&#34;) || ($ipSaMode == &#34;ipIncrHost&#34;)} {
       set iPTotalLengthSent [<a name="::GetIpTotalLength(1)"><a href="./MessageDecoding.tcl.html#::GetIpTotalLength_380">::GetIpTotalLength</a></a> $frameSent]
       set iPTotalLengthRecv [<a name="::GetIpTotalLength(2)"><a href="./MessageDecoding.tcl.html#::GetIpTotalLength_380">::GetIpTotalLength</a></a> $frameReceived]
       set sPortSent [<a name="::GetIPSourcePort(1)"><a href="./MessageDecoding.tcl.html#::GetIPSourcePort_573">::GetIPSourcePort</a></a> $frameSent]
       set sPortRecv [<a name="::GetIPSourcePort(2)"><a href="./MessageDecoding.tcl.html#::GetIPSourcePort_573">::GetIPSourcePort</a></a> $frameReceived]
       set dPortSent [<a name="::GetIPDestPort(1)"><a href="./MessageDecoding.tcl.html#::GetIPDestPort_604">::GetIPDestPort</a></a> $frameSent]
       set dPortRecv [<a name="::GetIPDestPort(2)"><a href="./MessageDecoding.tcl.html#::GetIPDestPort_604">::GetIPDestPort</a></a> $frameReceived]
    }   

    <span class="comment-line">#L2 forwarding</span>
    if { $ttlDecr == &#34;0&#34; &amp;&amp; !$tunnelMode} {
       if { $typeSent == $typeReceived } {
          if {$typeSent != &#34;81 00&#34; || ([lindex $tag 0] == [lindex $tag 1])} {
             if { $frameSent == $frameReceived } {
                <a name="::result_debug(51)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;Data L2 check passed&#34;
                return 1
             } else { 
                <a name="::result_debug(52)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;Data L2 check failed&#34;
                return 0
             }             
          } else {
             <span class="comment-line"># Case where frames have different ingress and egress tags</span>
             set frameSizeSent [string length $frameSent]
             set frameSizeReceived [string length $frameReceived]
             set txEndIndex [expr $frameSizeSent - 12]
             set rxEndIndex [expr $frameSizeReceived - 12]
             set frameSent4Compare &#34;[string range $frameSent 0 34][string range $frameSent 47 $txEndIndex]&#34;
             set frameRecv4Compare &#34;[string range $frameReceived 0 34][string range $frameReceived 47 $rxEndIndex]&#34;
             <a name="::result_debug(53)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;Tags $tagSent Removed frameSent4Compare:|$frameSent4Compare|&#34;
             <a name="::result_debug(54)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;Tags $tagRecv Removed frameRecv4Compare:|$frameRecv4Compare|&#34;
             if { $frameSent4Compare == $frameRecv4Compare &amp;&amp; [<a name="::CheckTag(3)"><a href="./Forwarding.tcl.html#::CheckTag_728">::CheckTag</a></a> $frameReceived [lindex $tag 1] ]} {
                <a name="::result_debug(55)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;Data L2 and rxTag: [lindex $tag 1] check pass &#34;
                return 1
             } else { 
                <a name="::result_debug(56)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;Data L2 and rxTag: [lindex $tag 1]  check failed&#34;
                <a name="::result_debug(57)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;txTag: [lindex $tag 0] rxTag: [lindex $tag 1]&#34;
                return 0
             }
          }
       } else {
          if { $typeSent == &#34;81 00&#34; } {
             <span class="comment-line">#take everything except 4 bytes tagged and checksum</span>
             set endIndex [expr $frameSizeSent - 12]
             set frameSent4Compare &#34;[string range $frameSent 0 34][string range $frameSent 47 $endIndex]&#34;
             set frameRecv4Compare [string range $frameReceived 0 [expr $endIndex - 12]]
          } else {
             <span class="comment-line">#take everything except 4 bytes tagged and checksum</span>
             set endIndex [expr $frameSizeReceived - 12]
             set frameSent4Compare [string range $frameSent 0 [expr $endIndex - 12]]
             set frameRecv4Compare &#34;[string range $frameReceived 0 34][string range $frameReceived 47 $endIndex]&#34;
          }
          <a name="::result_debug(58)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;${txTagText}frameSent4Compare:|$frameSent4Compare|&#34;
          <a name="::result_debug(59)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;${rxTagText}frameRecv4Compare:|$frameRecv4Compare|&#34;
          if { $frameSent4Compare == $frameRecv4Compare } {
             <a name="::result_debug(60)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;Data L2 check pass&#34;
             return 1
          } else { 
             <a name="::result_debug(61)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;Data L2 check failed&#34;
             <a name="::result_debug(62)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;Sent:$typeSent&#34;
             <a name="::result_debug(63)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;Recv:$frameReceived&#34;
             return 0
          }
       }
    } else {    
        <span class="comment-line"># check ttl               </span>
        set RxTTL $TTLReceived               
        if { ($ttlDecr == &#34;ignore&#34;) || ($TTLSent == [incr TTLReceived $ttlDecr]) } {
            if {$ttlDecr != &#34;ignore&#34;} {
                <a name="::result_debug(64)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;TLL check Pass. TX TTL: $TTLSent RX TTL: [expr $TTLSent - $ttlDecr]&#34;
            }
            <span class="comment-line">#check source and dest ip address (if ipDaMOde is &#34;ipIncrHost&#34;, no check on dest ip)</span>
            if { ($sourceIpRecv == [<a name="::GetSourceIPAddress(6)"><a href="./MessageDecoding.tcl.html#::GetSourceIPAddress_411">::GetSourceIPAddress</a></a> $frameSent]) &amp;&amp; \
            ($destIpRecv == [<a name="::GetDestIPAddress(7)"><a href="./MessageDecoding.tcl.html#::GetDestIPAddress_447">::GetDestIPAddress</a></a> $frameSent]) } {
                <a name="::result_debug(65)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;Source and Dest IP check pass&#34;
                <span class="comment-line">#check data</span>
                if { ($ipDaMode == &#34;ipIncrHost&#34;) || ($ipSaMode == &#34;ipIncrHost&#34;) } {
                    <a name="::result_debug(66)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;iPTotalLengthSent:|$iPTotalLengthSent| ; iPTotalLengthRecv:|$iPTotalLengthRecv|&#34;
                    <a name="::result_debug(67)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;sPortSent:|$sPortSent| ; sPortRecv:|$sPortRecv|&#34;
                    <a name="::result_debug(68)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;dPortSent:|$dPortSent| ; dPortRecv:|$dPortRecv|&#34;           
                    if { ($iPTotalLengthSent == $iPTotalLengthRecv) &amp;&amp; \
                    ($sPortSent == $sPortRecv) &amp;&amp; \
                    ($dPortSent == $dPortRecv) } {
                        <a name="::result_debug(69)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;L3 data check pass(only check ipLength, sPort, dPort)&#34; 
                        return 1
                    } else {
                        <a name="::result_debug(70)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;L3 data check failed(only check ipLength, sPort, dPort)&#34; 
                        return 0
                    }
                }                
                if { $typeSent == $typeReceived } {
                    if { $typeSent == &#34;81 00&#34; } { 
                        set startIndex 114
                    } else { set startIndex 102 }
                    set endIndex [expr $frameSizeReceived - 12]
                    set dataSent4Compare [string range $frameSent $startIndex $endIndex]
                    set dataRecv4Compare [string range $frameReceived $startIndex $endIndex]
                } else {
                    if { $typeSent == &#34;81 00&#34; } {
                        <span class="comment-line">#take everything except 4 bytes tagged and checksum</span>
                        set endIndex [expr $frameSizeSent - 12]
                        set dataSent4Compare &#34;[string range $frameSent 114 $endIndex]&#34;
                        set dataRecv4Compare [string range $frameReceived 102 [expr $endIndex - 12]]
                    } else {
                        <span class="comment-line">#take everything except 4 bytes tagged and checksum</span>
                        set endIndex [expr $frameSizeReceived - 12]
                        set dataSent4Compare [string range $frameSent 102 [expr $endIndex - 12]]
                        set dataRecv4Compare &#34;[string range $frameReceived 114 $endIndex]&#34;
                    }
                }
                if { $dataSent4Compare == $dataRecv4Compare } {
                    <a name="::result_debug(71)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;${txTagText}dataSent4Compare:|$dataSent4Compare|&#34;
                    <a name="::result_debug(72)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;${rxTagText}dataRecv4Compare:|$dataRecv4Compare|&#34;
                    <a name="::result_debug(73)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;L3 data check pass&#34;
                    return 1
                } else { 
                    <a name="::result_debug(74)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;${txTagText}dataSent4Compare:|$dataSent4Compare|&#34;
                    <a name="::result_debug(75)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;${rxTagText}dataRecv4Compare:|$dataRecv4Compare|&#34;                    
                    <a name="::result_debug(76)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;L3 data check failed&#34;
                    return 0 
                }
            }
        } else {
            <a name="::result_debug(77)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;TLL check Fail. TX TTL: $TTLSent RX TTL: $RxTTL Want TTL: [expr $TTLSent - $ttlDecr]&#34;
            return 0
        }
    }
    return 0
} 

<span class="comment-line">##################################################################    </span>
<span class="comment-line"># Description:</span>
<span class="comment-line">#		This function checks the frame's tag to see if it matches</span>
<span class="comment-line">#	the expected tag.</span>
<span class="comment-line"># Input args:  Frame and tag id</span>
<span class="comment-line"># Output args: return 0 if  the tag of the frame is not expected.</span>
<span class="comment-line">#		       return 1 if the frame contains the expected Tag id.</span>
<span class="comment-line"># Typical usage:</span>
<span class="comment-line">#  CheckTag $frameReceived  $tag</span>
<span class="comment-line"># Category: VerifyTraffic</span>
<span class="comment-line">##################################################################</span>

<strong><a name="::::CheckTag_728">proc <a href="Forwarding.tcl-annot.html#::::CheckTag">::::CheckTag</a></a></strong> {frameReceived tag} {

  set type [string range $frameReceived 36 40]
   if {$tag == &#34;&#34; } {
      return 1
   } elseif {$tag != &#34;none&#34; } {
     switch -- $type \
       &#34;81 00&#34; {
       set tagRecv [<a name="::GetTagId(3)"><a href="./MessageDecoding.tcl.html#::GetTagId_482">::GetTagId</a></a> $frameReceived]
       if {$tag == $tagRecv} {
         <a name="::result_debug(78)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;Tag ($tag) check pass. Got tag $tagRecv&#34;
         return 1
       } else {
         <a name="::result_debug(79)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;Tag ($tag) check fail. Got tag $tagRecv&#34;
         return 0
       }
     } default {
       <a name="::result_debug(80)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;Packet Not Tagged: $type. Wanted Tag ($tag)&#34;
       return 0
     }
   } else {
      if {$type != &#34;81 00&#34;} {
         <a name="::result_debug(81)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;Untagged packet check pass&#34;
         return 1
      } else {
         set tagRecv [<a name="::GetTagId(4)"><a href="./MessageDecoding.tcl.html#::GetTagId_482">::GetTagId</a></a> $frameReceived]
         <a name="::result_debug(82)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;Untagged packet check fail. Got tag $tagRecv&#34;
         return 0
      }
   }
}

<span class="comment-line">##################################################################</span>
<span class="comment-line"># Procedure Name: GetSwHwTxSpeed </span>
<span class="comment-line">#</span>
<span class="comment-line"># Description: Returns either the SW or HW rate or percentage for</span>
<span class="comment-line">#      traffic to be passed between a list of port IDs.  If any</span>
<span class="comment-line">#      of the portIDs requires SW forwarding, that is the rate</span>
<span class="comment-line">#      that will be used.</span>
<span class="comment-line">#</span>
<span class="comment-line">#  NOTE: !!! GetPortIdInfoStd Must have been run prior to this !!!</span>
<span class="comment-line">#</span>
<span class="comment-line"># Input args: portIDList &#34;1 2 3 4&#34; (&#34;1 2&#34; by default)</span>
<span class="comment-line">#             type percentage|rate (percentage by default)</span>
<span class="comment-line"># Output args: none</span>
<span class="comment-line"># Return value: txPerc or Rate for sw if there are any sw ports</span>
<span class="comment-line"># Typical usage:</span>
<span class="comment-line">#       GetSwHwTxSpeed &#34;1 2&#34; rate;</span>
<span class="comment-line"># Category: Utility</span>
<span class="comment-line">##################################################################</span>
<strong><a name="::::GetSwHwTxSpeed_778">proc <a href="Forwarding.tcl-annot.html#::::GetSwHwTxSpeed">::::GetSwHwTxSpeed</a></a></strong> {portIDList &#34;1 2&#34; type &#34;percentage&#34;} {
global PortID_Info

if {$type != &#34;percentage&#34; &amp;&amp; $type != &#34;rate&#34;} {
   <a name="::result_debug(83)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;!!!!! ERROR BAD TYPE PASSED IN TO &#34;
} elseif {$type == percentage} {
   set typeText txSwHwPerc
   set rValue 100
} else {
   set typeText txSwHwRate
   set rValue 148000
}
foreach pID $portIDList {
   if {$PortID_Info($pID,txPath) == sw} {
      return $PortID_Info($pID,$typeText)
   }
}
return $rValue

}
</pre>
<hr>
<div class="index-selector">
	<a href="index_main.html#byfilename">file name</a> 
 | 
	<a href="index_main.html#byprocname">procedure name</a> 
 | 
	<a href="index_main.html#bycall">procedure call</a> 
 | 
	<a href="index_annot_full.html">annotation</a> 

<br>
<cite>File generated 2018-06-14 at 17:09.</cite>
</div>

</body>
</html>
