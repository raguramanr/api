<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                       "http://www.w3.org/TR/html4/transitional.dtd">
<!-- Generated by TclDoc @@VERSION@@ -->
<html>
<head>
  <title>autolock.tcl</title>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <link rel="stylesheet" type="text/css" href="default.css">
</head>
<body class="src-html">
<div class="index-selector">
<!-- index for tcl source files -->
	Index by: 
	<a href="index_main.html#autolock.tcl">file name</a> | 
	<a href="index_main.html#byprocname">procedure name</a> | 
	<a href="index_main.html#bycall">procedure call</a> | 
	<a href="index_annot_full.html">annotation</a>

</div>
<hr>

<p><strong>autolock.tcl</strong>&nbsp;&nbsp;<span class="filetype-link">(<a href="autolock.tcl-annot.html">annotations</a> | <a href="autolock.tcl.txt">original source</a>)</span>
</p>
<pre class="src-code">

<span class="comment-line">################################################################## </span>
<span class="comment-line"># Procedure Name: check_auto_lock</span>
<span class="comment-line">#   </span>
<span class="comment-line"># Description:  Verify the contents of the autolock file.</span>
<span class="comment-line">#               Linux only</span>
<span class="comment-line">#     </span>
<span class="comment-line">#</span>
<span class="comment-line"># Input args: none</span>
<span class="comment-line"># Output args: none</span>
<span class="comment-line"># Typical usage: release_auto_lock</span>
<span class="comment-line"># </span>
<span class="comment-line">#</span>
<span class="comment-line"># Category Types (Setup,GetSwitchInfo,SendTraffic,CaptureTraffic,VerifySwitchOutput</span>
<span class="comment-line">#                          VerifyTraffic)</span>
<span class="comment-line"># Category: Setup</span>
<span class="comment-line">##################################################################</span>
<strong><a name="::::check_auto_lock_18">proc <a href="autolock.tcl-annot.html#::::check_auto_lock">::::check_auto_lock</a></a></strong> {} {
	global tcl_platform

	if {$tcl_platform(platform) == &#34;windows&#34;} {
		return 0
	}

	set pid 0
	
	if [file exists /tmp/sqa_automation_lock] {
		set fid [open /tmp/sqa_automation_lock &#34;r&#34;]
		set pid [read $fid]
		close $fid
		if {![file exists &#34;/proc/$pid&#34;]} {
			return 0
		}
	}

	return $pid
}

<span class="comment-line">################################################################## </span>
<span class="comment-line"># Procedure Name: grab_auto_lock</span>
<span class="comment-line">#   </span>
<span class="comment-line"># Description:  Set file locks at the beginning of an automation module.</span>
<span class="comment-line">#               Linux only</span>
<span class="comment-line">#     </span>
<span class="comment-line">#</span>
<span class="comment-line"># Input args: none</span>
<span class="comment-line"># Output args: none</span>
<span class="comment-line"># Typical usage: release_auto_lock</span>
<span class="comment-line"># </span>
<span class="comment-line">#</span>
<span class="comment-line"># Category Types (Setup,GetSwitchInfo,SendTraffic,CaptureTraffic,VerifySwitchOutput</span>
<span class="comment-line">#                          VerifyTraffic)</span>
<span class="comment-line"># Category: Setup</span>
<span class="comment-line">##################################################################</span>
<strong><a name="::::grab_auto_lock_55">proc <a href="autolock.tcl-annot.html#::::grab_auto_lock">::::grab_auto_lock</a></a></strong> {} {
	global tcl_platform

	if {$tcl_platform(platform) == &#34;windows&#34;} {
		return
	}

	set fid [open /tmp/sqa_automation_lock &#34;w&#34;]
	puts -nonewline $fid [pid]
	close $fid
	file attributes /tmp/sqa_automation_lock -permissions 0666
}

<span class="comment-line">################################################################## </span>
<span class="comment-line"># Procedure Name: release_auto_lock</span>
<span class="comment-line">#   </span>
<span class="comment-line"># Description:  Release file locks at the end of an automation module.</span>
<span class="comment-line">#               Linux only</span>
<span class="comment-line">#     </span>
<span class="comment-line">#</span>
<span class="comment-line"># Input args: none</span>
<span class="comment-line"># Output args: none</span>
<span class="comment-line"># Typical usage: release_auto_lock</span>
<span class="comment-line"># </span>
<span class="comment-line">#</span>
<span class="comment-line"># Category Types (Setup,GetSwitchInfo,SendTraffic,CaptureTraffic,VerifySwitchOutput</span>
<span class="comment-line">#                          VerifyTraffic)</span>
<span class="comment-line"># Category: Setup</span>
<span class="comment-line">##################################################################</span>
<strong><a name="::::release_auto_lock_84">proc <a href="autolock.tcl-annot.html#::::release_auto_lock">::::release_auto_lock</a></a></strong> {} {
	global tcl_platform

	if {$tcl_platform(platform) == &#34;windows&#34;} {
		return
	}

	if [file exists /tmp/sqa_automation_lock] {
		file delete /tmp/sqa_automation_lock
	}
}
<span class="comment-line">################################################################## </span>
<span class="comment-line"># Procedure Name: acquire_lock</span>
<span class="comment-line">#   </span>
<span class="comment-line"># Description:  Create a lockid.  If the lockid is already created</span>
<span class="comment-line">#               return 0</span>
<span class="comment-line">#</span>
<span class="comment-line"># Input args: none</span>
<span class="comment-line"># Output args: none</span>
<span class="comment-line"># Typical usage: if [acquire_lock 231] </span>
<span class="comment-line"># </span>
<span class="comment-line"># Category Types (Setup,GetSwitchInfo,SendTraffic,CaptureTraffic,VerifySwitchOutput</span>
<span class="comment-line">#                          VerifyTraffic)</span>
<span class="comment-line"># Category: Setup</span>
<span class="comment-line">##################################################################</span>
<strong><a name="::::acquire_lock_109">proc <a href="autolock.tcl-annot.html#::::acquire_lock">::::acquire_lock</a></a></strong> {LOCKID} {
    
    global LOCK_SOCKET
    
    set PORT [<a name="::_lockPortMap(1)"><a href="./autolock.tcl.html#::_lockPortMap_190">::_lockPortMap</a></a> &#34;$LOCKID&#34;]
    
    <span class="comment-line"># 'socket already in use' error will be our lock detection mechanism</span>
    if { [catch {socket -server _dummy_accept $PORT} SOCKET] } {
        puts &#34;Could not aquire lock port $PORT Socket $SOCKET lockID $LOCKID&#34;
        return 0
    }
    puts &#34;\n~~~~~~~~~~~\n~~~~~~~~~~~\n~~~~~~~~~~~\n\
          Successfully Got a SOCKET $SOCKET \n\
          ~~~~~~~~~~~\n~~~~~~~~~~~\n~~~~~~~~~~~&#34; 
    set LOCK_SOCKET(&#34;$LOCKID&#34;) &#34;$SOCKET&#34;
    return 1
}

<span class="comment-line">################################################################## </span>
<span class="comment-line"># Procedure Name: release_lock</span>
<span class="comment-line">#   </span>
<span class="comment-line"># Description:  Delete a lockid.  If it fails</span>
<span class="comment-line">#               return 0</span>
<span class="comment-line">#   Release a lock (assumes you actually hold the lock):</span>
<span class="comment-line"># Input args: none</span>
<span class="comment-line"># Output args: none</span>
<span class="comment-line"># Typical usage: if [release_lock 231] </span>
<span class="comment-line"># </span>
<span class="comment-line"># Category Types (Setup,GetSwitchInfo,SendTraffic,CaptureTraffic,VerifySwitchOutput</span>
<span class="comment-line">#                          VerifyTraffic)</span>
<span class="comment-line"># Category: Setup</span>
<span class="comment-line">##################################################################</span>
<strong><a name="::::release_lock_141">proc <a href="autolock.tcl-annot.html#::::release_lock">::::release_lock</a></a></strong> {LOCKID} {
    global LOCK_SOCKET
    if { ($LOCKID != &#34;null&#34;) &amp;&amp; [catch {close $LOCK_SOCKET(&#34;$LOCKID&#34;)} ERRORMSG] } {
        puts &#34;Error '$ERRORMSG' on closing socket for lock '$LOCKID'&#34;
        return 0
    } elseif {$LOCKID != &#34;null&#34;} {
        puts &#34;\n~~~~~~~~~~~\n~~~~~~~~~~~\n~~~~~~~~~~~\n\
          Successfully Released SOCKET $LOCK_SOCKET(&#34;$LOCKID&#34;) with LOCKID $LOCKID\n\
          ~~~~~~~~~~~\n~~~~~~~~~~~\n~~~~~~~~~~~&#34;
        unset LOCK_SOCKET(&#34;$LOCKID&#34;)
        return 1
    } else {
        return 1        
    }
}
<span class="comment-line">##################################################################</span>
<span class="comment-line">#  Procedure Name: verify_release_lock</span>
<span class="comment-line">#  - Check to see if this release lock worked</span>
<span class="comment-line">#</span>
<span class="comment-line"># Input args: list of partner cfgs</span>
<span class="comment-line"># Output args: none</span>
<span class="comment-line"># Typical usage:</span>
<span class="comment-line">#           verify_release_lock LOCKID</span>
<span class="comment-line"># Category: Setup</span>
<span class="comment-line">##################################################################</span>
<strong><a name="::::verify_release_lock_166">proc <a href="autolock.tcl-annot.html#::::verify_release_lock">::::verify_release_lock</a></a></strong> {{LOCKID}} {
    global LOCK_SOCKET

    set nsLine [catch {exec netstat -an | egrep -e &#34;$LOCKID&#34; | grep -v grep} psout]
    if {[regexp -nocase &#34;tcp&#34; [lindex $psout 0]]} {
        puts &#34;\n!!!!!!!!\n!!!!!!!!!\n THE LOCK IS STILL IN PLACE FOR ID $LOCKID\n!!!!!!!!\n!!!!!!!!!&#34;
        return 0;
    }
    return 1;
}
<span class="comment-line">################################################################## </span>
<span class="comment-line"># Procedure Name: _lockPortMap</span>
<span class="comment-line">#   </span>
<span class="comment-line"># Description:  </span>
<span class="comment-line">#   #Map LOCKID to an O/S socket:</span>
<span class="comment-line">#</span>
<span class="comment-line"># Input args: none</span>
<span class="comment-line"># Output args: none</span>
<span class="comment-line"># Typical usage:  </span>
<span class="comment-line"># </span>
<span class="comment-line"># Category Types (Setup,GetSwitchInfo,SendTraffic,CaptureTraffic,VerifySwitchOutput</span>
<span class="comment-line">#                          VerifyTraffic)</span>
<span class="comment-line"># Category: Internal</span>
<span class="comment-line">##################################################################</span>
<strong><a name="::::_lockPortMap_190">proc <a href="autolock.tcl-annot.html#::::_lockPortMap">::::_lockPortMap</a></a></strong> {LOCKID} {
    <span class="comment-line"># calculate our 'unique' port number using a hash function.</span>
    <span class="comment-line"># this mapping function comes from dr. KNUTH's art of programming volume 3.</span>
    set LEN [string length $LOCKID]
    set HASH $LEN
    
    for {set IDX 0} {$IDX &lt; $LEN} {incr IDX} {
        scan [string index &#34;$LOCKID&#34; $IDX] &#34;%c&#34; ASC
        set HASH [expr (($HASH&lt;&lt;5)^($HASH&gt;&gt;27))^$ASC];
    }
    <span class="comment-line"># always use a prime for remainder</span>
    <span class="comment-line"># note that the prime number used here will basicly determine the maximum</span>
    <span class="comment-line"># number of simultaneous locks</span>
    return [expr (65535 - ($HASH % 101))]
}

<span class="comment-line">################################################################## </span>
<span class="comment-line"># Procedure Name: _dummy_accept</span>
<span class="comment-line">#   </span>
<span class="comment-line"># Description:  </span>
<span class="comment-line"># Server call-back function (that does nothing at all):</span>
<span class="comment-line">#</span>
<span class="comment-line"># Input args: none</span>
<span class="comment-line"># Output args: none</span>
<span class="comment-line"># Typical usage:  </span>
<span class="comment-line"># </span>
<span class="comment-line"># Category Types (Setup,GetSwitchInfo,SendTraffic,CaptureTraffic,VerifySwitchOutput</span>
<span class="comment-line">#                          VerifyTraffic)</span>
<span class="comment-line"># Category: Internal</span>
<span class="comment-line">##################################################################</span>
<strong><a name="::::_dummy_accept_220">proc <a href="autolock.tcl-annot.html#::::_dummy_accept">::::_dummy_accept</a></a></strong> {newsock addr port} {
}
</pre>
<hr>
<div class="index-selector">
	<a href="index_main.html#byfilename">file name</a> 
 | 
	<a href="index_main.html#byprocname">procedure name</a> 
 | 
	<a href="index_main.html#bycall">procedure call</a> 
 | 
	<a href="index_annot_full.html">annotation</a> 

<br>
<cite>File generated 2018-06-14 at 17:09.</cite>
</div>

</body>
</html>
