<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                       "http://www.w3.org/TR/html4/transitional.dtd">
<!-- Generated by TclDoc @@VERSION@@ -->
<html>
<head>
  <title>ssh_scpLib.tcl</title>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <link rel="stylesheet" type="text/css" href="default.css">
</head>
<body class="src-html">
<div class="index-selector">
<!-- index for tcl source files -->
	Index by: 
	<a href="index_main.html#ssh_scpLib.tcl">file name</a> | 
	<a href="index_main.html#byprocname">procedure name</a> | 
	<a href="index_main.html#bycall">procedure call</a> | 
	<a href="index_annot_full.html">annotation</a>

</div>
<hr>

<p><strong>ssh_scpLib.tcl</strong>&nbsp;&nbsp;<span class="filetype-link">(<a href="ssh_scpLib.tcl-annot.html">annotations</a> | <a href="ssh_scpLib.tcl.txt">original source</a>)</span>
</p>
<pre class="src-code">

<span class="comment-line"># abortIfSshModuleError are implemented as script</span>
<span class="comment-line"># rather than proc because return needs to be eval at the caller's scope</span>
<span class="comment-line"># usage:</span>
<span class="comment-line">#  eval skipTestIfSshNotLoaded</span>
set abortIfSshModuleError {
   global AbortSSH_SCP
   global DUT1_CONNECT
   global DUTs_info
   global whichDutNow
set AbortSSH_SCP 1
   <a name="::Login(1)"><a href="./login.tcl.html#::Login_24">::Login</a></a> $DUT1_CONNECT
   if {$AbortSSH_SCP == 1 } {
      <span class="comment-line">#We already try to load and enable ssh unsuccessfully. Abort</span>
      <a name="::report_start_test(1)"><a href="./report.tcl.html#::report_start_test_79">::report_start_test</a></a> &#34;test aborted&#34;
      <a name="::result_error(1)"><a href="./lconsoles.tcl.html#::result_error_6">::result_error</a></a> &#34;test aborted&#34;
      <a name="::report_end_test(1)"><a href="./report.tcl.html#::report_end_test_122">::report_end_test</a></a>
      <a name="::close_result_file(1)"><a href="./result.tcl.html#::close_result_file_363">::close_result_file</a></a>
      <a name="::report_end_test(2)"><a href="./report.tcl.html#::report_end_test_122">::report_end_test</a></a>
      return
   } 
<span class="comment-line">#   set output [SendACmd &#34;show management&#34;]</span>
    set shMgmtList &#34;&#34;
    lappend shMgmtList &#34;{Key valid} exist&#34;
    if {[regexp -nocase &#34;error&#34; [<a name="::CheckKeyValue(1)"><a href="./OptionCheck.tcl.html#::CheckKeyValue_47">::CheckKeyValue</a></a> &#34;show management&#34; $shMgmtList -reportResults 0]]} {
      <span class="comment-line">#if module not downloaded try to download it</span>
      set output [<a name="::SendACmd(1)"><a href="./SendSwCmd.tcl.html#::SendACmd_157">::SendACmd</a></a> &#34;show version image $DUTs_info(DUT$whichDutNow,imageSel)&#34;]
      if ![regexp {([^ ]+ssh[^ ]+)} $output] {
         <a name="::downloadSshModule(1)"><a href="./ssh_scpLib.tcl.html#::downloadSshModule_477">::downloadSshModule</a></a>
      }
      set version $DUTs_info(DUT$whichDutNow,version)
      if {$version&gt;=&#34;11.2.0.18&#34;} {
         <a name="::SendACmd(2)"><a href="./SendSwCmd.tcl.html#::SendACmd_157">::SendACmd</a></a> &#34;start process thttpd&#34;
         <a name="::SendACmd(3)"><a href="./SendSwCmd.tcl.html#::SendACmd_157">::SendACmd</a></a> &#34;start process snmpmaster&#34;
      }
      <a name="::SendACmd(4)"><a href="./SendSwCmd.tcl.html#::SendACmd_157">::SendACmd</a></a> &#34;start process exsshd&#34;
      <a name="::exSleep(1)"><a href="./sleep.tcl.html#::exSleep_248">::exSleep</a></a> 5
      <span class="comment-line">#if ssh not enabled. enable it.</span>
      if ![<a name="::enableSsh(1)"><a href="./ssh_scpLib.tcl.html#::enableSsh_74">::enableSsh</a></a>] {
         set AbortSSH_SCP 1
         <a name="::report_start_test(2)"><a href="./report.tcl.html#::report_start_test_79">::report_start_test</a></a> &#34;test aborted&#34;
         <a name="::result_error(2)"><a href="./lconsoles.tcl.html#::result_error_6">::result_error</a></a> &#34;test aborted&#34;
         <a name="::report_end_test(3)"><a href="./report.tcl.html#::report_end_test_122">::report_end_test</a></a>
         <a name="::close_result_file(2)"><a href="./result.tcl.html#::close_result_file_363">::close_result_file</a></a>
         <a name="::report_end_test(4)"><a href="./report.tcl.html#::report_end_test_122">::report_end_test</a></a>
         return
      } 
      <span class="comment-line">#double check the key is now valid</span>
<span class="comment-line">#      set output [SendACmd &#34;show management&#34;]</span>
      set shMgmtList &#34;&#34;
      lappend shMgmtList &#34;{Key valid} exist&#34;
      if {[regexp -nocase &#34;error&#34; [<a name="::CheckKeyValue(2)"><a href="./OptionCheck.tcl.html#::CheckKeyValue_47">::CheckKeyValue</a></a> &#34;show management&#34; $shMgmtList -reportResults 0]]} {
         set AbortSSH_SCP 1
         <a name="::report_start_test(3)"><a href="./report.tcl.html#::report_start_test_79">::report_start_test</a></a> &#34;error enabling ssh, test aborted&#34;
         <a name="::result_error(3)"><a href="./lconsoles.tcl.html#::result_error_6">::result_error</a></a> &#34;error enabling ssh, test aborted&#34;
         <a name="::report_end_test(5)"><a href="./report.tcl.html#::report_end_test_122">::report_end_test</a></a>
         <a name="::close_result_file(3)"><a href="./result.tcl.html#::close_result_file_363">::close_result_file</a></a>
         <a name="::report_end_test(6)"><a href="./report.tcl.html#::report_end_test_122">::report_end_test</a></a>
         return
      }
   }
}
<span class="comment-line">##################################################################</span>
<span class="comment-line"># Procedure Name: enableSsh</span>
<span class="comment-line"># Description:</span>
<span class="comment-line">#       enable ssh on the current DUT</span>
<span class="comment-line"># Input args:  command can be &#34;enable ssh&#34; or &#34;config ssh&#34; etc.</span>
<span class="comment-line"># Output args: return 0 if failed, 1 if success</span>
<span class="comment-line"># Typical usage:</span>
<span class="comment-line">#       enableSsh</span>
<span class="comment-line">#       enableSsh &#34;config ssh key&#34;</span>
<span class="comment-line"># Category: SSH_SCP</span>
<span class="comment-line">##################################################################</span>
<strong><a name="::::enableSsh_74">proc <a href="ssh_scpLib.tcl-annot.html#::::enableSsh">::::enableSsh</a></a></strong> { {command &#34;enable ssh&#34;} } {
   global DUTs_info
   global whichDutNow
   global DUT${whichDutNow}_IP;
   global connectionTimeout

   <a name="::ConfigGatewayNetwork(1)"><a href="./SendSwCmd.tcl.html#::ConfigGatewayNetwork_2110">::ConfigGatewayNetwork</a></a>
   set tm1 [clock seconds]
   set origCTimeout $connectionTimeout
   set extraCTimeout 1200
   set connectionTimeout $extraCTimeout
   <a name="::SendACmd(5)"><a href="./SendSwCmd.tcl.html#::SendACmd_157">::SendACmd</a></a> &#34;configure sys-recovery-level all&#34;
   if {[catch {<a name="::SendACmd(6)"><a href="./SendSwCmd.tcl.html#::SendACmd_157">::SendACmd</a></a> $command} reason]} {
     <a name="::result_error(4)"><a href="./lconsoles.tcl.html#::result_error_6">::result_error</a></a> &#34;$command failed: $reason&#34;
   }
   set connectionTimeout $origCTimeout 
   set tm2 [clock seconds]
   set tmDelta [expr $tm2 - $tm1]
   <a name="::result_debug(1)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;it took $tmDelta seconds&#34;
   if {$tmDelta &gt; [expr $extraCTimeout - 50]} {
     <a name="::result_debug(2)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;enableSsh in a loop&#34;
     set ipAddr [set DUT${whichDutNow}_IP]
     <a name="::Login(2)"><a href="./login.tcl.html#::Login_24">::Login</a></a> $ipAddr
     <a name="::EnableDebugMode(1)"><a href="./misc.tcl.html#::EnableDebugMode_2430">::EnableDebugMode</a></a>
     set exsshdProcess &#34;&#34;
     lappend exsshdProcess &#34;root -1&#34;
     set pidList [<a name="::GetKeyValue(1)"><a href="./OptionCheck.tcl.html#::GetKeyValue_438">::GetKeyValue</a></a> &#34;!ps -ef | grep exsshd&#34; $exsshdProcess]
     set pidListLn [llength $pidList]
     if {$pidListLn &gt; 2} {
       set lnWant [expr $pidListLn - 3]
       set pidList [lrange $pidList 0 $lnWant]
       <a name="::result_debug(3)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;enableSsh pidList $pidList&#34;
       <a name="::result_debug(4)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;dumping exsshd cores&#34;
       <a name="::SendACmd(7)"><a href="./SendSwCmd.tcl.html#::SendACmd_157">::SendACmd</a></a> &#34;!kill -11 $pidList\r&#34;
       <a name="::exSleep(2)"><a href="./sleep.tcl.html#::exSleep_248">::exSleep</a></a> 120
       <a name="::Login(3)"><a href="./login.tcl.html#::Login_24">::Login</a></a> $DUTs_info(DUT$whichDutNow,connect)
       <a name="::SendACmd(8)"><a href="./SendSwCmd.tcl.html#::SendACmd_157">::SendACmd</a></a> &#34;start process exsshd&#34;
       <a name="::ConfigGatewayNetwork(2)"><a href="./SendSwCmd.tcl.html#::ConfigGatewayNetwork_2110">::ConfigGatewayNetwork</a></a>
     }
     <a name="::Login(4)"><a href="./login.tcl.html#::Login_24">::Login</a></a> $DUTs_info(DUT$whichDutNow,connect)
     unset exsshdProcess
     return 0
   }
   return 1
}

<span class="comment-line">##################################################################</span>
<span class="comment-line"># Procedure Name: checkScpGet</span>
<span class="comment-line"># Description:</span>
<span class="comment-line">#       verify scp of file from DUT to the linux machine. </span>
<span class="comment-line">#       the file copied to the linux machine will be under a different name</span>
<span class="comment-line"># Input args:  user       ssh user name</span>
<span class="comment-line">#              password   ssh password</span>
<span class="comment-line">#              dutIp      IP of the DUT</span>
<span class="comment-line">#              dutFileName full path of file at the DUT</span>
<span class="comment-line"># Output args: return the filename of the file copied in the linux machine</span>
<span class="comment-line"># Typical usage:</span>
<span class="comment-line">#       checkScpGet test123 test123 10.212.37.137 /config/primary.cfg</span>
<span class="comment-line"># Category: SSH_SCP</span>
<span class="comment-line">##################################################################</span>
<strong><a name="::::checkScpGet_134">proc <a href="ssh_scpLib.tcl-annot.html#::::checkScpGet">::::checkScpGet</a></a></strong> { user password dutIp dutFileName } {
   global SSHClient
   global SSHUser
   global SSHPassword


   <a name="::report_start_test(4)"><a href="./report.tcl.html#::report_start_test_79">::report_start_test</a></a> &#34;scp2 file $dutFileName from $dutIp&#34;
   set linuxFileName &#34;/tmp/[<a name="::uniqueName(1)"><a href="./LocateImage.tcl.html#::uniqueName_431">::uniqueName</a></a> $dutFileName]&#34;

   <a name="::login_linux(1)"><a href="./linux.tcl.html#::login_linux_16">::login_linux</a></a> $SSHClient $SSHUser $SSHPassword $SSHPassword
   exp_send \
      &#34;/usr/local/bin/scp2 $user@$dutIp:$dutFileName $linuxFileName\r&#34;
   <span class="comment-line">#there could be a few yes/no prompt before password prompt, depends </span>
   <span class="comment-line">#whether the client has the correct public key</span>
   set passwordPromptSeen 0
   for {set try 1} {$try &lt;= 5} { incr try } {
      expect {
         &#34;yes/no)?&#34;  {
            <a name="::::result_debug_expect(1)"><a href="./telnet.tcl.html#::::result_debug_expect_12">::::result_debug_expect</a></a>
            exp_send &#34;yes\r&#34;
         } 
         <span class="comment-line"># EY-06-14-2006: Changed expect pattern to match both types of</span>
         <span class="comment-line"># password prompts.</span>
         -re &#34;password for $user|$user@$dutIp's password:&#34; {
            <a name="::::result_debug_expect(2)"><a href="./telnet.tcl.html#::::result_debug_expect_12">::::result_debug_expect</a></a>
            exp_send &#34;$password\r&#34;
            set passwordPromptSeen 1
            break
         }
      }
   }
   if { $passwordPromptSeen != 1 } {
      <a name="::::result_debug_expect(3)"><a href="./telnet.tcl.html#::::result_debug_expect_12">::::result_debug_expect</a></a>
      <a name="::result_error(5)"><a href="./lconsoles.tcl.html#::result_error_6">::result_error</a></a> &#34;not seeing password prompt from scp2&#34; 
      <a name="::report_end_test(7)"><a href="./report.tcl.html#::report_end_test_122">::report_end_test</a></a>
      return 0
   }
   <a name="::linuxSendACmd(1)"><a href="./linux.tcl.html#::linuxSendACmd_268">::linuxSendACmd</a></a> &#34;\r&#34;
   if ![regexp -nocase &#34;No such&#34; [<a name="::linuxSendACmd(2)"><a href="./linux.tcl.html#::linuxSendACmd_268">::linuxSendACmd</a></a> &#34;ls $linuxFileName&#34;]] {
      <a name="::::result_debug_expect(4)"><a href="./telnet.tcl.html#::::result_debug_expect_12">::::result_debug_expect</a></a>
      <a name="::result_ok(1)"><a href="./lconsoles.tcl.html#::result_ok_9">::result_ok</a></a> &#34;scp2 get file $dutFileName pass&#34;
      <a name="::report_end_test(8)"><a href="./report.tcl.html#::report_end_test_122">::report_end_test</a></a>
      return $linuxFileName
   } else {
      <a name="::::result_debug_expect(5)"><a href="./telnet.tcl.html#::::result_debug_expect_12">::::result_debug_expect</a></a>
      <a name="::result_error(6)"><a href="./lconsoles.tcl.html#::result_error_6">::result_error</a></a> &#34;scp2 get file $dutFileName failed&#34;
      <a name="::report_end_test(9)"><a href="./report.tcl.html#::report_end_test_122">::report_end_test</a></a>
      return 0
   }
}

<span class="comment-line">##################################################################</span>
<span class="comment-line"># Procedure Name: checkScpPut</span>
<span class="comment-line"># Description:</span>
<span class="comment-line">#       verify scp of file from the linux machine to the DUT. </span>
<span class="comment-line"># Input args:  user       ssh user name</span>
<span class="comment-line">#              password   ssh password</span>
<span class="comment-line">#              dut        IP for the DUT console </span>
<span class="comment-line">#              dutIp      IP of the DUT</span>
<span class="comment-line">#              linuxFileName full path of the file at the linux machine</span>
<span class="comment-line">#              dutFileName full path of file at the DUT</span>
<span class="comment-line"># Output args: return 1 if success, 0 if failure</span>
<span class="comment-line"># Typical usage:</span>
<span class="comment-line">#       checkScpPut test123 test123 $DUT1_CONNECT $DUT1_IP /tmp/fileabc.cfg</span>
<span class="comment-line">#       /config/primary.cfg</span>
<span class="comment-line"># Category: SSH_SCP</span>
<span class="comment-line">##################################################################</span>
<strong><a name="::::checkScpPut_201">proc <a href="ssh_scpLib.tcl-annot.html#::::checkScpPut">::::checkScpPut</a></a></strong> { user password dut dutIp linuxFileName dutFileName args} {
   global SSHClient
   global SSHUser
   global SSHPassword

   <a name="::parse_args(1)"><a href="./parse_args.tcl.html#::parse_args_29">::parse_args</a></a> checkScpPut $args {
      checkUploaded &#34;yes&#34;
   }

   <a name="::report_start_test(5)"><a href="./report.tcl.html#::report_start_test_79">::report_start_test</a></a> &#34;scp2 file $linuxFileName to $dutIp&#34;

   <a name="::Login(5)"><a href="./login.tcl.html#::Login_24">::Login</a></a> $dut
   <span class="comment-line">#make sure the file doesn't exist in DUT</span>
   <a name="::EnableDebugMode(2)"><a href="./misc.tcl.html#::EnableDebugMode_2430">::EnableDebugMode</a></a>

   set dirLst [split $dutFileName /]
   set lng [llength $dirLst]
   set fnam [lindex $dirLst [expr $lng -1]]
   set checkList &#34;{{.*$fnam.*} exist}&#34;
   set result [<a name="::CheckKeyValue(3)"><a href="./OptionCheck.tcl.html#::CheckKeyValue_47">::CheckKeyValue</a></a> &#34;ls&#34; $checkList -reportResults 0]
   if {$result == &#34;ok&#34;} {
     <a name="::SendACmd(9)"><a href="./SendSwCmd.tcl.html#::SendACmd_157">::SendACmd</a></a> &#34;rm $fnam&#34;
   }

   <a name="::login_linux(2)"><a href="./linux.tcl.html#::login_linux_16">::login_linux</a></a> $SSHClient $SSHUser $SSHPassword $SSHPassword
   exp_send \
      &#34;/usr/local/bin/scp2 $linuxFileName $user@$dutIp:$dutFileName\r&#34;
   <span class="comment-line">#there could be a few yes/no prompt before password prompt, depends </span>
   <span class="comment-line">#whether the client has the correct public key</span>
<a name="::exSleep(3)"><a href="./sleep.tcl.html#::exSleep_248">::exSleep</a></a> 5
   set passwordPromptSeen 0
   for {set try 1} {$try &lt;= 5} { incr try } {
      expect {
         &#34;Connection closed by remote host&#34; {
            exp_send \
               &#34;/usr/local/bin/scp2 $linuxFileName $user@$dutIp:$dutFileName\r&#34;
            continue
         }
         &#34;yes/no)?&#34;  {
            <a name="::::result_debug_expect(6)"><a href="./telnet.tcl.html#::::result_debug_expect_12">::::result_debug_expect</a></a>
            exp_send &#34;yes\r&#34;
         } 
         <span class="comment-line"># EY-06-14-2006: Changed expect pattern to match both types of</span>
         <span class="comment-line"># password prompts.</span>
         -re &#34;password for $user|$user@$dutIp's password:&#34; {
            <a name="::::result_debug_expect(7)"><a href="./telnet.tcl.html#::::result_debug_expect_12">::::result_debug_expect</a></a>
            exp_send &#34;$password\r&#34;
            set passwordPromptSeen 1
            break
         }
      }
   }
   if { $passwordPromptSeen != 1 } {
      <a name="::::result_debug_expect(8)"><a href="./telnet.tcl.html#::::result_debug_expect_12">::::result_debug_expect</a></a>
      <a name="::result_error(7)"><a href="./lconsoles.tcl.html#::result_error_6">::result_error</a></a> &#34;not seeing password prompt from scp2&#34; 
      <a name="::report_end_test(10)"><a href="./report.tcl.html#::report_end_test_122">::report_end_test</a></a>
      return 0
   }
   <a name="::linuxSendACmd(3)"><a href="./linux.tcl.html#::linuxSendACmd_268">::linuxSendACmd</a></a> &#34;\r&#34;
   <a name="::Login(6)"><a href="./login.tcl.html#::Login_24">::Login</a></a> $dut
   if {$checkUploaded == &#34;yes&#34;} {
     set output [<a name="::SendACmd(10)"><a href="./SendSwCmd.tcl.html#::SendACmd_157">::SendACmd</a></a> &#34;!ls $dutFileName&#34;]
     <a name="::DisableDebugMode(1)"><a href="./misc.tcl.html#::DisableDebugMode_2957">::DisableDebugMode</a></a>
     if ![regexp -nocase &#34;No such&#34; $output] {
        <a name="::::result_debug_expect(9)"><a href="./telnet.tcl.html#::::result_debug_expect_12">::::result_debug_expect</a></a>
        <a name="::result_ok(2)"><a href="./lconsoles.tcl.html#::result_ok_9">::result_ok</a></a> &#34;scp2 put file $dutFileName pass&#34;
        <a name="::report_end_test(11)"><a href="./report.tcl.html#::report_end_test_122">::report_end_test</a></a>
        return 1
     } else {
        <a name="::::result_debug_expect(10)"><a href="./telnet.tcl.html#::::result_debug_expect_12">::::result_debug_expect</a></a>
        <a name="::result_error(8)"><a href="./lconsoles.tcl.html#::result_error_6">::result_error</a></a> &#34;scp2 put file $dutFileName failed&#34;
        <a name="::report_end_test(12)"><a href="./report.tcl.html#::report_end_test_122">::report_end_test</a></a>
        return 0
     }
   } else {
     <a name="::DisableDebugMode(2)"><a href="./misc.tcl.html#::DisableDebugMode_2957">::DisableDebugMode</a></a>
     <a name="::report_end_test(13)"><a href="./report.tcl.html#::report_end_test_122">::report_end_test</a></a>
     return 1
   }
}
<span class="comment-line">##################################################################</span>
<span class="comment-line"># Procedure Name: checkSsh</span>
<span class="comment-line"># Description:</span>
<span class="comment-line">#       verify successful ssh session from linux to DUT</span>
<span class="comment-line">#       This proc telnet to the SSHClient and start ssh2 from there</span>
<span class="comment-line">#       to dutIp. ssh2 is installed only on SSHClient in the lab.</span>
<span class="comment-line"># Input args:  user       ssh user name</span>
<span class="comment-line">#              password   ssh password</span>
<span class="comment-line">#              dutIp      IP of the DUT</span>
<span class="comment-line">#              option     option to the ssh2 command e.g. -p 1024</span>
<span class="comment-line">#              kill       kill - kill the ssh session before returning</span>
<span class="comment-line">#                         noKill - do not kill the ssh session </span>
<span class="comment-line">#              expected   pass - expect ssh to succed</span>
<span class="comment-line">#                         fail - expect ssh to fail  </span>
<span class="comment-line">#              command    ssh - use OpenSSH ssh client</span>
<span class="comment-line">#                         ssh2 - use SSH Communications Security ssh2 client</span>
<span class="comment-line"># Output args: return 1 if ssh result as expected in  expected, return 0</span>
<span class="comment-line">#              otherwise</span>
<span class="comment-line"># Typical usage:</span>
<span class="comment-line">#       checkSsh test123 test123 $DUT1_IP </span>
<span class="comment-line"># Category: SSH_SCP</span>
<span class="comment-line">##################################################################</span>
<strong><a name="::::checkSsh_303">proc <a href="ssh_scpLib.tcl-annot.html#::::checkSsh">::::checkSsh</a></a></strong> { user password dutIp {option &#34;&#34; } {kill kill} \
   {expected pass} {command sshSecure} } {
   global SSHClient
   global SSHUser
   global SSHPassword
   <span class="comment-line">#upvar spawn_id spawn_id</span>
   global spawn_id

   <a name="::report_start_test(6)"><a href="./report.tcl.html#::report_start_test_79">::report_start_test</a></a> &#34;Ssh from linux to DUT, expect ssh to $expected&#34;

   <span class="comment-line">#login_linux $SSHClient $SSHUser $SSHPassword $SSHPassword</span>
   <span class="comment-line">#use spawnTelnetLinux instead of login_linux because some tests require</span>
   <span class="comment-line">#multiple ssh sessions simultaneously.</span>
   set spawn_id [<a name="::spawnTelnetLinux(1)"><a href="./ssh_scpLib.tcl.html#::spawnTelnetLinux_420">::spawnTelnetLinux</a></a> $SSHClient $SSHUser $SSHPassword]
   if { $spawn_id == 0} { 
      <a name="::result_error(9)"><a href="./lconsoles.tcl.html#::result_error_6">::result_error</a></a> &#34;Error telneting to SSHClient&#34;
      <a name="::report_end_test(14)"><a href="./report.tcl.html#::report_end_test_122">::report_end_test</a></a>
      return 0
   }
   <span class="comment-line">#ssh2 is the SSH Communication client</span>
   <span class="comment-line">#ssh is the OpenSSH client</span>
   set cmd(ssh2) &#34;/usr/bin/ssh2&#34;
   set cmd(sshSecure) &#34;/usr/bin/ssh2&#34;
   set cmd(ssh) &#34;ssh&#34;
   set cmd(debug) &#34;/usr/local/bin/ssh2 -d 1&#34;
<span class="comment-line">#   removeLineFromFile &#34;/root/.ssh/known_hosts&#34; $dutIp</span>
   <a name="::SendACmd(11)"><a href="./SendSwCmd.tcl.html#::SendACmd_157">::SendACmd</a></a> &#34;rm -rf /root/.ssh/known_hosts&#34;
   <a name="::SendACmd(12)"><a href="./SendSwCmd.tcl.html#::SendACmd_157">::SendACmd</a></a> &#34;rm -rf /root/.ssh/known_hosts2&#34;
   set cmd(openSsh) &#34;/usr/bin/ssh&#34;  ;<span class="comment-line"># openssh is in /usr/bin/ssh</span>
   <span class="comment-line">#exp_send &#34;$cmd($command) $user@$dutIp $option\r&#34;</span>
   <span class="comment-line">#expect &#34;#&#34;</span>
   <span class="comment-line">#exSleep 5</span>
   exp_send &#34;$cmd($command) $user@$dutIp $option\r&#34;
   <span class="comment-line">#there could be a few yes/no prompt before password prompt, depends </span>
   <span class="comment-line">#whether the client has the correct public key</span>
   set passwordPromptSeen 0
   set loginResult fail
   for {set try 1} {$try &lt;= 5} { incr try } {
      expect {
         -re {} {
            <a name="::::result_debug_expect(11)"><a href="./telnet.tcl.html#::::result_debug_expect_12">::::result_debug_expect</a></a>
            continue
         }
         -re {} {
            <a name="::::result_debug_expect(12)"><a href="./telnet.tcl.html#::::result_debug_expect_12">::::result_debug_expect</a></a>
            continue
         }
         &#34;yes/no)?&#34;  {
            <a name="::::result_debug_expect(13)"><a href="./telnet.tcl.html#::::result_debug_expect_12">::::result_debug_expect</a></a>
            exp_send &#34;yes\r&#34;
         }
         &#34;yes\' or \'no\':&#34; {
            <a name="::::result_debug_expect(14)"><a href="./telnet.tcl.html#::::result_debug_expect_12">::::result_debug_expect</a></a>
            exp_send &#34;yes\r&#34;
         }
         -re &#34;password for $user|$user@$dutIp's password:&#34; {
            <a name="::::result_debug_expect(15)"><a href="./telnet.tcl.html#::::result_debug_expect_12">::::result_debug_expect</a></a>
            exp_send &#34;$password\r&#34;
            set passwordPromptSeen 1
         }
         -re {} {
            <a name="::::result_debug_expect(16)"><a href="./telnet.tcl.html#::::result_debug_expect_12">::::result_debug_expect</a></a>
            if { $kill == &#34;kill&#34; } {
               <span class="comment-line">#clear the session to terminate ssh</span>
               exp_send &#34;clear session all\r&#34;
               expect -re {}
               <a name="::::result_debug_expect(17)"><a href="./telnet.tcl.html#::::result_debug_expect_12">::::result_debug_expect</a></a>
            }
            set loginResult pass
            break
         }
      }
   }
   if { $kill == &#34;kill&#34; } {
      <span class="comment-line">#exit the telnet session to SSHClient</span>
      exp_send &#34;exit\r&#34;
   }
   if { ($loginResult == &#34;pass&#34;) &amp;&amp; ($passwordPromptSeen != 1) } {
      <a name="::result_error(10)"><a href="./lconsoles.tcl.html#::result_error_6">::result_error</a></a> &#34;not seeing password prompt from ssh&#34; 
      <a name="::report_end_test(15)"><a href="./report.tcl.html#::report_end_test_122">::report_end_test</a></a>
      return 0
   }
   <span class="comment-line">#    Actual,Expected   Return code</span>
   set rc(pass,pass)         1
   set rc(fail,pass)         0
   set rc(pass,fail)         0
   set rc(fail,fail)         1
   <span class="comment-line">#return 1 only if loginResult and expected result matched</span>
   if { $rc($loginResult,$expected) == 1 } {
      if {($expected == &#34;pass&#34;) &amp;&amp; ($kill != &#34;kill&#34;)} {
	<a name="::exSleep(4)"><a href="./sleep.tcl.html#::exSleep_248">::exSleep</a></a> 10
        <a name="::SendACmd(13)"><a href="./SendSwCmd.tcl.html#::SendACmd_157">::SendACmd</a></a> &#34;disable clipaging&#34;
      <span class="comment-line">#   EnableDebugMode</span>
      <span class="comment-line">#   SendACmd &#34;!echo dump_stack &gt; /sys/module/watchdog/parameters/watchdog_warn_behavior&#34;</span>
      }
      <a name="::result_ok(3)"><a href="./lconsoles.tcl.html#::result_ok_9">::result_ok</a></a> &#34;SUCCESS: ssh ${expected}&#34;
      <a name="::report_end_test(16)"><a href="./report.tcl.html#::report_end_test_122">::report_end_test</a></a>
      return 1
   } else {
      <a name="::result_error(11)"><a href="./lconsoles.tcl.html#::result_error_6">::result_error</a></a> &#34;FAILURE: ssh did not ${expected}&#34;
      <a name="::report_end_test(17)"><a href="./report.tcl.html#::report_end_test_122">::report_end_test</a></a>
      return 0
   }
}

<span class="comment-line">##################################################################</span>
<span class="comment-line"># Procedure Name: spawnTelnetLinux</span>
<span class="comment-line"># Description:</span>
<span class="comment-line">#       spawn telnet to linux</span>
<span class="comment-line"># Input args:  ip         IP of the linux</span>
<span class="comment-line">#              user       user name</span>
<span class="comment-line">#              password   password</span>
<span class="comment-line"># Output args: return 0 if failed, return spawn_id if ok</span>
<span class="comment-line"># Typical usage:</span>
<span class="comment-line">#       </span>
<span class="comment-line"># Category: SSH_SCP</span>
<span class="comment-line">##################################################################</span>
<strong><a name="::::spawnTelnetLinux_420">proc <a href="ssh_scpLib.tcl-annot.html#::::spawnTelnetLinux">::::spawnTelnetLinux</a></a></strong> { <a name="::ip(1)"><a href="./ePTClient.tcl.html#::ip_974">::ip</a></a> user password } {
   global tspids
   upvar spawn_id spawn_id

   set timeout 5
   if [catch &#34;spawn telnet $ip&#34; reason] {
      <a name="::result_debug(5)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;Error telneting to $ip: $reason&#34;
      return 0
   }
   lappend tspids $spawn_id
   lappend tspids $ip
   for {set i 1} {$i&lt;5} {incr i} {
      expect {
         -re {Last login} {
            <span class="comment-line">#make sure &#34;Last login&#34; is  the fist patterm because </span>
            <span class="comment-line">#&#34;login&#34; will match both &#34;login&#34; and &#34;last login&#34;</span>
         
            <span class="comment-line">#login success, get the prompt</span>
            expect -re {}
            <a name="::::result_debug_expect(18)"><a href="./telnet.tcl.html#::::result_debug_expect_12">::::result_debug_expect</a></a>
            return $spawn_id
         }
         &#34;login:&#34; {
            <a name="::::result_debug_expect(19)"><a href="./telnet.tcl.html#::::result_debug_expect_12">::::result_debug_expect</a></a>
            sleep 1
            send &#34;$user\r&#34;
         }
         &#34;assword:&#34; {
            <a name="::::result_debug_expect(20)"><a href="./telnet.tcl.html#::::result_debug_expect_12">::::result_debug_expect</a></a>
            sleep 1
            send &#34;$password\r&#34;
         }
         timeout {
            <a name="::::result_debug_expect(21)"><a href="./telnet.tcl.html#::::result_debug_expect_12">::::result_debug_expect</a></a>
            <a name="::result_debug(6)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;Error logging into linux at $ip&#34;
         }
      }
   }
   return 0
}

<strong><a name="::::downloadModule_461">proc <a href="ssh_scpLib.tcl-annot.html#::::downloadModule">::::downloadModule</a></a></strong> {TFTPServerIP filename} {
  
   global whichDutNow
   <a name="::SendACmd(14)"><a href="./SendSwCmd.tcl.html#::SendACmd_157">::SendACmd</a></a> &#34;download image $TFTPServerIP $filename vr [<a name="::GetVrString(1)"><a href="./misc.tcl.html#::GetVrString_3157">::GetVrString</a></a> $whichDutNow]&#34;
   <a name="::exSleep(5)"><a href="./sleep.tcl.html#::exSleep_248">::exSleep</a></a> 4
   <a name="::SendACmd(15)"><a href="./SendSwCmd.tcl.html#::SendACmd_157">::SendACmd</a></a> &#34;run update&#34;

   <a name="::SendACmd(16)"><a href="./SendSwCmd.tcl.html#::SendACmd_157">::SendACmd</a></a> &#34;restart process snmpmaster&#34;
   <a name="::SendACmd(17)"><a href="./SendSwCmd.tcl.html#::SendACmd_157">::SendACmd</a></a> &#34;restart process thttpd&#34;
<span class="comment-line">#   CheckReboot</span>
}

<strong><a name="::::getSshModulePath_473">proc <a href="ssh_scpLib.tcl-annot.html#::::getSshModulePath">::::getSshModulePath</a></a></strong> { } {
   return [<a name="::getImagePath(1)"><a href="./LocateImage.tcl.html#::getImagePath_1">::getImagePath</a></a> -Image ssh]
}

<strong><a name="::::downloadSshModule_477">proc <a href="ssh_scpLib.tcl-annot.html#::::downloadSshModule">::::downloadSshModule</a></a></strong> { } {
   global tftpServerList tftpServerLogin tftpServerPasswd tftpServerTftpboot
   global moduleArg
   global DUTs_info

   if {$moduleArg!=&#34;&#34;} {
      set modulePath $moduleArg
   } else {
      set modulePath [<a name="::getSshModulePath(1)"><a href="./ssh_scpLib.tcl.html#::getSshModulePath_473">::getSshModulePath</a></a>]
   }
   set moduleName [file tail $modulePath ]

   foreach tftpServer $tftpServerList {
      <span class="comment-line">#if module is found in the TFTP server use it</span>
      <span class="comment-line">#this gives the user a way to manually copy the SSH module to TFTP</span>
      if [<a name="::tftpFileExists(1)"><a href="./LocateImage.tcl.html#::tftpFileExists_438">::tftpFileExists</a></a> $tftpServer $moduleName] {
         <a name="::result_debug(7)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> \
            &#34;Module $moduleName found on TFTP server. Download it&#34;
         <a name="::downloadModule(1)"><a href="./ssh_scpLib.tcl.html#::downloadModule_461">::downloadModule</a></a> $tftpServer $moduleName
         return
      }
   }

   <span class="comment-line">#module is not found on tftp server</span>
   <span class="comment-line">#Put the module to the TFTP server, download it</span>
   <span class="comment-line">#and then remove it.</span>
<span class="comment-line">#   result_debug \</span>
<span class="comment-line">#      &#34;Module $moduleName not found on TFTP server. Copy module to TFTP server from $modulePath&#34;</span>
<span class="comment-line">#   if ![file exists $modulePath] {</span>
<span class="comment-line">#      report_start_test &#34;SSH module not found in $modulePath. Please copy $moduleName to TFTP server and rerun the test.&#34;</span>
<span class="comment-line">#      result_error &#34;SSH module not found in $modulePath. Please copy $moduleName to TFTP server and rerun the test.&#34;</span>
<span class="comment-line">#      report_end_test</span>
<span class="comment-line">#      return</span>
<span class="comment-line">#   }</span>

   foreach tftpServer $tftpServerList {
      set fileName [<a name="::uniqueName(2)"><a href="./LocateImage.tcl.html#::uniqueName_431">::uniqueName</a></a> $moduleName]
      <a name="::result_debug(8)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;TFTP server is $tftpServer&#34;
      <span class="comment-line">#put the SSH module to the TFTP server and download it</span>
      <a name="::result_debug(9)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> \
         &#34;puting SSH module $modulePath to TFTP Server as $fileName&#34; 
      exec \
         echo &#34;put $modulePath $fileName\nquit\n&#34; | /usr/bin/tftp $tftpServer
      <a name="::downloadModule(2)"><a href="./ssh_scpLib.tcl.html#::downloadModule_461">::downloadModule</a></a> $tftpServer $fileName

      <span class="comment-line">#remove the SSH module from TFTP server</span>
      global spawn_id
      set sid $spawn_id
      <a name="::result_debug(10)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;remove SSH module from TFTP Server&#34;
      <a name="::login_linux(3)"><a href="./linux.tcl.html#::login_linux_16">::login_linux</a></a> $tftpServer $tftpServerLogin $tftpServerPasswd
      <a name="::linuxSendACmd(4)"><a href="./linux.tcl.html#::linuxSendACmd_268">::linuxSendACmd</a></a> &#34;/bin/rm $tftpServerTftpboot/$fileName&#34; 
      set spawn_id $sid
      global whichDutNow

      set output [<a name="::SendACmd(18)"><a href="./SendSwCmd.tcl.html#::SendACmd_157">::SendACmd</a></a> &#34;show version image $DUTs_info(DUT$whichDutNow,imageSel)&#34;]
      if [regexp {([^ ]+ssh[^ ]+)} $output] {
         <span class="comment-line">#ssh module downloaded successfully. no need to try next tftp server</span>
         break
      }
   }
   <span class="comment-line">#sleep 2</span>
   <span class="comment-line">#SendACmd &#34;start process exsshd&#34;</span>

}


<strong><a name="::::uninstallSshModule_543">proc <a href="ssh_scpLib.tcl-annot.html#::::uninstallSshModule">::::uninstallSshModule</a></a></strong> { } {
    global DUTs_info
    global whichDutNow

    set version $DUTs_info(DUT$whichDutNow,version)
    if {[<a name="::CompareRelease(1)"><a href="./misc.tcl.html#::CompareRelease_891">::CompareRelease</a></a> $version 11.2.0.18]&gt;=0} {
       <a name="::SendACmd(19)"><a href="./SendSwCmd.tcl.html#::SendACmd_157">::SendACmd</a></a> &#34;terminate process thttpd forceful&#34;
    } else {
       <a name="::SendACmd(20)"><a href="./SendSwCmd.tcl.html#::SendACmd_157">::SendACmd</a></a> &#34;terminate process exsshd forceful&#34;
    }
    <a name="::exSleep(6)"><a href="./sleep.tcl.html#::exSleep_248">::exSleep</a></a> 5 
    <a name="::SendACmd(21)"><a href="./SendSwCmd.tcl.html#::SendACmd_157">::SendACmd</a></a> &#34;&#34;
    if {[<a name="::CompareRelease(2)"><a href="./misc.tcl.html#::CompareRelease_891">::CompareRelease</a></a> $version 12.3.0.3]&gt;=0} {
       <a name="::SendACmd(22)"><a href="./SendSwCmd.tcl.html#::SendACmd_157">::SendACmd</a></a> &#34;terminate process snmpMaster forceful&#34;
       <a name="::exSleep(7)"><a href="./sleep.tcl.html#::exSleep_248">::exSleep</a></a> 10 
       <a name="::SendACmd(23)"><a href="./SendSwCmd.tcl.html#::SendACmd_157">::SendACmd</a></a> &#34;terminate process xmlc forceful&#34;
       <a name="::exSleep(8)"><a href="./sleep.tcl.html#::exSleep_248">::exSleep</a></a> 10
       <a name="::SendACmd(24)"><a href="./SendSwCmd.tcl.html#::SendACmd_157">::SendACmd</a></a> &#34;terminate process techSupport forceful&#34;
       <a name="::exSleep(9)"><a href="./sleep.tcl.html#::exSleep_248">::exSleep</a></a> 10
    }

    <span class="comment-line">#uninstall all ssh module from switch</span>
    <a name="::uninstallImage(1)"><a href="./ssh_scpLib.tcl.html#::uninstallImage_580">::uninstallImage</a></a> &#34;ssh&#34; $DUTs_info(DUT$whichDutNow,imageSel)

    if {[<a name="::CompareRelease(3)"><a href="./misc.tcl.html#::CompareRelease_891">::CompareRelease</a></a> $version 12.3.0.3]&gt;=0} {
      <a name="::SendACmd(25)"><a href="./SendSwCmd.tcl.html#::SendACmd_157">::SendACmd</a></a> &#34;start process thttpd&#34;
      <a name="::SendACmd(26)"><a href="./SendSwCmd.tcl.html#::SendACmd_157">::SendACmd</a></a> &#34;start process snmpMaster&#34;
      <a name="::SendACmd(27)"><a href="./SendSwCmd.tcl.html#::SendACmd_157">::SendACmd</a></a> &#34;start process techSupport&#34;
      <a name="::SendACmd(28)"><a href="./SendSwCmd.tcl.html#::SendACmd_157">::SendACmd</a></a> &#34;start process xmlc&#34;
      <a name="::exSleep(10)"><a href="./sleep.tcl.html#::exSleep_248">::exSleep</a></a> 5
    }
    <a name="::SendACmd(29)"><a href="./SendSwCmd.tcl.html#::SendACmd_157">::SendACmd</a></a> &#34;&#34;
 }




<strong><a name="::::uninstallImage_580">proc <a href="ssh_scpLib.tcl-annot.html#::::uninstallImage">::::uninstallImage</a></a></strong> {moduleName partition } {
    global DUTs_info
    global whichDutNow
    global stackable
    global stacking
    global maxSlot	
    global DUT1_CONNECTB
    set maxTry 5
    set i 3

for {set try 0} {$try &lt;= 5 } {incr try } {
       if {$try == $maxTry} {
          <a name="::result_error(12)"><a href="./lconsoles.tcl.html#::result_error_6">::result_error</a></a> &#34;Error removing $moduleName module after trying $maxTry times&#34;
          break
 	} else {
	if {([regexp -nocase $stackable $DUTs_info(DUT$whichDutNow,platform)]) || ([<a name="::GetPlatform(1)"><a href="./misc.tcl.html#::GetPlatform_478">::GetPlatform</a></a>] == &#34;BD-12802&#34;)} {

       set output [<a name="::SendACmd(30)"><a href="./SendSwCmd.tcl.html#::SendACmd_157">::SendACmd</a></a> &#34;show version image $partition &#34; ]
               if {$moduleName == &#34;ssh&#34;} {
                 set cnd [regexp {([^ ]+ssh[^ \r\n]+)} $output dummy imageName ]
               } elseif {$moduleName == &#34;cna&#34;} {
                 set cnd [regexp {([^ ]+cna[^ \r\n]+)} $output dummy imageName ]
               } else {
                 <a name="::result_error(13)"><a href="./lconsoles.tcl.html#::result_error_6">::result_error</a></a> &#34;unknown module&#34;
                 return
               }
               if $cnd {
		<a name="::SendACmd(31)"><a href="./SendSwCmd.tcl.html#::SendACmd_157">::SendACmd</a></a> &#34;uninstall image $imageName $partition&#34;
                <a name="::exSleep(11)"><a href="./sleep.tcl.html#::exSleep_248">::exSleep</a></a> 10
               } else {
               break
        }
      } else {
        set msmtype &#34;msm A&#34;
        set output [<a name="::SendACmd(32)"><a href="./SendSwCmd.tcl.html#::SendACmd_157">::SendACmd</a></a> &#34;show version image $partition $msmtype &#34;]
        if {$moduleName == &#34;ssh&#34;} {
          set cnd [regexp {([^ ]+ssh[^ \r\n]+)} $output dummy imageName ]
        } elseif {$moduleName == &#34;cna&#34;} {
          set cnd [regexp {([^ ]+cna[^ \r\n]+)} $output dummy imageName ]
        } else {
          <a name="::result_error(14)"><a href="./lconsoles.tcl.html#::result_error_6">::result_error</a></a> &#34;unknown module&#34;
          return
        }
        if $cnd {
     	     <a name="::SendACmd(33)"><a href="./SendSwCmd.tcl.html#::SendACmd_157">::SendACmd</a></a> &#34;uninstall image $imageName $partition $msmtype&#34;
             <a name="::exSleep(12)"><a href="./sleep.tcl.html#::exSleep_248">::exSleep</a></a> 10
        }
        if {[info exists DUT1_CONNECTB]!=1} {
           return
        }
        set msmtype &#34;msm B&#34;
        set output [<a name="::SendACmd(34)"><a href="./SendSwCmd.tcl.html#::SendACmd_157">::SendACmd</a></a> &#34;show version image $partition $msmtype &#34;]
         if {$moduleName == &#34;ssh&#34;} {
          set cnd [regexp {([^ ]+ssh[^ \r\n]+)} $output dummy imageName ]
        } elseif {$moduleName == &#34;cna&#34;} {
          set cnd [regexp {([^ ]+cna[^ \r\n]+)} $output dummy imageName ]
        } else {
          <a name="::result_error(15)"><a href="./lconsoles.tcl.html#::result_error_6">::result_error</a></a> &#34;unknown module&#34;
          return
        }
        if $cnd {
        <a name="::SendACmd(35)"><a href="./SendSwCmd.tcl.html#::SendACmd_157">::SendACmd</a></a> &#34;uninstall image $imageName $partition $msmtype&#34;
             <a name="::exSleep(13)"><a href="./sleep.tcl.html#::exSleep_248">::exSleep</a></a> 10
        }

}
set j $i
 if { [regexp -nocase &#34;$stacking&#34; [<a name="::GetPlatform(2)"><a href="./misc.tcl.html#::GetPlatform_478">::GetPlatform</a></a>]] } {
	set parameterList &#34;&#34;
	lappend parameterList &#34;{Factory MAC address} 2&#34;
	set nodeMac [<a name="::GetKeyValue(2)"><a href="./OptionCheck.tcl.html#::GetKeyValue_438">::GetKeyValue</a></a> &#34;show stacking detail&#34; $parameterList]
	set maxSlot [llength $nodeMac]
	if {$maxSlot &gt; 2} {
	for {set j $i } {$j &lt;= $maxSlot} {incr j } {
	set msmtype &#34;slot $j&#34;
	set output [<a name="::SendACmd(36)"><a href="./SendSwCmd.tcl.html#::SendACmd_157">::SendACmd</a></a> &#34;show version image $partition $msmtype &#34;]
        if {$moduleName == &#34;ssh&#34;} {
          set cnd [regexp {([^ ]+ssh[^ \r\n]+)} $output dummy imageName ]
        } elseif {$moduleName == &#34;cna&#34;} {
          set cnd [regexp {([^ ]+cna[^ \r\n]+)} $output dummy imageName ]
        } else {
          <a name="::result_error(16)"><a href="./lconsoles.tcl.html#::result_error_6">::result_error</a></a> &#34;unknown module&#34;
          return
        }
        	if $cnd {
		set result [<a name="::CheckCmdLegal(1)"><a href="./checkCmdLegality.tcl.html#::CheckCmdLegal_58">::CheckCmdLegal</a></a>  &#34;uninstall image $imageName $partition $msmtype&#34;]
        	<a name="::exSleep(14)"><a href="./sleep.tcl.html#::exSleep_248">::exSleep</a></a> 10
			 if {$result==&#34;illegal&#34;} {
                        break
                        }

			
       		 } 
	}
	incr j -1
	if {$j == $maxSlot} {
                break
                }
	}
	} else {
          break
        }
}
}
     <span class="comment-line"># adding delay back - failed on 11.3.1.3 BD-10K</span>
     <a name="::exSleep(15)"><a href="./sleep.tcl.html#::exSleep_248">::exSleep</a></a> 1
}

<strong><a name="::::removeLineFromFile_688">proc <a href="ssh_scpLib.tcl-annot.html#::::removeLineFromFile">::::removeLineFromFile</a></a></strong> {fileName1 LineString} {
   if {[set fd1 [<a name="::FileOpen(1)"><a href="./queueLib.tcl.html#::FileOpen_58">::FileOpen</a></a> Tmp/tmp[pid] w]]==-1} {
      return $fd1
   }
   if {[set fd2 [<a name="::FileOpen(2)"><a href="./queueLib.tcl.html#::FileOpen_58">::FileOpen</a></a> $fileName1 r]]==-1} {
      return $fd2
   }
   set lines [split [read $fd2] &#34;\n&#34;]
   close $fd2
   fconfigure stdout -buffering full

   for {set i 0} {$i &lt;= [expr {[llength $lines]-2}]} {incr i 1} {
      if {[regexp -nocase $LineString [lindex $lines $i]]!=1} {
         puts $fd1 [lindex $lines $i]
      }
   }
   close $fd1
   file rename Tmp/tmp[pid] $fileName1
}


<span class="comment-line">##################################################################</span>
<span class="comment-line"># Procedure Name: ssh_vr_connect_cipher</span>
<span class="comment-line"># Description:</span>
<span class="comment-line">#       verify SSH from DUT to the linux machine.</span>
<span class="comment-line">#</span>
<span class="comment-line"># Input args:  vr            virtual router</span>
<span class="comment-line">#              remote_host   remote host ip with user name</span>
<span class="comment-line">#	       password      remote host password</span>
<span class="comment-line">#              cppher         algorithm</span>
<span class="comment-line">#</span>
<span class="comment-line"># Output args: return 0 or 1 depends on success or failure</span>
<span class="comment-line"># Typical usage:</span>
<span class="comment-line">#	ssh_vr_connect_cipher vr-default admin@10.127.17.100 &#34;pwd&#34; &#34;cipher 3des&#34;</span>
<span class="comment-line"># Category: SSH_SCP</span>
<span class="comment-line">##################################################################</span>

<strong><a name="::::ssh_vr_connect_cipher_725">proc <a href="ssh_scpLib.tcl-annot.html#::::ssh_vr_connect_cipher">::::ssh_vr_connect_cipher</a></a></strong> {{vr VR_Default} remote_host {passwd &#34;&#34;} {cipher &#34;&#34;} } {

    <a name="::SendACmd(37)"><a href="./SendSwCmd.tcl.html#::SendACmd_157">::SendACmd</a></a> &#34;\r&#34;
<a name="::result_debug(11)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;new lib&#34;
    <a name="::slow_send(1)"><a href="./SendSwCmd.tcl.html#::slow_send_1567">::slow_send</a></a> &#34;ssh2 $cipher vr $vr $remote_host\r&#34;
    expect {
      timeout {
        <a name="::::result_debug_expect(22)"><a href="./telnet.tcl.html#::::result_debug_expect_12">::::result_debug_expect</a></a>
        return 0
      }
      &#34;password:&#34; {
         <a name="::::result_debug_expect(23)"><a href="./telnet.tcl.html#::::result_debug_expect_12">::::result_debug_expect</a></a>
         exp_send &#34;$passwd\r&#34;
      }
    }
     <a name="::result_debug(12)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;BufferStart ===$expect_out(buffer)=== BufferEnd&#34;
     sleep 10

    expect {
      &#34;]&#34; {
        <a name="::::result_debug_expect(24)"><a href="./telnet.tcl.html#::::result_debug_expect_12">::::result_debug_expect</a></a>
        <a name="::result_debug(13)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;We are in ]&#34;
        return 1
      }
      &#34;&gt;&#34; {
        <a name="::::result_debug_expect(25)"><a href="./telnet.tcl.html#::::result_debug_expect_12">::::result_debug_expect</a></a>
        <a name="::result_debug(14)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;We are in &gt;&#34;
        return 1  

      }
      &#34;$&#34; {
        <a name="::::result_debug_expect(26)"><a href="./telnet.tcl.html#::::result_debug_expect_12">::::result_debug_expect</a></a>
        <a name="::result_debug(15)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;We are in $&#34;
        return 1
      }
      timeout {
<a name="::result_debug(16)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;timed out&#34;
      <a name="::::result_debug_expect(27)"><a href="./telnet.tcl.html#::::result_debug_expect_12">::::result_debug_expect</a></a>
        return 0
      }
    }
}

<span class="comment-line">##################################################################</span>
<span class="comment-line"># Procedure Name: logout_ssh</span>
<span class="comment-line"># Description:</span>
<span class="comment-line">#</span>
<span class="comment-line">#     Used to logout linux session established from DUT</span>
<span class="comment-line">#</span>
<span class="comment-line"># Input args: none</span>
<span class="comment-line">#</span>
<span class="comment-line"># Output args: return 0 or 1 depends on success or failure</span>
<span class="comment-line"># Typical usage:</span>
<span class="comment-line">#		logout_ssh</span>
<span class="comment-line"># Category: SSH_SCP</span>
<span class="comment-line">##################################################################</span>


<strong><a name="::::logout_ssh_783">proc <a href="ssh_scpLib.tcl-annot.html#::::logout_ssh">::::logout_ssh</a></a></strong> { } {

    <a name="::slow_send(2)"><a href="./SendSwCmd.tcl.html#::slow_send_1567">::slow_send</a></a> &#34;logout\r&#34;
    expect {
      &#34;#&#34; {
        <a name="::::result_debug_expect(28)"><a href="./telnet.tcl.html#::::result_debug_expect_12">::::result_debug_expect</a></a>
        return 1
      }
      timeout {
        <a name="::::result_debug_expect(29)"><a href="./telnet.tcl.html#::::result_debug_expect_12">::::result_debug_expect</a></a>
        <a name="::result_error(17)"><a href="./lconsoles.tcl.html#::result_error_6">::result_error</a></a> &#34;switch is not echoing characters sent to the linux PC&#34;
        send &#34;\r&#34;
        <a name="::exSleep(16)"><a href="./sleep.tcl.html#::exSleep_248">::exSleep</a></a> 1
        <a name="::result_debug(17)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;trying to logout with fast expect send&#34;
        send &#34;logout\r&#34;
        expect {
          &#34;#&#34; {
            <a name="::::result_debug_expect(30)"><a href="./telnet.tcl.html#::::result_debug_expect_12">::::result_debug_expect</a></a>
            return 1
          }
          timeout {
            <a name="::::result_debug_expect(31)"><a href="./telnet.tcl.html#::::result_debug_expect_12">::::result_debug_expect</a></a>
            return 0
          }
        }
      }
    }
}
</pre>
<hr>
<div class="index-selector">
	<a href="index_main.html#byfilename">file name</a> 
 | 
	<a href="index_main.html#byprocname">procedure name</a> 
 | 
	<a href="index_main.html#bycall">procedure call</a> 
 | 
	<a href="index_annot_full.html">annotation</a> 

<br>
<cite>File generated 2018-06-14 at 17:09.</cite>
</div>

</body>
</html>
