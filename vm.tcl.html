<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                       "http://www.w3.org/TR/html4/transitional.dtd">
<!-- Generated by TclDoc @@VERSION@@ -->
<html>
<head>
  <title>vm.tcl</title>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <link rel="stylesheet" type="text/css" href="default.css">
</head>
<body class="src-html">
<div class="index-selector">
<!-- index for tcl source files -->
	Index by: 
	<a href="index_main.html#vm.tcl">file name</a> | 
	<a href="index_main.html#byprocname">procedure name</a> | 
	<a href="index_main.html#bycall">procedure call</a> | 
	<a href="index_annot_full.html">annotation</a>

</div>
<hr>

<p><strong>vm.tcl</strong>&nbsp;&nbsp;<span class="filetype-link">(<a href="vm.tcl-annot.html">annotations</a> | <a href="vm.tcl.txt">original source</a>)</span>
</p>
<pre class="src-code">
<span class="comment-line">##############################################################################</span>
<span class="comment-line"># Figure out which VM link to take down.</span>
<span class="comment-line">#</span>
<span class="comment-line">#</span>
<span class="comment-line">#</span>
<span class="comment-line">##############################################################################</span>
<strong><a name="::::_vmDisableEnablePorts_7">proc <a href="vm.tcl-annot.html#::::_vmDisableEnablePorts">::::_vmDisableEnablePorts</a></a></strong><a name="::::_vmDisableEnablePorts"></a> {args} {
    global MAIN whichDutNow trunkPortList portMappingList VBOXINFO spawn_ids
    global VBOXSERVER whichMsmNow spawn_id
    global DUT${whichDutNow}_CONNECT${whichMsmNow}
    <a name="::parse_args(1)"><a href="./parse_args.tcl.html#::parse_args_29">::parse_args</a></a> _vmTakeDownPorts $args {
        ports  &#34;null&#34;
        state  &#34;disable&#34;
    }
    regsub -all {[ ]+,|,[ ]+} $ports &#34;,&#34; ports
    regsub -all {[ ]+} $ports &#34;,&#34; ports
    set outports &#34;&#34;    
    if {[regexp &#34;,&#34; $ports]} {
        set portList [split $ports &#34;,&#34;]
        foreach p $portList {
            if {[regexp &#34;\-&#34; $p]} {
                set portList2 [split $p &#34;-&#34;]
                set l [lindex $portList2 0]
                set h [lindex $portList2 1]
                while {$l&lt;=$h} {
                    lappend outports $l
                    incr l
                }
            } else {
                lappend outports $p
            }
        }
    } elseif {[regexp &#34;\-&#34; $ports]} {
        set portList [split $ports &#34;-&#34;]
        set l [lindex $portList 0]
        set h [lindex $portList 1]
        while {$l&lt;=$h} {
            lappend outports $l
            incr l
        }  
    } else {
        set outports $ports
    }
    set remoteList &#34;&#34;
    foreach p $outports {
        set hitPort($p) 0
        foreach ind $trunkPortList {
            set one [lindex $ind 0]
            set two [lindex $ind 1]
            set three [lindex $ind 2]
            if {![info exists cc($one,$two)]} {
                set cc($one,$two) 1
            } else {
                incr cc($one,$two)
            }
            if {$one == $whichDutNow &amp;&amp; $three == $p} {
                set remoteDut $two
                set remotePort [<a name="::::GetATrunkPort(1)"><a href="./SystemSetup.tcl.html#::::GetATrunkPort_601">::::GetATrunkPort</a></a> $remoteDut $whichDutNow $cc($one,$two)]
                <span class="comment-line">#lappend remoteList &#34;$whichDutNow $p&#34;</span>
                lappend remoteList &#34;$remoteDut $remotePort&#34;
                unset cc($one,$two)
                set hitPort($p) 1
                break;
            }
        }
        if {!$hitPort($p)} {
            <span class="comment-line">#must be connected to an ixia</span>
            foreach ind2 $portMappingList {
                if {[lindex $ind2 2] == $whichDutNow &amp;&amp; [lindex $ind2 1] == $p} {
                    set hitPort($p) 1
                    lappend remoteList &#34;skip&#34;
                    break;
                }
            }
        }
    }
    <span class="comment-line">#        _vmDisableEnablePorts -state &#34;disable&#34; -ports &#34;1,2,3,5&#34;</span>
    <span class="comment-line">#        _vmDisableEnablePorts -ports &#34;1,2,3,5&#34; -state &#34;enable&#34;</span>
    puts &#34;remlist $remoteList&#34;
    <span class="comment-line">#_setShowOutput -screen off -log off -res_fmt off</span>
    <a name="::::LoginVBox(1)"><a href="./vm.tcl.html#::::LoginVBox_107">::::LoginVBox</a></a>
    foreach pair $remoteList {
        if {[lindex $pair 0] == &#34;skip&#34; || [lindex $pair 0] == 0} {
            continue;
        }
        if {[regexp -nocase &#34;dis&#34; $state]} {
            <a name="::linuxSendACmd(1)"><a href="./linux.tcl.html#::linuxSendACmd_268">::linuxSendACmd</a></a> &#34;VBoxManage controlvm [set VBOXINFO([lindex $pair 0],name)] setlinkstate[expr [lindex $pair 1] + 1] off&#34;
        }
        if {[regexp -nocase &#34;ena&#34; $state]} {
            <a name="::linuxSendACmd(2)"><a href="./linux.tcl.html#::linuxSendACmd_268">::linuxSendACmd</a></a> &#34;VBoxManage controlvm [set VBOXINFO([lindex $pair 0],name)] setlinkstate[expr [lindex $pair 1] + 1] on&#34;
        }
    }
    if [catch {close -i $spawn_id} reason] {
        puts &#34;Failed to close spawn_id $spawn_id Reason: $reason&#34;
    }
    if [catch {wait} x] {
        puts &#34;Failed on wait : reason $x&#34;
    }
    <a name="::Login(1)"><a href="./login.tcl.html#::Login_24">::Login</a></a> [set DUT${whichDutNow}_CONNECT${whichMsmNow}] -masterCheck 0 -CheckOperational 0
    <span class="comment-line">#_setShowOutput -screen on -log on -res_fmt on</span>
}
<span class="comment-line">#######################################################################</span>
<span class="comment-line">#</span>
<span class="comment-line">#</span>
<span class="comment-line">#</span>
<span class="comment-line">#######################################################################</span>
<strong><a name="::::LoginVBox_107">proc <a href="vm.tcl-annot.html#::::LoginVBox">::::LoginVBox</a></a></strong><a name="::::LoginVBox"></a> {} {
    global VBOXSERVER VBOXUSER VBOXPASS
    <a name="::login_linux(1)"><a href="./linux.tcl.html#::login_linux_16">::login_linux</a></a> $VBOXSERVER $VBOXUSER $VBOXPASS NULL &#34;ssh&#34;
}
<span class="comment-line">#######################################################################</span>
<span class="comment-line">#</span>
<span class="comment-line">#</span>
<span class="comment-line">#</span>
<span class="comment-line">#######################################################################</span>
<strong><a name="::::powerCycleVM_116">proc <a href="vm.tcl-annot.html#::::powerCycleVM">::::powerCycleVM</a></a></strong><a name="::::powerCycleVM"></a> {DUT mode} {
    global MAIN trunkPortList portMappingList VBOXINFO spawn_ids
    global spawn_id hostname VBOXSERVER
    global DUT${DUT}_CONNECT
    <a name="::::LoginVBox(2)"><a href="./vm.tcl.html#::::LoginVBox_107">::::LoginVBox</a></a>
    if {[regexp -nocase &#34;of|reb|oot&#34; $mode]} {
        <a name="::linuxSendACmd(3)"><a href="./linux.tcl.html#::linuxSendACmd_268">::linuxSendACmd</a></a> &#34;VBoxManage controlvm [set VBOXINFO($DUT,name)] poweroff&#34;
        <a name="::linuxSendACmd(4)"><a href="./linux.tcl.html#::linuxSendACmd_268">::linuxSendACmd</a></a> &#34;VBoxManage snapshot [set VBOXINFO($DUT,name)] restore primary&#34;
        after 1000
    }
    if {[regexp -nocase &#34;on|reb|oot&#34; $mode]} {
        <a name="::linuxSendACmd(5)"><a href="./linux.tcl.html#::linuxSendACmd_268">::linuxSendACmd</a></a> &#34;VBoxManage startvm [set VBOXINFO($DUT,name)] -type headless&#34;
    }
    if [catch {close -i $spawn_id} reason] {
        puts &#34;Failed to close spawn_id $spawn_id Reason: $reason&#34;
    }
    if [catch {wait} x] {
        puts &#34;Failed on wait : reason $x&#34;
    }
    set spawn_ids($VBOXSERVER) &#34;INVALID&#34;
    set hostname [<a name="::ldelete(1)"><a href="./misc.tcl.html#::ldelete_3310">::ldelete</a></a> $hostname $VBOXSERVER]
}
</pre>
<hr>
<div class="index-selector">
	<a href="index_main.html#byfilename">file name</a> 
 | 
	<a href="index_main.html#byprocname">procedure name</a> 
 | 
	<a href="index_main.html#bycall">procedure call</a> 
 | 
	<a href="index_annot_full.html">annotation</a> 

<br>
<cite>File generated 2018-06-14 at 17:09.</cite>
</div>

</body>
</html>
