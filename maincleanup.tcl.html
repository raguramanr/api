<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                       "http://www.w3.org/TR/html4/transitional.dtd">
<!-- Generated by TclDoc @@VERSION@@ -->
<html>
<head>
  <title>maincleanup.tcl</title>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <link rel="stylesheet" type="text/css" href="default.css">
</head>
<body class="src-html">
<div class="index-selector">
<!-- index for tcl source files -->
	Index by: 
	<a href="index_main.html#maincleanup.tcl">file name</a> | 
	<a href="index_main.html#byprocname">procedure name</a> | 
	<a href="index_main.html#bycall">procedure call</a> | 
	<a href="index_annot_full.html">annotation</a>

</div>
<hr>

<p><strong>maincleanup.tcl</strong>&nbsp;&nbsp;<span class="filetype-link">(<a href="maincleanup.tcl-annot.html">annotations</a> | <a href="maincleanup.tcl.txt">original source</a>)</span>
</p>
<pre class="src-code">
<span class="comment-line"># ------------------------------  Clean up everything at the bottom ---------------------------------</span>
<strong><a name="::::_cleanAndStoreResults_2">proc <a href="maincleanup.tcl-annot.html#::::_cleanAndStoreResults">::::_cleanAndStoreResults</a></a></strong> {args} {

    global MAIN
    <a name="::parse_args(1)"><a href="./parse_args.tcl.html#::parse_args_29">::parse_args</a></a> _cleanAndStoreResults $args {
        returnFlag    &#34;testCompleted&#34;
    }

    puts &#34;@@@@@@@@@@@@@@@@@@  returnFlag $returnFlag  @@@@@@@@@@@@@@@@@@&#34;
    puts &#34; ---   Old style returnFlag = [lindex $returnFlag 0]   ----&#34;

    set returnFlag [lindex $returnFlag 0]

    flush stdout
    flush stderr

    <span class="comment-line"># -----------------------------------------------------------------------------------------</span>
    <span class="comment-line"># Any harness files that need to be moved to the results storage will be covered here</span>
    <span class="comment-line">#</span>
    <span class="comment-line"># Also - init files to the main/Tmp location</span>
    <span class="comment-line"># -----------------------------------------------------------------------------------------</span>

    <span class="comment-line"># --- Generate the topology html    </span>
    if {0 &amp;&amp; ![regexp -nocase {clitest|SystemTest} $regPath]} {
    } 

    <span class="comment-line"># -----   Init file handling</span>
    if {($MAIN(ifPipe) != &#34;NULL&#34;) &amp;&amp; ($MAIN(runMode) == 0)} {
        close $MAIN(ifPipe)
        <a name="::result_debug(1)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;closed $MAIN(initFile)&#34;
    } else {
        <a name="::result_debug(2)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;No need to close init file: initFile pipe= $MAIN(ifPipe) runMode= $MAIN(runMode)&#34;
    }
    if {[<a name="::::VerifyInitFile(1)"><a href="./SystemSetup.tcl.html#::::VerifyInitFile_2823">::::VerifyInitFile</a></a> $MAIN(initFile)]} {
        <a name="::result_debug(3)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;Copying good init file $MAIN(initFile) to Tmp2&#34;
        regsub -all &#34;Tmp&#34; $MAIN(initFile) &#34;Tmp2&#34; initFile2
        catch {file copy -force $MAIN(initFile) $initFile2} why
    }
    if {[file exists $MAIN(initFile)]} {
        puts &#34;Move init file to result directory&#34;
        file copy $MAIN(initFile) [<a name="::get_result_dir(1)"><a href="./result.tcl.html#::get_result_dir_189">::get_result_dir</a></a> { $randomIndex }]/initFile.txt
    }
    <span class="comment-line"># -----  Store the cfg file with the results</span>
    set cfg_file &#34;$MAIN(autoRoot)/main/cfg/$MAIN(cfg)&#34;
    if {[file exists $cfg_file]} {
        puts &#34;Move config file to result directory&#34;
        file copy $cfg_file  [<a name="::get_result_dir(2)"><a href="./result.tcl.html#::get_result_dir_189">::get_result_dir</a></a> { $randomIndex }]/[file root [file tail $cfg_file]]_config.txt
    }

    <span class="comment-line"># -----  Generate a Execution Summary File only if we used &#34;all/pass/quick&#34; list.</span>
    if {[file exists $MAIN(timeFile)] } {
        <a name="::result_debug(4)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;Generating Execution Summary File&#34;
        if {[<a name="::generateExecutionSummary(1)"><a href="./maindiag.tcl.html#::generateExecutionSummary_21">::generateExecutionSummary</a></a> $MAIN(timeFile) $MAIN(lst) $MAIN(module) \
                $MAIN(tSetupDuration) $MAIN(tCheckConnectionDuration) $MAIN(MainDuration)] == 0} {
            <a name="::result_debug(5)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;...No execution summary file was generated...&#34;
        }

    } else {
        <a name="::result_debug(6)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;Execution Summary File NOT generated&#34;
        <a name="::result_debug(7)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;$MAIN(timeFile) present:  [file exists $MAIN(timeFile)]&#34;
        <a name="::result_debug(8)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;lst file: $MAIN(lst)&#34;
    }
    <span class="comment-line"># ----- Create json file from tcl vars collected during run</span>
    <a name="::_createJSONfromTclResults(1)"><a href="./maincleanup.tcl.html#::_createJSONfromTclResults_99">::_createJSONfromTclResults</a></a>

    if { $returnFlag == &#34;testCompleted&#34; || $returnFlag == &#34;testSkipped&#34; } {
        <a name="::create_report_directory(1)"><a href="./result.tcl.html#::create_report_directory_890">::create_report_directory</a></a> $MAIN(sourceFile) yes $MAIN(optionalPath) &#34;&#34; $MAIN(subversion) $MAIN(qId)
        <a name="::gen_text_report(1)"><a href="./report.tcl.html#::gen_text_report_602">::gen_text_report</a></a> &#34;[<a name="::get_result_dir(3)"><a href="./result.tcl.html#::get_result_dir_189">::get_result_dir</a></a> { $MAIN(randomIndex) }]/report.exr&#34; &#34;stdout&#34; $MAIN(feature_directory) $MAIN(sourceFile)
        ;<span class="comment-line"># Move the complete result directory to report directory</span>
        <a name="::result_debug(9)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;Moving contents of [<a name="::get_result_dir(4)"><a href="./result.tcl.html#::get_result_dir_189">::get_result_dir</a></a>] to Report directory&#34;
        if {$returnFlag == &#34;testSkipped&#34; &amp;&amp; !$MAIN(NOFEATSUPPORT)} {
            if {[set fd_main_skip [open &#34;[<a name="::get_result_dir(5)"><a href="./result.tcl.html#::get_result_dir_189">::get_result_dir</a></a>]/skipTestsList.txt&#34; &#34;w&#34;]] == -1} {
                return -1
            }
            puts $fd_main_skip &#34;FeatureSkipped&#34;
            close $fd_main_skip
        }
        <a name="::move_result_directory(1)"><a href="./result.tcl.html#::move_result_directory_1006">::move_result_directory</a></a> $MAIN(optionalPath) &#34;&#34; $MAIN(timeFile)

    } elseif {$returnFlag == &#34;connectionBad&#34; } {
        <a name="::result_error(1)"><a href="./lconsoles.tcl.html#::result_error_6">::result_error</a></a> &#34;Connections between DUTs and/or Ixia/Hub are not detected properly&#34;
        <a name="::result_error(2)"><a href="./lconsoles.tcl.html#::result_error_6">::result_error</a></a> &#34;Please make sure physical connections match with config setup file&#34;
        <a name="::result_debug(10)"><a href="./lconsoles.tcl.html#::result_debug_3">::result_debug</a></a> &#34;Program will now clean the boxes and terminate&#34;
        <a name="::cleanup(1)"><a href="./cleanup.tcl.html#::cleanup_15">::cleanup</a></a>
    } else {
        <a name="::result_error(3)"><a href="./lconsoles.tcl.html#::result_error_6">::result_error</a></a> &#34;main.tcl error $returnFlag&#34;
        <a name="::result_error(4)"><a href="./lconsoles.tcl.html#::result_error_6">::result_error</a></a> &#34;Report NOT moved to Report directory&#34;
    }
    return $returnFlag
}
<span class="comment-line">######################################################################</span>
<span class="comment-line">#</span>
<span class="comment-line">#</span>
<span class="comment-line">#</span>
<span class="comment-line">#</span>
<span class="comment-line">#</span>
<span class="comment-line">#</span>
<span class="comment-line">######################################################################</span>
<strong><a name="::::_createJSONfromTclResults_99">proc <a href="maincleanup.tcl-annot.html#::::_createJSONfromTclResults">::::_createJSONfromTclResults</a></a></strong> {args} {
    global MAIN REG_PATH module auto_path modName DUTs_info

    <a name="::parse_args(2)"><a href="./parse_args.tcl.html#::parse_args_29">::parse_args</a></a> _createJSONfromTclResults $args {
        name    &#34;null&#34;
    }
    set resVarFile [<a name="::get_result_dir(6)"><a href="./result.tcl.html#::get_result_dir_189">::get_result_dir</a></a> {$MAIN(randomIndex)}]/TCLStatusVars.txt
    set trackerFile [<a name="::get_result_dir(7)"><a href="./result.tcl.html#::get_result_dir_189">::get_result_dir</a></a> {$MAIN(randomIndex)}]/TCRealTimeCR.txt];
    set resJSONFile [<a name="::get_result_dir(8)"><a href="./result.tcl.html#::get_result_dir_189">::get_result_dir</a></a> {$MAIN(randomIndex)}]/JsonResults.txt
    if {[file exists $resVarFile]} {
        if {[set fd_json [open &#34;$resJSONFile&#34; &#34;w&#34;]] == -1} {
            return -1
        }
        if {[catch {source $resVarFile} why]} {
            puts &#34;Failed to source result file: $why&#34;
            return -1
        }
        if {![info exists ReportCases] || [llength $ReportCases] &lt;= 0} {
            return -1
        }
        set cc [llength $ReportCases];
        puts $fd_json &#34;\{&#34;
        puts $fd_json &#34;\&#34;TestCases\&#34;: \[ \&#34;[join $ReportCases &#34;\&#34;,\&#34;&#34;]\&#34; \],&#34;
        puts $fd_json &#34;\&#34;Results\&#34;: \{&#34;
        set i 1;
        foreach tc $ReportCases {
            if {$i == $cc} {
                puts $fd_json &#34;    \&#34;$tc\&#34;: \{\&#34;status\&#34;: \&#34;$RepResArray($tc)\&#34;, \
                   \&#34;duration\&#34;: \&#34;$RepDurArray($tc)\&#34;\}&#34;
            } else {
                puts $fd_json &#34;    \&#34;$tc\&#34;: \{\&#34;status\&#34;: \&#34;$RepResArray($tc)\&#34;, \
                   \&#34;duration\&#34;: \&#34;$RepDurArray($tc)\&#34;\},&#34;
            }
            incr i
        }
        puts $fd_json &#34;    \}&#34;;<span class="comment-line"># End of Results</span>
        if {[file exists $trackerFile]} {
            catch {source $trackerFile} why
            if {![info exists TrackerCases] || [llength $TrackerCases] &lt;= 0} {
                break;
            }
            set cc [llength $TrackerCases]
            set i 1
            puts $fd_json &#34;\&#34;CR_TestCases\&#34;: \[ \&#34;[join $TrackerCases &#34;\&#34;,\&#34;&#34;]\&#34; \],&#34;
            puts $fd_json &#34;\&#34;Tracker\&#34;: \{&#34;
            foreach tc $TrackerCases {
                if {$i == $cc} {
                    puts $fd_json &#34;    \&#34;$tc\&#34;: \{\&#34;CR\&#34;: \&#34;$RepResArray($tc)\&#34;, \
                       \&#34;globalState\&#34;: \&#34;$RepResArray($tc)\&#34;, \
                       \&#34;status\&#34;: \&#34;$RepDurArray($tc)\&#34;\}&#34;
                } else {
                    puts $fd_json &#34;    \&#34;$tc\&#34;: \{\&#34;CR\&#34;: \&#34;$RepResArray($tc)\&#34;, \
                       \&#34;globalState\&#34;: \&#34;$RepResArray($tc)\&#34;, \
                       \&#34;status\&#34;: \&#34;$RepDurArray($tc)\&#34;\},&#34;
                }
                incr i
            }
        }
        puts $fd_json &#34;\}&#34;
        close $fd_json
    }
}
<span class="comment-line">######################################################################</span>
<span class="comment-line"># proc _changeFeature</span>
<span class="comment-line">#</span>
<span class="comment-line"># Change to a new feature directory in order to execute tests.</span>
<span class="comment-line">#</span>
<span class="comment-line">#</span>
<span class="comment-line">#</span>
<span class="comment-line">######################################################################</span>
<strong><a name="::::_changeFeature_169">proc <a href="maincleanup.tcl-annot.html#::::_changeFeature">::::_changeFeature</a></a></strong> {args} {
    global MAIN REG_PATH module auto_path modName DUTs_info

    <span class="comment-line">#    set REG_PATH [pwd]  - directory of the feature</span>
    <span class="comment-line">#    set MAIN(REG_PATH) [pwd] - dir of the feature</span>

    <a name="::parse_args(3)"><a href="./parse_args.tcl.html#::parse_args_29">::parse_args</a></a> _changeFeature $args {
        regPath    &#34;Functional&#34;
        module     &#34;qad&#34;
        m          &#34;null&#34;
    }

    if {$m != &#34;null&#34;} {
        set module $m
    }
    <span class="comment-line">#Remove previous feature from the auto path , MAIN(auto_path_clean)</span>
    set auto_path $MAIN(auto_path_clean)

    cd $MAIN(autoRoot)/main ;<span class="comment-line"># return to the base of the automation tree</span>
puts &#34;1- [pwd]&#34;
    set regPath [<a name="::_verifyRegPathArg(1)"><a href="./filetools.tcl.html#::_verifyRegPathArg_107">::_verifyRegPathArg</a></a> -regPath $regPath]
    set module [_verifyModuleNameArg $regPath $module]
    puts &#34;Changing to $module&#34;
    cd $module
    set REG_PATH [pwd]
    set MAIN(REG_PATH) [pwd]
    <span class="comment-line"># Create supporting dirctories for this feature</span>
    <a name="::_createSupportDirectories(1)"><a href="./filetools.tcl.html#::_createSupportDirectories_50">::_createSupportDirectories</a></a> -dirList &#34;Report Result Tmp Log&#34;

    set MAIN(module) $module;<span class="comment-line"># Full path, not just the short one passed into the arg</span>
    set modName [file tail $module]; <span class="comment-line"># modName is feature_directory name</span>
    set MAIN(feature_directory) $modName;
    set auto_path [linsert $auto_path 0 [pwd] ]
    <a name="::::gen_index(1)"><a href="./summarize.tcl.html#::::gen_index_76">::::gen_index</a></a> [pwd]
    <a name="::_createSupportDirectories(2)"><a href="./filetools.tcl.html#::_createSupportDirectories_50">::_createSupportDirectories</a></a> -dirList &#34;Report Result Tmp Tmp2 Log&#34;
    puts &#34;Successfully changed feature to [pwd]&#34;
    puts &#34;CUT AND PASTE:   gen_index .  To put this directories procs in your scope.&#34;
}
</pre>
<hr>
<div class="index-selector">
	<a href="index_main.html#byfilename">file name</a> 
 | 
	<a href="index_main.html#byprocname">procedure name</a> 
 | 
	<a href="index_main.html#bycall">procedure call</a> 
 | 
	<a href="index_annot_full.html">annotation</a> 

<br>
<cite>File generated 2018-06-14 at 17:09.</cite>
</div>

</body>
</html>
